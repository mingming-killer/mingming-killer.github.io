
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

  
    <title>Android 内存优化方法 | Light.Moon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Mingming">
    
    <meta name="description" content="统计方法
做优化相关的工作，最重要的就是要有可以量化的指标。所以我们先要知道哪些可以衡量系统占用内存的方法和工具。结合自身工作的一些经验和网上的一些资料，下面先介绍一些查看内存占用情况的方法和工具：
dumpsys meminfo
dumpsys meminfo 是 Android 中最常用的查看内">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/apple_icon.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/apple_icon.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
		<div id="header_author">
		</div>
		

         <!--
         
           <div id="imglogo">
           <a href="/"><img src="/img/logo.svg" alt="Light.Moon" title="Light.Moon"/></a>
           </div>
         
         -->

			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Light.Moon">Light.Moon</a></h1>
				<h2 class="blog-motto">三月学长的小站</h2>
			</div>

			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/1986/12/20/文章索引">索引</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					

                      <form class="search" action=http://search.light3moon.com/cse/search target="_blank">
                      <label>搜索</label>
                      <!--
                      <input name="s" type="hidden" value="undefined">
                      -->
                      <input name="s" type="hidden" value="12628367885198549364">
                      <input type="text" name="q" size="30" placeholder="搜索"> <br>

                      
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/12/07/Android 内存优化方法/" title="Android 内存优化方法" itemprop="url">Android 内存优化方法</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.light3moon.com" title="Mingming">Mingming</a>
    </p>
  <p class="article-time">
    <time datetime="2020-12-07T15:18:16.000Z" itemprop="datePublished">2020 12月 7</time>
    更新日期:<time datetime="2021-02-08T15:18:16.000Z" itemprop="dateModified">2021 2月 8</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#统计方法"><span class="toc-number">1.</span> <span class="toc-text">统计方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dumpsys_meminfo"><span class="toc-number">1.1.</span> <span class="toc-text">dumpsys meminfo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Total_RAM:"><span class="toc-number">1.1.1.</span> <span class="toc-text">Total RAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Free_RAM:"><span class="toc-number">1.1.2.</span> <span class="toc-text">Free RAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Used_RAM:"><span class="toc-number">1.1.3.</span> <span class="toc-text">Used RAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZRAM:"><span class="toc-number">1.1.4.</span> <span class="toc-text">ZRAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lost_RAM:"><span class="toc-number">1.1.5.</span> <span class="toc-text">Lost RAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tuning:"><span class="toc-number">1.1.6.</span> <span class="toc-text">Tuning:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dumpsys_meminfo_pid:"><span class="toc-number">1.1.7.</span> <span class="toc-text">dumpsys meminfo pid:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#procrank"><span class="toc-number">1.2.</span> <span class="toc-text">procrank</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#进程列表："><span class="toc-number">1.2.1.</span> <span class="toc-text">进程列表：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZRAM："><span class="toc-number">1.2.2.</span> <span class="toc-text">ZRAM：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RAM："><span class="toc-number">1.2.3.</span> <span class="toc-text">RAM：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/proc/pid/maps"><span class="toc-number">1.3.</span> <span class="toc-text">/proc/pid/maps</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/proc/pid/smaps"><span class="toc-number">1.4.</span> <span class="toc-text">/proc/pid/smaps</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/proc/meminfo"><span class="toc-number">1.5.</span> <span class="toc-text">/proc/meminfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PageMap"><span class="toc-number">1.6.</span> <span class="toc-text">PageMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ion"><span class="toc-number">1.7.</span> <span class="toc-text">ion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel_used"><span class="toc-number">1.8.</span> <span class="toc-text">Kernel used</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel_reserved"><span class="toc-number">1.9.</span> <span class="toc-text">Kernel reserved</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MAT"><span class="toc-number">1.10.</span> <span class="toc-text">MAT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc_debug"><span class="toc-number">1.11.</span> <span class="toc-text">malloc_debug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工具小结"><span class="toc-number">1.12.</span> <span class="toc-text">工具小结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#内存总计"><span class="toc-number">1.12.1.</span> <span class="toc-text">内存总计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用内存分析"><span class="toc-number">1.12.2.</span> <span class="toc-text">应用内存分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#优化思路"><span class="toc-number">2.</span> <span class="toc-text">优化思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel"><span class="toc-number">2.1.</span> <span class="toc-text">Kernel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel_used-1"><span class="toc-number">2.1.1.</span> <span class="toc-text">Kernel used</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel_reserved-1"><span class="toc-number">2.1.2.</span> <span class="toc-text">Kernel reserved</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速回收"><span class="toc-number">2.1.3.</span> <span class="toc-text">快速回收</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android"><span class="toc-number">2.2.</span> <span class="toc-text">Android</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#删除无用模块"><span class="toc-number">2.2.1.</span> <span class="toc-text">删除无用模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#精简模块内容"><span class="toc-number">2.2.2.</span> <span class="toc-text">精简模块内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源瘦身"><span class="toc-number">2.2.3.</span> <span class="toc-text">资源瘦身</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#虚拟机参数调优"><span class="toc-number">2.2.4.</span> <span class="toc-text">虚拟机参数调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lmk_参数调优"><span class="toc-number">2.2.5.</span> <span class="toc-text">lmk 参数调优</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多媒体"><span class="toc-number">2.3.</span> <span class="toc-text">多媒体</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol>
		</div>
		
		<h1 id="统计方法">统计方法</h1>
<p>做优化相关的工作，最重要的就是要有可以量化的指标。所以我们先要知道哪些可以衡量系统占用内存的方法和工具。结合自身工作的一些经验和网上的一些资料，下面先介绍一些查看内存占用情况的方法和工具：</p>
<h2 id="dumpsys_meminfo">dumpsys meminfo</h2>
<p>dumpsys meminfo 是 Android 中最常用的查看内存的一个命令。它是 AMS（ActivityManagerService）中一个 binder 接口，具体源码见参考资料，它会显示当前的内存情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div></pre></td><td class="code"><pre><div class="line">Applications Memory Usage (in Kilobytes):</div><div class="line">Uptime: <span class="number">73832068</span> Realtime: <span class="number">103320267</span></div><div class="line"></div><div class="line">Total PSS by process:</div><div class="line">     <span class="number">50</span>,<span class="number">992</span>K: system (pid <span class="number">2309</span>)</div><div class="line">     <span class="number">41</span>,<span class="number">119</span>K: com.android.systemui (pid <span class="number">3382</span>)</div><div class="line">     <span class="number">24</span>,<span class="number">075</span>K: com.android.launcher3 (pid <span class="number">3993</span> / activities)</div><div class="line">      <span class="number">9</span>,<span class="number">564</span>K: com.android.phone (pid <span class="number">3734</span>)</div><div class="line">      <span class="number">8</span>,<span class="number">738</span>K: com.android.calendar (pid <span class="number">12956</span>)</div><div class="line">      <span class="number">8</span>,<span class="number">711</span>K: com.android.deskclock (pid <span class="number">12994</span>)</div><div class="line">      <span class="number">8</span>,<span class="number">196</span>K: android.process.media (pid <span class="number">4888</span>)</div><div class="line">      <span class="number">8</span>,<span class="number">195</span>K: com.android.inputmethod.latin (pid <span class="number">4161</span>)</div><div class="line">      <span class="number">8</span>,<span class="number">049</span>K: com.google.android.permissioncontroller (pid <span class="number">5523</span>)</div><div class="line">      <span class="number">8</span>,<span class="number">037</span>K: mediaserver (pid <span class="number">1985</span>)</div><div class="line">      <span class="number">6</span>,<span class="number">730</span>K: media.swcodec (pid <span class="number">1995</span>)</div><div class="line">      <span class="number">6</span>,<span class="number">621</span>K: com.android.providers.calendar (pid <span class="number">5453</span>)</div><div class="line">      <span class="number">6</span>,<span class="number">099</span>K: com.android.email (pid <span class="number">5328</span>)</div><div class="line">      <span class="number">5</span>,<span class="number">487</span>K: com.android.settings (pid <span class="number">5480</span>)</div><div class="line">      <span class="number">5</span>,<span class="number">216</span>K: com.android.traceur (pid <span class="number">5501</span>)</div><div class="line">      <span class="number">5</span>,<span class="number">088</span>K: com.android.se (pid <span class="number">4696</span>)</div><div class="line">      <span class="number">5</span>,<span class="number">050</span>K: zygote (pid <span class="number">1928</span>)</div><div class="line">      <span class="number">5</span>,<span class="number">040</span>K: com.android.keychain (pid <span class="number">6191</span>)</div><div class="line">      <span class="number">5</span>,<span class="number">001</span>K: surfaceflinger (pid <span class="number">1951</span>)</div><div class="line">      <span class="number">4</span>,<span class="number">895</span>K: audioserver (pid <span class="number">1948</span>)</div><div class="line">      <span class="number">4</span>,<span class="number">426</span>K: media.extractor (pid <span class="number">1983</span>)</div><div class="line">      <span class="number">2</span>,<span class="number">656</span>K: cameraserver (pid <span class="number">1976</span>)</div><div class="line">      <span class="number">2</span>,<span class="number">464</span>K: media.codec (pid <span class="number">1989</span>)</div><div class="line">      <span class="number">2</span>,<span class="number">320</span>K: init (pid <span class="number">1</span>)</div><div class="line">      <span class="number">2</span>,<span class="number">232</span>K: android.hardware.audio@<span class="number">2.0</span>-service (pid <span class="number">1933</span>)</div><div class="line">      <span class="number">2</span>,<span class="number">166</span>K: logd (pid <span class="number">1773</span>)</div><div class="line">      <span class="number">2</span>,<span class="number">074</span>K: android.hardware.graphics.composer@<span class="number">2.2</span>-service (pid <span class="number">1939</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">858</span>K: media.metrics (pid <span class="number">1984</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">756</span>K: drmserver (pid <span class="number">1977</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">667</span>K: vold (pid <span class="number">1778</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">645</span>K: netd (pid <span class="number">1929</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">603</span>K: rild (pid <span class="number">1993</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">578</span>K: adbd (pid <span class="number">8775</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">567</span>K: ueventd (pid <span class="number">1400</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">385</span>K: idmap2d (pid <span class="number">1978</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">258</span>K: android.hardware.graphics.allocator@<span class="number">2.0</span>-service (pid <span class="number">1938</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">236</span>K: init (pid <span class="number">1397</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">234</span>K: installd (pid <span class="number">1980</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">210</span>K: storaged (pid <span class="number">1987</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">171</span>K: statsd (pid <span class="number">1986</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">126</span>K: keystore (pid <span class="number">1981</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">115</span>K: apexd (pid <span class="number">1910</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">011</span>K: android.hardware.keymaster@<span class="number">4.0</span>-service-aw (pid <span class="number">1859</span>)</div><div class="line">      <span class="number">1</span>,<span class="number">010</span>K: init (pid <span class="number">1398</span>)</div><div class="line">        <span class="number">978</span>K: hwservicemanager (pid <span class="number">1775</span>)</div><div class="line">        <span class="number">954</span>K: android.hardware.wifi@<span class="number">1.0</span>-service-lazy (pid <span class="number">3344</span>)</div><div class="line">        <span class="number">928</span>K: mediadrmserver (pid <span class="number">1982</span>)</div><div class="line">        <span class="number">923</span>K: android.system.suspend@<span class="number">1.0</span>-service (pid <span class="number">1932</span>)</div><div class="line">        <span class="number">904</span>K: gatekeeperd (pid <span class="number">1996</span>)</div><div class="line">        <span class="number">889</span>K: gpuservice (pid <span class="number">1949</span>)</div><div class="line">        <span class="number">877</span>K: incidentd (pid <span class="number">1979</span>)</div><div class="line">        <span class="number">865</span>K: android.hardware.sensors@<span class="number">2.0</span>-service (pid <span class="number">1945</span>)</div><div class="line">        <span class="number">833</span>K: android.hardware.configstore@<span class="number">1.1</span>-service (pid <span class="number">1936</span>)</div><div class="line">        <span class="number">832</span>K: android.hardware.health@<span class="number">2.0</span>-service (pid <span class="number">1940</span>)</div><div class="line">        <span class="number">831</span>K: android.hardware.cas@<span class="number">1.1</span>-service (pid <span class="number">1935</span>)</div><div class="line">        <span class="number">829</span>K: android.hardware.gatekeeper@<span class="number">1.0</span>-service (pid <span class="number">1937</span>)</div><div class="line">        <span class="number">820</span>K: android.hardware.bluetooth@<span class="number">1.0</span>-service (pid <span class="number">1934</span>)</div><div class="line">        <span class="number">818</span>K: android.hardware.power@<span class="number">1.0</span>-service (pid <span class="number">1943</span>)</div><div class="line">        <span class="number">802</span>K: android.hardware.usb@<span class="number">1.0</span>-service (pid <span class="number">1946</span>)</div><div class="line">        <span class="number">801</span>K: android.hardware.light@<span class="number">2.0</span>-service (pid <span class="number">1941</span>)</div><div class="line">        <span class="number">789</span>K: android.hardware.memtrack@<span class="number">1.0</span>-service (pid <span class="number">1942</span>)</div><div class="line">        <span class="number">787</span>K: android.hardware.boot@<span class="number">1.0</span>-service (pid <span class="number">1858</span>)</div><div class="line">        <span class="number">775</span>K: android.hardware.radio.config@<span class="number">1.1</span>-service (pid <span class="number">1944</span>)</div><div class="line">        <span class="number">742</span>K: wificond (pid <span class="number">1988</span>)</div><div class="line">        <span class="number">736</span>K: awlogd (pid <span class="number">2000</span>)</div><div class="line">        <span class="number">725</span>K: displayservice (pid <span class="number">4587</span>)</div><div class="line">        <span class="number">667</span>K: crda.uevent (pid <span class="number">1990</span>)</div><div class="line">        <span class="number">642</span>K: servicemanager (pid <span class="number">1774</span>)</div><div class="line">        <span class="number">629</span>K: ip6tables-restore (pid <span class="number">2044</span>)</div><div class="line">        <span class="number">629</span>K: dumpsys (pid <span class="number">28152</span>)</div><div class="line">        <span class="number">609</span>K: lmkd (pid <span class="number">1950</span>)</div><div class="line">        <span class="number">590</span>K: android.hidl.allocator@<span class="number">1.0</span>-service (pid <span class="number">1931</span>)</div><div class="line">        <span class="number">577</span>K: ashmemd (pid <span class="number">1947</span>)</div><div class="line">        <span class="number">574</span>K: iptables-restore (pid <span class="number">2043</span>)</div><div class="line">        <span class="number">572</span>K: sh (pid <span class="number">13796</span>)</div><div class="line">        <span class="number">561</span>K: vndservicemanager (pid <span class="number">1776</span>)</div><div class="line">        <span class="number">559</span>K: sh (pid <span class="number">1801</span>)</div><div class="line">        <span class="number">543</span>K: tee_supplicant (pid <span class="number">1860</span>)</div><div class="line">        <span class="number">539</span>K: radio_monitor (pid <span class="number">1992</span>)</div><div class="line">        <span class="number">519</span>K: dom2reg (pid <span class="number">1991</span>)</div><div class="line">        <span class="number">489</span>K: tombstoned (pid <span class="number">1997</span>)</div><div class="line">        <span class="number">485</span>K: kmsgd (pid <span class="number">2002</span>)</div><div class="line"></div><div class="line">Total PSS by OOM adjustment:</div><div class="line">     <span class="number">99</span>,<span class="number">103</span>K: Native</div><div class="line">          <span class="number">8</span>,<span class="number">037</span>K: mediaserver (pid <span class="number">1985</span>)</div><div class="line">          <span class="number">6</span>,<span class="number">730</span>K: media.swcodec (pid <span class="number">1995</span>)</div><div class="line">          <span class="number">5</span>,<span class="number">050</span>K: zygote (pid <span class="number">1928</span>)</div><div class="line">          <span class="number">5</span>,<span class="number">001</span>K: surfaceflinger (pid <span class="number">1951</span>)</div><div class="line">          <span class="number">4</span>,<span class="number">895</span>K: audioserver (pid <span class="number">1948</span>)</div><div class="line">          <span class="number">4</span>,<span class="number">426</span>K: media.extractor (pid <span class="number">1983</span>)</div><div class="line">          <span class="number">2</span>,<span class="number">656</span>K: cameraserver (pid <span class="number">1976</span>)</div><div class="line">          <span class="number">2</span>,<span class="number">464</span>K: media.codec (pid <span class="number">1989</span>)</div><div class="line">          <span class="number">2</span>,<span class="number">320</span>K: init (pid <span class="number">1</span>)</div><div class="line">          <span class="number">2</span>,<span class="number">232</span>K: android.hardware.audio@<span class="number">2.0</span>-service (pid <span class="number">1933</span>)</div><div class="line">          <span class="number">2</span>,<span class="number">166</span>K: logd (pid <span class="number">1773</span>)</div><div class="line">          <span class="number">2</span>,<span class="number">074</span>K: android.hardware.graphics.composer@<span class="number">2.2</span>-service (pid <span class="number">1939</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">858</span>K: media.metrics (pid <span class="number">1984</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">756</span>K: drmserver (pid <span class="number">1977</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">667</span>K: vold (pid <span class="number">1778</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">645</span>K: netd (pid <span class="number">1929</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">603</span>K: rild (pid <span class="number">1993</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">578</span>K: adbd (pid <span class="number">8775</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">567</span>K: ueventd (pid <span class="number">1400</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">385</span>K: idmap2d (pid <span class="number">1978</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">258</span>K: android.hardware.graphics.allocator@<span class="number">2.0</span>-service (pid <span class="number">1938</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">236</span>K: init (pid <span class="number">1397</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">234</span>K: installd (pid <span class="number">1980</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">210</span>K: storaged (pid <span class="number">1987</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">171</span>K: statsd (pid <span class="number">1986</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">126</span>K: keystore (pid <span class="number">1981</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">115</span>K: apexd (pid <span class="number">1910</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">011</span>K: android.hardware.keymaster@<span class="number">4.0</span>-service-aw (pid <span class="number">1859</span>)</div><div class="line">          <span class="number">1</span>,<span class="number">010</span>K: init (pid <span class="number">1398</span>)</div><div class="line">            <span class="number">978</span>K: hwservicemanager (pid <span class="number">1775</span>)</div><div class="line">            <span class="number">954</span>K: android.hardware.wifi@<span class="number">1.0</span>-service-lazy (pid <span class="number">3344</span>)</div><div class="line">            <span class="number">928</span>K: mediadrmserver (pid <span class="number">1982</span>)</div><div class="line">            <span class="number">923</span>K: android.system.suspend@<span class="number">1.0</span>-service (pid <span class="number">1932</span>)</div><div class="line">            <span class="number">904</span>K: gatekeeperd (pid <span class="number">1996</span>)</div><div class="line">            <span class="number">889</span>K: gpuservice (pid <span class="number">1949</span>)</div><div class="line">            <span class="number">877</span>K: incidentd (pid <span class="number">1979</span>)</div><div class="line">            <span class="number">865</span>K: android.hardware.sensors@<span class="number">2.0</span>-service (pid <span class="number">1945</span>)</div><div class="line">            <span class="number">833</span>K: android.hardware.configstore@<span class="number">1.1</span>-service (pid <span class="number">1936</span>)</div><div class="line">            <span class="number">832</span>K: android.hardware.health@<span class="number">2.0</span>-service (pid <span class="number">1940</span>)</div><div class="line">            <span class="number">831</span>K: android.hardware.cas@<span class="number">1.1</span>-service (pid <span class="number">1935</span>)</div><div class="line">            <span class="number">829</span>K: android.hardware.gatekeeper@<span class="number">1.0</span>-service (pid <span class="number">1937</span>)</div><div class="line">            <span class="number">820</span>K: android.hardware.bluetooth@<span class="number">1.0</span>-service (pid <span class="number">1934</span>)</div><div class="line">            <span class="number">818</span>K: android.hardware.power@<span class="number">1.0</span>-service (pid <span class="number">1943</span>)</div><div class="line">            <span class="number">802</span>K: android.hardware.usb@<span class="number">1.0</span>-service (pid <span class="number">1946</span>)</div><div class="line">            <span class="number">801</span>K: android.hardware.light@<span class="number">2.0</span>-service (pid <span class="number">1941</span>)</div><div class="line">            <span class="number">789</span>K: android.hardware.memtrack@<span class="number">1.0</span>-service (pid <span class="number">1942</span>)</div><div class="line">            <span class="number">787</span>K: android.hardware.boot@<span class="number">1.0</span>-service (pid <span class="number">1858</span>)</div><div class="line">            <span class="number">775</span>K: android.hardware.radio.config@<span class="number">1.1</span>-service (pid <span class="number">1944</span>)</div><div class="line">            <span class="number">742</span>K: wificond (pid <span class="number">1988</span>)</div><div class="line">            <span class="number">736</span>K: awlogd (pid <span class="number">2000</span>)</div><div class="line">            <span class="number">725</span>K: displayservice (pid <span class="number">4587</span>)</div><div class="line">            <span class="number">667</span>K: crda.uevent (pid <span class="number">1990</span>)</div><div class="line">            <span class="number">642</span>K: servicemanager (pid <span class="number">1774</span>)</div><div class="line">            <span class="number">629</span>K: ip6tables-restore (pid <span class="number">2044</span>)</div><div class="line">            <span class="number">629</span>K: dumpsys (pid <span class="number">28152</span>)</div><div class="line">            <span class="number">609</span>K: lmkd (pid <span class="number">1950</span>)</div><div class="line">            <span class="number">590</span>K: android.hidl.allocator@<span class="number">1.0</span>-service (pid <span class="number">1931</span>)</div><div class="line">            <span class="number">577</span>K: ashmemd (pid <span class="number">1947</span>)</div><div class="line">            <span class="number">574</span>K: iptables-restore (pid <span class="number">2043</span>)</div><div class="line">            <span class="number">572</span>K: sh (pid <span class="number">13796</span>)</div><div class="line">            <span class="number">561</span>K: vndservicemanager (pid <span class="number">1776</span>)</div><div class="line">            <span class="number">559</span>K: sh (pid <span class="number">1801</span>)</div><div class="line">            <span class="number">543</span>K: tee_supplicant (pid <span class="number">1860</span>)</div><div class="line">            <span class="number">539</span>K: radio_monitor (pid <span class="number">1992</span>)</div><div class="line">            <span class="number">519</span>K: dom2reg (pid <span class="number">1991</span>)</div><div class="line">            <span class="number">489</span>K: tombstoned (pid <span class="number">1997</span>)</div><div class="line">            <span class="number">485</span>K: kmsgd (pid <span class="number">2002</span>)</div><div class="line">     <span class="number">50</span>,<span class="number">992</span>K: System</div><div class="line">         <span class="number">50</span>,<span class="number">992</span>K: system (pid <span class="number">2309</span>)</div><div class="line">     <span class="number">55</span>,<span class="number">771</span>K: Persistent</div><div class="line">         <span class="number">41</span>,<span class="number">119</span>K: com.android.systemui (pid <span class="number">3382</span>)</div><div class="line">          <span class="number">9</span>,<span class="number">564</span>K: com.android.phone (pid <span class="number">3734</span>)</div><div class="line">          <span class="number">5</span>,<span class="number">088</span>K: com.android.se (pid <span class="number">4696</span>)</div><div class="line">     <span class="number">24</span>,<span class="number">075</span>K: Foreground</div><div class="line">         <span class="number">24</span>,<span class="number">075</span>K: com.android.launcher3 (pid <span class="number">3993</span> / activities)</div><div class="line">      <span class="number">8</span>,<span class="number">195</span>K: Perceptible</div><div class="line">          <span class="number">8</span>,<span class="number">195</span>K: com.android.inputmethod.latin (pid <span class="number">4161</span>)</div><div class="line">     <span class="number">62</span>,<span class="number">157</span>K: Cached</div><div class="line">          <span class="number">8</span>,<span class="number">738</span>K: com.android.calendar (pid <span class="number">12956</span>)</div><div class="line">          <span class="number">8</span>,<span class="number">711</span>K: com.android.deskclock (pid <span class="number">12994</span>)</div><div class="line">          <span class="number">8</span>,<span class="number">196</span>K: android.process.media (pid <span class="number">4888</span>)</div><div class="line">          <span class="number">8</span>,<span class="number">049</span>K: com.google.android.permissioncontroller (pid <span class="number">5523</span>)</div><div class="line">          <span class="number">6</span>,<span class="number">621</span>K: com.android.providers.calendar (pid <span class="number">5453</span>)</div><div class="line">          <span class="number">6</span>,<span class="number">099</span>K: com.android.email (pid <span class="number">5328</span>)</div><div class="line">          <span class="number">5</span>,<span class="number">487</span>K: com.android.settings (pid <span class="number">5480</span>)</div><div class="line">          <span class="number">5</span>,<span class="number">216</span>K: com.android.traceur (pid <span class="number">5501</span>)</div><div class="line">          <span class="number">5</span>,<span class="number">040</span>K: com.android.keychain (pid <span class="number">6191</span>)</div><div class="line"></div><div class="line">Total PSS by category:</div><div class="line">     <span class="number">60</span>,<span class="number">569</span>K: .so mmap</div><div class="line">     <span class="number">37</span>,<span class="number">173</span>K: Native</div><div class="line">     <span class="number">23</span>,<span class="number">108</span>K: Dalvik</div><div class="line">     <span class="number">21</span>,<span class="number">030</span>K: .art mmap</div><div class="line">     <span class="number">20</span>,<span class="number">667</span>K: .jar mmap</div><div class="line">     <span class="number">20</span>,<span class="number">112</span>K: Unknown</div><div class="line">     <span class="number">15</span>,<span class="number">498</span>K: .dex mmap</div><div class="line">     <span class="number">13</span>,<span class="number">589</span>K: .oat mmap</div><div class="line">     <span class="number">11</span>,<span class="number">040</span>K: .apk mmap</div><div class="line">      <span class="number">5</span>,<span class="number">781</span>K: Other mmap</div><div class="line">      <span class="number">5</span>,<span class="number">432</span>K: Dalvik Other</div><div class="line">      <span class="number">1</span>,<span class="number">680</span>K: Stack</div><div class="line">        <span class="number">882</span>K: Other dev</div><div class="line">        <span class="number">520</span>K: Ashmem</div><div class="line">        <span class="number">512</span>K: .ttf mmap</div><div class="line">          <span class="number">0</span>K: Cursor</div><div class="line">          <span class="number">0</span>K: Gfx dev</div><div class="line">          <span class="number">0</span>K: EGL mtrack</div><div class="line">          <span class="number">0</span>K: GL mtrack</div><div class="line">          <span class="number">0</span>K: Other mtrack</div><div class="line"></div><div class="line">Total RAM:   <span class="number">486</span>,<span class="number">028</span>K (status normal)</div><div class="line"> Free RAM:   <span class="number">168</span>,<span class="number">297</span>K (   <span class="number">62</span>,<span class="number">157</span>K cached pss +    <span class="number">78</span>,<span class="number">284</span>K cached kernel +    <span class="number">27</span>,<span class="number">856</span>K free)</div><div class="line"> Used RAM:   <span class="number">292</span>,<span class="number">956</span>K (  <span class="number">238</span>,<span class="number">136</span>K used pss +    <span class="number">54</span>,<span class="number">820</span>K kernel)</div><div class="line"> hmm: Lost RAM:    <span class="number">65</span>,<span class="number">107</span>K, totalPss:   <span class="number">300</span>,<span class="number">293</span>K, totalSwapPss:    <span class="number">62</span>,<span class="number">700</span>K </div><div class="line">     ZRAM:    <span class="number">22</span>,<span class="number">368</span>K physical used <span class="keyword">for</span>    <span class="number">68</span>,<span class="number">664</span>K in swap (  <span class="number">364</span>,<span class="number">516</span>K total swap)</div><div class="line">   Tuning: <span class="number">128</span> (large <span class="number">512</span>), oom    <span class="number">97</span>,<span class="number">812</span>K, restore limit    <span class="number">32</span>,<span class="number">604</span>K (low-ram)</div><div class="line"></div></pre></td></tr></table></figure>

<p>上面是一个 512M Android 10 设备中的 dumpsys meminfo 的输出。</p>
<h3 id="Total_RAM:">Total RAM:</h3>
<p>这个数值是当前系统的所有内存大小。它是读取 /proc/meminfo 节点中的 MemTotal 获取的（/proc/meminfo 这个节点的信息我们后面再说）。它一般并不等于机器的物理内存大小，例如这里物理内存是 512M。那是因为 linux kernel 都会有预留内存（reserved），这个后面再说。物理内存 - kernel reserved = 系统实际内存总和。</p>
<h3 id="Free_RAM:">Free RAM:</h3>
<p>这个数值是当前系统可用内存大小。它是后面括号内那3项之和：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).cached pss</strong>: 是 Total PSS by OOM adjustment 里面 Cached 分类的总和。OOM score 是 Android 根据进程的类型给 lmk 打的分数，lmk 从高分开始回收进程。其中 Cached 的是 OOM 900 以上的，一般都是切到后台的进程，表示可以随时回收。Rss(resident set size)表示常驻内存的大小，但是由于不同的进程之间会共享内存，所以用 Rss 表示进程内存会偏大。而 Pss(Proportional Set Size)把共享内存的 Rss 进行了平均分摊，所以一般使用 Pss 来表示进程的内存大小。而这里把 OOM 900 以上的所有进程的 Pss 算做 free 内存，我认为并不准确。Android 的应该是认为 OOM 900 以上的进程能随时被 lmk 回收，所以认为这部分可以算作 free 内存。但是其实这些进程中包含进程的已经申请并且分配了的内存，所以这个算法我认为并不能很好的代表 free 内存。这也是我并不推荐参考这个 Free RAM 数值来衡量当前系统的可用内存的原因。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).cached kernel</strong>: 是 /proc/meminfo 中下面几项计算出来的： Buffers + Cached + SReclaimable - Mapped。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Buffers:</strong> 是 kernel 中块设备（block）申请的内存大小。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Cached:</strong>  这部分是文件缓存，例如进程加载的 so，jar，ttf，dex 等资源。它们的原始数据都在磁盘中，在内存紧缺的时候可以很方便将占用的内存交换出来使用。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>SReclaimable:</strong> 是 Slab 中的可回收的部分。Slab 是 linux 中的一种内存分配机制。一般都是 kernel 模块使用的。在 Android 7 的时候 dumpsys meminfo 还是将所有的 Slab 计算到 Free RAM 中的，在 10 中改成可以回收的部分了。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Mapped:</strong> 是 Cached 中已经被 mapped 的部分。Cached 中有一部分是被 unmapped 的，但是没有马上释放。可以理解 Mapped 就是进程中的一些文件资源已经被 load 进内存里面的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(3).free:</strong> 是 /proc/meminfo 下的 MemFree。</p>
<p>从上面的统计内容来看，和一般 linux 理解的 free RAM 并不一样，一般的 linux 认为 Free RAM = free + Cached。也就是说 Cached 在内存充足的情况，缓存了进程运行所需要的资源，能加快进程的运行（对于app启动速度尤为明显）；当内存不足的情况，可以快速的交换出来。linux 认为这可以算作可用内存，所以 linux 的 Cached 一般都比较大，真正的 free 内存都很少。而 dumpsys meminfo 则认为 lmk 可以随时回收的 Pss 是可用内存，而 load 进内存的文件 Cached 则不算。以我目前的认知，我认为 free + Cached 代表 Free RAM 能有更好的体验。并且 google 的 cts 测试统计可用内存也是按 free + Cached 统计的，但是某些下游客户比较执着于 dumpsys meminfo 的 Free RAM 统计算法。</p>
<h3 id="Used_RAM:">Used RAM:</h3>
<p>这个数值是当前系统已经内存的大小。它也是后面括号内那2项之和：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).used pss:</strong> 是 Total PSS by OOM adjustment 除了 Cached 分类之外的进程的 Pss 之和。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).kernel</strong>: 分2部分：第一部分是 /proc/meminfo 中： Shmem + SUnreclaim+ PageTables + KernelStack：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Shmem:</strong> Shared memory 即 kernel 中的共享内存，tmpfs 也会被统计为 Shmem。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>SUnreclaim:</strong> Slab 中的不可回收部分。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>PageTables:</strong> kernel 中用来转化虚拟地址和物理地址的。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>KernelStack:</strong> 每个用户线程都会在 kernel 有个内核栈（kernel stack）。kernel stack 虽然属于用户态线程，但是用户态无法访问，只有 syscall、异常等进入到内核态才会调用到。所以这部分内存是内核代码使用的。</p>
<p>第二部分是 VM_ALLOC_USED，它是 kernel 中的模块通过 vmalloc 函数申请的内存，通过统计 /proc/vmallocinfo 中 “pages=” 数值之和得到（注意这里统计的单位是页面，一般Android上跑的 linux 一个页面都是 4Kb）。</p>
<p>这部分，kernel 统计还算合理，used pss 把 OOM 900 以上的进程的 Pss 全部剔除（前面算作 Free RAM 了），理由还是和前面一样，我认为是不合理的。</p>
<h3 id="ZRAM:">ZRAM:</h3>
<p>zram 是 linux 的一项内存压缩技术，Android 里面用来当 Swap 用。当配置开启了 Zram，AMS 会把一些优先级低线程标记为可以放入 Swap 分区（例如说一些 Cached 进程）。这个 Swap 是基于内存的（Zram 支持写回磁盘，但是Android没支持），线程数据放入 Swap 的时候，会进行压缩（可以配置压缩算法），然后把之前占用的内存就可以给其他线程使用了。当再次使用这个线程数据的时候，再从 Swap 解压换回正常内存。这样能在小内存设备上挤出更多的内存空间给前台进程使用。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).22,368K physical used for</strong>: 是读取 /sys/block/zram0/mm_stat 统计的。mm_stat 一共有8个数值，含义可以参看参考资料里面的 kernel 官方文档。这里读取的是第三个数值，也就是 mem_used_total。这里代表是实际物理内存使用的大小（经过压缩算法）。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).68,664K in swap</strong>:  是 /proc/meminfo 里面 SwapTotal - SwapFree。代表 swap 里存放实际内存的大小（解压之后的） 。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(3).364,516K total swap</strong>: 是 /proc/meminfo 里面的 SwapTotal。可以由方案配置。A50 配置的 zram size 是整个内存的 75% （在方案下的 fstab.sun8iw15p1 里有配置），我截图的是 512M 的（整个内存是除去预留内存的实际可用内存），486,028k * 0.75 = 364, 521k，差不多。</p>
<p>上面整体来看，就是使用了 22M（22,368K）内存，压缩存放了 67M（68,664K）的数据，压缩比例大概是 67% 。</p>
<h3 id="Lost_RAM:">Lost RAM:</h3>
<p>这一项其实没什么实际意义，它是: Total RAM - (totalPss - totalSwapPss) - free - cached kernel - kernel - zram total：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).TotalPss - totalSwapPss</strong>： totalPss 就是上面所有进程 Pss 之和。但是为什么要减去 totalSwapPss。每个进程的 SwapPss 在 /proc/pid/smaps 里面可以统计到（smaps 里面每一段 vma 里面都有 SwapPss）。拿来举例的设备是开启了 ZRAM 的，dumpsys meminfo 统计进程的 Pss 是计算了 swapPss 在里面的。所以其实按真正内存使用来看，是要减去 SwapPss。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).free</strong>: Free RAM 里面的 free<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(3).cached kernel</strong>: Free RAM 里面的 cached kernel<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(4).kerenl</strong>: Used RAM 里面的 kernel<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(5).zram total</strong>: ZRAM 里面的  physical used for</p>
<p>其实上面的公式可以简单化为： Lost RAM = Total RAM - Free RAM - Used RAM - zram physical used + totalSwapPss 。totalSwapPss 从统计原理来看，应该等于 ZRAM 项里面的 “in swap” ，但是计算了一下发现有点偏差。用 totalPss 去减 procrank 统计的 totalPss（procrank 进程的 pss 是直接通过 /proc/pid/map 来统计的，没有加 swapPss，所以比 dumpsys meminfo 的小一些）来计算 totalSwapPss 也还是有点偏差，有可能是前面2次命令的时间间隔带来的进程数据统计偏差，也有可能是本来这么算就有点偏差。不过用 dumpsys meminfo 的 totalPss - procrank 的 totalPss 的偏差会比较小。所以我偏向于用这种方式计算 totalSwapPss （当然也可以在自己在 AMS 的源码里面打 totalSwapTotal 打印出来，这样就没偏差了）。</p>
<h3 id="Tuning:">Tuning:</h3>
<p>这里的值都是一些属性配置的值：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).128</strong>: dalvik.vm.heapgrowthlimit属性取值，单位为MB<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).large</strong>: dalvik.vm.heapsize属性取值，单位为MB<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(3).oom</strong>:  ProcessList中 mOomMinFree 数组最后一个元素取值<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(4).restore limit</strong>: ProcessList中 mCachedRestoreLevel 变量取值，原生设计是 oom 的 1/3<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(5).low-ram</strong>: ro.config.low_ram=true 时判断显示 low-ram，ro.config.low_ram=false 且 config_avoidGfxAccel 为 false 时显示 high-end-gfx </p>
<h3 id="dumpsys_meminfo_pid:">dumpsys meminfo pid:</h3>
<p>不加 pid 参数是统计整个系统所有进程的内存信息，如果后面接 pid 可以详细显示单个进程的内存信息。例如说下面这个是 dump systemui 的 pid（3382）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">Applications Memory Usage (in Kilobytes):</div><div class="line">Uptime: <span class="number">73902242</span> Realtime: <span class="number">103390441</span></div><div class="line"></div><div class="line">** MEMINFO in pid <span class="number">3382</span> [com.android.systemui] **</div><div class="line">hmm:    <span class="number">10128</span>     <span class="number">8676</span>     <span class="number">1451</span>,    <span class="number">10716</span>     <span class="number">5358</span>     <span class="number">5358</span></div><div class="line">                   Pss  Private  Private  SwapPss     Heap     Heap     Heap</div><div class="line">                 Total    Dirty    Clean    Dirty     Size    Alloc     Free</div><div class="line">                ------   ------   ------   ------   ------   ------   ------</div><div class="line">  Native Heap     <span class="number">6570</span>     <span class="number">6544</span>        <span class="number">0</span>     <span class="number">1859</span>    <span class="number">10128</span>     <span class="number">8676</span>     <span class="number">1451</span></div><div class="line">  Dalvik Heap     <span class="number">5720</span>     <span class="number">5720</span>        <span class="number">0</span>       <span class="number">87</span>    <span class="number">10716</span>     <span class="number">5358</span>     <span class="number">5358</span></div><div class="line"> Dalvik Other     <span class="number">1480</span>     <span class="number">1480</span>        <span class="number">0</span>       <span class="number">40</span>                           </div><div class="line">        Stack       <span class="number">56</span>       <span class="number">56</span>        <span class="number">0</span>        <span class="number">0</span>                           </div><div class="line">       Ashmem        <span class="number">8</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>                           </div><div class="line">    Other dev       <span class="number">37</span>        <span class="number">0</span>       <span class="number">36</span>        <span class="number">0</span>                           </div><div class="line">     .so mmap     <span class="number">4097</span>      <span class="number">128</span>      <span class="number">492</span>      <span class="number">173</span>                           </div><div class="line">    .jar mmap     <span class="number">2850</span>        <span class="number">0</span>      <span class="number">524</span>        <span class="number">0</span>                           </div><div class="line">    .apk mmap     <span class="number">4231</span>        <span class="number">0</span>     <span class="number">3828</span>        <span class="number">0</span>                           </div><div class="line">    .ttf mmap      <span class="number">340</span>        <span class="number">0</span>      <span class="number">252</span>        <span class="number">0</span>                           </div><div class="line">    .dex mmap     <span class="number">8027</span>       <span class="number">16</span>     <span class="number">7996</span>        <span class="number">4</span>                           </div><div class="line">    .oat mmap     <span class="number">2110</span>        <span class="number">0</span>       <span class="number">64</span>        <span class="number">0</span>                           </div><div class="line">    .art mmap     <span class="number">2077</span>     <span class="number">1508</span>        <span class="number">0</span>       <span class="number">51</span>                           </div><div class="line">   Other mmap      <span class="number">165</span>       <span class="number">28</span>       <span class="number">64</span>        <span class="number">0</span>                           </div><div class="line">      Unknown     <span class="number">1015</span>     <span class="number">1008</span>        <span class="number">0</span>      <span class="number">176</span>                           </div><div class="line">        TOTAL    <span class="number">41173</span>    <span class="number">16488</span>    <span class="number">13256</span>     <span class="number">2390</span>    <span class="number">20844</span>    <span class="number">14034</span>     <span class="number">6809</span></div><div class="line"> </div><div class="line"> App Summary</div><div class="line">                       Pss(KB)</div><div class="line">                        ------</div><div class="line">           Java Heap:     <span class="number">7228</span></div><div class="line">         Native Heap:     <span class="number">6544</span></div><div class="line">                Code:    <span class="number">13300</span></div><div class="line">               Stack:       <span class="number">56</span></div><div class="line">            Graphics:        <span class="number">0</span></div><div class="line">       Private Other:     <span class="number">2616</span></div><div class="line">              System:    <span class="number">11429</span></div><div class="line"> </div><div class="line">               TOTAL:    <span class="number">41173</span>       TOTAL SWAP PSS:     <span class="number">2390</span></div><div class="line"> </div><div class="line"> Objects</div><div class="line">               Views:      <span class="number">606</span>         ViewRootImpl:        <span class="number">4</span></div><div class="line">         AppContexts:       <span class="number">16</span>           Activities:        <span class="number">0</span></div><div class="line">              Assets:       <span class="number">12</span>        AssetManagers:        <span class="number">0</span></div><div class="line">       Local Binders:      <span class="number">180</span>        Proxy Binders:       <span class="number">62</span></div><div class="line">       Parcel memory:       <span class="number">13</span>         Parcel count:       <span class="number">55</span></div><div class="line">    Death Recipients:        <span class="number">4</span>      OpenSSL Sockets:        <span class="number">0</span></div><div class="line">            WebViews:        <span class="number">0</span></div><div class="line"> </div><div class="line"> SQL</div><div class="line">         MEMORY_USED:        <span class="number">0</span></div><div class="line">  PAGECACHE_OVERFLOW:        <span class="number">0</span>          MALLOC_SIZE:        <span class="number">0</span></div><div class="line"></div></pre></td></tr></table></figure>

<p>你会发现就算只间隔了2个命令的时间，详细统计出来的 Pss 都会和整体统计的有些小差别。因为程序每时每刻都在运行变化，所有总会优点小差别。</p>
<p>单独 dump pid 和统计方法和整体 dump 是一样的，就是说整理 dump 里面所有进程的 Pss 的统计之和就是单独 dump 的方法统计出来的，只是整体的只是取了 Pss 而已。是通过统计 /proc/pid/smaps 里面的项目得到上面这些信息（统计核心代码在 android_os_Debug.cpp 里面的 android_os_Debug_getDirtyPagesPid() 和 load_maps()）。详细说明见 /proc/pid/smaps（/proc/pid/maps）章节说明。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).</strong> 我们先来说横着的列：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Pss Total</strong>:  /proc/pid/smaps vma 里面 Pss 之和<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Private Dirty</strong>: /proc/pid/smaps vma 里面 Private_Dirty 之和<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Private Clean</strong>: /proc/pid/smaps vma 里面 Private_Clean 之和<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>SwapPss Dirty</strong>: /proc/pid/smaps vma 里面 SwapPss  之和（这是开了 Zram 的，如果没开就是 Swap 之和，同时显示会变为 Swap Dirty）<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Heap Size</strong>:  Native Heap 是 mallinfo() 里面 usmblks 的值。mallinof() 这个是一个 glic 函数，用来获取当前  native heap 的信息，返回的是一个结构体，里面的字段可以 man mallinfo 查看。usmblks 是 heap 能申请的最大值。Dalvik Heap 是 java 类 Runtime 里面的 totalMemory() 函数获取的，是当前虚拟机的 heap 大小，这值会动态调整，初始大小和调整策略由 dalvik.vm.heapgrowthlimit 和 dalvik.vm.heapsize 属性控制（这里不展开说）。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Heap Alloc</strong>: Native Heap 是 mallinfo() 里面 uordblks 的值，表示当前 native heap 已经申请的内存大小。Dalvik Heap 是 Runtime 里面 totalMemory() - freeMemory() 的值。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Heap Free</strong>:  Native Heap 是 mallinfo() 里面 fordblks 的值，表示当前 native heap 空闲内存的大小。Dalvik Heap 是 Runtime 里面 freeMemory() 的值，表示虚拟机 heap 空闲内存大小。虚拟机 heap 的空闲内存小到一定程度会有一定程度的策略扩大 heap 的 total size，策略的阀值由上面说的属性控制。</p>
<p>​&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).</strong> 接下来再说竖着的行：只有 Pss Total、Private Dirty、Private Clean、SwapPss Dirty 区分竖直的分类（Heap Size、Heap Alloc、Heap Free 只区分 Native Heap 和 Dalvik Heap 前面已经说过了）<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Natvie Heap</strong>:  /proc/pid/smaps 中： 所有 [heap]、[anon:libc_malloc] 的 vma 中各自字段之和。例如说 Natvie Heap 的 Pss Total 就是所有的 [heap]、[anon:libc_malloc] 的 vma 中 Pss 之和。从 vma 的名字来看，应该是 natvie malloc 申请的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Dalvik Heap</strong>: /proc/pid/smaps 中所有以 [anon:dalvik-alloc space、[anon:dalvik-main space、[anon:dalvik-large object space、[anon:dalvik-free list large object space、[anon:dalvik-non moving space、[anon:dalvik-zygote space 开头的 vma 中各字段之和。从 vma 的名字来看，应该是 java 虚拟机申请的内存。<br>​&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Dalvik Other:</strong> /proc/pid/smaps 中 vma 中一些以 anon:dalvik 开头的字段之和（大部分是除了上面 Dalvik Heap 之外的），有点多我就不一一列的，详细的可以自己去 android/framework/base/core/jni/android_os_Debug.cpp 里面的 load_maps() 函数里面看。这里看 vma 名字像是虚拟机的一些引用计数、字节码缓存之类的。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Stack:</strong> /proc/pid/smaps 中所有以 [stack 开头的 vma 各字段之和。应该是栈申请的内存，一般也不是很大，几十k这样。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Ashmem:</strong> /proc/pid/smaps 中所有以 /dev/ashmem 开头的 vma 各字段之和。应该是前面说的进程间的共享内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Other dev:</strong> /proc/pid/smaps 中所有以 /dev 开头的 vma 各字段之和。应该是一些设备驱动映射的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>.so mmap:</strong> /proc/pid/smaps 中所有以 .so 结尾的 vma 各字段之和。是 load so 映射的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>.jar mmap:</strong> /proc/pid/smaps 中所有以 .jar 结尾的 vma 各字段之和。是 load jar 映射的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>.apk mmap:</strong> /proc/pid/smaps 中所有以 .apk 结尾的 vma 各字段之和。是 load apk 映射的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>.ttf mmap:</strong> /proc/pid/smaps 中所有以 .ttf 结尾的 vma 各字段之和。是 load ttf 映射的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>.dex mmap:</strong> /proc/pid/smaps 中所有以 .odex、.dex、.vdex、结尾的 vma 各字段之和。应该是加载虚拟机字节码、预编译的字节码映射的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>.oat mmap:</strong> /proc/pid/smaps 中所有以 .oat 结尾的 vma 各字段之和。应该是加载虚拟机预编译字节码映射的内存。好像是 system 的 jar dex2oat 出来的是 oat，其他的是 odex。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>.art mmap:</strong> /proc/pid/smaps 中所有以 .art、art] 结尾的 vma 各字段之和。这个好像是 odex 的一些索引，又叫启动镜像。也是虚拟机预编译出来的内容加载到内存里面所占用的。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Other mmap:</strong> 除了上面分类， vma 中有名字的各字段之和。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Unknown:</strong> 除了上面分类， vma 中没有名字的各字段之和。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Total:</strong>  分别等于各自列上的项目之和，Pss Total 还需要额外加上 SwapPss Dirty 这一列的求和。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(3).App Summary：</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Java Heap:</strong> Dalvik Heap 的 Private Dirty + .art mmap 的 (Private Dirty + Private Clean)。Android 认为这些代表进程的虚拟机占用的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Native Heap:</strong> Native Heap 中的 Private Dirty。Android 认为这个数值代表进程的 native 占用的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Code:</strong>  .so mmap、.jar mmap、.apk mmap、ttf mmap、.dex mmap、oat mmap 的 (Private Dirty + Private Clean )”。Android 认为这些是一些资源类（例如字节码文件、图片、字体等）占用的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Stack:</strong>  Stack 中 Private Dirty 的值。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Graphcis:</strong> 这个是 GPU 里面 texture、buffer 占用的内存，需要 gpu 驱动支持才行。0 的话代表 gpu 驱动还没支持。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Private Other:</strong> TOTAL(Private Dirty + Private Clean) - Java Heap - Native Heap - Code - Stack - Graphcis<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>System:</strong> TOTAL(Pss) - TOTAL(Private Dirty + Private Clean)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>TOTAL:</strong> TOTAL(Pss)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>TOTAL SWAP PSS:</strong> TOTAL(SwapPss Dirty)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(4).OBjects:</strong> 这些统计的是进程里面一些 Android Java 对象的引用信息，对于排查 Java 内存泄漏比较有用。这里不细说，其实看名字大概也能猜到是哪些对象。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(5).SQL:</strong> 应该是 sql 申请的内存，占时没研究过，不过一般这部分占用内存都不高。</p>
<h2 id="procrank">procrank</h2>
<p>procrank 是一个 native 的 bin 小工具，在 shell 中敲命令执行（在 userdebug 中 root 才能显示全，user 下会因为没权限，只能显示 total 数值。因为 shell 组没权限去读 /proc/pid/maps ）。它的显示内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line">    PID       Vss      Rss      Pss      Uss     Swap    PSwap    USwap    ZSwap  cmdline</div><div class="line"> <span class="number">2309</span>  <span class="number">2052916</span>K   <span class="number">85976</span>K   <span class="number">46063</span>K   <span class="number">38164</span>K    <span class="number">8376</span>K    <span class="number">5642</span>K    <span class="number">5456</span>K    <span class="number">1838</span>K  system_server</div><div class="line"> <span class="number">3382</span>  <span class="number">1170900</span>K   <span class="number">80940</span>K   <span class="number">38878</span>K   <span class="number">29684</span>K    <span class="number">7176</span>K    <span class="number">2519</span>K    <span class="number">2196</span>K     <span class="number">820</span>K  com.android.systemui</div><div class="line"> <span class="number">3993</span>  <span class="number">1114268</span>K   <span class="number">63652</span>K   <span class="number">23538</span>K   <span class="number">15212</span>K    <span class="number">5920</span>K     <span class="number">819</span>K     <span class="number">464</span>K     <span class="number">266</span>K  com.android.launcher3</div><div class="line"> <span class="number">3734</span>  <span class="number">1058588</span>K   <span class="number">33280</span>K    <span class="number">8938</span>K    <span class="number">6820</span>K    <span class="number">6268</span>K     <span class="number">857</span>K     <span class="number">476</span>K     <span class="number">279</span>K  com.android.phone</div><div class="line"> <span class="number">4161</span>  <span class="number">1040096</span>K   <span class="number">33340</span>K    <span class="number">7546</span>K    <span class="number">5324</span>K    <span class="number">6372</span>K     <span class="number">899</span>K     <span class="number">512</span>K     <span class="number">292</span>K  com.android.inputmethod.latin</div><div class="line"> <span class="number">1995</span>    <span class="number">48688</span>K    <span class="number">9988</span>K    <span class="number">6725</span>K    <span class="number">6612</span>K      <span class="number">44</span>K      <span class="number">44</span>K      <span class="number">44</span>K      <span class="number">14</span>K  media.swcodec</div><div class="line"> <span class="number">1985</span>    <span class="number">75200</span>K   <span class="number">13192</span>K    <span class="number">6644</span>K    <span class="number">5232</span>K    <span class="number">1480</span>K    <span class="number">1480</span>K    <span class="number">1480</span>K     <span class="number">482</span>K  /system/bin/mediaserver</div><div class="line"> <span class="number">4888</span>  <span class="number">1031384</span>K   <span class="number">32052</span>K    <span class="number">5705</span>K    <span class="number">3432</span>K    <span class="number">8216</span>K    <span class="number">2742</span>K    <span class="number">2356</span>K     <span class="number">893</span>K  android.process.media</div><div class="line"> <span class="number">5523</span>  <span class="number">1032036</span>K   <span class="number">31788</span>K    <span class="number">5267</span>K    <span class="number">2784</span>K    <span class="number">8580</span>K    <span class="number">3008</span>K    <span class="number">2608</span>K     <span class="number">980</span>K  com.google.android.permissioncontroller</div><div class="line"><span class="number">12956</span>  <span class="number">1028588</span>K   <span class="number">37652</span>K    <span class="number">5103</span>K    <span class="number">1012</span>K    <span class="number">9480</span>K    <span class="number">3904</span>K    <span class="number">3500</span>K    <span class="number">1272</span>K  com.android.calendar</div><div class="line"><span class="number">12994</span>  <span class="number">1032108</span>K   <span class="number">37636</span>K    <span class="number">4783</span>K     <span class="number">728</span>K    <span class="number">9720</span>K    <span class="number">4199</span>K    <span class="number">3804</span>K    <span class="number">1367</span>K  com.android.deskclock</div><div class="line"> <span class="number">1948</span>    <span class="number">52824</span>K    <span class="number">8820</span>K    <span class="number">4349</span>K    <span class="number">4084</span>K     <span class="number">596</span>K     <span class="number">596</span>K     <span class="number">596</span>K     <span class="number">194</span>K  /system/bin/audioserver</div><div class="line"> <span class="number">1983</span>    <span class="number">33136</span>K   <span class="number">10440</span>K    <span class="number">4245</span>K    <span class="number">3124</span>K     <span class="number">252</span>K     <span class="number">252</span>K     <span class="number">252</span>K      <span class="number">82</span>K  media.extractor</div><div class="line"> <span class="number">1928</span>  <span class="number">1705140</span>K   <span class="number">27260</span>K    <span class="number">3612</span>K    <span class="number">1712</span>K    <span class="number">7984</span>K    <span class="number">1706</span>K     <span class="number">676</span>K     <span class="number">556</span>K  zygote</div><div class="line"> <span class="number">1951</span>    <span class="number">64340</span>K    <span class="number">9012</span>K    <span class="number">3532</span>K    <span class="number">3032</span>K    <span class="number">1516</span>K    <span class="number">1516</span>K    <span class="number">1516</span>K     <span class="number">493</span>K  /system/bin/surfaceflinger</div><div class="line"> <span class="number">4696</span>  <span class="number">1026632</span>K   <span class="number">22872</span>K    <span class="number">2998</span>K    <span class="number">1672</span>K    <span class="number">8564</span>K    <span class="number">2308</span>K    <span class="number">1280</span>K     <span class="number">752</span>K  com.android.se</div><div class="line"> <span class="number">5453</span>  <span class="number">1027204</span>K   <span class="number">28024</span>K    <span class="number">2759</span>K     <span class="number">636</span>K    <span class="number">9624</span>K    <span class="number">4097</span>K    <span class="number">3704</span>K    <span class="number">1334</span>K  com.android.providers.calendar</div><div class="line"> <span class="number">1989</span>    <span class="number">35368</span>K    <span class="number">6640</span>K    <span class="number">2482</span>K    <span class="number">2308</span>K       <span class="number">8</span>K       <span class="number">8</span>K       <span class="number">8</span>K       <span class="number">2</span>K  media.codec</div><div class="line"> <span class="number">1933</span>    <span class="number">27316</span>K    <span class="number">5420</span>K    <span class="number">2232</span>K    <span class="number">2124</span>K      <span class="number">24</span>K      <span class="number">24</span>K      <span class="number">24</span>K       <span class="number">7</span>K  /vendor/bin/hw/android.hardware.audio@<span class="number">2.0</span>-service</div><div class="line"> <span class="number">5480</span>  <span class="number">1070120</span>K   <span class="number">23592</span>K    <span class="number">2013</span>K     <span class="number">632</span>K    <span class="number">9308</span>K    <span class="number">3721</span>K    <span class="number">3316</span>K    <span class="number">1212</span>K  com.android.settings</div><div class="line"> <span class="number">5328</span>  <span class="number">1035528</span>K   <span class="number">24700</span>K    <span class="number">1890</span>K     <span class="number">388</span>K    <span class="number">9980</span>K    <span class="number">4467</span>K    <span class="number">4076</span>K    <span class="number">1455</span>K  com.android.email</div><div class="line"> <span class="number">1976</span>    <span class="number">34248</span>K    <span class="number">5968</span>K    <span class="number">1881</span>K    <span class="number">1724</span>K     <span class="number">812</span>K     <span class="number">812</span>K     <span class="number">812</span>K     <span class="number">264</span>K  /system/bin/cameraserver</div><div class="line"> <span class="number">1773</span>    <span class="number">16328</span>K    <span class="number">3964</span>K    <span class="number">1859</span>K    <span class="number">1824</span>K     <span class="number">316</span>K     <span class="number">316</span>K     <span class="number">316</span>K     <span class="number">102</span>K  /system/bin/logd</div><div class="line"> <span class="number">5501</span>  <span class="number">1030772</span>K   <span class="number">22184</span>K    <span class="number">1844</span>K     <span class="number">548</span>K    <span class="number">9220</span>K    <span class="number">3597</span>K    <span class="number">3184</span>K    <span class="number">1171</span>K  com.android.traceur</div><div class="line"> <span class="number">6191</span>  <span class="number">1025652</span>K   <span class="number">23060</span>K    <span class="number">1827</span>K     <span class="number">472</span>K    <span class="number">9112</span>K    <span class="number">3465</span>K    <span class="number">3044</span>K    <span class="number">1129</span>K  com.android.keychain</div><div class="line"> <span class="number">1939</span>    <span class="number">50688</span>K    <span class="number">5924</span>K    <span class="number">1720</span>K    <span class="number">1508</span>K     <span class="number">388</span>K     <span class="number">388</span>K     <span class="number">388</span>K     <span class="number">126</span>K  /vendor/bin/hw/android.hardware.graphics.composer@<span class="number">2.2</span>-service</div><div class="line">    <span class="number">1</span>    <span class="number">27940</span>K    <span class="number">3340</span>K    <span class="number">1595</span>K    <span class="number">1236</span>K     <span class="number">744</span>K     <span class="number">744</span>K     <span class="number">744</span>K     <span class="number">242</span>K  /system/bin/init</div><div class="line"> <span class="number">1993</span>    <span class="number">19328</span>K    <span class="number">4680</span>K    <span class="number">1593</span>K    <span class="number">1444</span>K      <span class="number">24</span>K      <span class="number">24</span>K      <span class="number">24</span>K       <span class="number">7</span>K  /vendor/bin/hw/rild</div><div class="line"> <span class="number">1778</span>    <span class="number">19408</span>K    <span class="number">4404</span>K    <span class="number">1511</span>K    <span class="number">1436</span>K     <span class="number">172</span>K     <span class="number">172</span>K     <span class="number">172</span>K      <span class="number">56</span>K  /system/bin/vold</div><div class="line"> <span class="number">8775</span>    <span class="number">27672</span>K    <span class="number">3728</span>K    <span class="number">1441</span>K    <span class="number">1356</span>K     <span class="number">124</span>K     <span class="number">124</span>K     <span class="number">124</span>K      <span class="number">40</span>K  /system/bin/adbd</div><div class="line"> <span class="number">1929</span>    <span class="number">30720</span>K    <span class="number">4032</span>K    <span class="number">1222</span>K    <span class="number">1156</span>K     <span class="number">436</span>K     <span class="number">436</span>K     <span class="number">436</span>K     <span class="number">142</span>K  /system/bin/netd</div><div class="line"> <span class="number">1910</span>    <span class="number">15576</span>K    <span class="number">2476</span>K    <span class="number">1108</span>K     <span class="number">940</span>K      <span class="number">16</span>K      <span class="number">16</span>K      <span class="number">16</span>K       <span class="number">5</span>K  /system/bin/apexd</div><div class="line"> <span class="number">1987</span>    <span class="number">17048</span>K    <span class="number">4000</span>K    <span class="number">1065</span>K     <span class="number">980</span>K     <span class="number">160</span>K     <span class="number">160</span>K     <span class="number">160</span>K      <span class="number">52</span>K  /system/bin/storaged</div><div class="line"> <span class="number">1986</span>    <span class="number">18768</span>K    <span class="number">4032</span>K    <span class="number">1025</span>K     <span class="number">916</span>K     <span class="number">160</span>K     <span class="number">160</span>K     <span class="number">160</span>K      <span class="number">52</span>K  /system/bin/statsd</div><div class="line"> <span class="number">1981</span>    <span class="number">15684</span>K    <span class="number">3932</span>K    <span class="number">1024</span>K     <span class="number">948</span>K     <span class="number">116</span>K     <span class="number">116</span>K     <span class="number">116</span>K      <span class="number">37</span>K  /system/bin/keystore</div><div class="line"> <span class="number">1980</span>    <span class="number">18456</span>K    <span class="number">3588</span>K    <span class="number">1009</span>K     <span class="number">944</span>K     <span class="number">240</span>K     <span class="number">240</span>K     <span class="number">240</span>K      <span class="number">78</span>K  /system/bin/installd</div><div class="line"> <span class="number">1859</span>    <span class="number">12740</span>K    <span class="number">3960</span>K     <span class="number">999</span>K     <span class="number">932</span>K      <span class="number">24</span>K      <span class="number">24</span>K      <span class="number">24</span>K       <span class="number">7</span>K  /vendor/bin/hw/android.hardware.keymaster@<span class="number">4.0</span>-service-aw</div><div class="line"> <span class="number">1400</span>    <span class="number">11880</span>K    <span class="number">2568</span>K     <span class="number">980</span>K     <span class="number">680</span>K     <span class="number">588</span>K     <span class="number">588</span>K     <span class="number">588</span>K     <span class="number">191</span>K  /system/bin/ueventd</div><div class="line"> <span class="number">3344</span>    <span class="number">13124</span>K    <span class="number">3920</span>K     <span class="number">967</span>K     <span class="number">888</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K  /vendor/bin/hw/android.hardware.wifi@<span class="number">1.0</span>-service-lazy</div><div class="line"><span class="number">30353</span>    <span class="number">18348</span>K    <span class="number">2972</span>K     <span class="number">950</span>K     <span class="number">912</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K  procrank</div><div class="line"> <span class="number">1984</span>    <span class="number">22596</span>K    <span class="number">5052</span>K     <span class="number">946</span>K     <span class="number">776</span>K     <span class="number">948</span>K     <span class="number">948</span>K     <span class="number">948</span>K     <span class="number">308</span>K  media.metrics</div><div class="line"> <span class="number">1996</span>    <span class="number">14000</span>K    <span class="number">3680</span>K     <span class="number">897</span>K     <span class="number">824</span>K      <span class="number">20</span>K      <span class="number">20</span>K      <span class="number">20</span>K       <span class="number">6</span>K  /system/bin/gatekeeperd</div><div class="line"> <span class="number">1979</span>    <span class="number">13100</span>K    <span class="number">3632</span>K     <span class="number">861</span>K     <span class="number">800</span>K      <span class="number">28</span>K      <span class="number">28</span>K      <span class="number">28</span>K       <span class="number">9</span>K  /system/bin/incidentd</div><div class="line"> <span class="number">1936</span>    <span class="number">12296</span>K    <span class="number">3836</span>K     <span class="number">839</span>K     <span class="number">752</span>K       <span class="number">8</span>K       <span class="number">8</span>K       <span class="number">8</span>K       <span class="number">2</span>K  /vendor/bin/hw/android.hardware.configstore@<span class="number">1.1</span>-service</div><div class="line"> <span class="number">1945</span>    <span class="number">12740</span>K    <span class="number">3820</span>K     <span class="number">838</span>K     <span class="number">740</span>K      <span class="number">40</span>K      <span class="number">40</span>K      <span class="number">40</span>K      <span class="number">13</span>K  /vendor/bin/hw/android.hardware.sensors@<span class="number">2.0</span>-service</div><div class="line"> <span class="number">1938</span>    <span class="number">16316</span>K    <span class="number">4896</span>K     <span class="number">834</span>K     <span class="number">696</span>K     <span class="number">452</span>K     <span class="number">452</span>K     <span class="number">452</span>K     <span class="number">147</span>K  /vendor/bin/hw/android.hardware.graphics.allocator@<span class="number">2.0</span>-service</div><div class="line"> <span class="number">1934</span>    <span class="number">13172</span>K    <span class="number">3824</span>K     <span class="number">833</span>K     <span class="number">760</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K  /vendor/bin/hw/android.hardware.bluetooth@<span class="number">1.0</span>-service</div><div class="line"> <span class="number">1937</span>    <span class="number">11064</span>K    <span class="number">3772</span>K     <span class="number">809</span>K     <span class="number">744</span>K      <span class="number">32</span>K      <span class="number">32</span>K      <span class="number">32</span>K      <span class="number">10</span>K  /vendor/bin/hw/android.hardware.gatekeeper@<span class="number">1.0</span>-service</div><div class="line"> <span class="number">1935</span>    <span class="number">12912</span>K    <span class="number">3940</span>K     <span class="number">807</span>K     <span class="number">712</span>K      <span class="number">40</span>K      <span class="number">40</span>K      <span class="number">40</span>K      <span class="number">13</span>K  /vendor/bin/hw/android.hardware.cas@<span class="number">1.1</span>-service</div><div class="line"> <span class="number">1944</span>    <span class="number">12500</span>K    <span class="number">3804</span>K     <span class="number">787</span>K     <span class="number">676</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K  /vendor/bin/hw/android.hardware.radio.config@<span class="number">1.1</span>-service</div><div class="line"> <span class="number">1943</span>    <span class="number">11164</span>K    <span class="number">3816</span>K     <span class="number">780</span>K     <span class="number">704</span>K      <span class="number">52</span>K      <span class="number">52</span>K      <span class="number">52</span>K      <span class="number">16</span>K  /vendor/bin/hw/android.hardware.power@<span class="number">1.0</span>-service</div><div class="line"> <span class="number">1946</span>    <span class="number">12088</span>K    <span class="number">3688</span>K     <span class="number">770</span>K     <span class="number">708</span>K      <span class="number">44</span>K      <span class="number">44</span>K      <span class="number">44</span>K      <span class="number">14</span>K  /vendor/bin/hw/android.hardware.usb@<span class="number">1.0</span>-service</div><div class="line"> <span class="number">1940</span>    <span class="number">11144</span>K    <span class="number">3732</span>K     <span class="number">769</span>K     <span class="number">708</span>K      <span class="number">76</span>K      <span class="number">76</span>K      <span class="number">76</span>K      <span class="number">24</span>K  /vendor/bin/hw/android.hardware.health@<span class="number">2.0</span>-service</div><div class="line"> <span class="number">1932</span>    <span class="number">16448</span>K    <span class="number">3428</span>K     <span class="number">761</span>K     <span class="number">636</span>K     <span class="number">172</span>K     <span class="number">172</span>K     <span class="number">172</span>K      <span class="number">56</span>K  /system/bin/hw/android.system.suspend@<span class="number">1.0</span>-service</div><div class="line"> <span class="number">2000</span>    <span class="number">35216</span>K    <span class="number">2920</span>K     <span class="number">743</span>K     <span class="number">712</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K  /system/bin/awlogd</div><div class="line"> <span class="number">1775</span>    <span class="number">12096</span>K    <span class="number">3388</span>K     <span class="number">735</span>K     <span class="number">636</span>K     <span class="number">256</span>K     <span class="number">256</span>K     <span class="number">256</span>K      <span class="number">83</span>K  /system/bin/hwservicemanager</div><div class="line"> <span class="number">4587</span>    <span class="number">13076</span>K    <span class="number">3580</span>K     <span class="number">734</span>K     <span class="number">668</span>K       <span class="number">8</span>K       <span class="number">8</span>K       <span class="number">8</span>K       <span class="number">2</span>K  /system/bin/displayservice</div><div class="line"> <span class="number">1988</span>    <span class="number">11928</span>K    <span class="number">3232</span>K     <span class="number">723</span>K     <span class="number">676</span>K      <span class="number">28</span>K      <span class="number">28</span>K      <span class="number">28</span>K       <span class="number">9</span>K  /system/bin/wificond</div><div class="line"> <span class="number">1977</span>    <span class="number">21816</span>K    <span class="number">4568</span>K     <span class="number">715</span>K     <span class="number">576</span>K    <span class="number">1072</span>K    <span class="number">1072</span>K    <span class="number">1072</span>K     <span class="number">349</span>K  /system/bin/drmserver</div><div class="line"> <span class="number">2044</span>     <span class="number">8216</span>K    <span class="number">2556</span>K     <span class="number">634</span>K     <span class="number">608</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K  /system/bin/ip6tables-restore</div><div class="line"> <span class="number">1950</span>     <span class="number">8764</span>K    <span class="number">2996</span>K     <span class="number">619</span>K     <span class="number">576</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K  /system/bin/lmkd</div><div class="line"> <span class="number">1941</span>    <span class="number">11032</span>K    <span class="number">3536</span>K     <span class="number">606</span>K     <span class="number">544</span>K     <span class="number">208</span>K     <span class="number">208</span>K     <span class="number">208</span>K      <span class="number">67</span>K  /vendor/bin/hw/android.hardware.light@<span class="number">2.0</span>-service</div><div class="line"> <span class="number">1978</span>    <span class="number">18612</span>K    <span class="number">4300</span>K     <span class="number">584</span>K     <span class="number">476</span>K     <span class="number">828</span>K     <span class="number">828</span>K     <span class="number">828</span>K     <span class="number">269</span>K  /system/bin/idmap2d</div><div class="line"> <span class="number">2043</span>     <span class="number">8204</span>K    <span class="number">2516</span>K     <span class="number">579</span>K     <span class="number">552</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K  /system/bin/iptables-restore</div><div class="line"><span class="number">13796</span>     <span class="number">7828</span>K    <span class="number">2620</span>K     <span class="number">577</span>K     <span class="number">452</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K       <span class="number">0</span>K  -/system/bin/sh</div><div class="line"> <span class="number">1949</span>    <span class="number">12684</span>K    <span class="number">3608</span>K     <span class="number">564</span>K     <span class="number">500</span>K     <span class="number">344</span>K     <span class="number">344</span>K     <span class="number">344</span>K     <span class="number">112</span>K  /system/bin/gpuservice</div><div class="line"> <span class="number">1397</span>    <span class="number">12392</span>K    <span class="number">1880</span>K     <span class="number">556</span>K     <span class="number">436</span>K     <span class="number">688</span>K     <span class="number">688</span>K     <span class="number">688</span>K     <span class="number">224</span>K  /system/bin/init</div><div class="line"> <span class="number">1947</span>     <span class="number">9904</span>K    <span class="number">2812</span>K     <span class="number">530</span>K     <span class="number">496</span>K      <span class="number">56</span>K      <span class="number">56</span>K      <span class="number">56</span>K      <span class="number">18</span>K  /system/bin/ashmemd</div><div class="line"> <span class="number">1942</span>    <span class="number">11024</span>K    <span class="number">3464</span>K     <span class="number">529</span>K     <span class="number">468</span>K     <span class="number">272</span>K     <span class="number">272</span>K     <span class="number">272</span>K      <span class="number">88</span>K  /vendor/bin/hw/android.hardware.memtrack@<span class="number">1.0</span>-service</div><div class="line"> <span class="number">1858</span>    <span class="number">11036</span>K    <span class="number">3432</span>K     <span class="number">528</span>K     <span class="number">468</span>K     <span class="number">272</span>K     <span class="number">272</span>K     <span class="number">272</span>K      <span class="number">88</span>K  /vendor/bin/hw/android.hardware.boot@<span class="number">1.0</span>-service</div><div class="line"> <span class="number">1990</span>    <span class="number">10744</span>K    <span class="number">3028</span>K     <span class="number">524</span>K     <span class="number">460</span>K     <span class="number">152</span>K     <span class="number">152</span>K     <span class="number">152</span>K      <span class="number">49</span>K  /vendor/bin/crda.uevent</div><div class="line"> <span class="number">1982</span>    <span class="number">13640</span>K    <span class="number">3656</span>K     <span class="number">512</span>K     <span class="number">436</span>K     <span class="number">432</span>K     <span class="number">432</span>K     <span class="number">432</span>K     <span class="number">140</span>K  /system/bin/mediadrmserver</div><div class="line"> <span class="number">1991</span>     <span class="number">8900</span>K    <span class="number">3044</span>K     <span class="number">510</span>K     <span class="number">448</span>K      <span class="number">20</span>K      <span class="number">20</span>K      <span class="number">20</span>K       <span class="number">6</span>K  /vendor/bin/dom2reg</div><div class="line"> <span class="number">1774</span>     <span class="number">9468</span>K    <span class="number">2600</span>K     <span class="number">482</span>K     <span class="number">448</span>K     <span class="number">168</span>K     <span class="number">168</span>K     <span class="number">168</span>K      <span class="number">54</span>K  /system/bin/servicemanager</div><div class="line"> <span class="number">1997</span>     <span class="number">8248</span>K    <span class="number">2464</span>K     <span class="number">479</span>K     <span class="number">452</span>K      <span class="number">16</span>K      <span class="number">16</span>K      <span class="number">16</span>K       <span class="number">5</span>K  /system/bin/tombstoned</div><div class="line"> <span class="number">2002</span>     <span class="number">8540</span>K    <span class="number">2724</span>K     <span class="number">478</span>K     <span class="number">444</span>K      <span class="number">16</span>K      <span class="number">16</span>K      <span class="number">16</span>K       <span class="number">5</span>K  /system/bin/kmsgd</div><div class="line"> <span class="number">1860</span>     <span class="number">9888</span>K    <span class="number">2964</span>K     <span class="number">419</span>K     <span class="number">372</span>K     <span class="number">132</span>K     <span class="number">132</span>K     <span class="number">132</span>K      <span class="number">43</span>K  /vendor/bin/hw/tee_supplicant</div><div class="line"> <span class="number">1801</span>     <span class="number">7828</span>K    <span class="number">2392</span>K     <span class="number">407</span>K     <span class="number">284</span>K     <span class="number">156</span>K     <span class="number">156</span>K     <span class="number">156</span>K      <span class="number">50</span>K  /system/bin/sh</div><div class="line"> <span class="number">1992</span>    <span class="number">10232</span>K    <span class="number">2956</span>K     <span class="number">325</span>K     <span class="number">276</span>K     <span class="number">224</span>K     <span class="number">224</span>K     <span class="number">224</span>K      <span class="number">72</span>K  /vendor/bin/hw/radio_monitor</div><div class="line"> <span class="number">1931</span>    <span class="number">10320</span>K    <span class="number">2876</span>K     <span class="number">309</span>K     <span class="number">264</span>K     <span class="number">292</span>K     <span class="number">292</span>K     <span class="number">292</span>K      <span class="number">95</span>K  /system/bin/hw/android.hidl.allocator@<span class="number">1.0</span>-service</div><div class="line"> <span class="number">1776</span>    <span class="number">10036</span>K    <span class="number">2688</span>K     <span class="number">281</span>K     <span class="number">240</span>K     <span class="number">288</span>K     <span class="number">288</span>K     <span class="number">288</span>K      <span class="number">93</span>K  /vendor/bin/vndservicemanager</div><div class="line"> <span class="number">1398</span>    <span class="number">11880</span>K    <span class="number">1396</span>K     <span class="number">125</span>K       <span class="number">8</span>K     <span class="number">892</span>K     <span class="number">892</span>K     <span class="number">892</span>K     <span class="number">290</span>K  /system/bin/init</div><div class="line">                           ------   ------   ------   ------   ------   ------  ------</div><div class="line">                          <span class="number">241304</span>K  <span class="number">178772</span>K  <span class="number">150872</span>K   <span class="number">64930</span>K   <span class="number">57624</span>K   <span class="number">21151</span>K  TOTAL</div><div class="line"></div><div class="line">ZRAM: <span class="number">22368</span>K physical used <span class="keyword">for</span> <span class="number">68664</span>K in swap (<span class="number">364516</span>K total swap)</div><div class="line"> RAM: <span class="number">486028</span>K total, <span class="number">27368</span>K free, <span class="number">788</span>K buffers, <span class="number">172428</span>K cached, <span class="number">1644</span>K shmem, <span class="number">40944</span>K slab, <span class="number">195</span>M free+cached</div><div class="line"></div></pre></td></tr></table></figure>

<h3 id="进程列表：">进程列表：</h3>
<p>procrank 每个进程的内存信息是通过读取 /proc/pid/maps 统计的，这点和 dumpsys meminfo 不太一样（具体代码见： libmeminfo/procmeminfo.cpp 的 ReadMaps() 和 ReadVmaStats()）。dumpsys meminfo 统计的进程的 Pss 是通过 /proc/pid/smaps 统计的，会比 procrank 的大一些，包含了 Zram 里面的 SwapPss。来看一下先说横着的列：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Vss(Virtual Set Size):</strong>  /proc/pid/maps 中每一段 vma 的 size 之和。size 可以通过 vma 的 (结束地址 - 开始地址) x page_size 计算出来（一般 page_size 是 4kb，代码里面可以通过 unistd.h 里面的 getpagesize() 获取）。这里的 vma 有一些是没有映射到内存里面的（或者在 Swap 里面的），像是 page_count = 0 的就是没映射的，也就是没有被任何进程引用（注意和下面 Rss 的区别）。page_count  可以通过 /proc/pid/maps 中 vma 的虚拟地址，在 /proc/pid/pagemap 里面获取到内存页面的 PFN（Page Frame Number），然后再在 /proc/kpagecount 里就能读到页面被引用的计数了（具体的可以看 procrank 的源码或是参考资料里面的 pagemap 的相关资料）。再加上进程里面有很多共享库和资源（特别是 Android apk 是从 Zygote fork 出来的），所以 Vss 一般都很大，所以没啥参考价值。具体的怎么索引的和页面表的标志位含义可以看附录参考资料里面的 <a href="https://www.cnblogs.com/pengdonglin137/p/6802108.html" target="_blank" rel="external">利用/proc/pid/pagemap将虚拟地址转换为物理地址</a> 和 <a href="https://www.cnblogs.com/pengdonglin137/p/6802108.html" target="_blank" rel="external">pagemap和VSS/USS/PSS/RSS的计算</a>。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Rss(Resident Set Size):</strong> /proc/pid/maps 中 page_count &gt; 0 的 vma size 之和。 和 Vss 相比， 多了page_count &gt; 0 这个过滤，表示这段 vma 至少被一个进程引用（被映射到内存当中）。所以 Rss 表示进程实际占用内存的情况（包含共享资源）。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Pss(Proportional Set Size):</strong>  /proc/pid/maps 中每一段 vma size / page_count 。和 Rss 相比，Pss 把多进程共享资源部分的内存按比例均分了。所以 Pss 表示进程实际占用内存的情况（共享资源按比例均分）。一般可以拿 Pss 来衡量进程内存占用情况。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Uss(Unique Set Size):</strong> /proc/pid/maps 中 page_count = 1 的 vma size 之和。和 Pss 相比，Uss 除去了共享资源的内存。所以 Uss 表示进程私有内存占用的情况。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Swap:</strong> 和 dumpsys meminfo 统计的类似，当开启了 Zram 就能统计到 Swap。这里的是通过 linux 的接口判断出 /proc/pid/maps 中哪些 vma 是在 Swap 分区里面的（同样是在上面的函数里面判断的）。这里统计到的值是包含了进程共享资源内存的 Swap 的，和 Vss 类似。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>PSwap:</strong> 和 dumpsys meminfo 里面的 SwapPss 一样，按 page_count 均分了。和 Pss 类似。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>USwap:</strong> Swap 里面 page_count = 1 的。和 Uss 类似。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>ZSwap:</strong> PSwap x zram 压缩率。 zram 压缩率 = zram_size / (SwapTotal- SwapFree)。zram_size 是前面介绍的 /sys/block/zram0/mm_stat 第三个数值，SwapTotal 和 SwapFree 是 /proc/meminfo 下面的数值。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>TOTAL:</strong> 上列表的简单求和。</p>
<h3 id="ZRAM：">ZRAM：</h3>
<p>这里的 Zram 信息和 dumpsys meminfo 是一样的。</p>
<h3 id="RAM：">RAM：</h3>
<p>这里信息都是直接从 /proc/info 下读取同名的数值（名字有点点差别）。另外 free+cached 的数值是我们平台自己加上去的。</p>
<h2 id="/proc/pid/maps">/proc/pid/maps</h2>
<p>每个进程都会有这个文件节点，表示进程的内存映射信息。例如说我们 cat 一下 systemui 的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="number">12</span>c00000-<span class="number">12</span>cc0000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>          [anon:dalvik-main space (region space)]</div><div class="line"><span class="number">12</span>cc0000-<span class="number">12e40000</span> ---p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>          [anon:dalvik-main space (region space)]</div><div class="line"><span class="number">12e40000</span>-<span class="number">12</span>f00000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>          [anon:dalvik-main space (region space)]</div><div class="line"><span class="number">12</span>f00000-<span class="number">12</span>f80000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>          [anon:dalvik-main space (region space)]</div><div class="line"><span class="number">12</span>f80000-<span class="number">13280000</span> rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>          [anon:dalvik-main space (region space)]</div><div class="line"><span class="number">13280000</span>-<span class="number">14140000</span> ---p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>          [anon:dalvik-main space (region space)]</div><div class="line"><span class="number">14140000</span>-<span class="number">22</span>c00000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>          [anon:dalvik-main space (region space)]</div><div class="line"><span class="number">6</span>fef2000-<span class="number">700</span>cb000 rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1476</span>       /system/framework/arm/boot.art</div><div class="line"><span class="number">700</span>cb000-<span class="number">70185000</span> rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1455</span>       /system/framework/arm/boot-core-libart.art</div><div class="line"><span class="number">70185000</span>-<span class="number">701</span>ad000 rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1467</span>       /system/framework/arm/boot-okhttp.art</div><div class="line"><span class="number">701</span>ad000-<span class="number">701e2000</span> rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1452</span>       /system/framework/arm/boot-bouncycastle.art</div><div class="line"><span class="number">701e2000</span>-<span class="number">701</span>ee000 rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1449</span>       /system/framework/arm/boot-apache-xml.art</div><div class="line"><span class="number">701</span>ee000-<span class="number">7087</span>f000 rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1461</span>       /system/framework/arm/boot-framework.art</div><div class="line"><span class="number">7087</span>f000-<span class="number">708</span>ab000 rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1458</span>       /system/framework/arm/boot-ext.art</div><div class="line"><span class="number">708</span>ab000-<span class="number">70966000</span> rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1470</span>       /system/framework/arm/boot-telephony-common.art</div><div class="line"><span class="number">70966000</span>-<span class="number">70970000</span> rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1473</span>       /system/framework/arm/boot-voip-common.art</div><div class="line"><span class="number">70970000</span>-<span class="number">70980000</span> rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1464</span>       /system/framework/arm/boot-ims-common.art</div><div class="line"><span class="number">70980000</span>-<span class="number">70983000</span> rw-p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1446</span>       /system/framework/arm/boot-android.test.base.art</div><div class="line"><span class="number">70983000</span>-<span class="number">70</span>a37000 r--p <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1477</span>       /system/framework/arm/boot.oat</div><div class="line"><span class="number">70</span>a37000-<span class="number">70</span>c5a000 r-xp <span class="number">000</span>b4000 fd:<span class="number">03</span> <span class="number">1477</span>       /system/framework/arm/boot.oat</div><div class="line"><span class="number">70</span>c5a000-<span class="number">70</span>c5b000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>          [anon:.bss]</div><div class="line"><span class="number">70</span>c5b000-<span class="number">70</span>c5d000 r--s <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1491</span>       /system/framework/boot.vdex</div><div class="line"></div></pre></td></tr></table></figure>

<p>上面只是截图了前面一部分，因为是整个进程的内存页面，所以整个文件会比较大（和进程复杂度有关，systemui 挺复杂的）。里面每一行代表一个 vma（virtual memory areas：虚拟内存区域）。下面我们来看看 vma 每一列代表什么含义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>12c00000-12cc0000:</strong> 这个是该虚拟内存段的开始和结束地址。通过地址 x page_size 可以计算出该段内存的大小。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>rw-p:</strong> 该段内存的权限。前3位分别是：读、写、执行，最后一位 p 代表私有，s 代表共享。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>00000000:</strong> 该虚拟内存段起始地址在对应的映射文件中以页为单位的偏移量，对匿名映射，它等于0或者vm_start/PAGE_SIZE。<br>​&nbsp;&nbsp;&nbsp;&nbsp;<strong>00:00:</strong> 文件的主设备号和次设备号。对匿名映射来说，因为没有文件在磁盘上，所以没有设备号，始终为00:00。对有名映射来说，是映射的文件所在设备的设备号。上面有映射号的都是一些文件资源。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>0:</strong> 被映射到虚拟内存的文件的索引节点号，通过该节点可以找到对应的文件，对匿名映射来说，因为没有文件在磁盘上，所以没有节点号，始终为00:00。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>[anon:dalvik-main space (region space)]:</strong> 被映射到虚拟内存的文件名称。后面带(deleted)的是内存数据，可以被销毁。对有名来说，是映射的文件名。对匿名映射来说，是此段虚拟内存在进程中的角色。dumpsys meminfo 是通过这个字段来进行分类统计的。</p>
<h2 id="/proc/pid/smaps">/proc/pid/smaps</h2>
<p>smaps 是 map 的扩展，它显示的信息更加详细，还是拿 systemui 的来举例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="number">12</span>c00000-<span class="number">12</span>dc0000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>          [anon:dalvik-main space (region space)]</div><div class="line">Name:           [anon:dalvik-main space (region space)]</div><div class="line">Size:               <span class="number">1792</span> kB</div><div class="line">KernelPageSize:        <span class="number">4</span> kB</div><div class="line">MMUPageSize:           <span class="number">4</span> kB</div><div class="line">Rss:                 <span class="number">480</span> kB</div><div class="line">Pss:                 <span class="number">480</span> kB</div><div class="line">Shared_Clean:          <span class="number">0</span> kB</div><div class="line">Shared_Dirty:          <span class="number">0</span> kB</div><div class="line">Private_Clean:         <span class="number">0</span> kB</div><div class="line">Private_Dirty:       <span class="number">480</span> kB</div><div class="line">Referenced:          <span class="number">480</span> kB</div><div class="line">Anonymous:           <span class="number">480</span> kB</div><div class="line">AnonHugePages:         <span class="number">0</span> kB</div><div class="line">ShmemPmdMapped:        <span class="number">0</span> kB</div><div class="line">Shared_Hugetlb:        <span class="number">0</span> kB</div><div class="line">Private_Hugetlb:       <span class="number">0</span> kB</div><div class="line">Swap:                  <span class="number">0</span> kB</div><div class="line">SwapPss:               <span class="number">0</span> kB</div><div class="line">Locked:                <span class="number">0</span> kB</div><div class="line">VmFlags: rd wr mr mw me ac </div><div class="line"></div><div class="line"><span class="number">70</span>c5b000-<span class="number">70</span>c5d000 r--s <span class="number">00000000</span> fd:<span class="number">03</span> <span class="number">1491</span>       /system/framework/boot.vdex</div><div class="line">Size:                  <span class="number">8</span> kB</div><div class="line">KernelPageSize:        <span class="number">4</span> kB</div><div class="line">MMUPageSize:           <span class="number">4</span> kB</div><div class="line">Rss:                   <span class="number">8</span> kB</div><div class="line">Pss:                   <span class="number">2</span> kB</div><div class="line">Shared_Clean:          <span class="number">8</span> kB</div><div class="line">Shared_Dirty:          <span class="number">0</span> kB</div><div class="line">Private_Clean:         <span class="number">0</span> kB</div><div class="line">Private_Dirty:         <span class="number">0</span> kB</div><div class="line">Referenced:            <span class="number">8</span> kB</div><div class="line">Anonymous:             <span class="number">0</span> kB</div><div class="line">AnonHugePages:         <span class="number">0</span> kB</div><div class="line">ShmemPmdMapped:        <span class="number">0</span> kB</div><div class="line">Shared_Hugetlb:        <span class="number">0</span> kB</div><div class="line">Private_Hugetlb:       <span class="number">0</span> kB</div><div class="line">Swap:                  <span class="number">0</span> kB</div><div class="line">SwapPss:               <span class="number">0</span> kB</div><div class="line">Locked:                <span class="number">0</span> kB</div><div class="line">VmFlags: rd mr me ms</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里也是截图了其中2段 vma。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Size:</strong> vma 空间的大小。可以由地址计算出来。等于 Vss，进程有时候 malloc 了一大块内存，但是并没有真正使用。但是还是会计算这块内存的大小。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>KernelPageSize:</strong> kernel page size 的大小，一般是 4kb。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>MMUPageSize:</strong> MMU page size 大小，一般等于 KernelPageSize。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Rss:</strong> 前面解释了。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Pss:</strong> 前面也解释了。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Shared/Private:</strong> 该 vma 是私有的还是共享的。对照前面的权限标志位的最后一位，确实 p 的 Shared 有数值，并且不等于 Pss（被均分了）；而 s 的就是 Private 的有数值，并等于 Pss（因为是私有的）。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Dirty/Clean:</strong> 在页面被淘汰的时候，就会把该脏页面回写到交换分区（换出，swap out）。有一个标志位用于表示页面是否dirty。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Referenced:</strong> 当前页面被标记为已引用或者包含匿名映射。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Anonymous:</strong> 匿名映射的物理内存，这部分内存不来自于文件的内存大小。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>AnonHugePages</strong> 统计的是Transparent HugePages (THP)。我暂时没理解是啥意思（网上抄的说明）。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Shared/Private_Hugetlb:</strong> 由hugetlbfs页面支持的内存使用量，由于历史原因，该页面未计入“ RSS”或“ PSS”字段中。 并且这些没有包含在Shared/Private_Clean/Dirty 字段中。（网上抄的说明）。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Swap:</strong> 开启 Zram 后，Swap 到 Zram 分区的大小。这里是包含了共享资源部分内存的。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>SwapPss:</strong> Swap 共享部分按比例均分。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Locked:</strong> 常驻物理内存的大小，这些页不会被换出。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>VmFlags:</strong> 表示与特定虚拟内存区域关联的内核标志。标志如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">rd  - readable</div><div class="line">wr  - writeable</div><div class="line">ex  - executable</div><div class="line">sh  - shared</div><div class="line">mr  - may read</div><div class="line">mw  - may write</div><div class="line">me  - may execute</div><div class="line">ms  - may share</div><div class="line">gd  - stack segment growns down</div><div class="line">pf  - pure PFN range</div><div class="line">dw  - disabled write to the mapped file</div><div class="line">lo  - pages are locked in memory</div><div class="line">io  - memory mapped I/O area</div><div class="line">sr  - sequential read advise provided</div><div class="line">rr  - random read advise provided</div><div class="line">dc  - do not copy area on fork</div><div class="line">de  - do not expand area on remapping</div><div class="line">ac  - area is accountable</div><div class="line">nr  - swap space is not reserved <span class="keyword">for</span> the area</div><div class="line">ht  - area uses huge tlb pages</div><div class="line">ar  - architecture specific flag</div><div class="line">dd  - do not include area into core dump</div><div class="line">sd  - soft-dirty flag</div><div class="line">mm  - mixed map area</div><div class="line">hg  - huge page advise flag</div><div class="line">nh  - no-huge page advise flag</div><div class="line">mg  - mergable advise flag</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="/proc/meminfo">/proc/meminfo</h2>
<p>前面的 dumpsys meminfo 和 procrank 中 total 统计的部分的基础就来源于这个节点的数值： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">MemTotal:         <span class="number">486028</span> kB</div><div class="line">MemFree:           <span class="number">26124</span> kB</div><div class="line">MemAvailable:     <span class="number">181240</span> kB</div><div class="line">Buffers:             <span class="number">788</span> kB</div><div class="line">Cached:           <span class="number">172652</span> kB</div><div class="line">SwapCached:         <span class="number">6428</span> kB</div><div class="line">Active:           <span class="number">145524</span> kB</div><div class="line">Inactive:         <span class="number">159336</span> kB</div><div class="line">Active(anon):      <span class="number">61084</span> kB</div><div class="line">Inactive(anon):    <span class="number">74240</span> kB</div><div class="line">Active(file):      <span class="number">84440</span> kB</div><div class="line">Inactive(file):    <span class="number">85096</span> kB</div><div class="line">Unevictable:        <span class="number">2892</span> kB</div><div class="line">Mlocked:            <span class="number">2892</span> kB</div><div class="line">HighTotal:             <span class="number">0</span> kB</div><div class="line">HighFree:              <span class="number">0</span> kB</div><div class="line">LowTotal:         <span class="number">486028</span> kB</div><div class="line">LowFree:           <span class="number">26124</span> kB</div><div class="line">SwapTotal:        <span class="number">364516</span> kB</div><div class="line">SwapFree:         <span class="number">295852</span> kB</div><div class="line">Dirty:                <span class="number">20</span> kB</div><div class="line">Writeback:             <span class="number">0</span> kB</div><div class="line">AnonPages:        <span class="number">132388</span> kB</div><div class="line">Mapped:           <span class="number">108676</span> kB</div><div class="line">Shmem:              <span class="number">1644</span> kB</div><div class="line">Slab:              <span class="number">41300</span> kB</div><div class="line">SReclaimable:      <span class="number">13752</span> kB</div><div class="line">SUnreclaim:        <span class="number">27548</span> kB</div><div class="line">KernelStack:        <span class="number">5792</span> kB</div><div class="line">PageTables:        <span class="number">14332</span> kB</div><div class="line">NFS_Unstable:          <span class="number">0</span> kB</div><div class="line">Bounce:                <span class="number">0</span> kB</div><div class="line">WritebackTmp:          <span class="number">0</span> kB</div><div class="line">CommitLimit:      <span class="number">607528</span> kB</div><div class="line">Committed_AS:   <span class="number">11034652</span> kB</div><div class="line">VmallocTotal:     <span class="number">507904</span> kB</div><div class="line">VmallocUsed:           <span class="number">0</span> kB</div><div class="line">VmallocChunk:          <span class="number">0</span> kB</div><div class="line">CmaTotal:           <span class="number">8192</span> kB</div><div class="line">CmaFree:             <span class="number">248</span> kB</div><div class="line"></div></pre></td></tr></table></figure>

<p>选一些重点的讲一些：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).MemTotal:</strong> 总共系统可用的物理内存。你会发现这个并不等于实际贴在机器上的内存大小。是因为还有一部分内存要作为 linux kernel 的保留内存（reserved）。保留内存的详细信息后面再说。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).MemFree:</strong> 这个就是真正意义上没有被使用的内存了。这值在 linux 系统上会比较低，其实有一部分内存是各个进程正在使用的，还有一大部分是 Cached。linux 的设计本意就是尽量多的使用内存，来保证进程间切换的平滑性（多任务）。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(3).MemAvailable:</strong> 这个值会比 MemFree 多一些，kernel 根据一些可以回收的内存（例如 cached、buffer 之类的）估算出一个能用的。这个值我目前没发现有啥用处。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(4).Buffers:</strong> 块设备(block)申请的内存。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(5).Cached/Mapped/AnonPages:</strong> 进程的内存页面分为2种： file-backed pages（与文件对应的内存页）和 anonymous pages（匿名页）。file-backed pages 是指例如说进程的代码段、so、jar 库之类的，映射的都是 file-backed，而进程的堆、栈是不与文件相对应的，就属于匿名页。file-backed pages 在内存不足的时候可以直接写回硬盘的文件（叫 page-out），而不需要用到交互区（swap）；而匿名页在内存不足的时候就只能写到硬盘的交换区里（叫 swap-out）。<br>​&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>AnonPages:</strong> 是前面提到的 anonymous pages。它是进程的私有堆栈。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Mapped:</strong> 是前面提到的 file-backed pages。<br>​&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Cached:</strong> Cached 是 Mapped 的超集，除了包含 Mapped 之外，Cached 还包括了 unmapped 的页面。进程中的 file-backed pages 被 unmapped 后不会马上回收，而是当做缓冲计算在 Cached 当中。但是进程中的 anonymous pages 一旦进程退出，则会马上回收。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(6).SwapCached:</strong>  这个好像是 Swap 分区的 page cached。SwapCached 并没有包含在 Cached 里面。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(7).Active/Inactive/Active(anon)/Inactive(anon)/Active(file)/Inactive(file):</strong> linux kernel 有个 LRU 的页面回收算法。LRU list 包括：LRU_INACTIVE_ANON（Inactive(anon)）、LRU_ACTIVE_ANON（Active(anon)）、LRU_INACTIVE_FILE（Inactive(file)）、 LRU_ACTIVE_FILE（Active(anon)）、LRU_UNEVICTABLE（Unevictable）。Active 就是对应正在使用的内存页面，一般这种是无法回收的。而 Inactive 则是最近没在使用的页面，一般这种是可以回收（reclaimed）的。而 Active(anon/file)则分别代表了正在使用的 anonymous pages 和 file-backed pages。Inactive(anon/file) 则是最近没在使用的 anonymous pages 和 file-backed pages。从上面定义来看一般： Active(anon) + Inactive(anon) = AnonPages ，但是发现并不相等，一个会受 Shmem 状态的影响，一个是有点小偏差。同理 Active(file) + Inactive(flie) 与不完全等于 Cached，一个也是受 Shmem 状态影响，一个是 Activie(flie) + Inactivie(file) 还包含 Buffers。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(8).Unevictable:</strong> 是不能被 page-out/swap-out 的页面。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(9).SwapTotal/SwapFree:</strong> 前面说了，配置了 Zram 后，swap 分区的总大小和空闲大小。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(10).Shmem:</strong> 包括 shared memory 和 tmpfs。android 上一般也不大。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(11).Slab/SReclaimable/SUnreclaim:</strong>  Slab 是 linux kernel 上的一种内存分配管理机制，一般是内核模块使用。SReclaimable 和 SUnreclaim 一个是可以回收的，一个是不能回收的 Slab 内存，而 Slab 则这2个加一起。dumpsys meminfo 把 SUnreclaim 算成是 kernel Used 。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(12).KernelStack:</strong>  前面有提到过，是内核的调用堆栈。内核栈是常驻内存的，既不包括在 LRU lists 里，也不包括在进程的 RSS/PSS 内存里，所以可以认为它是 kernel 消耗的内存。dumpsys meminfo 把 KernelStack 也计算在 Kernel Used 里面<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(13).PageTables:</strong> Page Table用于将内存的虚拟地址翻译成物理地址，随着内存地址分配得越来越多，Page Table会增大。请把Page Table与Page Frame（页帧）区分开，物理内存的最小单位是 page frame，每个物理页对应一个描述符(struct page)，在内核的引导阶段就会分配好、保存在 mem_map[] 数组中，mem_map[] 所占用的内存被统计在 dmesg 显示的 reserved （前面提到的 kernel 预留内存）中，/proc/meminfo 的 MemTotal 是不包含它们的。而Page Table的用途是翻译虚拟地址和物理地址，它是会动态变化的，要从 MemTotal 中消耗内存。dumpsys meminfo 把 PageTables 计算在 Kernel Used 里面。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(14).VmallocUsed:</strong> kernel 模块使用 vmalloc 申请的内存。它也是算 kernel 使用的内存的，dumpsys meminfo 把 VmallocUsed 也计算在 Kernel Used 里面。然而在 Android 上 /proc/meminfo 这里的 VmallocUsed 统计不到数值。dumpsys meminfo 是通过 /proc/vmallocinfo 统计的。/proc/vmallocinfo 里不仅有 vmalloc 的，还有 ioremap（这个是IO地址映射的）、vmap 的，这2个是不占内存的。vmalloc 的每一行有 “pages=x” 的页面数量信息，所以直接计算 pages 的总数，然后 x page_size 就能统计到 VmallocUsed 了（这也是前面 dumpsys meminfo kernel used 那里我说计算 pages= 的理由）。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(15).CmaTotal/CmaFree:</strong> 配置的 cma 总大小和 free 大小。一般有 iommu 的方案 cma 都会比较小。</p>
<p>其他一些数值不是很重要就不细说了。 </p>
<h2 id="PageMap">PageMap</h2>
<p>PageMap 是一个 github 上的小工具（<a href="https://github.com/andywarduk/PageMap" target="_blank" rel="external">github地址</a>），可以统计到每个进程匿名页、文件缓存等信息。可以认为是 /proc/meminfo 的 pid 版本。它的源码也比较简单，就一个 PageMap.c 文件，统计的方法是：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).</strong> 遍历 /proc/pid/maps 中的所有 vma（也就是每一行）。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).</strong> 通过 vma 的虚拟地址在 /proc/pid/pagemap 里面找到对应的 PFN，这是一个 64 bit 的值，含义 kernel 说明文档如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">* Bits <span class="number">0</span>-<span class="number">54</span>  page frame number (PFN) <span class="keyword">if</span> present</div><div class="line">* Bits <span class="number">0</span>-<span class="number">4</span>   swap <span class="keyword">type</span> <span class="keyword">if</span> swapped</div><div class="line">* Bits <span class="number">5</span>-<span class="number">54</span>  swap offset <span class="keyword">if</span> swapped</div><div class="line">* <span class="typename">Bit</span>  <span class="number">55</span>    pte <span class="keyword">is</span> soft-dirty (see Documentation/vm/soft-dirty.txt)</div><div class="line">* <span class="typename">Bit</span>  <span class="number">56</span>    page exclusively mapped (since <span class="number">4.2</span>)</div><div class="line">* Bits <span class="number">57</span>-<span class="number">60</span> zero</div><div class="line">* <span class="typename">Bit</span>  <span class="number">61</span>    page <span class="keyword">is</span> <span class="keyword">file</span>-page <span class="keyword">or</span> <span class="keyword">shared</span>-anon (since <span class="number">3.5</span>)</div><div class="line">* <span class="typename">Bit</span>  <span class="number">62</span>    page swapped</div><div class="line">* <span class="typename">Bit</span>  <span class="number">63</span>    page present</div></pre></td></tr></table></figure>

<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(3).</strong>  通过 PFN 可以在 /proc/kpagecount 里面得到对应页面的引用计数。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(4).</strong> 通过 PFN 可以在 /proc/kpageflag 里得到对应页面的标志位，从而判断出页数的属性（这个标志也是个 64 位数值，可以通过位来判断），通过页面属性累计各种信息（例如匿名页、文件缓存等）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"> 0. LOCKED</div><div class="line"> 1. ERROR</div><div class="line"> 2. REFERENCED</div><div class="line"> 3. UPTODATE</div><div class="line"> 4. DIRTY</div><div class="line"> 5. LRU</div><div class="line"> 6. ACTIVE</div><div class="line"> 7. SLAB</div><div class="line"> 8. WRITEBACK</div><div class="line"> 9. RECLAIM</div><div class="line"><span class="bullet">10. </span>BUDDY</div><div class="line"><span class="bullet">11. </span>MMAP</div><div class="line"><span class="bullet">12. </span>ANON</div><div class="line"><span class="bullet">13. </span>SWAPCACHE</div><div class="line"><span class="bullet">14. </span>SWAPBACKED</div><div class="line"><span class="bullet">15. </span>COMPOUND_HEAD</div><div class="line"><span class="bullet">16. </span>COMPOUND_TAIL</div><div class="line"><span class="bullet">17. </span>HUGE</div><div class="line"><span class="bullet">18. </span>UNEVICTABLE</div><div class="line"><span class="bullet">19. </span>HWPOISON</div><div class="line"><span class="bullet">20. </span>NOPAGE</div><div class="line"><span class="bullet">21. </span>KSM</div><div class="line"><span class="bullet">22. </span>THP</div><div class="line"><span class="bullet">23. </span>BALLOON</div><div class="line"><span class="bullet">24. </span>ZERO_PAGE</div><div class="line"><span class="bullet">25. </span>IDLE</div></pre></td></tr></table></figure>

<p>其实上面的过程和前面 procrank 统计 Vss/Rss/Pss 是类似的。但是这个工具跑在全志的平台上统计需要稍微改一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">diff --git a/PageMap.c b/PageMap.c</div><div class="line">old mode <span class="number">100644</span></div><div class="line"><span class="keyword">new</span> mode <span class="number">100755</span></div><div class="line">index d52dedb..c80bcd1</div><div class="line">--- a/PageMap.c</div><div class="line">+++ b/PageMap.c</div><div class="line">@@ -<span class="number">288</span>,<span class="number">7</span> +<span class="number">288</span>,<span class="number">7</span> @@ <span class="keyword">int</span> dumppid(<span class="keyword">struct</span> global *globals)</div><div class="line"> 	uint64_t pfn;</div><div class="line"> 	uint64_t swapfile;</div><div class="line"> 	uint64_t swapoff;</div><div class="line">-	<span class="keyword">int</span> present,swapped;</div><div class="line">+	<span class="keyword">int</span> present,swapped,file_or_shareanon,soft_dirty;</div><div class="line"> 	<span class="keyword">unsigned</span> <span class="keyword">int</span> shift;</div><div class="line"> 	<span class="keyword">unsigned</span> <span class="keyword">int</span> pagesize;</div><div class="line"> </div><div class="line">@@ -<span class="number">383</span>,<span class="number">8</span> +<span class="number">383</span>,<span class="number">11</span> @@ <span class="keyword">int</span> dumppid(<span class="keyword">struct</span> global *globals)</div><div class="line"> 				<span class="comment">// Unpack common bits</span></div><div class="line"> 				present = (entry & <span class="number">0x8000000000000000</span>LL) &gt;&gt; <span class="number">62</span>;</div><div class="line"> 				swapped = (entry & <span class="number">0x4000000000000000</span>LL) &gt;&gt; <span class="number">61</span>;</div><div class="line">-				shift = (entry & <span class="number">0x1f80000000000000</span>LL) &gt;&gt; <span class="number">55</span>;</div><div class="line">-				pagesize = (<span class="number">1</span>&lt;&lt;shift);</div><div class="line">+				file_or_shareanon = (entry & <span class="number">0x2000000000000000</span>LL) &gt;&gt; <span class="number">60</span>;</div><div class="line">+				soft_dirty = (entry & <span class="number">0x80000000000000</span>LL) &gt;&gt; <span class="number">54</span>;</div><div class="line">+				<span class="comment">//shift = (entry & 0x1f80000000000000LL) &gt;&gt; 55;</span></div><div class="line">+				<span class="comment">//pagesize = (1&lt;&lt;shift);</span></div><div class="line">+				pagesize = <span class="number">4096</span>;</div><div class="line"> 				</div><div class="line"> 				<span class="keyword">if</span>(!present && !swapped){</div><div class="line"> 					<span class="comment">// Page not present in physical ram or swap</span></div><div class="line">@@ -<span class="number">409</span>,<span class="number">6</span> +<span class="number">412</span>,<span class="number">10</span> @@ <span class="keyword">int</span> dumppid(<span class="keyword">struct</span> global *globals)</div><div class="line"> 						pfn = entry & <span class="number">0x007fffffffffffff</span>LL;</div><div class="line"> 						<span class="keyword">if</span>(globals-&gt;verbose && !skip){</div><div class="line"> 							<span class="built_in">printf</span>(<span class="string">", Present (pfn %016"</span> UINT64FMT <span class="string">"x)"</span>, pfn);</div><div class="line">+							<span class="keyword">if</span> (file_or_shareanon)</div><div class="line">+								<span class="built_in">printf</span>(<span class="string">", file/shareAnon"</span>);</div><div class="line">+							<span class="keyword">if</span> (soft_dirty)</div><div class="line">+								<span class="built_in">printf</span>(<span class="string">", pte-soft-dirty"</span>);</div><div class="line"> 						}</div><div class="line"> 						<span class="keyword">if</span>(globals-&gt;<span class="built_in">map</span> && !skip) <span class="built_in">printf</span>(<span class="string">"P"</span>);</div><div class="line"> </div><div class="line">@@ -<span class="number">473</span>,<span class="number">6</span> +<span class="number">480</span>,<span class="number">7</span> @@ <span class="keyword">int</span> dumppid(<span class="keyword">struct</span> global *globals)</div><div class="line"> 							<span class="keyword">if</span>(hdpageflags & (<span class="number">1</span>&lt;&lt;<span class="number">12</span>)) stats.anon += pagesize;</div><div class="line"> 							<span class="keyword">if</span>(hdpageflags & (<span class="number">1</span>&lt;&lt; <span class="number">2</span>)) stats.refd += pagesize;</div><div class="line"> 						}</div><div class="line">+						<span class="built_in">printf</span>(<span class="string">",%s"</span>, item);</div><div class="line"> </div><div class="line"> 					}</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后可以用编译服务器的 arm-gcc 编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ming85 ~ $ which arm-<span class="keyword">none</span>-linux-gnueabi-g++</div><div class="line">/arm/arm-<span class="number">2010.09</span>/bin/arm-<span class="keyword">none</span>-linux-gnueabi-g++</div><div class="line"></div><div class="line">arm-<span class="keyword">none</span>-linux-gnueabi-g++ <span class="type">PageMap</span>.<span class="built_in">c</span>  -<span class="type">Wall</span> -<span class="type">Wextra</span> -fPIC -fno-inline -g -<span class="type">O2</span> --<span class="keyword">static</span> -o pgmap_my</div></pre></td></tr></table></figure>

<p>编译出来的 bin 文件 push 到 /data/local/tmp/（chmod +x 加下执行权限），用下面就可以统计指定进程的详细信息了： /data/local/tmp/pgmap_my -v -p pid &gt; /sdcard/pgmap.txt 。统计是打印信息，所以需要重定向到一个文本里面，而且是一个页面一个页面的信息，还需要脚本二次统计：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">==================== (region <span class="built_in">space</span>)] [rw-p] [ <span class="number">768</span>kB] ====================</div><div class="line">   <span class="number">0000000012</span>c00000-<span class="number">0000000012</span>c00fff [   <span class="number">4</span>kB], Present (pfn <span class="number">0000000000059145</span>), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c01000-<span class="number">0000000012</span>c01fff [   <span class="number">4</span>kB], Present (pfn <span class="number">000000000004</span>fb0d), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c02000-<span class="number">0000000012</span>c02fff [   <span class="number">4</span>kB], Present (pfn <span class="number">0000000000057</span>f79), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c03000-<span class="number">0000000012</span>c03fff [   <span class="number">4</span>kB], Present (pfn <span class="number">000000000005</span>c536), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c04000-<span class="number">0000000012</span>c04fff [   <span class="number">4</span>kB], Present (pfn <span class="number">00000000000553</span>ae), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c05000-<span class="number">0000000012</span>c05fff [   <span class="number">4</span>kB], Present (pfn <span class="number">00000000000555</span>db), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c06000-<span class="number">0000000012</span>c06fff [   <span class="number">4</span>kB], Present (pfn <span class="number">000000000004e044</span>), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c07000-<span class="number">0000000012</span>c07fff [   <span class="number">4</span>kB], Present (pfn <span class="number">0000000000057</span>b57), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c08000-<span class="number">0000000012</span>c08fff [   <span class="number">4</span>kB], Present (pfn <span class="number">0000000000046809</span>), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c09000-<span class="number">0000000012</span>c09fff [   <span class="number">4</span>kB], Present (pfn <span class="number">0000000000059</span>b61), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div><div class="line">   <span class="number">0000000012</span>c0a000-<span class="number">0000000012</span>c0afff [   <span class="number">4</span>kB], Present (pfn <span class="number">0000000000047</span>f0d), RefCnt <span class="number">1</span>, Flags [UPTODATE LRU ACTIVE MMAP ANON SWAPBACKED],(region <span class="built_in">space</span>)]</div></pre></td></tr></table></figure>

<p>每个页面的页面属性（Flags 那里的），引用计数（RefCnt）会打印出来。例如说我们比较关心的就是进程的匿名页面和缓存信息，可以用下面脚本对得到的文本进行统计：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">cat <span class="variable">$1</span> | grep Swapped: | awk <span class="string">'{print $1,$2/4}'</span></div><div class="line"><span class="built_in">echo</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"anon inactive lru: `cat <span class="variable">$1</span> |grep -v ACTIVE| grep ANON |grep LRU |  wc -l`"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"anon active lru: `cat <span class="variable">$1</span> |grep ANON| grep ACTIVE |grep LRU | wc -l`"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"anon undirty lru: `cat <span class="variable">$1</span> |grep ANON| grep -v DIRTY |grep LRU | wc -l`"</span></div><div class="line"><span class="built_in">echo</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"file inactive lru: `cat <span class="variable">$1</span> | grep -i 'file' | grep -v ACTIVE|grep LRU |  wc -l` "</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"file active lru: `cat <span class="variable">$1</span> | grep -i file | grep ACTIVE |grep LRU |    wc -l`"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"file unique inactive lru: `cat <span class="variable">$1</span> | grep -i 'file' | grep -v ACTIVE|grep LRU | grep "</span>RefCnt <span class="number">1</span>,<span class="string">" |  wc -l` "</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"file unique active lru: `cat <span class="variable">$1</span> | grep -i file | grep ACTIVE |grep LRU | grep "</span>RefCnt <span class="number">1</span>,<span class="string">" | wc -l`"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"file unique undirty lru: `cat <span class="variable">$1</span> | grep -i file | grep -v DIRTY|grep LRU | grep "</span>RefCnt <span class="number">1</span>,<span class="string">" | wc -l`"</span></div></pre></td></tr></table></figure>

<p>这个脚本需要 linux 环境运行（window 可以用 cygwin），也可以直接 push 到设备上跑：  sh /data/local/tmp/x1.sh /sdcard/pgmap.txt ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在 Swap 分区中的页面，下面的数据单位都是页面（一个页面为4kb）</span></div><div class="line">Swapped: <span class="number">3343</span></div><div class="line"></div><div class="line"><span class="comment">// anon 是匿名页面</span></div><div class="line">anon inactive lru: <span class="number">2525</span></div><div class="line">anon active lru: <span class="number">1000</span></div><div class="line"><span class="comment">// undirty 是非脏页面</span></div><div class="line">anon undirty lru: <span class="number">3525</span></div><div class="line"></div><div class="line"><span class="comment">// file 是文件缓存</span></div><div class="line"><span class="keyword">file</span> inactive lru: <span class="number">1514</span></div><div class="line"><span class="keyword">file</span> active lru: <span class="number">1445</span></div><div class="line"><span class="comment">// unique 是引用计数为1的页面，undirty 是非脏页面</span></div><div class="line"><span class="keyword">file</span> unique inactive lru: <span class="number">508</span></div><div class="line"><span class="keyword">file</span> unique active lru: <span class="number">484</span></div><div class="line"><span class="keyword">file</span> unique undirty lru: <span class="number">969</span></div></pre></td></tr></table></figure>

<h2 id="ion">ion</h2>
<p>ion 是 google 推出的 Android 的一种内存管理机制，一般用于多媒体、Camera、显示模块。它可以在用户空间的进程间共享，或者内核的模块之间共享。我个人认为 ion 的内存没有计算在前面的进程内存里面（Pss）或者 kernel 模块里面（/proc/meminfo）。我们先来看一下 ion 的内存怎么看，Android 10 上面有一个节点可以看到： cat /sys/kernel/debug/ion/heaps/sys_user：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">          client              pid             size</div><div class="line">----------------------------------------------------</div><div class="line">            init             <span class="number">1397</span>             <span class="number">4096</span></div><div class="line">            init             <span class="number">1397</span>             <span class="number">4096</span></div><div class="line">            init             <span class="number">1397</span>            <span class="number">77824</span></div><div class="line">       ion_disp2                <span class="number">1</span>          <span class="number">4915200</span></div><div class="line">----------------------------------------------------</div><div class="line">orphaned allocations (info is from last known client):</div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">81920</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>          <span class="number">2494464</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>          <span class="number">2494464</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">81920</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>             <span class="number">8192</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>             <span class="number">8192</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>           <span class="number">118784</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>           <span class="number">118784</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>           <span class="number">118784</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>             <span class="number">8192</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>             <span class="number">8192</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>             <span class="number">8192</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>             <span class="number">8192</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>          <span class="number">2494464</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>          <span class="number">2494464</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>          <span class="number">2494464</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>          <span class="number">8503296</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">20480</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>          <span class="number">2494464</span> <span class="number">0</span> <span class="number">1</span></div><div class="line"> allocator@<span class="number">2.0</span>-s             <span class="number">1938</span>            <span class="number">81920</span> <span class="number">0</span> <span class="number">1</span></div><div class="line">----------------------------------------------------</div><div class="line">  total orphaned         <span class="number">24346624</span></div><div class="line">          total          <span class="number">29347840</span></div><div class="line">   deferred free                <span class="number">0</span></div><div class="line">----------------------------------------------------</div><div class="line"><span class="number">0</span> order <span class="number">8</span> highmem pages uncached <span class="number">0</span> total</div><div class="line"><span class="number">3</span> order <span class="number">8</span> lowmem pages uncached <span class="number">3145728</span> total</div><div class="line"><span class="number">0</span> order <span class="number">4</span> highmem pages uncached <span class="number">0</span> total</div><div class="line"><span class="number">48</span> order <span class="number">4</span> lowmem pages uncached <span class="number">3145728</span> total</div><div class="line"><span class="number">0</span> order <span class="number">0</span> highmem pages uncached <span class="number">0</span> total</div><div class="line"><span class="number">128</span> order <span class="number">0</span> lowmem pages uncached <span class="number">524288</span> total</div><div class="line"><span class="number">0</span> order <span class="number">8</span> highmem pages cached <span class="number">0</span> total</div><div class="line"><span class="number">0</span> order <span class="number">8</span> lowmem pages cached <span class="number">0</span> total</div><div class="line"><span class="number">0</span> order <span class="number">4</span> highmem pages cached <span class="number">0</span> total</div><div class="line"><span class="number">0</span> order <span class="number">4</span> lowmem pages cached <span class="number">0</span> total</div><div class="line"><span class="number">0</span> order <span class="number">0</span> highmem pages cached <span class="number">0</span> total</div><div class="line"><span class="number">0</span> order <span class="number">0</span> lowmem pages cached <span class="number">0</span> total</div><div class="line"></div></pre></td></tr></table></figure>

<p>上面列出了所有进程（ion 的 client）申请的 ion 的情况（上面单位是 byte）。上面主要分为2部分：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).</strong> init 占用的。这里并不多，也就才 4M 左右。上面 pid 1 和 1397 分别是2个 init 进程（好像从 android 某个版本开始就有2个 init 进程了）。一般 init 申请 ion 是用来做一些平滑显示用的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).</strong> 1938 从上面的进程列表可以看到是 android.hardware.graphics.allocator@2.0-service 。这个是 android 的里面的一个 hal 模块，用来管理 buffer queue 的（以前的 android 版本好像叫 gralloc）。procrank 可以看到这个进程就算是算 Rss 也才 4.8M，但是从 ion 这边看到的它申请的 ion 内存却有 23M。所以我认为前面计算进程 的 Pss 没有统计 ion。而且网上有个补丁：<a href="https://lkml.org/lkml/2020/3/10/2104" target="_blank" rel="external">android: ion: include system heap size in proc/meminfo</a> ，这么看原生的 /proc/meminfo 也是没统计 ion 的。gralloc 申请的 23M 内存大多数都是 SurfaceFlinger 用了，可以使用 dumpsys SurfaceFlinger 查看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">Display <span class="number">0</span> HWC layers:</div><div class="line">-------------------------------------------------------------------------------------------</div><div class="line"> Layer name</div><div class="line">           Z |  Window Type |  Comp Type |  Transform |   Disp Frame (LTRB) |          Source Crop (LTRB)</div><div class="line">-------------------------------------------------------------------------------------------</div><div class="line"> com.android.systemui.ImageWallpaper#<span class="number">0</span></div><div class="line">  rel      <span class="number">0</span> |         <span class="number">2013</span> |     CLIENT |          <span class="number">0</span> |    <span class="number">0</span>    <span class="number">0</span> <span class="number">1024</span>  <span class="number">600</span> |    <span class="number">0.0</span>    <span class="number">0.0</span> <span class="number">1318.0</span>  <span class="number">772.0</span></div><div class="line">- - - - - - - - - - - - - - - -- - - - - - - - - - - - - - - -- - - - - - - - - - - - - - -</div><div class="line"> com.android.launcher3/com.android.launcher3.Launcher#<span class="number">0</span></div><div class="line">  rel      <span class="number">0</span> |            <span class="number">1</span> |     CLIENT |          <span class="number">0</span> |    <span class="number">0</span>    <span class="number">0</span> <span class="number">1024</span>  <span class="number">600</span> |    <span class="number">0.0</span>    <span class="number">0.0</span> <span class="number">1024.0</span>  <span class="number">600.0</span></div><div class="line">- - - - - - - - - - - - - - - -- - - - - - - - - - - - - - - -- - - - - - - - - - - - - - -</div><div class="line"> StatusBar#<span class="number">0</span></div><div class="line">  rel      <span class="number">0</span> |         <span class="number">2000</span> |     CLIENT |          <span class="number">0</span> | <span class="number">1000</span>    <span class="number">0</span> <span class="number">1024</span>  <span class="number">600</span> |    <span class="number">0.0</span>    <span class="number">0.0</span>   <span class="number">24.0</span>  <span class="number">600.0</span></div><div class="line">- - - - - - - - - - - - - - - -- - - - - - - - - - - - - - - -- - - - - - - - - - - - - - -</div><div class="line"> NavigationBar0#<span class="number">0</span></div><div class="line">  rel      <span class="number">0</span> |         <span class="number">2019</span> |     CLIENT |          <span class="number">0</span> |    <span class="number">0</span>    <span class="number">0</span>   <span class="number">48</span>  <span class="number">600</span> |    <span class="number">0.0</span>    <span class="number">0.0</span>   <span class="number">48.0</span>  <span class="number">600.0</span></div><div class="line">- - - - - - - - - - - - - - - -- - - - - - - - - - - - - - - -- - - - - - - - - - - - - - -</div><div class="line"></div><div class="line">h/w composer state:</div><div class="line">  h/w composer enabled</div><div class="line">     layer      |  handle        |  format  |bl|space|TR|pAlp|       crop or color         |       frame         |zOrder|hz|ch|id|duto</div><div class="line">----------------------------------------------------------------------------------------------------------------------------------------------------</div><div class="line">      <span class="number">0xa813050c</span>|      <span class="number">0xa81270e0</span>|         <span class="number">1</span>| <span class="number">1</span>|    <span class="number">0</span>| <span class="number">0</span>|<span class="number">1.00</span>|[   <span class="number">0.0</span>,   <span class="number">0.0</span>,<span class="number">1318.0</span>, <span class="number">772.0</span>]|[   <span class="number">0</span>,   <span class="number">0</span>,<span class="number">1024</span>, <span class="number">600</span>]|     <span class="number">0</span>|-<span class="number">1</span>|-<span class="number">1</span>|-<span class="number">1</span>|FORCE_GPU</div><div class="line">      <span class="number">0xa81306ec</span>|      <span class="number">0xa8127540</span>|         <span class="number">1</span>| <span class="number">2</span>|    <span class="number">0</span>| <span class="number">0</span>|<span class="number">1.00</span>|[   <span class="number">0.0</span>,   <span class="number">0.0</span>,<span class="number">1024.0</span>, <span class="number">600.0</span>]|[   <span class="number">0</span>,   <span class="number">0</span>,<span class="number">1024</span>, <span class="number">600</span>]|     <span class="number">1</span>|-<span class="number">1</span>|-<span class="number">1</span>|-<span class="number">1</span>|FORCE_GPU</div><div class="line">      <span class="number">0xa813032c</span>|      <span class="number">0xa81271c0</span>|         <span class="number">1</span>| <span class="number">2</span>|    <span class="number">0</span>| <span class="number">0</span>|<span class="number">1.00</span>|[   <span class="number">0.0</span>,   <span class="number">0.0</span>,  <span class="number">24.0</span>, <span class="number">600.0</span>]|[<span class="number">1000</span>,   <span class="number">0</span>,<span class="number">1024</span>, <span class="number">600</span>]|     <span class="number">2</span>|-<span class="number">1</span>|-<span class="number">1</span>|-<span class="number">1</span>|FORCE_GPU</div><div class="line">      <span class="number">0xa8130a0c</span>|      <span class="number">0xa8127460</span>|         <span class="number">1</span>| <span class="number">2</span>|    <span class="number">0</span>| <span class="number">0</span>|<span class="number">1.00</span>|[   <span class="number">0.0</span>,   <span class="number">0.0</span>,  <span class="number">48.0</span>, <span class="number">600.0</span>]|[   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">48</span>, <span class="number">600</span>]|     <span class="number">3</span>|-<span class="number">1</span>|-<span class="number">1</span>|-<span class="number">1</span>|FORCE_GPU</div><div class="line">      <span class="number">0xa81301ec</span>|      <span class="number">0xa8127230</span>|         <span class="number">5</span>| <span class="number">2</span>|    <span class="number">0</span>| <span class="number">0</span>|<span class="number">1.00</span>|[   <span class="number">0.0</span>,   <span class="number">0.0</span>,<span class="number">1024.0</span>, <span class="number">600.0</span>]|[   <span class="number">0</span>,   <span class="number">0</span>,<span class="number">1024</span>, <span class="number">600</span>]| <span class="number">65536</span>| <span class="number">0</span>| <span class="number">1</span>| <span class="number">0</span>|HWC_LAYER</div><div class="line">disp:<span class="number">0</span> cur:<span class="number">1662</span>-<span class="number">1661</span> ker:<span class="number">1662</span></div><div class="line">----------------------------------------------------------------------------------------------------------------------------------------------------</div><div class="line">GL:<span class="number">29030400</span> GCL:<span class="number">2457600</span> GC:<span class="number">2457600</span> GR:<span class="number">0</span> DR:<span class="number">0</span> RM(C):<span class="number">8947848</span>(<span class="number">0</span>) RP(C):<span class="number">4147200</span>(<span class="number">0</span>)</div><div class="line">memmalloc:<span class="number">9408</span></div><div class="line">Allocated buffers:</div><div class="line"><span class="number">0xa80255b0</span>: <span class="number">2400.00</span> KiB | <span class="number">1024</span> (<span class="number">1024</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0x1a00</span> | FramebufferSurface</div><div class="line"><span class="number">0xa8025620</span>: <span class="number">2400.00</span> KiB | <span class="number">1024</span> (<span class="number">1024</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0x1a00</span> | FramebufferSurface</div><div class="line"><span class="number">0xa8025690</span>: <span class="number">2400.00</span> KiB | <span class="number">1024</span> (<span class="number">1024</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0x1a00</span> | FramebufferSurface</div><div class="line"><span class="number">0xa8027370</span>: <span class="number">2400.00</span> KiB | <span class="number">1024</span> (<span class="number">1024</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | com.android.launcher3/com.android.launcher3.Launcher#<span class="number">0</span></div><div class="line"><span class="number">0xa80273e0</span>:   <span class="number">75.00</span> KiB |   <span class="number">24</span> (  <span class="number">32</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | StatusBar#<span class="number">0</span></div><div class="line"><span class="number">0xa80274c0</span>:   <span class="number">75.00</span> KiB |   <span class="number">24</span> (  <span class="number">32</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | StatusBar#<span class="number">0</span></div><div class="line"><span class="number">0xa80276f0</span>: <span class="number">2400.00</span> KiB | <span class="number">1024</span> (<span class="number">1024</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | com.android.launcher3/com.android.launcher3.Launcher#<span class="number">0</span></div><div class="line"><span class="number">0xa80277d0</span>:   <span class="number">75.00</span> KiB |   <span class="number">24</span> (  <span class="number">32</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | StatusBar#<span class="number">0</span></div><div class="line"><span class="number">0xa80278b0</span>:  <span class="number">114.00</span> KiB |  <span class="number">600</span> ( <span class="number">608</span>) x   <span class="number">48</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | NavigationBar0#<span class="number">0</span></div><div class="line"><span class="number">0xa8027990</span>: <span class="number">8300.00</span> KiB | <span class="number">1318</span> (<span class="number">1328</span>) x <span class="number">1600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | com.android.systemui.ImageWallpaper#<span class="number">0</span></div><div class="line"><span class="number">0xa8027a00</span>:  <span class="number">114.00</span> KiB |  <span class="number">600</span> ( <span class="number">608</span>) x   <span class="number">48</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | NavigationBar0#<span class="number">0</span></div><div class="line"><span class="number">0xa8027a70</span>:  <span class="number">112.50</span> KiB |   <span class="number">48</span> (  <span class="number">48</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | NavigationBar0#<span class="number">0</span></div><div class="line"><span class="number">0xa8027ae0</span>: <span class="number">2400.00</span> KiB | <span class="number">1024</span> (<span class="number">1024</span>) x  <span class="number">600</span> |    <span class="number">1</span> |        <span class="number">1</span> | <span class="number">0xb02</span> | com.android.launcher3/com.android.launcher3.Launcher#<span class="number">0</span></div><div class="line">Total allocated (estimate): <span class="number">23265.50</span> KB</div><div class="line"></div></pre></td></tr></table></figure>

<p>gralloc 的 23M 都是 SurfaceFlinger 的 BufferQueue。一个 BufferQueue 一般对应一个显示图层（Layer）。一般普通的 Layer 对应的 BufferQueue 是3重缓冲，所以有3块内存块（壁纸的好像有点特殊只有一个）。除了显示的 Layer 的 BufferQueue 之外，还有一个 FramebufferSurface 的 BufferQueue，这个是用来做 GPU 合成的。所以说显示的 Layer 越多，就越占内存（BufferQueue 越多），而且也越占带宽（无论是 GPU 合成还是 HWC 合成，多一个图层就多一次合成操作）。</p>
<h2 id="Kernel_used">Kernel used</h2>
<p>目前我还是认可 dumpsys meminfo 中 kernel used 的统计方式：<strong>Shmem + SUnreclaim+ PageTables + KernelStack + VmallocUsed</strong>。</p>
<h2 id="Kernel_reserved">Kernel reserved</h2>
<p>前面有说无论是 /proc/meminfo 还是 free 看到的可用内存都会比物理内存小。这其中差的内存就属于 Kernel reserved。这部分内存有一些是一些驱动专用内存，一些是内核代码段，一些是内存页表。有几种方法可以看到 reserved 的信息：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).</strong> 开机启动的 dmesg 打印（一般可以接串口打印看到）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Memory: <span class="number">476056</span>K/<span class="number">524288</span>K available (<span class="number">10240</span>K kernel code, <span class="number">1419</span>K rwdata, <span class="number">3040</span>K rodata, <span class="number">1024</span>K init, <span class="number">423</span>K bss, <span class="number">40040</span>K reserved, <span class="number">8192</span>K cma-reserved, <span class="number">0</span>K highmem)</div><div class="line"></div></pre></td></tr></table></figure>

<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).</strong> cat /sys/kernel/debug/memblock/reserved：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"> <span class="number">0</span>: <span class="number">0x40004000</span>.<span class="number">.0</span>x40007fff, size:<span class="number">16</span>K</div><div class="line"> <span class="number">1</span>: <span class="number">0x40020000</span>.<span class="number">.0</span>x40020fff, size:<span class="number">4</span>K</div><div class="line"> <span class="comment">// 这个应该是包含了 kernel code、atf 相关的内容，地址连续所以只显示一块</span></div><div class="line"> <span class="number">2</span>: <span class="number">0x40100000</span>.<span class="number">.0</span>x411cdc1b, size:<span class="number">17207</span>K</div><div class="line"> <span class="number">3</span>: <span class="number">0x42000000</span>.<span class="number">.0</span>x420bc5b4, size:<span class="number">753</span>K</div><div class="line"> <span class="number">4</span>: <span class="number">0x44000000</span>.<span class="number">.0</span>x4401a0d3, size:<span class="number">104</span>K</div><div class="line"> <span class="comment">// 这个应该是存放内存页面表结构的</span></div><div class="line"> <span class="number">5</span>: <span class="number">0x48000000</span>.<span class="number">.0</span>x48ffffff, size:<span class="number">16384</span>K</div><div class="line"> <span class="number">6</span>: <span class="number">0x5f291000</span>.<span class="number">.0</span>x5f334fff, size:<span class="number">656</span>K</div><div class="line"> <span class="number">7</span>: <span class="number">0x5f335a80</span>.<span class="number">.0</span>x5f337a7f, size:<span class="number">8</span>K</div><div class="line"> <span class="number">8</span>: <span class="number">0x5f337aa0</span>.<span class="number">.0</span>x5f7ff03b, size:<span class="number">4893</span>K</div><div class="line"> <span class="number">9</span>: <span class="number">0x5f7ff040</span>.<span class="number">.0</span>x5f7ff07b, size:<span class="number">0</span>K</div><div class="line"><span class="number">10</span>: <span class="number">0x5f7ff080</span>.<span class="number">.0</span>x5f7ff0f7, size:<span class="number">0</span>K</div><div class="line"><span class="number">11</span>: <span class="number">0x5f7ff100</span>.<span class="number">.0</span>x5f7ff10f, size:<span class="number">0</span>K</div><div class="line"><span class="number">12</span>: <span class="number">0x5f7ff140</span>.<span class="number">.0</span>x5f7ff14f, size:<span class="number">0</span>K</div><div class="line"><span class="number">13</span>: <span class="number">0x5f7ff180</span>.<span class="number">.0</span>x5f7ff183, size:<span class="number">0</span>K</div><div class="line"><span class="number">14</span>: <span class="number">0x5f7ff1c0</span>.<span class="number">.0</span>x5f7ff1c3, size:<span class="number">0</span>K</div><div class="line"><span class="number">15</span>: <span class="number">0x5f7ff200</span>.<span class="number">.0</span>x5f7ff59a, size:<span class="number">0</span>K</div><div class="line"><span class="number">16</span>: <span class="number">0x5f7ff5c0</span>.<span class="number">.0</span>x5f7ff95a, size:<span class="number">0</span>K</div><div class="line"><span class="number">17</span>: <span class="number">0x5f7ff980</span>.<span class="number">.0</span>x5f7ffd1a, size:<span class="number">0</span>K</div><div class="line"><span class="number">18</span>: <span class="number">0x5f7ffd2c</span>.<span class="number">.0</span>x5f7ffd49, size:<span class="number">0</span>K</div><div class="line"><span class="number">19</span>: <span class="number">0x5f7ffd4c</span>.<span class="number">.0</span>x5f7ffd80, size:<span class="number">0</span>K</div><div class="line"><span class="number">20</span>: <span class="number">0x5f7ffd84</span>.<span class="number">.0</span>x5f7ffde4, size:<span class="number">0</span>K</div><div class="line"><span class="number">21</span>: <span class="number">0x5f7ffde8</span>.<span class="number">.0</span>x5f7ffe38, size:<span class="number">0</span>K</div><div class="line"><span class="number">22</span>: <span class="number">0x5f7ffe3c</span>.<span class="number">.0</span>x5f7ffece, size:<span class="number">0</span>K</div><div class="line"><span class="number">23</span>: <span class="number">0x5f7ffed0</span>.<span class="number">.0</span>x5f7ffeea, size:<span class="number">0</span>K</div><div class="line"><span class="number">24</span>: <span class="number">0x5f7ffeec</span>.<span class="number">.0</span>x5f7fff06, size:<span class="number">0</span>K</div><div class="line"><span class="number">25</span>: <span class="number">0x5f7fff08</span>.<span class="number">.0</span>x5f7fff22, size:<span class="number">0</span>K</div><div class="line"><span class="number">26</span>: <span class="number">0x5f7fff24</span>.<span class="number">.0</span>x5f7fff3e, size:<span class="number">0</span>K</div><div class="line"><span class="number">27</span>: <span class="number">0x5f7fff40</span>.<span class="number">.0</span>x5f7fff9f, size:<span class="number">0</span>K</div><div class="line"><span class="comment">// 这个是 cma</span></div><div class="line"><span class="number">28</span>: <span class="number">0x5f7fffb0</span>.<span class="number">.0</span>x5fffffff, size:<span class="number">8192</span>K</div><div class="line"></div></pre></td></tr></table></figure>

<p>第一种方法看到的可用内存 476056K 会比 /proc/meminfo 的少一些。是因为这里统计的的可用内存有一部分在 boot 阶段还未释放，所以启动后的 /proc/meminfo 的可用内存会比这里统计的高一些。这里的一些内核代码段和init的一些占用，加起来也不等于后面的 40040K reserved，而且 reserved 也不光光只有这些。</p>
<p>所以还是第二种方法好一些，而且还能看到具体的地址分布。这个在优化 reserved 内存的时候相关负责的研发可以根据地址分布推断出是哪里占用 reserved 内存，从而进行裁剪、优化。第二种方法累积求和和第一种的 reserved 差不多（需要把最后那个 8192K 剪掉，这个是 cma 大小。cma 系统是可以使用的，不应该计算在 reserved  里面）。reserved（40025kb） + memoryTotal（486028kb） 会比 512Mb（例子中是 512 的样机） 大一点点，可能多多少少哪里又有点统计重复了。上面的注释是根据全志平台的 kernel 推断出来的。</p>
<h2 id="MAT">MAT</h2>
<p>MAT（MemoryAnalyzer）是一个分析 java heap 的工具，可以分析 java heap 中对象的引用情况。一般来说这个工具是用来分析 java 内存泄漏的，但是这个工具同时也可以拿来分析内存占用情况。我之前写过一篇 MAT 的使用文章可以参考一下：<a href="http://light3moon.com/2015/11/02/Android%20%E5%BA%94%E7%94%A8%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E5%88%86%E6%9E%90/" target="_blank" rel="external">Android 应用内存泄漏问题分析</a></p>
<p>MAT 可以在官网下载到：<a href="http://www.eclipse.org/mat/" target="_blank" rel="external">MAT下载地址</a>。使用方法就是抓取 dump heap 文件，让用 MAT 打开来分析。dump heap 可以使用 AndroidStudio 抓，也可以使用 sdk 里面的 monitor.bat  抓，但是我更喜欢用命令行抓：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># </span></div><div class="line"><span class="preprocessor"># 给进程发 10 信号量，是强制进行 gc，在抓之前排除一些弱引用的干扰</span></div><div class="line">kill -<span class="number">10</span> pid</div><div class="line"><span class="preprocessor"># am 的 dumpheap 命令把 java heap dump 出来，并保存到指定路径（一般 /data/local/tmp 会有权限）</span></div><div class="line">am dumpheap pid /data/local/xx.heap</div><div class="line"><span class="preprocessor"># 把 dump 的 heap pull 到 pc</span></div><div class="line">adb pull /data/local/xx.heap</div><div class="line"><span class="preprocessor"># hprof-conv 是 sdk platform-tools 下面的一个转化工具，转化之后的 hprof 文件就可以用 MAT 打开了</span></div><div class="line">hprof-conv xx.heap xx.hprof</div></pre></td></tr></table></figure>

<p>MAT 打开 hprof 文件后，一般选 Top Consumers（占内存最高的对象和Class）：</p>
<p><img src="https://mingming-killer.github.io/img/pics/android/perf-mem-opt/mat_biggest_objects.png" alt="最占内存的对象排行榜"></p>
<p>这张图显示的是 java 单个对象占用内存最高的排行榜（这里是 dump system_server 的）。从这里看到基本上没什么大的对象（一般来说像 Bitmap 这种就是大的对象），单个对象最大的也就才 500k。</p>
<p><img src="https://mingming-killer.github.io/img/pics/android/perf-mem-opt/mat_top_level_classes.png" alt="最占内存的对象排行榜"></p>
<p>这行图是显示占内存最多的类的排行榜。从这里可以看到都是数量巨大小对象占了内存。所以不是很好简单的针对优化。例如说如果有 Bitmap 这种大对象的就可以看看是不是可以剪裁掉。这里结合 system_server 应该是里面包含了很多服务对象导致，可以考虑删掉一些不需要的服务模块来减少一部分对象，来节省一些内存。</p>
<h2 id="malloc_debug">malloc_debug</h2>
<p>上一章的 MAT 是分析 java 内存的，这一章介绍的 malloc_debug 就是分析 native 内存的。它是 libc 的一个调试开关，打开之后 c 库会跟踪并记录每一个 malloc 的调用堆栈。下面是它的源码和说明：</p>
<p>android/bionic/libc/malloc_debug<br>android/bionic/libc/malloc_debug/README.md</p>
<p>调试普通 app 和 platform apk 是不太一样的，这里我们介绍 platform apk 的调试方法，因为我们这里是用来分析内存占用的。这个工具又分为：</p>
<p>​&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).中途抓取：</strong> 让应用先启动，然后发送一个信号量打开 malloc_debug 开关。这个适用于排查一些内存泄漏场景，并不适合我们这里分析系统模块的内存占用情况。<br>​&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).从开始抓取：</strong> 这个需要先把 malloc_debug 打开，然后再让应用运行，这样就能完整的记录下来每一个 native 的 malloc 申请，这样才能分析内存占用情况。</p>
<p>所以我们这里介绍的是基于 platform apk 从头开始抓取的用法（注意这里需要使用 userdebug 或是 eng 固件，user 固件是无法调试的）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># </span></div><div class="line"><span class="preprocessor"># stop 先终止所有的 android 进程</span></div><div class="line">stop</div><div class="line"><span class="preprocessor"># 下面2个属性就打开 malloc_debug 的开关：</span></div><div class="line"><span class="preprocessor"># libc.debug.malloc.program: 是配置需要开启 malloc_debug 的进程名字，由于 android 的 apk 都是</span></div><div class="line"><span class="preprocessor"># 由 zygote fork 出来的，所以只能让 zygote 进程开启 malloc_debug，zygote 进程就是 app_process </span></div><div class="line"><span class="preprocessor"># backtrace: 是记录 malloc 堆栈的深度，记录的堆栈越深越耗时，默认是 16</span></div><div class="line">setprop libc.debug.malloc.program app_process</div><div class="line">setprop libc.debug.malloc.options backtrace=<span class="number">8</span></div><div class="line"><span class="preprocessor"># 配置了上面属性开关后，重新让 android 系统进程启动</span></div><div class="line">start</div></pre></td></tr></table></figure>

<p>这里说明一下：让 app_process(zygote) 开启了 malloc_debug ，也就是让所有的 apk 进程开启了 malloc_debug ，这会导致 system_server 启动变得很慢，很容易造成卡死，然后触发 WatchDog 自动重启，导致抓取失败。有几个方面可以改善一下：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).</strong> 尽量选择内存大的机器来抓取，这个并不影响分析结果的。因为记录每一个 malloc 的堆栈，会额外占用内存。最少1G以上的，512M 的就不要抓取了，基本无法启动。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).</strong> 所以上面 backtrace 配置成 8，默认的 16 更加难以成功启动。<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(3).</strong> 注意观看 logcat，如果有报由于什么卡住了导致重启，就先把这个相关的功能先注释掉（例如说开启了 malloc_debug ，awbms 老是报错，我就先把 awbms 注释掉了）。</p>
<p>然后剩下的就是靠运气了不停的重试了，我在 A50 Android10 1G 的设备有一次成功启动了。启动了之后使用下面命令在抓取：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># </span></div><div class="line"><span class="preprocessor"># 抓取命令同样是 am dumpheap ，只不过抓 native 需要加上 -n</span></div><div class="line">am dumpheap -n pid /data/local/xx_heap.txt</div><div class="line"><span class="preprocessor"># adb pull 拉出来</span></div><div class="line">adb shell pull /data/local/xx_heap.txt</div><div class="line"></div><div class="line"><span class="preprocessor"># 在 sdk 的路径下面有一个转化脚本： development/scripts/native_heapdump_viewer.py</span></div><div class="line"><span class="preprocessor"># 这是一个 python 脚本，打开有使用说明：</span></div><div class="line"><span class="preprocessor"># --html: 表示要生成 html 报表，主要后面要自己重定向到 html 文件</span></div><div class="line"><span class="preprocessor"># --symbols： 这个是你抓取固件，编译出来的符号表，在 out/target/product/xx/symbols/ 下面，</span></div><div class="line"><span class="preprocessor">#   所以说要抓取分析的话，需要保留好编译固件的中间文件</span></div><div class="line">python native_heapdump_viewer.py --html --symbols xx xx_heap.txt &gt; xx_heap.html</div></pre></td></tr></table></figure>

<p>dumpheap -n 出来的 txt 就已经包含了每个 malloc 的调用堆栈，但是都是一些函数地址，需要自己去 maps 文件的代码段，去符号表里用 addr2line 反编译来看。这里就不介绍具体方法了（网上也有），sdk 里面这个 python 脚本就是帮我们转化了（所以他也是需要符号表的）。例如说转化出来的一个报表是（抓的是 Android 10 systemui 的）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Native allocation HTML viewer</div><div class="line"></div><div class="line">Click <span class="keyword">on</span> <span class="keyword">an</span> individual <span class="built_in">line</span> <span class="keyword">to</span> <span class="built_in">expand</span>/collapse <span class="keyword">to</span> see the details of the allocation data</div><div class="line"><span class="number">13945660</span> <span class="number">100.00</span>% <span class="number">22197</span> app</div><div class="line"><span class="number">2122038</span> <span class="number">100.00</span>% <span class="number">16699</span> zygote</div></pre></td></tr></table></figure>

<p>点开 app 开具体情况，zygote 的是父进程的：</p>
<p><img src="https://mingming-killer.github.io/img/pics/android/perf-mem-opt/systemui_native_heap.png" alt="systemui native heap"></p>
<p>systemui 的 native 堆栈一共 13.2MB（13945660 单位是字节）。下面的对象是按占用内存大小来排序的。排在第一个是一个 8MB 的 Bitmap decode 的时候申请的，占了 native heap 60% 的大小。这里我把堆栈配成了8，好像不是很直观的看到是哪里调用到的。但是 systemui 里面 8M 大小的 Bitmap，之前 dumpsys SurfaceFlinger 的时候看到 ImageWallpaper 申请的 Layer buffer 刚好是 8M。所以可以猜想到这个应该是 ImageWallpaper 加载的 Bitmap 申请的内存。然后去查看了一下相关代码，正是 SystemUI load ImageWallpaper 的 Bitmap 申请的内存。所以一张壁纸不光占用了显示 buffer（图层），同时加载的 Bitmap 也很占内存。如果不要壁纸的话，把图层和 Bitmap 都干掉，这里以 A50 Android10 1280x720 为例，可以节省 16M 的内存。</p>
<h2 id="工具小结">工具小结</h2>
<h3 id="内存总计">内存总计</h3>
<p>上面说了那么多，我们试着来看看统计一下系统各个模块内存的占用情况。我以上面的列举的数据为例：样机物理内存 512Mb，减去大概 40Mb 的 reserved，系统可用内存为： 486028 Kb。根据上面的理论知识，系统总共内存应该等于下面各个部分之和：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;(1). 所有进程的 Pss 之和：可使用 dumpsys meminfo 的中的统计。但是这个是包含了 Zram SwapPss 的，如果用这个，那应该减去 SwapPss 的部分（我认为可以使用 ZRAM 里面的  68,664K in swap - 22,368K physical used）。如果使用 procrank 的 Pss 统计之和，这个是不包含 SwapPss 的，所以应该把 Zram 22368K physical used 这部分加上。<br>&nbsp;&nbsp;&nbsp;&nbsp;(2). 缓存中 unmapp 的部分：这部分没有统计在进程 Pss 里面，可以使用 /proc/meminfo: Cached - Mapped<br>&nbsp;&nbsp;&nbsp;&nbsp;(3). 空闲内存：/proc/meminfo: free。<br>&nbsp;&nbsp;&nbsp;&nbsp;(4). Kernel Used：可以按照 dumpsys meminfo 的统计。<br>&nbsp;&nbsp;&nbsp;&nbsp;(5). Kernel Cached：也可以按照 dumpsys meminfo 的统计，但是这个计算公式把 (2) 那里也算上了。<br>&nbsp;&nbsp;&nbsp;&nbsp;(6). gralloc 申请的：前面有统计方法。<br>&nbsp;&nbsp;&nbsp;&nbsp;(7). cma：前面有统计方法。</p>
<p>其实仔细看上面这些部分，可以等效等于 dumpsys meminfo 中的 Free RAM + Used RAM - SwapPss + gralloc + cma。按这个计算：</p>
<p>168,297K + 292,956K - (68,664K - 22,368K) + (29347840 / 1024)K + 8192K = 451809Kb</p>
<p>和系统记录的 486028 kb 还有点差距。可能是哪里统计有漏洞（我也没一一去看统计代码，网上一些资料说这些统计是点有遗漏的），也有可能是例子这个样机还没支持 dumpsys meminfo GL（A50 Android 10），GPU 那部分内存没统计上（也不确定 GPU 驱动的是不是包含在哪个里面了）。然后其实进程 Pss 之和还可以用 procrank 的，前面也有说，再加上 Zram physical used 的。然后其他的内容去 /proc/meminfo 里面自己算。计算出来的结果和上面直接加 dumpsys meminfo 的差不多。那目前来说我感觉这样也挺接近可用内存了。</p>
<p>然后我去拿了一台支持 dumpsys meminfo GL 的样机（A100 Android 10），通过上面的计算公式计算，发现已经和可用内存很接近了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. dumpsys meminfo:</span></div><div class="line">Total RAM:   <span class="number">991</span>,<span class="number">364</span>K (status normal)</div><div class="line"> Free RAM:   <span class="number">239</span>,<span class="number">195</span>K (  <span class="number">121</span>,<span class="number">859</span>K cached pss +    <span class="number">85</span>,<span class="number">892</span>K cached kernel +    <span class="number">31</span>,<span class="number">444</span>K free)</div><div class="line"> Used RAM:   <span class="number">728</span>,<span class="number">265</span>K (  <span class="number">591</span>,<span class="number">361</span>K used pss +   <span class="number">136</span>,<span class="number">904</span>K kernel)</div><div class="line"> Lost RAM:    <span class="number">56</span>,<span class="number">974</span>K</div><div class="line">     ZRAM:    <span class="number">11</span>,<span class="number">908</span>K physical used <span class="keyword">for</span>    <span class="number">50</span>,<span class="number">128</span>K in swap (  <span class="number">743</span>,<span class="number">516</span>K total swap)</div><div class="line">         </div><div class="line"><span class="comment">// 2. cat /sys/kernel/debug/ion/heaps/sys_user:</span></div><div class="line">----------------------------------------------------</div><div class="line">  total orphaned         <span class="number">33128448</span></div><div class="line">          total          <span class="number">41689088</span>     </div><div class="line">         </div><div class="line"><span class="comment">// 3. cat /proc/meminfo:</span></div><div class="line">CmaTotal:           <span class="number">8192</span> kB</div><div class="line">CmaFree:            <span class="number">5224</span> kB</div><div class="line"></div></pre></td></tr></table></figure>

<p>239,195K + 728,265K - (50,128K - 11,908K) + (41689088/1024)K + 8192K = 978144Kb</p>
<p>我拿的 oppo X20（4G，Android 8.1）也试了下，发现也挺接近了的（cat ion 没权限，可以用 dumpsys SurfaceFlinger 代替，在没有多媒体播放或是 camera 的情况下，误差不会特别大）。那应该这个计算方式还算靠谱吧。</p>
<h3 id="应用内存分析">应用内存分析</h3>
<p>上面 dumpsys meminfo 还是 procrank 看到的 apk 进程占用的 Pss 都挺大的，但是其实单独 dumpsys meminfo pid 就会发现一般进程大部分都是一些文件缓存占用比较大（例如 Code、资源、库文件等）。可以单独看 Dalvik Heap 和 Native Heap，然后还能通过 MAT 和 malloc_debug 进一步分析是是哪些对象申请了内存。MAT 抓出来的 java heap 和 dumpsys meminfo pid 里面的 Dalvik Heap 中的 heap size 算是比较接近，但是还是有些差距，可能统计的内容有点不一样。malloc_debug 抓出来的 native heap 和 dumpsys meminfo pid 里面的 Native Heap 的 Total Pss 还是挺接近的，比 MAT 的误差小很多。</p>
<p>某些时候还能直接使用 /proc/pid/maps 或是 /proc/pid/smaps 直接分析，也可以使用 PageMap 具体查看应用的匿名内存页和文件缓存页情况。</p>
<h1 id="优化思路">优化思路</h1>
<h2 id="Kernel">Kernel</h2>
<h3 id="Kernel_used-1">Kernel used</h3>
<p>按第一章的 kernel used 拆分，目前我的认知来说：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).</strong> 可以优化 Slab 的占用<br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).</strong> 可以去掉一些无用的，但是却加载了的 ko 模块</p>
<p>不过这个需要 kernel 的同事来分析，目前暂时还没接触到案例。以后接触到再补充。</p>
<h3 id="Kernel_reserved-1">Kernel reserved</h3>
<p>kernel reserved 的大小直接决定了开机后 MemTotal 的大小。从第一章的拆分来看：</p>
<p>​&nbsp;&nbsp;&nbsp;&nbsp;<strong>(1).精简代码段:</strong> 可通过 kernel 的 config 去掉一些无用的模块，这样可以节省一部分 kernel 代码段的占用。一般也是需要 kernel 的同事进行确认。例如说 R818 Android 10 1G 方案通过 menuconfig 去掉无用模块，代码段节省了 2M。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>(2).删除 optee 部分内容:</strong> 这里就是第一章分析的 atf 那部分。如果是非安全系统，是几乎可以把整个 atf 部分删掉的（好像需要留1、2M吧）。如果是安全系统，那么根据需求可以删去一部分，例如说 R818 Android 10 1G 方案就删掉了 gatekeeper 和 keymaster（具体删掉方案得找相关负责人弄），atf 部分节省了 14M。</p>
<h3 id="快速回收">快速回收</h3>
<p>这个是在研究竞品hisi系统上发现的一个方法，原理是快速（强制）让 kernel 回收后台应用的匿名页面（anon）和文件缓存（file），从而达到增大 free+cache 的目的。kernel 原生有个 /proc/sys/vm/drop_caches 接口（echo 1 是释放 cache，echo 2 是释放 slab，echo 3 = 1+2），但是效果不是特别明显（很多占用的 cache 其实释放不掉）。kernel 同事仿造这个思路在 5.4 的 kernel 新增了一个接口（目前还处于调试阶段，我提前拿到补丁在 A133 上试了一下）：/proc/sys/vm/reclaim ，用法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># </span></div><div class="line"><span class="comment"># pid: 要回收的进程，可以自己制定一些策略，强制回收哪些进程（例如可以参考一下 oom adjust score）</span></div><div class="line"><span class="comment"># 1: 代表回收 anon，2 代表回收 file， 3 = 1+2</span></div><div class="line">echo pid <span class="number">1</span> &gt; /<span class="keyword">proc</span>/sys/vm/reclaim</div></pre></td></tr></table></figure>

<p>在 A133 B3 上以切换到后台的 Settings 为例，效果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 强制回收前：</span></div><div class="line"><span class="comment">// dumpsys meminfo:</span></div><div class="line">** MEMINFO in pid <span class="number">1615</span> [com.android.settings] **</div><div class="line">                   Pss  Private  Private     Swap      Rss     Heap     Heap     Heap</div><div class="line">                 Total    Dirty    Clean    Dirty    Total     Size    Alloc     Free</div><div class="line">                ------   ------   ------   ------   ------   ------   ------   ------</div><div class="line">  Native Heap     <span class="number">4105</span>     <span class="number">4048</span>        <span class="number">0</span>        <span class="number">0</span>     <span class="number">5640</span>     <span class="number">5540</span>     <span class="number">4334</span>     <span class="number">1205</span></div><div class="line">  Dalvik Heap     <span class="number">2889</span>     <span class="number">2832</span>        <span class="number">0</span>        <span class="number">0</span>     <span class="number">3904</span>     <span class="number">3480</span>     <span class="number">2610</span>      <span class="number">870</span></div><div class="line"> Dalvik Other      <span class="number">613</span>      <span class="number">428</span>        <span class="number">0</span>        <span class="number">0</span>     <span class="number">1268</span></div><div class="line">        Stack      <span class="number">508</span>      <span class="number">508</span>        <span class="number">0</span>        <span class="number">0</span>      <span class="number">512</span></div><div class="line">       Ashmem        <span class="number">2</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>       <span class="number">16</span></div><div class="line">    Other dev       <span class="number">44</span>        <span class="number">0</span>       <span class="number">44</span>        <span class="number">0</span>      <span class="number">260</span></div><div class="line">     .so mmap     <span class="number">2768</span>      <span class="number">212</span>        <span class="number">0</span>        <span class="number">0</span>    <span class="number">32600</span></div><div class="line">    .jar mmap     <span class="number">2112</span>        <span class="number">0</span>      <span class="number">108</span>        <span class="number">0</span>    <span class="number">19236</span></div><div class="line">    .apk mmap     <span class="number">5052</span>        <span class="number">0</span>     <span class="number">4380</span>        <span class="number">0</span>     <span class="number">7236</span></div><div class="line">    .ttf mmap       <span class="number">63</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>      <span class="number">248</span></div><div class="line">    .dex mmap      <span class="number">678</span>       <span class="number">16</span>      <span class="number">644</span>        <span class="number">0</span>      <span class="number">732</span></div><div class="line">    .oat mmap     <span class="number">1128</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>    <span class="number">12956</span></div><div class="line">    .art mmap     <span class="number">3101</span>     <span class="number">2456</span>        <span class="number">8</span>        <span class="number">0</span>    <span class="number">13828</span></div><div class="line">   Other mmap      <span class="number">112</span>       <span class="number">32</span>        <span class="number">0</span>        <span class="number">0</span>     <span class="number">1136</span></div><div class="line">      Unknown      <span class="number">408</span>      <span class="number">404</span>        <span class="number">0</span>        <span class="number">0</span>      <span class="number">596</span></div><div class="line">        TOTAL    <span class="number">23583</span>    <span class="number">10936</span>     <span class="number">5184</span>        <span class="number">0</span>    <span class="number">23583</span>     <span class="number">9020</span>     <span class="number">6944</span>     <span class="number">2075</span></div><div class="line">        </div><div class="line"><span class="comment">// PageMap 统计：</span></div><div class="line"><span class="comment">// 1G 设备内存充足，占时没有用到 Zram，所以 Swap 是 0</span></div><div class="line">Swapped: <span class="number">0</span></div><div class="line"></div><div class="line">anon inactive lru: <span class="number">0</span></div><div class="line">anon active lru: <span class="number">6913</span></div><div class="line">anon undirty lru: <span class="number">6913</span></div><div class="line"></div><div class="line">file inactive lru: <span class="number">3435</span></div><div class="line">file active lru: <span class="number">14458</span></div><div class="line">file unique inactive lru: <span class="number">664</span></div><div class="line">file unique active lru: <span class="number">624</span></div><div class="line">file unique undirty lru: <span class="number">1286</span></div><div class="line"></div></pre></td></tr></table></figure>

<p>使用 echo 3 进行强制 anon + file 回收后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// dumpsys meminfo: </span></div><div class="line">** MEMINFO in pid <span class="number">1615</span> [com.android.settings] **</div><div class="line">                   Pss  Private  Private  SwapPss      Rss     Heap     Heap     Heap</div><div class="line">                 Total    Dirty    Clean    Dirty    Total     Size    Alloc     Free</div><div class="line">                ------   ------   ------   ------   ------   ------   ------   ------</div><div class="line">  Native Heap       <span class="number">48</span>       <span class="number">48</span>        <span class="number">0</span>     <span class="number">3583</span>       <span class="number">64</span>     <span class="number">5056</span>     <span class="number">4123</span>      <span class="number">932</span></div><div class="line">  Dalvik Heap        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>     <span class="number">2141</span>        <span class="number">0</span>     <span class="number">3458</span>     <span class="number">2594</span>      <span class="number">864</span></div><div class="line"> Dalvik Other        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>      <span class="number">427</span>        <span class="number">0</span></div><div class="line">        Stack       <span class="number">84</span>       <span class="number">84</span>        <span class="number">0</span>      <span class="number">424</span>       <span class="number">88</span></div><div class="line">    Other dev       <span class="number">12</span>        <span class="number">0</span>       <span class="number">12</span>        <span class="number">0</span>      <span class="number">180</span></div><div class="line">     .so mmap      <span class="number">146</span>       <span class="number">12</span>        <span class="number">0</span>      <span class="number">238</span>     <span class="number">4284</span></div><div class="line">    .jar mmap       <span class="number">83</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>     <span class="number">1480</span></div><div class="line">    .apk mmap        <span class="number">1</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>       <span class="number">32</span></div><div class="line">    .dex mmap        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>       <span class="number">16</span>        <span class="number">0</span></div><div class="line">    .oat mmap       <span class="number">82</span>        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>     <span class="number">1352</span></div><div class="line">    .art mmap       <span class="number">53</span>        <span class="number">0</span>        <span class="number">0</span>     <span class="number">3032</span>     <span class="number">1016</span></div><div class="line">   Other mmap       <span class="number">30</span>       <span class="number">24</span>        <span class="number">0</span>        <span class="number">8</span>      <span class="number">532</span></div><div class="line">      Unknown        <span class="number">0</span>        <span class="number">0</span>        <span class="number">0</span>      <span class="number">408</span>        <span class="number">8</span></div><div class="line">        TOTAL    <span class="number">10816</span>      <span class="number">168</span>       <span class="number">12</span>    <span class="number">10277</span>    <span class="number">10816</span>     <span class="number">8514</span>     <span class="number">6717</span>     <span class="number">1796</span></div><div class="line">        </div><div class="line"><span class="comment">// PageMap:</span></div><div class="line">Swapped: <span class="number">3343</span></div><div class="line"></div><div class="line">anon inactive lru: <span class="number">2525</span></div><div class="line">anon active lru: <span class="number">1000</span></div><div class="line">anon undirty lru: <span class="number">3525</span></div><div class="line"></div><div class="line">file inactive lru: <span class="number">1514</span></div><div class="line">file active lru: <span class="number">1445</span></div><div class="line">file unique inactive lru: <span class="number">508</span></div><div class="line">file unique active lru: <span class="number">484</span></div><div class="line">file unique undirty lru: <span class="number">969</span></div><div class="line"></div></pre></td></tr></table></figure>

<p>可以看到强制回收后，在后台 Settings 的 Pss 大量减少，通过 PageMap 看到匿名页面和缓存页面大量被换入 Swap 分区。如果对所有后台进程都进行这个操作，那么 free+cache 将会大量增加（国旭测试 512M 方案大概可以增加 40-50M）。</p>
<p>但是这个方案也是有弊端的，因为它的是通过牺牲了后台进程的缓存，来换取前台进程的可用内存。当再次切换到后台进程的时候经过强制回收后的进程，Activity 速度明显慢了一个档次。在 A133 上将 Settings 切换到后台，对比正常温启动和强制回收后的温启动2次启动的时间：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor"># </span></div><div class="line"><span class="preprocessor"># 正常温启动 Settings:</span></div><div class="line"><span class="label">ActivityTaskManager:</span> Displayed <span class="keyword">com</span>.android.settings/.Settings: +<span class="number">412</span>ms</div><div class="line"><span class="preprocessor"># 强制回收后温启动 Settings：</span></div><div class="line"><span class="label">ActivityTaskManager:</span> Displayed <span class="keyword">com</span>.android.settings/.Settings: +<span class="number">1</span>s416ms</div></pre></td></tr></table></figure>

<p>可以看到，强制回收后，由于失去了缓存的作用，温启动速度大幅度慢于正常的温启动。所以这方案仅适用于内存十分低下的设备（例如说 512）。io 很慢的 nand 设备也要慎用，因为强制回收后，不光是要从 Swap 解压内存，某些还是需要重新从磁盘 load 数据的，这会进一步放大 nand 设备 io 瓶颈问题。</p>
<h2 id="Android">Android</h2>
<h3 id="删除无用模块">删除无用模块</h3>
<p>这个是最简单，也是最有效的优化手段。随着 Android 版本的更新，功能增多和模块框架化的同时，进程会越来越多和臃肿。用  dumpsys meminfo 看看，结合具体产品看看，哪些 Pss 大，又用不到的模块就可以想办法删掉。其中有不少的模块都是可以直接删掉的，有一些可能需要改改代码，这个需要具体模块具体分析。在 R818 Android10 1G 方案上我列了一个表，删掉了 68 个 模块（有很多是主题 Overlay 只是能省一点 emmc 而已，并不能省运行内存）。删模块的时候最好一个一个的删，删除之后测试一下一些产品的基本功能是否正常，再进行下一个会比较好。</p>
<p>删一些系统自带的模块，可能无法避免要去修改 build/core 下面系统的编译脚本，这里介绍一个办法，可以巧妙的删除系统自带模块，而又不用修改系统编译脚本：</p>
<p>Android 的 .mk 文件里面有一个 LOCAL_OVERRIDES_PACKAGES 的配置，就是可以用当前的模块覆盖已有的模块。我们只需要在 vendor 下面新建一个空壳的模块（例如说 apk），然后把想要删除的原生模块给 override 掉就变相把这些原生模块给删掉了。例如说空壳 .mk 可以这样写：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># </span></div><div class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">#</span></div><div class="line"><span class="attribute">LOCAL_PATH</span>:= $(call my-dir)</div><div class="line"></div><div class="line">include $(CLEAR_VARS)</div><div class="line">LOCAL_PACKAGE_NAME := PackageOverride</div><div class="line">LOCAL_MODULE_TAGS := optional</div><div class="line">LOCAL_CERTIFICATE := platform</div><div class="line">LOCAL_PRODUCT_MODULE := <span class="literal">true</span></div><div class="line">LOCAL_OVERRIDES_PACKAGES := $(GLOBAL_REMOVED_PACKAGES)</div><div class="line"><span class="comment">#LOCAL_SRC_FILES := $(call all-java-files-under, src)</span></div><div class="line">LOCAL_SDK_VERSION := current</div><div class="line">include $(BUILD_PACKAGE)</div></pre></td></tr></table></figure>

<p>其中 GLOBAL_REMOVED_PACKAGES 就是我们自定义的全局变量，可以在方案的 .mk 中配置这个变量，把想要删除的原生模块加到这个变量里面，例如说下面就是 R818 Android 10 1G 方案配置删除的原生模块：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="special">#</span> Remove Some unuse system package to save memory.</div><div class="line">GLOBAL_REMOVED_PACKAGES := <span class="command">\</span></div><div class="line">    MmsService <span class="command">\</span></div><div class="line">    Telecom <span class="command">\</span></div><div class="line">    TelephonyProvider <span class="command">\</span></div><div class="line">    TeleService <span class="command">\</span></div><div class="line">    SecureElement <span class="command">\</span></div><div class="line">    CalendarProvider <span class="command">\</span></div><div class="line">    Calendar <span class="command">\</span></div><div class="line">    Contacts <span class="command">\</span></div><div class="line">    Email <span class="command">\</span></div><div class="line">    DeskClock <span class="command">\</span></div><div class="line">    QuickSearchBox <span class="command">\</span></div><div class="line">    ExactCalculator <span class="command">\</span></div><div class="line">    Calculator <span class="command">\</span></div><div class="line">    WallpaperPicker2 <span class="command">\</span></div><div class="line">    Browser2 <span class="command">\</span></div><div class="line">    Gallery2 <span class="command">\</span></div><div class="line">    BookmarkProvider <span class="command">\</span></div><div class="line">    Camera2 <span class="command">\</span></div><div class="line">    CtsShimPrebuilt <span class="command">\</span></div><div class="line">    CtsShimPrivPrebuilt <span class="command">\</span></div><div class="line">    DocumentsUI <span class="command">\</span></div><div class="line">    BasicDreams <span class="command">\</span></div><div class="line">    EasterEgg <span class="command">\</span></div><div class="line">    Music <span class="command">\</span></div><div class="line">    MusicFX <span class="command">\</span></div><div class="line">    WallpaperCropper <span class="command">\</span></div><div class="line">    WallpaperBackup <span class="command">\</span></div><div class="line">    HTMLViewer <span class="command">\</span></div><div class="line">    SoundRecorder <span class="command">\</span></div><div class="line">    VideoPlayer <span class="command">\</span></div><div class="line">    BuiltInPrintService <span class="command">\</span></div><div class="line">    NfcNci <span class="command">\</span></div><div class="line">    OneTimeInitializer <span class="command">\</span></div><div class="line">    PrintRecommendationService <span class="command">\</span></div><div class="line">    frameworks-base-overlays <span class="command">\</span></div><div class="line">    DynamicSystemInstallationService <span class="command">\</span></div><div class="line">    LocalTransport <span class="command">\</span></div><div class="line">    ManagedProvisioning <span class="command">\</span></div><div class="line">    mediametrics <span class="command">\</span></div><div class="line">    mediadrmserver <span class="command">\</span></div><div class="line">    drmserver <span class="command">\</span></div><div class="line">    vr</div></pre></td></tr></table></figure>

<h3 id="精简模块内容">精简模块内容</h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;(1). 可以参看 1.10 和 1.11 小结的内容，找到模块中最占资源的内容，看看是不是可以精简掉。例如说在某些产品上精简掉不必要的壁纸，就能节省不少内存（同时去掉显示 Layer 和加载的 Bitmap）。如果说实在要保留壁纸，也可以限制壁纸的大小，让其不超过屏幕的大小，也能节省一些内存。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;(2). 可以参考 Android Watch 的一些宏定义，精简 SystemService 一些不需要的服务，可以减少 SystemService 的一些占用。还可以去掉 Class 预加载，但是这个会减慢应用启动速度。</p>
<p>后续有什么新发现，再补充。</p>
<h3 id="资源瘦身">资源瘦身</h3>
<p>例如一些 ttf 字体和 apk 的体积，应该可以减少 file cache 的占用。虽然 file cache 也可以算上可用内存，但是多余的资源占用的 file cache 还是比不上 free 内存好。这部分占时还没怎么研究，不太清楚效果，只是根据前面的理论分析得出一个思路。</p>
<p>待补充。</p>
<h3 id="虚拟机参数调优">虚拟机参数调优</h3>
<p>待补充。</p>
<h3 id="lmk_参数调优">lmk 参数调优</h3>
<p>待补充。</p>
<h2 id="多媒体">多媒体</h2>
<p>在低内存方案如何在解码一些大分辨率、高帧率视频，可能会存在解码器占用内存过多的情况。这个时候可以适当的降低一些解码器的 buffer 数量来减少内存占用。但是好像会稍微降低视频的平滑度。例如说之前 H313 512M 方案预研的时候曾经将 vbv buffer 调整了8M，去掉降噪模块，减少3个 framebuffer。这个具体需要多媒体的同事来分析、优化。而且这个优化只针对视频播放场景（解码场景），不过我们的产品关键场景就是视频播放。</p>
<h1 id="参考资料">参考资料</h1>
<p>(1). dumpsys meminfo 源码（Android 10）： android/frameworks/services/core/java/com/android/server/am/ActivityManagerService.java: dumpApplicationMemoryUsage()<br>(2). dumpsys meminfo pid 源码（Android 10）: android/frameworks/base/core/java/android/app/ActivityThread.java: dumpMemInfoTable()<br>(3). procrank 源码（Android 10）:  android/system/core/libmeminfo/tools/procrank.cpp<br>(4). <a href="http://linuxperf.com/?p=142" target="_blank" rel="external">/PROC/MEMINFO之谜</a><br>(5).<a href="https://www.kernel.org/doc/Documentation/blockdev/zram.txt" target="_blank" rel="external">Kernel Zram 说明</a><br>(6).<a href="https://source.android.com/devices/tech/config/low-ram?hl=zh-cn#zram" target="_blank" rel="external">Android Zram 说明</a><br>(7).<a href="http://kernel.meizu.com/zram-introduction.html" target="_blank" rel="external">zram 简介</a><br>(8).<a href="https://developer.android.com/topic/performance/memory-management" target="_blank" rel="external">Android 进程内存分配说明</a><br>(9).<a href="https://www.jianshu.com/p/8203457a11cc" target="_blank" rel="external">Linux内存管理 — /proc/{pid}/smaps讲解</a><br>(10).<a href="https://www.cnblogs.com/pengdonglin137/p/6802108.html" target="_blank" rel="external">利用/proc/pid/pagemap将虚拟地址转换为物理地址</a><br>(11).<a href="https://www.cnblogs.com/pengdonglin137/p/6802108.html" target="_blank" rel="external">pagemap和VSS/USS/PSS/RSS的计算</a><br>(12).<a href="https://github.com/andywarduk/PageMap" target="_blank" rel="external">PageMap统计工具GitHub</a></p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/android/">android</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Performance/">Performance</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.light3moon.com/2020/12/07/Android 内存优化方法/" data-title="Android 内存优化方法 | Light.Moon" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2020/09/18/Android 多媒体通路简介/"  title="Android 多媒体通路简介">
 <strong>下一篇:</strong><br/> 
 <span>Android 多媒体通路简介
</span>
</a>
</div>

</nav>


	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#统计方法"><span class="toc-number">1.</span> <span class="toc-text">统计方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dumpsys_meminfo"><span class="toc-number">1.1.</span> <span class="toc-text">dumpsys meminfo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Total_RAM:"><span class="toc-number">1.1.1.</span> <span class="toc-text">Total RAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Free_RAM:"><span class="toc-number">1.1.2.</span> <span class="toc-text">Free RAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Used_RAM:"><span class="toc-number">1.1.3.</span> <span class="toc-text">Used RAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZRAM:"><span class="toc-number">1.1.4.</span> <span class="toc-text">ZRAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lost_RAM:"><span class="toc-number">1.1.5.</span> <span class="toc-text">Lost RAM:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tuning:"><span class="toc-number">1.1.6.</span> <span class="toc-text">Tuning:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dumpsys_meminfo_pid:"><span class="toc-number">1.1.7.</span> <span class="toc-text">dumpsys meminfo pid:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#procrank"><span class="toc-number">1.2.</span> <span class="toc-text">procrank</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#进程列表："><span class="toc-number">1.2.1.</span> <span class="toc-text">进程列表：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZRAM："><span class="toc-number">1.2.2.</span> <span class="toc-text">ZRAM：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RAM："><span class="toc-number">1.2.3.</span> <span class="toc-text">RAM：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/proc/pid/maps"><span class="toc-number">1.3.</span> <span class="toc-text">/proc/pid/maps</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/proc/pid/smaps"><span class="toc-number">1.4.</span> <span class="toc-text">/proc/pid/smaps</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/proc/meminfo"><span class="toc-number">1.5.</span> <span class="toc-text">/proc/meminfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PageMap"><span class="toc-number">1.6.</span> <span class="toc-text">PageMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ion"><span class="toc-number">1.7.</span> <span class="toc-text">ion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel_used"><span class="toc-number">1.8.</span> <span class="toc-text">Kernel used</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel_reserved"><span class="toc-number">1.9.</span> <span class="toc-text">Kernel reserved</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MAT"><span class="toc-number">1.10.</span> <span class="toc-text">MAT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc_debug"><span class="toc-number">1.11.</span> <span class="toc-text">malloc_debug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工具小结"><span class="toc-number">1.12.</span> <span class="toc-text">工具小结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#内存总计"><span class="toc-number">1.12.1.</span> <span class="toc-text">内存总计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用内存分析"><span class="toc-number">1.12.2.</span> <span class="toc-text">应用内存分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#优化思路"><span class="toc-number">2.</span> <span class="toc-text">优化思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel"><span class="toc-number">2.1.</span> <span class="toc-text">Kernel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel_used-1"><span class="toc-number">2.1.1.</span> <span class="toc-text">Kernel used</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel_reserved-1"><span class="toc-number">2.1.2.</span> <span class="toc-text">Kernel reserved</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速回收"><span class="toc-number">2.1.3.</span> <span class="toc-text">快速回收</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android"><span class="toc-number">2.2.</span> <span class="toc-text">Android</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#删除无用模块"><span class="toc-number">2.2.1.</span> <span class="toc-text">删除无用模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#精简模块内容"><span class="toc-number">2.2.2.</span> <span class="toc-text">精简模块内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#资源瘦身"><span class="toc-number">2.2.3.</span> <span class="toc-text">资源瘦身</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#虚拟机参数调优"><span class="toc-number">2.2.4.</span> <span class="toc-text">虚拟机参数调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lmk_参数调优"><span class="toc-number">2.2.5.</span> <span class="toc-text">lmk 参数调优</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多媒体"><span class="toc-number">2.3.</span> <span class="toc-text">多媒体</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android-Development/" title="Android Development">Android Development<sup>32</sup></a></li>
		
			<li><a href="/categories/Android-Framework/" title="Android Framework">Android Framework<sup>48</sup></a></li>
		
			<li><a href="/categories/Basics-Knowledge/" title="Basics Knowledge">Basics Knowledge<sup>11</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>24</sup></a></li>
		
			<li><a href="/categories/MiniGUI/" title="MiniGUI">MiniGUI<sup>12</sup></a></li>
		
			<li><a href="/categories/Other/" title="Other">Other<sup>9</sup></a></li>
		
			<li><a href="/categories/Performance/" title="Performance">Performance<sup>4</sup></a></li>
		
			<li><a href="/categories/Window/" title="Window">Window<sup>10</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		
			<li><a href="/tags/android/" title="android">android<sup>84</sup></a></li>
		
			<li><a href="/tags/basics/" title="basics">basics<sup>11</sup></a></li>
		
			<li><a href="/tags/install/" title="install">install<sup>9</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>27</sup></a></li>
		
			<li><a href="/tags/minigui/" title="minigui">minigui<sup>13</sup></a></li>
		
			<li><a href="/tags/opengl/" title="opengl">opengl<sup>3</sup></a></li>
		
			<li><a href="/tags/other/" title="other">other<sup>5</sup></a></li>
		
			<li><a href="/tags/server/" title="server">server<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>5</sup></a></li>
		
			<li><a href="/tags/window/" title="window">window<sup>11</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">我的链接</p>
    <ul>
      <li><i class="fa fa-github"></i> <a href="https://github.com/mingming-killer" target="_blank">GitHub</a></li>
      
        
          <li><i class="fa fa-analytics"></i> <a href="http://tongji.baidu.com/web/welcome/ico?s=fa045dbd45ffce238b146e00f91ba6a3" target="_blank">网站数据统计</a></li>
        
      
      <li><i class="fa fa-markdown-help"></i> <a href="http://zh.wikipedia.org/wiki/Markdown" target="_blank">Makrdown</a></li>
    </ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <li><i class="fa fa-book"></i> <a href="http://taoyuanxiaoqi.com" target="_blank">桃园小七的博客</a></li>
      <li><i class="fa fa-book"></i> <a href="https://dongka.github.io" target="_blank">Dongka的博客</a></li>
    </ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
<!--
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
-->

     <!-- this is defined in footer.styl, line holder -->
	<div class="line">
	</div>
     
<!--
	<div class="social-font clearfix">
		
		
		
		
		
		<a href="https://github.com/mingming-killer" target="_blank" title="github"></a>
		
        	         
	</div>
-->

		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/mingming-killer/Lightmoon" target="_blank" title="Lightmoon">Lightmoon</a> © 2021 
		
		<a href="http://www.light3moon.com" target="_blank" title="Mingming">Mingming</a>
		
		</p>

  <!-- baidu search verification -->
  
    <meta name="baidu-site-verification" content="w1BSX6yZ9k" />
  

  <!-- swiftype search verification -->
  

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fa045dbd45ffce238b146e00f91ba6a3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>
