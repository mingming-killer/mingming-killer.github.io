
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

  
    <title>Android SystemUI 分析——通知 | Light.Moon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Mingming">
    
    <meta name="description" content="Notification 作为 android 系统中的一种提醒类的 UI，其实不是很复杂。但是过了些时候又有点忘记了，又要去翻代码，所以还是稍微总结记录一下比较好。这里不会说得太深，就是一些 Notification 比较基本的东西（浅析一下吧），我们先照例把相关代码位置啰嗦一下（4.2.2）：
">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/apple_icon.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/apple_icon.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
		<div id="header_author">
		</div>
		

         <!--
         
           <div id="imglogo">
           <a href="/"><img src="/img/logo.svg" alt="Light.Moon" title="Light.Moon"/></a>
           </div>
         
         -->

			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Light.Moon">Light.Moon</a></h1>
				<h2 class="blog-motto">〜(￣△￣〜) 三月学长的根据地 (〜￣△￣)〜</h2>
			</div>

			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/1986/12/20/文章索引">索引</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					

                      <form class="search" action=http://search.light3moon.com/cse/search target="_blank">
                      <label>搜索</label>
                      <!--
                      <input name="s" type="hidden" value="undefined">
                      -->
                      <input name="s" type="hidden" value="12628367885198549364">
                      <input type="text" name="q" size="30" placeholder="搜索"> <br>

                      
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/02/06/Android SystemUI 分析——通知/" title="Android SystemUI 分析——通知" itemprop="url">Android SystemUI 分析——通知</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.light3moon.com" title="Mingming">Mingming</a>
    </p>
  <p class="article-time">
    <time datetime="2015-02-06T02:17:16.000Z" itemprop="datePublished">2015 2月 6</time>
    更新日期:<time datetime="2015-02-09T01:15:16.000Z" itemprop="dateModified">2015 2月 9</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#UI_表现"><span class="toc-number">1.</span> <span class="toc-text">UI 表现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通知标示"><span class="toc-number">2.</span> <span class="toc-text">通知标示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Content"><span class="toc-number">3.</span> <span class="toc-text">Content</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#直接设置_Notification"><span class="toc-number">3.1.</span> <span class="toc-text">直接设置 Notification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用_Notification-Builder"><span class="toc-number">3.2.</span> <span class="toc-text">使用 Notification.Builder</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#系统处理流程"><span class="toc-number">4.</span> <span class="toc-text">系统处理流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小技巧"><span class="toc-number">5.</span> <span class="toc-text">小技巧</span></a></li></ol>
		</div>
		
		<p>Notification 作为 android 系统中的一种提醒类的 UI，其实不是很复杂。但是过了些时候又有点忘记了，又要去翻代码，所以还是稍微总结记录一下比较好。这里不会说得太深，就是一些 Notification 比较基本的东西（浅析一下吧），<br>我们先照例把相关代码位置啰嗦一下（4.2.2）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 应用接口相关代码</span></div><div class="line">frameworks/base/core/java/android/app/Notification.java</div><div class="line">frameworks/base/core/java/android/app/NotificationManager.java</div><div class="line"></div><div class="line"><span class="comment"># 系统内部接口相关代码</span></div><div class="line">frameworks/base/core/java/com/android/internal/statusbar/StatusBarNotification.java</div><div class="line">frameworks/base/core/java/com/android/internal/statusbar/StatusBarIcon.java</div><div class="line"></div><div class="line"><span class="comment"># System Server 相关代码</span></div><div class="line">frameworks/base/services/java/com/android/server/NotificationManagerService.java</div><div class="line">frameworks/base/services/java/com/android/server/StatusBarManagerService.java</div><div class="line"></div><div class="line"><span class="comment"># SystemUI 相关代码</span></div><div class="line">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/NotificationData.java</div><div class="line">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarIconView.java</div><div class="line">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/BaseStatusBar.java</div><div class="line">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBar.java</div><div class="line">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/Ticker.java</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="UI_表现">UI 表现</h2>
<p>目前 android 系统中的通知 UI 表现有3种：</p>
<ul>
<li><p><strong>Ticker</strong><br>就是刚发送一条通知的时候，通知栏上会有 一个小图标 + 一条文本 伴随一个滚动动画滚动出来，过一小段时间（3s）后会消失。作用是用一个动态效果告诉用户有一条通知来了。</p>
</li>
<li><p><strong>StatusBar Icon</strong><br>当 Ticker 消失后，状态栏的左上角就会多一个小图标（和刚刚 Ticker 的小图标一样），告诉用户已经有一条通知了。</p>
</li>
<li><p><strong>Notification Row</strong><br>发送一条通知后，下拉通知面板中的通知列表中会多一条通知行。上面那2个相当于是预览信息，这里的就是通知的完整信息了（不过话说本来通知就是应用程序的预览信息）。</p>
</li>
</ul>
<p>所以说应用要对系统发送一条通知，显示上可以设置的就是这3大块（效果图见后面的系统分析那里），还有一个可以设置的是不可见的部分——PendingIntent：点击通知要完成的动作，一般是启动某个程序的 Activity 界面（还可以设置一个通知被删除时候的动作）。</p>
<p>通知分为2种：</p>
<ol>
<li>可删除的：这种可以在通知面板上由用户用手动删除，删除后，状态栏上对应的这条通知的小图标也会被删除掉（一般的通知类通知可以用这种）。</li>
<li>不可删除的：这种通知用户无法手动删除，只能由发送通知的程序用代码取消掉（一些工具类的挂在通知面板上的快捷方式可以用这种，例如音乐播放器）。当然这种方式可能会被一些流氓应用利用，长按这条通知，然后可以查看到发送这条通知的应用（系统设置中），强制终止掉发送通知的 apk（在系统设置中强制终止 apk 或是进程自己挂掉了，发送的通知会被清楚掉）。当然还可以更狠点，直接禁止这个 apk 发送通知。</li>
</ol>
<p>上面那2种类型可以通过设置 Notification 的 flags <code>FLAG_NO_CLEAR</code> 来表示。同时还有一个容易和这个搞混的标志叫： <code>FLAG_ONGOING_EVENT</code> 这个表示发送这条通知的应用正在进行某些工作。设置了这个正在进行的标志，效果和设置不可删除的是一样的，用户同样无法手动去删除这条通知。在老的 android 版本（好像应该是 4.0 以前），通知面板上显示通知是分2组显示的，一组叫“正在进行的”，一组叫“通知”。设置了 <code>FLAG_ONGOING_EVENT</code> 会被分到“正在进行的”那组，其他的在“通知”组。不过从 4.0 开始，android 改了设计了，全都归到一组去显示了。所以 4.0 以后，<code>FLAG_ONGOING_EVENT</code> 从视觉上看不出和没设置的有啥区别的（当然如果你自己定制的 framework 你可以继续改回分组的显示方式）。</p>
<h2 id="通知标示">通知标示</h2>
<p>应用 new 一个 Notification 之后，获取 NotificationManager(NM) 之后，调用相应的接口就可以发送通知：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ================== NotificationManager.java =====================</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Post a notification to be shown in the status bar. If a notification with</span></div><div class="line"><span class="comment">     * the same id has already been posted by your application and has not yet been canceled, it</span></div><div class="line"><span class="comment">     * will be replaced by the updated information.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * @param id An identifier for this notification unique within your</span></div><div class="line"><span class="comment">     *        application.</span></div><div class="line"><span class="comment">     * @param notification A {@link Notification} object describing what to show the user. Must not</span></div><div class="line"><span class="comment">     *        be null.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span>(<span class="keyword">int</span> id, Notification notification) {</div><div class="line">        notify(<span class="keyword">null</span>, id, notification);</div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Post a notification to be shown in the status bar. If a notification with</span></div><div class="line"><span class="comment">     * the same tag and id has already been posted by your application and has not yet been</span></div><div class="line"><span class="comment">     * canceled, it will be replaced by the updated information.</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * @param tag A string identifier for this notification.  May be {@code null}.</span></div><div class="line"><span class="comment">     * @param id An identifier for this notification.  The pair (tag, id) must be unique</span></div><div class="line"><span class="comment">     *        within your application.</span></div><div class="line"><span class="comment">     * @param notification A {@link Notification} object describing what to</span></div><div class="line"><span class="comment">     *        show the user. Must not be null.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span>(String tag, <span class="keyword">int</span> id, Notification notification) {</div><div class="line">        <span class="keyword">int</span>[] idOut = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</div><div class="line">        INotificationManager service = getService();</div><div class="line">        String pkg = mContext.getPackageName();</div><div class="line">        <span class="keyword">if</span> (notification.sound != <span class="keyword">null</span>) {</div><div class="line">            notification.sound = notification.sound.getCanonicalUri();</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, pkg + <span class="string">": notify("</span> + id + <span class="string">", "</span> + notification + <span class="string">")"</span>);</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            service.enqueueNotificationWithTag(pkg, tag, id, notification, idOut,</div><div class="line">                    user.getIdentifier());</div><div class="line">            <span class="keyword">if</span> (id != idOut[<span class="number">0</span>]) {</div><div class="line">                Slog.w(TAG, <span class="string">"notify: id corrupted: sent "</span> + id + <span class="string">", got back "</span> + idOut[<span class="number">0</span>]);</div><div class="line">            }</div><div class="line">        } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Cancel a previously shown notification.  If it's transient, the view</span></div><div class="line"><span class="comment">     * will be hidden.  If it's persistent, it will be removed from the status</span></div><div class="line"><span class="comment">     * bar.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span>(<span class="keyword">int</span> id) {</div><div class="line">        cancel(<span class="keyword">null</span>, id);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Cancel a previously shown notification.  If it's transient, the view</span></div><div class="line"><span class="comment">     * will be hidden.  If it's persistent, it will be removed from the status</span></div><div class="line"><span class="comment">     * bar.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span>(String tag, <span class="keyword">int</span> id) {</div><div class="line">        INotificationManager service = getService();</div><div class="line">        String pkg = mContext.getPackageName();</div><div class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, pkg + <span class="string">": cancel("</span> + id + <span class="string">")"</span>);</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            service.cancelNotificationWithTag(pkg, tag, id, UserHandle.myUserId());</div><div class="line">        } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Cancel all previously shown notifications. See {@link #cancel} for the</span></div><div class="line"><span class="comment">     * detailed behavior.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAll</span>() {</div><div class="line">        INotificationManager service = getService();</div><div class="line">        String pkg = mContext.getPackageName();</div><div class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, pkg + <span class="string">": cancelAll()"</span>);</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            service.cancelAllNotifications(pkg, UserHandle.myUserId());</div><div class="line">        } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">        }      </div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>NMS 中有几种方式可以用来标示一条通知。首先说说为什么要标示一条通知。因为发送一条通知，之后可以更新它的状态（显示的信息），取消它（删除），所以要有一个东西能唯一表示一条通知。首先有一个原则，那就是除了系统以外，<strong>一个应用只能操作自己发送的通知</strong>。所以对于普通应用，虽然说有几种标示，但是都在 pkg（包名）这个大的标示下（其实还有一个大的标示，就是用户，不过我们这里先不讨论多用户）。所以看 NM 接口的实现，都自动把调用接口的应用的 pkg 发给 NMS，不让应用自己设置（免得有些应用故意写别人的包名，干坏事）。</p>
<p>然后我们看到接口，有 id（int） 和 tag（String） 这2种标示。一般应用开发中 id 用得比较多，然后我们看下 NMS 中识别的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ================== NotificationManagerService.java =====================</span></div><div class="line"></div><div class="line">    <span class="comment">// lock on mNotificationList</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> <span class="title">indexOfNotificationLocked</span>(String pkg, String tag, <span class="keyword">int</span> id, <span class="keyword">int</span> userId)</div><div class="line">    {</div><div class="line">        ArrayList&lt;NotificationRecord&gt; list = mNotificationList;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> len = list.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;len; i++) {</div><div class="line">            NotificationRecord r = list.get(i);</div><div class="line">            <span class="keyword">if</span> (!notificationMatchesUserId(r, userId) || r.id != id) {</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            }    </div><div class="line">            <span class="keyword">if</span> (tag == <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">if</span> (r.tag != <span class="keyword">null</span>) {</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                }    </div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="keyword">if</span> (!tag.equals(r.tag)) {</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                }    </div><div class="line">            }    </div><div class="line">            <span class="keyword">if</span> (r.pkg.equals(pkg)) {</div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            }    </div><div class="line">        }    </div><div class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>发现优先匹配 id，然后才是 tag（最后包名那来个保险，确保你只能操作自己发的通知）。所以说要自己设计通知的 id 话，可以随意点，因为系统帮你确保你的 id 只在你的 pkg 中有效了，android 系统里面是直接拿图标的 R 资源的 id 来做 id 用的。也有一些用 tag，不过那个用得少。</p>
<h2 id="Content">Content</h2>
<p>接下来介绍下通知的显示内容。通知的 Content 一般来说是这样的：</p>
<p><img src="http://7u2hy4.com1.z0.glb.clouddn.com/android/SystemUI-notification/normal_notification_callouts.png" alt="normal view 模式" title="normal view 模式"></p>
<p>从 4.0 开始多了一个 big view 的模式，是这样的：</p>
<p><img src="http://7u2hy4.com1.z0.glb.clouddn.com/android/SystemUI-notification/bigpicture_notification_callouts.png" alt="big view 模式" title="big view 模式"></p>
<p>前面看了通知的接口。应用需要构造出一个 Notification 对象出来。在 2.x 的时候是直接设置 Notification 的字段的（里面的字段都是 public 的），后面 android 本着封装的设计感觉原来的不太好，所以搞了一个 Notification.Builder 出来，之后建议开发者用这个 Builder 来构造 Notification。其实2个原理上基本上是一样的，但是某些地方有点点不一样。就算是新的 sdk，你仍然可以坚持直接设置 Notification。所以我们来分开说一下：</p>
<h3 id="直接设置_Notification">直接设置 Notification</h3>
<p>我们来列一下 Notification 中我们需要设置的一些数据。</p>
<ul>
<li><p><strong>icon(int)</strong><br>通知图标的资源 id。是上面 normal 模式的 2。</p>
</li>
<li><p><strong>iconLevel(int)</strong><br>上面那个 icon 可以设成 LevelListDrawable 的，然后可以通过设置 iconLevel 来改变 icon 的图标 level，如果定时改变的话，可以形成一些下载通知图标的动态效果。</p>
</li>
<li><p><strong>setLatestEventInfo</strong><br>这是个接口，参数如下：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ============== Notification.java =====================</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Sets the {@link #contentView} field to be a view with the standard "Latest Event"</span></div><div class="line"><span class="comment">     * layout.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * &lt;p&gt;Uses the {@link #icon} and {@link #when} fields to set the icon and time fields</span></div><div class="line"><span class="comment">     * in the view.&lt;/p&gt;</span></div><div class="line"><span class="comment">     * @param context       The context for your application / activity.</span></div><div class="line"><span class="comment">     * @param contentTitle The title that goes in the expanded entry.</span></div><div class="line"><span class="comment">     * @param contentText  The text that goes in the expanded entry.</span></div><div class="line"><span class="comment">     * @param contentIntent The intent to launch when the user clicks the expanded notification.</span></div><div class="line"><span class="comment">     * If this is an activity, it must include the</span></div><div class="line"><span class="comment">     * {@link android.content.Intent#FLAG_ACTIVITY_NEW_TASK} flag, which requires</span></div><div class="line"><span class="comment">     * that you take care of task management as described in the</span></div><div class="line"><span class="comment">     * &lt;a href="{@docRoot}guide/topics/fundamentals/tasks-and-back-stack.html"&gt;Tasks and Back</span></div><div class="line"><span class="comment">     * Stack&lt;/a&gt; document.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * @deprecated Use {@link Builder} instead.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="annotation">@Deprecated</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLatestEventInfo</span>(Context context,</div><div class="line">            CharSequence contentTitle, CharSequence contentText, PendingIntent contentIntent) {</div><div class="line">        <span class="comment">// TODO: rewrite this to use Builder</span></div><div class="line">        RemoteViews contentView = <span class="keyword">new</span> RemoteViews(context.getPackageName(),</div><div class="line">                R.layout.notification_template_base);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.icon != <span class="number">0</span>) { </div><div class="line">            contentView.setImageViewResource(R.id.icon, <span class="keyword">this</span>.icon);</div><div class="line">        }    </div><div class="line">        <span class="keyword">if</span> (priority &lt; PRIORITY_LOW) {</div><div class="line">            contentView.setInt(R.id.icon,</div><div class="line">                    <span class="string">"setBackgroundResource"</span>, R.drawable.notification_template_icon_low_bg);</div><div class="line">            contentView.setInt(R.id.status_bar_latest_event_content,</div><div class="line">                    <span class="string">"setBackgroundResource"</span>, R.drawable.notification_bg_low);</div><div class="line">        }    </div><div class="line">        <span class="keyword">if</span> (contentTitle != <span class="keyword">null</span>) {</div><div class="line">            contentView.setTextViewText(R.id.title, contentTitle);</div><div class="line">        }    </div><div class="line">        <span class="keyword">if</span> (contentText != <span class="keyword">null</span>) {</div><div class="line">            contentView.setTextViewText(R.id.text, contentText);</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.when != <span class="number">0</span>) {</div><div class="line">            contentView.setViewVisibility(R.id.time, View.VISIBLE);</div><div class="line">            contentView.setLong(R.id.time, <span class="string">"setTime"</span>, when);</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.number != <span class="number">0</span>) {</div><div class="line">            NumberFormat f = NumberFormat.getIntegerInstance();</div><div class="line">            contentView.setTextViewText(R.id.info, f.format(<span class="keyword">this</span>.number));</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.contentView = contentView;</div><div class="line">        <span class="keyword">this</span>.contentIntent = contentIntent;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个可以说以前（4.0 之前）通知的最主要的部分了。看这个函数里面的实现知道，系统帮我们提供了一个通知的模板（xml 在 frameworks/base/core/res/res 下面），帮我们 new 了一个 RemoteViews 来当作通知的 ContentView。一个通知必须要有的2个元素，一个是 id，另外一个就是 contentView。这个 RemoteViews 是跨进程的 UI 组件，这个东西以后再分析，这里先不管它。系统的模板弄出来的样子就和上面的 normal view 那样。这里参数可以让你设置通知的标题（title）和内容（text）。分别对应 normal view 的 1 和 3。</p>
<p>这里除了 UI 元素设置，最后还有一个 PendingIntent 的参数（contentIntent），算是功能性设置。注释中说是用户点击通知的时候对应完成的功能。可以是 activity（点击时 launch），也可以是 broadcast（点击时发送）。可以说还是挺灵活的，这里就不展开分析了。</p>
<ul>
<li><p><strong>number(int)</strong><br>标准模板中的右下角显示一个小数字（一些消息、邮件类的通知很有用），对应 normal view 的 4。注意如果不想显示把这个设置 0 就可以了（默认是 0，上面 setLatestEventInfo 处理那里代码能看得出的）。</p>
</li>
<li><p><strong>when(long)</strong><br>标志模板中右上角显示发送通知的时间，对应 normal view 的 6。看到类型是 long 的就知道这个时间是自从 1970-01-01 00:00:00.0 的 UTC，可以通过 System.currentTimeMillis() 取当前的时间，当然你也可以故意设置成别的时间。顺带一提，如果你不想显示时间，把这个设置成 0 就行了（和 number 一样的）。</p>
</li>
<li><p><strong>contentView(RemoteViews)</strong><br>其实上面 setLatestEventInfo 是让系统帮你生成一个标准的通知模板。但是你会发现一些音乐播放器和一些手机助手，在通知栏上有一些比较高级的通知，这些是通过自定义的 content view 来实现的。不要用系统的模板，自己写 content view 就行了，这个是 RemoteViews，和写 widget 差不多的。</p>
</li>
<li><p><strong>bigContentView(RemoteViews)</strong><br>这个是 Notification 新增的 big view 模式，和 contentView 一样，可以自定义，详见下面 Builder 的说明。</p>
</li>
<li><p><strong>deleteIntent</strong><br>上面那个 contentIntent 是点击通知时候的动作。这个顾名思义，是通知被删除的时候的动作，例如说通知被删掉了，可以做一些清除发送通知相关的数据的操作。</p>
</li>
<li><p><strong>fullScreenIntent</strong><br>这个看名字不是太直白（但是也有点沾边），这个是指发送通知的时候做的动作，例如说闹钟来了，对通知栏发送一条通知，顺带 launch 闹钟界面的 activity（系统闹钟的做法）；或者是插入 usb，发送 usb 连接通知，顺带 launch usb storage 操作界面。</p>
</li>
<li><p><strong>tickerText(Char CharSequence)</strong><br>设置前面说的那个 ticker 显示的文本信息。这个也是系统有一个标准模板的，左边一个 icon，右边是文本。模板中 ticker 的 icon 是取 Notification 的 icon（源码中本着封装的原则，不同模块搞了一堆数据结构，又绕了半天，这篇侧重应用，代码这里不分析了）。所以 ticker 图标是和状态栏上的显示的图标是一样的，独立的只能设置文本。如果你没设 tickerText（为 null），那你发通知的时间就没 ticker 显示了（就是没那段通知滚动的动画了）。</p>
</li>
<li><p><strong>tickerView(RemoteViews)</strong><br>看到前面 tickerText 那里提到模板就能猜到 ticker 也是可以自定义的。但是注意一点原生的 android 系统只有 Tablet UI 才允许你自定义 ticker view，因为只有 Tablet UI 才会使用 Notification 中设置的 tickerView。这里顺带说下 android SystemUI 的一些策略问题：</p>
</li>
</ul>
<p>SystemUI 的状态栏（包括虚拟按键、通知面板）以分为好几种 UI 风格，目前已有的是 phone、table、tv。它共同继续只同一个父类 BaseStatusBar。然后实现不同的 UI 风格。在 frameworks/base/package/SystemUI/src/com/android/systemui/statusbar 下面有对应的包。framework 中可以在 xml 中指定要运行的 UI 风格。要想知道自己的设备状态用的是哪一种风格，拿 hierarchyviewer 看下状态栏的包名和类名就行了。</p>
<p>当然这是原生定的，你也可以改成 phone 也可以使用自定义的 tickerView，或者你自己都可以完全搞一套状态栏 UI 风格（只要实现了父类抽象的功能即可）。不过 android 内部也是矛盾不断，4.0 ~ 4.2 的时候原生还是有 phone 和 table 2种风格的（tv 的现在基本上是摆设），到了 4.4 之后 android 就把 table 给干掉了，然后全部只有 phone 的（也许是想统一手机和平板的风格吧）。所以说现在这个接口在原生系统上就是摆设，老老实实用系统标准的模板。 </p>
<p>经过上面的介绍，你会发现前面 normal view 下的通知栏，好像还有一个元素（6）没哪个接口可以设置。对的，在直接使用 Notification 设置是没办法设置右边那个小图标的（我不知道这个小图标是不是后面新加入的新元素）。因为这种方法已经被系统标记为过时的（deprecated），新的 sdk 推荐你使用 Notification.Builder 来设置通知。当然系统为了兼容性还保留着以前的接口，你要坚持使用老接口也可以，就是功能没那么全而已。 </p>
<h3 id="使用_Notification-Builder">使用 Notification.Builder</h3>
<p>自从 4.0（应该是吧，我就不具体去考查版本了）通知新加入了一种模式，就出现了这个 Builder 的辅助类。我们先来说下新加入的这种通知模式。这模式官方叫 big view。一般通知的表现是在通知面板上一条一条的，虽然可以自定义 content view，但是系统规定死了 normal view 下每一条通知的高度的，所以所有 normal view 的通知的大小都是一样的（这样才好看）。但是你会发现某些音乐播放器的通知栏上的控制工具会比普通的通知要大，这个就是 big view 模式：</p>
<ol>
<li>big view 高度没有限制（我看代码是，具体没试过），可以比 normal view 高很多（宽是不可能了，屏幕就那么宽），效果见上面的 big view 图。</li>
<li>一个 Notification 可以有 normal view 和 big view。</li>
<li>通知普通情况下显示 normal view，可以通过双指滑动展开 big view（隐藏 normal view），双指缩放关闭 big view（显示 normal view），其实好像不是双指，但是我实在没明白官方怎么个操作法的，但是双指很容易能搞出来。</li>
</ol>
<p>big view 系统也是提供了若干模板，通过 new 不同的 Notiifcation.Style 可以设置不同风格的 big view 模板，当然也可以自定义（自己设置 bigContentView）。这就不细说 Builder、Style 有哪些接口了，自己去看下官方文档一目了然（其中包括上面说的设置右边的那个小图标的接口）。这里稍微看下系统是在 Builder 和 Style 中怎么帮我们创建 Notification 的 content view 的。</p>
<ul>
<li><strong>不使用风格</strong><br>如果直接 new Notification.Builder 然后设置一堆东西，然后调用 builder 的话，会是这样的：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ============== Notification.java =====================</span></div><div class="line"></div><div class="line">        <span class="comment">/*  </span></div><div class="line"><span class="comment">         * Combine all of the options that have been set and return a new {@link Notification}</span></div><div class="line"><span class="comment">         * object.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">public</span> Notification <span class="title">build</span>() {</div><div class="line">            <span class="keyword">if</span> (mStyle != <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">return</span> mStyle.build();</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="keyword">return</span> buildUnstyled();</div><div class="line">            }    </div><div class="line">        }</div><div class="line"></div></pre></td></tr></table></figure>

<p>你如果没有调用 setStyle 设置任何风格的话，使用的是 buildUnstyled：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ============== Notification.java =====================</span></div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * Apply the unstyled operations and return a new {@link Notification} object.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">private</span> Notification <span class="title">buildUnstyled</span>() { </div><div class="line">            Notification n = <span class="keyword">new</span> Notification();</div><div class="line">            n.when = mWhen;</div><div class="line">            n.icon = mSmallIcon;           </div><div class="line">            n.iconLevel = mSmallIconLevel; </div><div class="line">            n.number = mNumber;            </div><div class="line">            <span class="comment">// 创建 normal view 的 content view</span></div><div class="line">            n.contentView = makeContentView();</div><div class="line">            n.contentIntent = mContentIntent;</div><div class="line">            n.deleteIntent = mDeleteIntent;</div><div class="line">            n.fullScreenIntent = mFullScreenIntent;</div><div class="line">            n.tickerText = mTickerText;</div><div class="line">            <span class="comment">// 创建 ticker view    </span></div><div class="line">            n.tickerView = makeTickerView();</div><div class="line">            n.largeIcon = mLargeIcon;      </div><div class="line">            n.sound = mSound;</div><div class="line">            n.audioStreamType = mAudioStreamType;</div><div class="line">            n.vibrate = mVibrate;          </div><div class="line">            n.ledARGB = mLedArgb;          </div><div class="line">            n.ledOnMS = mLedOnMs;          </div><div class="line">            n.ledOffMS = mLedOffMs;        </div><div class="line">            n.defaults = mDefaults;        </div><div class="line">            n.flags = mFlags;</div><div class="line">            <span class="comment">// 创建 big view 的 content view</span></div><div class="line">            n.bigContentView = makeBigContentView();</div><div class="line">            <span class="keyword">if</span> (mLedOnMs != <span class="number">0</span> && mLedOffMs != <span class="number">0</span>) {</div><div class="line">                n.flags |= FLAG_SHOW_LIGHTS;   </div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> ((mDefaults & DEFAULT_LIGHTS) != <span class="number">0</span>) {</div><div class="line">                n.flags |= FLAG_SHOW_LIGHTS;   </div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (mKindList.size() &gt; <span class="number">0</span>) {    </div><div class="line">                n.kind = <span class="keyword">new</span> String[mKindList.size()];</div><div class="line">                mKindList.toArray(n.kind);     </div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                n.kind = <span class="keyword">null</span>;</div><div class="line">            }</div><div class="line">            n.priority = mPriority;        </div><div class="line">            n.extras = mExtras != <span class="keyword">null</span> ? <span class="keyword">new</span> Bundle(mExtras) : <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (mActions.size() &gt; <span class="number">0</span>) {     </div><div class="line">                n.actions = <span class="keyword">new</span> Action[mActions.size()]; </div><div class="line">                mActions.toArray(n.actions);   </div><div class="line">            }</div><div class="line">            <span class="keyword">return</span> n;</div><div class="line">        }</div><div class="line"></div></pre></td></tr></table></figure>

<p>我们稍微看下 normal view 和 big view 的创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ============== Notification.java =====================</span></div><div class="line"></div><div class="line">        <span class="keyword">private</span> RemoteViews <span class="title">makeContentView</span>() {</div><div class="line">            <span class="keyword">if</span> (mContentView != <span class="keyword">null</span>) {    </div><div class="line">                <span class="keyword">return</span> mContentView;           </div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="keyword">return</span> applyStandardTemplate(R.layout.notification_template_base, <span class="keyword">true</span>); <span class="comment">// no more special large_icon flavor</span></div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">private</span> RemoteViews <span class="title">applyStandardTemplate</span>(<span class="keyword">int</span> resId, <span class="keyword">boolean</span> fitIn1U) {</div><div class="line">            RemoteViews contentView = <span class="keyword">new</span> RemoteViews(mContext.getPackageName(), resId);</div><div class="line">            <span class="keyword">boolean</span> showLine3 = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">boolean</span> showLine2 = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">int</span> smallIconImageViewId = R.id.icon;</div><div class="line">            <span class="keyword">if</span> (mLargeIcon != <span class="keyword">null</span>) {</div><div class="line">                contentView.setImageViewBitmap(R.id.icon, mLargeIcon);</div><div class="line">                smallIconImageViewId = R.id.right_icon;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (mPriority &lt; PRIORITY_LOW) {</div><div class="line">                contentView.setInt(R.id.icon,</div><div class="line">                        <span class="string">"setBackgroundResource"</span>, R.drawable.notification_template_icon_low_bg);</div><div class="line">                contentView.setInt(R.id.status_bar_latest_event_content,</div><div class="line">                        <span class="string">"setBackgroundResource"</span>, R.drawable.notification_bg_low);</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (mSmallIcon != <span class="number">0</span>) {</div><div class="line">                contentView.setImageViewResource(smallIconImageViewId, mSmallIcon);</div><div class="line">                contentView.setViewVisibility(smallIconImageViewId, View.VISIBLE);</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                contentView.setViewVisibility(smallIconImageViewId, View.GONE);</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (mContentTitle != <span class="keyword">null</span>) {</div><div class="line">                contentView.setTextViewText(R.id.title, mContentTitle);</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (mContentText != <span class="keyword">null</span>) {</div><div class="line">                contentView.setTextViewText(R.id.text, mContentText);</div><div class="line">                showLine3 = <span class="keyword">true</span>;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (mContentInfo != <span class="keyword">null</span>) {</div><div class="line">                contentView.setTextViewText(R.id.info, mContentInfo);</div><div class="line">                contentView.setViewVisibility(R.id.info, View.VISIBLE);</div><div class="line">                showLine3 = <span class="keyword">true</span>;</div><div class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (mNumber &gt; <span class="number">0</span>) {</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> tooBig = mContext.getResources().getInteger(</div><div class="line">                        R.integer.status_bar_notification_info_maxnum);</div><div class="line">                <span class="keyword">if</span> (mNumber &gt; tooBig) {</div><div class="line">                    contentView.setTextViewText(R.id.info, mContext.getResources().getString(</div><div class="line">                                R.string.status_bar_notification_info_overflow));</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    NumberFormat f = NumberFormat.getIntegerInstance();</div><div class="line">                    contentView.setTextViewText(R.id.info, f.format(mNumber));</div><div class="line">                }</div><div class="line">                contentView.setViewVisibility(R.id.info, View.VISIBLE);</div><div class="line">                showLine3 = <span class="keyword">true</span>;</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                contentView.setViewVisibility(R.id.info, View.GONE);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// Need to show three lines?</span></div><div class="line">            <span class="keyword">if</span> (mSubText != <span class="keyword">null</span>) {</div><div class="line">                contentView.setTextViewText(R.id.text, mSubText);</div><div class="line">                <span class="keyword">if</span> (mContentText != <span class="keyword">null</span>) {</div><div class="line">                    contentView.setTextViewText(R.id.text2, mContentText);</div><div class="line">                    contentView.setViewVisibility(R.id.text2, View.VISIBLE);</div><div class="line">                    showLine2 = <span class="keyword">true</span>;</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    contentView.setViewVisibility(R.id.text2, View.GONE);</div><div class="line">                }  </div><div class="line">            } <span class="keyword">else</span> {   </div><div class="line">                contentView.setViewVisibility(R.id.text2, View.GONE);</div><div class="line">                <span class="keyword">if</span> (mProgressMax != <span class="number">0</span> || mProgressIndeterminate) {</div><div class="line">                    contentView.setProgressBar(</div><div class="line">                            R.id.progress, mProgressMax, mProgress, mProgressIndeterminate);</div><div class="line">                    contentView.setViewVisibility(R.id.progress, View.VISIBLE);</div><div class="line">                    showLine2 = <span class="keyword">true</span>;</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    contentView.setViewVisibility(R.id.progress, View.GONE);</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (showLine2) { </div><div class="line">                <span class="keyword">if</span> (fitIn1U) {</div><div class="line">                    <span class="comment">// need to shrink all the type to make sure everything fits</span></div><div class="line">                    <span class="keyword">final</span> Resources res = mContext.getResources();</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> subTextSize = res.getDimensionPixelSize(</div><div class="line">                            R.dimen.notification_subtext_size);</div><div class="line">                    contentView.setTextViewTextSize(R.id.text, TypedValue.COMPLEX_UNIT_PX, subTextSize);</div><div class="line">                }</div><div class="line">                <span class="comment">// vertical centering</span></div><div class="line">                contentView.setViewPadding(R.id.line1, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            }</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (mWhen != <span class="number">0</span> && mShowWhen) {</div><div class="line">                <span class="keyword">if</span> (mUseChronometer) {</div><div class="line">                    contentView.setViewVisibility(R.id.chronometer, View.VISIBLE);</div><div class="line">                    contentView.setLong(R.id.chronometer, <span class="string">"setBase"</span>,</div><div class="line">                            mWhen + (SystemClock.elapsedRealtime() - System.currentTimeMillis()));</div><div class="line">                    contentView.setBoolean(R.id.chronometer, <span class="string">"setStarted"</span>, <span class="keyword">true</span>);</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    contentView.setViewVisibility(R.id.time, View.VISIBLE);</div><div class="line">                    contentView.setLong(R.id.time, <span class="string">"setTime"</span>, mWhen);</div><div class="line">                }</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                contentView.setViewVisibility(R.id.time, View.GONE);</div><div class="line">            }</div><div class="line"></div><div class="line">            contentView.setViewVisibility(R.id.line3, showLine3 ? View.VISIBLE : View.GONE);</div><div class="line">            contentView.setViewVisibility(R.id.overflow_divider, showLine3 ? View.VISIBLE : View.GONE);</div><div class="line">            <span class="keyword">return</span> contentView;</div><div class="line">        }</div><div class="line"></div></pre></td></tr></table></figure>

<p>具体细节不看了，就是根据 Builder 设置的参数设置 R.layout.notification_template_base 中的界面元素。从这里能看出使用 Builder 比上面使用 Notification.setLatestEventInfo 创建的模板多很多东西。所以要想更多的控制自己程序发送的通知样式还是使用 sdk 推荐的接口比较好。</p>
<p>然后看下 big view 的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ============== Notification.java =====================</span></div><div class="line"></div><div class="line">        <span class="keyword">private</span> RemoteViews <span class="title">makeBigContentView</span>() {</div><div class="line">            <span class="keyword">if</span> (mActions.size() == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> applyStandardTemplateWithActions(R.layout.notification_template_big_base);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">private</span> RemoteViews <span class="title">applyStandardTemplateWithActions</span>(<span class="keyword">int</span> layoutId) {</div><div class="line">            RemoteViews big = applyStandardTemplate(layoutId, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">            <span class="keyword">int</span> N = mActions.size();       </div><div class="line">            <span class="keyword">if</span> (N &gt; <span class="number">0</span>) {</div><div class="line">                <span class="comment">// Log.d("Notification", "has actions: " + mContentText);</span></div><div class="line">                big.setViewVisibility(R.id.actions, View.VISIBLE);</div><div class="line">                big.setViewVisibility(R.id.action_divider, View.VISIBLE);</div><div class="line">                <span class="keyword">if</span> (N&gt;MAX_ACTION_BUTTONS) N=MAX_ACTION_BUTTONS;</div><div class="line">                big.removeAllViews(R.id.actions);</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) {      </div><div class="line">                    <span class="keyword">final</span> RemoteViews button = generateActionButton(mActions.get(i));</div><div class="line">                    <span class="comment">//Log.d("Notification", "adding action " + i + ": " + mActions.get(i).title);</span></div><div class="line">                    big.addView(R.id.actions, button);</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keyword">return</span> big;</div><div class="line">        }</div><div class="line"></div></pre></td></tr></table></figure>

<p>不设置任何风格的 Builder，并且又没设置任何 Actions，是没有 big view 的。</p>
<ul>
<li><strong>使用风格</strong><br>Builder 有一个 setStyle 的接口，可以设置一个风格，系统 Notification 目前提供了下面几种风格：</li>
</ul>
<ol>
<li>BigPictureStyle: 就是能设置很大一张的</li>
<li>BigTextStyle: 有很大的空间（高度）显示一大串文本</li>
<li>InboxStyle： 就是上面贴图的那个 big view</li>
</ol>
<p>我这里偷下懒就不一个一个上效果图了（自己试一下就能看到效果了）。然后这里的风格的区别主要是在 big view 上，这几个风格分别提供了3种 big view 的风格，设置也是设置相应的 big view 的模板元素。我们来稍微看下源码，还记得上面那个 Builder 的 build 函数么，如果 mStyle 不是 null 的话，那么就调用相应 Style 的 build 函数，我们这里稍微看下 BigPictureStyle 的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ============== Notification.java =====================</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Helper class for generating large-format notifications that include a large image attachment.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * This class is a "rebuilder": It consumes a Builder object and modifies its behavior, like so:</span></div><div class="line"><span class="comment">     * &lt;pre class="prettyprint"&gt;</span></div><div class="line"><span class="comment">     * Notification noti = new Notification.BigPictureStyle(</span></div><div class="line"><span class="comment">     *      new Notification.Builder()</span></div><div class="line"><span class="comment">     *         .setContentTitle(&quot;New photo from &quot; + sender.toString())</span></div><div class="line"><span class="comment">     *         .setContentText(subject)</span></div><div class="line"><span class="comment">     *         .setSmallIcon(R.drawable.new_post)</span></div><div class="line"><span class="comment">     *         .setLargeIcon(aBitmap))</span></div><div class="line"><span class="comment">     *      .bigPicture(aBigBitmap)</span></div><div class="line"><span class="comment">     *      .build();</span></div><div class="line"><span class="comment">     * &lt;/pre&gt;</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * @see Notification#bigContentView</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BigPictureStyle</span> <span class="keyword">extends</span> <span class="title">Style</span> </span>{</div><div class="line">        <span class="keyword">private</span> Bitmap mPicture;       </div><div class="line">        <span class="keyword">private</span> Bitmap mBigLargeIcon;  </div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> mBigLargeIconSet = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="title">BigPictureStyle</span>() {     </div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="title">BigPictureStyle</span>(Builder builder) {</div><div class="line">            setBuilder(builder);           </div><div class="line">        }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="keyword">private</span> RemoteViews <span class="title">makeBigContentView</span>() {</div><div class="line">            RemoteViews contentView = getStandardView(R.layout.notification_template_big_picture);</div><div class="line"></div><div class="line">            contentView.setImageViewBitmap(R.id.big_picture, mPicture);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> contentView;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="annotation">@Override</span></div><div class="line">        <span class="keyword">public</span> Notification <span class="title">build</span>() {</div><div class="line">            checkBuilder();</div><div class="line">            Notification wip = mBuilder.buildUnstyled();</div><div class="line">            <span class="keyword">if</span> (mBigLargeIconSet ) {</div><div class="line">                mBuilder.mLargeIcon = mBigLargeIcon;</div><div class="line">            }</div><div class="line">            wip.bigContentView = makeBigContentView();</div><div class="line">            <span class="keyword">return</span> wip;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>从代码中看，这些 Style 就是先调用 Builder 的无风格 build 函数，然后再重新把 bigContentView 自己生成一个，覆盖以前的而已。其他2个我就不贴代码了，套路基本上是一样的。通知栏智能机时代是 android 发明的（IOS 的在后面，android 在界面设计方面有领先 IOS 的地方了哟），加入了 big view 之后 UI 更加灵活了，好像 5.0 又多了一个新功能，以后有时间再看看。</p>
<h2 id="系统处理流程">系统处理流程</h2>
<p>上面说了一些 Notification 的基本用法，也稍微分析下源代码的一些实现。这些稍微说下，应用对 NM 发送一条通知，framework 中会对应生成什么数据，然后通知的 content view 是怎么加到 SystemUI 的状态栏和通知面板中的。先是上一张图先：</p>
<p><img src="http://7u2hy4.com1.z0.glb.clouddn.com/android/SystemUI-notification/Send-notification.png" alt="流程图" title="流程图"></p>
<p>从图中可以看到一个通知从 app 自己构造通知然后调用 NotificationManager（NM）的接口发送，经过了 NotificationManagerService（NMS）到 StatusBarManagerService(SBMS) 最后到添加 Notification 的 UI 元素到 SystemUI 中。好像也有点麻烦的样子，然后图中蓝色的部分是每个模块（NMS、SBMS、SystemUI）保存通知的相关数据（前面说了每个模块都不一样，还真是不一样）。然后我们再贴下通知相关的 UI 元素最后在 SystemUI 中的表现：</p>
<p><img src="http://7u2hy4.com1.z0.glb.clouddn.com/android/SystemUI-notification/notification-ui.jpeg" alt="UI 效果" title="UI 效果"><br>(PS: 这不是 android 原生的 SystemUI，是被我定制过的，通知没分组了)</p>
<p>上面我们稍微注意下每个模块对应的数据结构，和最后扔到 SystemUI 中的 view 就差不多能摸清系统处理通知的流程了。下面开始跟流程：</p>
<ul>
<li><strong>1.App</strong><br>首先是构造 Notification，前面分析过了，然后获取 NM 调用 notify 的接口，把 id 和 Notificaiton 传给 NM。这里代码前面贴过了，回去看看就行。</li>
</ul>
<ul>
<li><strong>2.NotificationManagerService</strong><br>然后 NM 会调用 NMS 的 enqueueNotificationInternal（Notification 是 Parcelable 所以可以当作 Binder 的参数传给 NMS）：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">// Not exposed via Binder; for system use only (otherwise malicious apps could spoof the</span></div><div class="line">    <span class="comment">// uid/pid of another application)</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueNotificationInternal</span>(String pkg, <span class="keyword">int</span> callingUid, <span class="keyword">int</span> callingPid,</div><div class="line">            String tag, <span class="keyword">int</span> id, Notification notification, <span class="keyword">int</span>[] idOut, <span class="keyword">int</span> userId)</div><div class="line">    {</div><div class="line">        <span class="keyword">if</span> (DBG) {</div><div class="line">            Slog.v(TAG, <span class="string">"enqueueNotificationInternal: pkg="</span> + pkg + <span class="string">" id="</span> + id + <span class="string">" notification="</span> + notification);</div><div class="line">        }</div><div class="line">        <span class="comment">// 判断是不是当前用户应用发出来的通知</span></div><div class="line">        checkCallerIsSystemOrSameApp(pkg);</div><div class="line">        <span class="comment">// 判断是不是系统应用发出来的通知</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isSystemNotification = isUidSystem(callingUid) || (<span class="string">"android"</span>.equals(pkg));</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userId = ActivityManager.handleIncomingUser(callingPid,</div><div class="line">                callingUid, incomingUserId, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"enqueueNotification"</span>, pkg);</div><div class="line">        <span class="keyword">final</span> UserHandle user = <span class="keyword">new</span> UserHandle(userId);</div><div class="line"></div><div class="line">        <span class="comment">// 如果不是系统应用的话，限制一下一个包发送总共应用的条数，原生限制 50 条</span></div><div class="line">        <span class="comment">// 通过统计 NotificationRecord 的 list 包名一样的通知记录 </span></div><div class="line">        <span class="comment">// Limit the number of notifications that any given package except the android</span></div><div class="line">        <span class="comment">// package can enqueue.  Prevents DOS attacks and deals with leaks.</span></div><div class="line">        <span class="keyword">if</span> (!isSystemNotification) {</div><div class="line">            <span class="keyword">synchronized</span> (mNotificationList) {</div><div class="line">                <span class="keyword">int</span> count = <span class="number">0</span>; </div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = mNotificationList.size();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) {</div><div class="line">                    <span class="keyword">final</span> NotificationRecord r = mNotificationList.get(i);</div><div class="line">                    <span class="keyword">if</span> (r.sbn.getPackageName().equals(pkg) && r.sbn.getUserId() == userId) {</div><div class="line">                        count++;</div><div class="line">                        <span class="keyword">if</span> (count &gt;= MAX_PACKAGE_NOTIFICATIONS) {</div><div class="line">                            Slog.e(TAG, <span class="string">"Package has already posted "</span> + count</div><div class="line">                                    + <span class="string">" notifications.  Not showing more.  package="</span> + pkg);</div><div class="line">                            <span class="keyword">return</span>;</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// This conditional is a dirty hack to limit the logging done on</span></div><div class="line">        <span class="comment">//     behalf of the download manager without affecting other apps.</span></div><div class="line">        <span class="keyword">if</span> (!pkg.equals(<span class="string">"com.android.providers.downloads"</span>)</div><div class="line">                || Log.isLoggable(<span class="string">"DownloadManager"</span>, Log.VERBOSE)) {</div><div class="line">            EventLog.writeEvent(EventLogTags.NOTIFICATION_ENQUEUE, pkg, id, tag, userId,</div><div class="line">                    notification.toString());</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span> || notification == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null not allowed: pkg="</span> + pkg</div><div class="line">                    + <span class="string">" id="</span> + id + <span class="string">" notification="</span> + notification);</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (notification.icon != <span class="number">0</span>) {</div><div class="line">            <span class="comment">// content view 必须要有</span></div><div class="line">            <span class="keyword">if</span> (notification.contentView == <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"contentView required: pkg="</span> + pkg</div><div class="line">                        + <span class="string">" id="</span> + id + <span class="string">" notification="</span> + notification);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// === Scoring ===</span></div><div class="line"></div><div class="line">        <span class="comment">// 通知有个分数排序的，分数高的排在列表前面，在 SystemUI 的显示通知列表中也靠前，我们以后再分析这个分数怎么算的</span></div><div class="line">        <span class="comment">// 0. Sanitize inputs</span></div><div class="line">        notification.priority = clamp(notification.priority, Notification.PRIORITY_MIN, Notification.PRIORITY_MAX);</div><div class="line">        <span class="comment">// Migrate notification flags to scores</span></div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> != (notification.flags & Notification.FLAG_HIGH_PRIORITY)) {</div><div class="line">            <span class="keyword">if</span> (notification.priority &lt; Notification.PRIORITY_MAX) notification.priority = Notification.PRIORITY_MAX;</div><div class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (SCORE_ONGOING_HIGHER && <span class="number">0</span> != (notification.flags & Notification.FLAG_ONGOING_EVENT)) {</div><div class="line">            <span class="keyword">if</span> (notification.priority &lt; Notification.PRIORITY_HIGH) notification.priority = Notification.PRIORITY_HIGH;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// 1. initial score: buckets of 10, around the app </span></div><div class="line">        <span class="keyword">int</span> score = notification.priority * NOTIFICATION_PRIORITY_MULTIPLIER; <span class="comment">//[-20..20]</span></div><div class="line"></div><div class="line">        <span class="comment">// 2. Consult external heuristics (TBD)</span></div><div class="line"></div><div class="line">        <span class="comment">// 3. Apply local rules</span></div><div class="line"></div><div class="line">        <span class="comment">// 在系统设置中，可以屏蔽掉某一个应用的通知</span></div><div class="line">        <span class="comment">// blocked apps</span></div><div class="line">        <span class="keyword">if</span> (ENABLE_BLOCKED_NOTIFICATIONS && !isSystemNotification && !areNotificationsEnabledForPackageInt(pkg)) {</div><div class="line">            score = JUNK_SCORE;</div><div class="line">            Slog.e(TAG, <span class="string">"Suppressing notification from package "</span> + pkg + <span class="string">" by user request."</span>);</div><div class="line">        }</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (DBG) {</div><div class="line">            Slog.v(TAG, <span class="string">"Assigned score="</span> + score + <span class="string">" to "</span> + notification);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (score &lt; SCORE_DISPLAY_THRESHOLD) {</div><div class="line">            <span class="comment">// Notification will be blocked because the score is too low.</span></div><div class="line">            Slog.i(TAG, <span class="string">"Notification="</span> + notification + <span class="string">" score is low than display threshold, we don't show it."</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Should this notification make noise, vibe, or use the LED?</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> canInterrupt = (score &gt;= SCORE_INTERRUPTION_THRESHOLD);</div><div class="line"></div><div class="line">        <span class="comment">// 喜闻乐见的 SS 业务函数多线程同步锁</span></div><div class="line">        <span class="keyword">synchronized</span> (mNotificationList) {</div><div class="line">            <span class="comment">// 这里用发通知 app的包名、通知的 tag、id、app 的 uid、app 的 pid、</span></div><div class="line">            <span class="comment">// app 的用户 id 和 Notiifcaiton 构造出一个 NotiifcationRecord（nr）</span></div><div class="line">            NotificationRecord r = <span class="keyword">new</span> NotificationRecord(pkg, tag, id,  </div><div class="line">                    callingUid, callingPid, userId,</div><div class="line">                    score,</div><div class="line">                    notification);</div><div class="line">            NotificationRecord old = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="comment">// 这里去看之前应用有没有发送过相同的通知（通过前面的标示区分）</span></div><div class="line">            <span class="keyword">int</span> index = indexOfNotificationLocked(pkg, tag, id, userId);</div><div class="line">            <span class="keyword">if</span> (index &lt; <span class="number">0</span>) { </div><div class="line">                <span class="comment">// 如果是新通知就加入到 NR 列表中</span></div><div class="line">                mNotificationList.add(r);</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="comment">// 如果原来有，取出来原来的，顺带把原来的从 list 删掉，再把新的加进去 -_-||</span></div><div class="line">                old = mNotificationList.remove(index);</div><div class="line">                mNotificationList.add(index, r);</div><div class="line">                <span class="comment">// Make sure we don't lose the foreground service state.</span></div><div class="line">                <span class="keyword">if</span> (old != <span class="keyword">null</span>) {</div><div class="line">                    notification.flags |=</div><div class="line">                        old.notification.flags&Notification.FLAG_FOREGROUND_SERVICE;</div><div class="line">                }    </div><div class="line">            }   </div><div class="line">            </div><div class="line">            <span class="comment">// Ensure if this is a foreground service that the proper additional</span></div><div class="line">            <span class="comment">// flags are set.</span></div><div class="line">            <span class="keyword">if</span> ((notification.flags&Notification.FLAG_FOREGROUND_SERVICE) != <span class="number">0</span>) {</div><div class="line">                notification.flags |= Notification.FLAG_ONGOING_EVENT</div><div class="line">                        | Notification.FLAG_NO_CLEAR;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> currentUser;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">long</span> token = Binder.clearCallingIdentity();</div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                currentUser = ActivityManager.getCurrentUser();</div><div class="line">            } <span class="keyword">finally</span> {</div><div class="line">                Binder.restoreCallingIdentity(token);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (notification.icon != <span class="number">0</span>) {</div><div class="line">                <span class="comment">// 通过和构造 NR 差不多的东西构造出一个 StatusBarNotification(sbn)</span></div><div class="line">                <span class="keyword">final</span> StatusBarNotification n = <span class="keyword">new</span> StatusBarNotification(</div><div class="line">                        pkg, id, tag, r.uid, r.initialPid, score, notification, user);</div><div class="line">                <span class="comment">// 判断下原来的和新的是不是同一样，通过以前通知保存的 SBMS 返回的 IBinder 来判断</span></div><div class="line">                <span class="comment">// 如果是一样的话那么调用 SBMS 的 updateNotification</span></div><div class="line">                <span class="keyword">if</span> (old != <span class="keyword">null</span> && old.statusBarKey != <span class="keyword">null</span>) {</div><div class="line">                    r.statusBarKey = old.statusBarKey;</div><div class="line">                    <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</div><div class="line">                    <span class="keyword">try</span> {</div><div class="line">                        mStatusBar.updateNotification(r.statusBarKey, n);</div><div class="line">                    }</div><div class="line">                    <span class="keyword">finally</span> {</div><div class="line">                        Binder.restoreCallingIdentity(identity);</div><div class="line">                    }</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    <span class="comment">// 如果是新发送的通知，那么调用 SBMS 的 addNotification 添加通知</span></div><div class="line">                    <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</div><div class="line">                    <span class="keyword">try</span> {</div><div class="line">                        <span class="comment">// NR 保存一下 SBMS 返回的 IBinder(Bp)</span></div><div class="line">                        r.statusBarKey = mStatusBar.addNotification(n);</div><div class="line">                        <span class="keyword">if</span> ((n.notification.flags & Notification.FLAG_SHOW_LIGHTS) != <span class="number">0</span></div><div class="line">                                && canInterrupt) {</div><div class="line">                            mAttentionLight.pulse();</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                    <span class="keyword">finally</span> {</div><div class="line">                        Binder.restoreCallingIdentity(identity);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">                <span class="comment">// Send accessibility events only for the current user.</span></div><div class="line">                <span class="keyword">if</span> (currentUser == userId) {</div><div class="line">                    sendAccessibilityEvent(notification, pkg);</div><div class="line">                }  </div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="comment">// 对于没有设置 icon 的通知，当作 cancel 来处理（删掉通知）</span></div><div class="line">                Slog.e(TAG, <span class="string">"Ignoring notification with icon==0: "</span> + notification);</div><div class="line">                <span class="keyword">if</span> (old != <span class="keyword">null</span> && old.statusBarKey != <span class="keyword">null</span>) {</div><div class="line">                    <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</div><div class="line">                    <span class="keyword">try</span> {</div><div class="line">                        mStatusBar.removeNotification(old.statusBarKey);</div><div class="line">                    }</div><div class="line">                    <span class="keyword">finally</span> {</div><div class="line">                        Binder.restoreCallingIdentity(identity);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line"><span class="comment">// 下面还有一串，不过和发送关系不太大，我们先忽略</span></div><div class="line">... ...</div><div class="line"></div><div class="line">        }</div><div class="line"></div><div class="line">        idOut[<span class="number">0</span>] = id;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>NMS 处理通知的函数一开始是一些检测性的工作（其实很多 SS 的业务函数一开始都是一些检测工作）。我们稍微看下 checkCallerIsSystemOrSameApp：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> checkCallerIsSystemOrSameApp(String pkg) {</div><div class="line">    <span class="comment">// 获取 IPC 调用者（发送通知的应用）的 uid</span></div><div class="line">    <span class="keyword">int</span> uid = Binder.getCallingUid();</div><div class="line">    <span class="comment">// 如果是系统应用（uid 0 是 root 组），那么可以向所有用户发送通知</span></div><div class="line">    <span class="keyword">if</span> (UserHandle.getAppId(uid) == Process.SYSTEM_UID || uid == <span class="number">0</span>) {</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="comment">// 如果发送通知的应用（普通应用）的 uid 不属于当前用户，那么不允许发送</span></div><div class="line">        ApplicationInfo ai = AppGlobals.getPackageManager().getApplicationInfo(</div><div class="line">                pkg, <span class="number">0</span>, UserHandle.getCallingUserId());</div><div class="line">        <span class="keyword">if</span> (!UserHandle.isSameApp(ai.uid, uid)) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Calling uid "</span> + uid + <span class="string">" gave package"</span></div><div class="line">                    + pkg + <span class="string">" which is owned by uid "</span> + ai.uid);</div><div class="line">        }</div><div class="line">    } <span class="keyword">catch</span> (RemoteException re) { </div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Unknown package "</span> + pkg + <span class="string">"\n"</span> + re);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里可以看得出系统在多用户方面做的一些限制操作。然后 NMS 这里使用的数据结构是 NotificationRecrod，然后 NMS 是用一个 ArrayList 来保存的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* {@hide} */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationManagerService</span> <span class="keyword">extends</span> <span class="title">INotificationManager</span>.<span class="title">Stub</span></span></div><div class="line"><span class="class"></span>{</div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;NotificationRecord&gt; mNotificationList =</div><div class="line">            <span class="keyword">new</span> ArrayList&lt;NotificationRecord&gt;();</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationRecord</span></span></div><div class="line"><span class="class">    </span>{</div><div class="line">        <span class="keyword">final</span> String pkg;</div><div class="line">        <span class="keyword">final</span> String tag;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> id;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> uid;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> initialPid;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userId;</div><div class="line">        <span class="keyword">final</span> Notification notification;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> score;</div><div class="line">        IBinder statusBarKey;</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里会判断一下之前应用有没有发送相同标志的通知（indexOfNotificationLocked 前面有贴代码），如果有的话从 NR list 中删掉原来的，再插入新的，如果没有的话直接插入新的。然后再构造出一个 StatusBarNotifcation。注意一下这个数据结构虽然在 NMS 中 new 了出来，但是是在 SBMS 中使用的，这里只是为了传递给 SBMS 而已（SBMS 提供的接口的参数是 sbn），所以 NMS 中只是持有 NR 的数据而已，sbn 在这里这是临时数据。然后根据 indexOfNotificationLocked 的结果是否已经存在 NR 记录会调用 SBMS 不同的接口，如果有会调用 updateNotification，新通知的话会调用 addNotification。这里我们先以新通知来分析，所以到这里就到 SBMS 中了去。细心的会发现在我流程图中 NMS 到 SBMS 那里没有标 IPC 而是标了 Bn（表示本地）。这是因为 NMS 和 SBMS 都是在 SS（SystemServer）进程中的（忘记了的去 Binder 篇复习下），所以它之间可以直接持有对方的对象直接调用相关的接口，无需跨进程。同时 SBMS 提供的 IPC 接口只是占本身接口的一小部分的（aidl 中的），这里调用的接口是没在 aidl 中申明的，所以别的进程只能使用 SMBS 很有限的一部分功能。可以说这里 NMS 转到 SBMS 属于 SS 内部的功能。</p>
<ul>
<li><strong>3.StatusBarManagerService</strong><br>现在从 NMS 转到 SBMS 中的 addNotification 中了：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatusBarManagerService</span> <span class="keyword">extends</span> <span class="title">IStatusBarService</span>.<span class="title">Stub</span> </span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">WindowManagerService</span>.<span class="title">OnHardKeyboardStatusChangeListener</span></span></div><div class="line"><span class="class"></span>{</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"StatusBarManagerService"</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SPEW = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Context mContext;</div><div class="line">    <span class="keyword">final</span> WindowManagerService mWindowManager;</div><div class="line">    Handler mHandler = <span class="keyword">new</span> Handler();</div><div class="line">    NotificationCallbacks mNotificationCallbacks;</div><div class="line">    <span class="keyword">volatile</span> IStatusBar mBar;</div><div class="line">    StatusBarIconList mIcons = <span class="keyword">new</span> StatusBarIconList();</div><div class="line">    <span class="comment">// 保存数据结构的是一个 HashMap</span></div><div class="line">    HashMap&lt;IBinder,StatusBarNotification&gt; mNotifications</div><div class="line">            = <span class="keyword">new</span> HashMap&lt;IBinder,StatusBarNotification&gt;();</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">public</span> IBinder <span class="title">addNotification</span>(StatusBarNotification notification) {</div><div class="line">        <span class="keyword">synchronized</span> (mNotifications) {</div><div class="line">            <span class="comment">// 生成 NotificationRecord 的 Binder 对象</span></div><div class="line">            IBinder key = <span class="keyword">new</span> Binder();    </div><div class="line">            mNotifications.put(key, notification);</div><div class="line">            <span class="keyword">if</span> (mBar != <span class="keyword">null</span>) {            </div><div class="line">                <span class="keyword">try</span> {</div><div class="line">                    mBar.addNotification(key, notification);</div><div class="line">                } <span class="keyword">catch</span> (RemoteException ex) { </div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keyword">return</span> key;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个函数非常简单，因为这里的 SBMS 其实只是起到一个桥接作用，大部分工作在提供了 IStatusBar 接口的 SystemUI 中。不过虽然简单这里 SBMS 还是持有了一个数据结构：StatusBarNotification：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Class encapsulating a Notification. Sent by the NotificationManagerService to the IStatusBar (in System UI).</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatusBarNotification</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>{</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String pkg;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> id; </div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String tag;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> uid;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> initialPid;</div><div class="line">    <span class="comment">// TODO: make this field private and move callers to an accessor that</span></div><div class="line">    <span class="comment">// ensures sourceUser is applied.</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Notification notification;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> score;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> UserHandle user;</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>可以看到这里 StatusBarNotification 也是支持 Parcelable，不过构造的地方是在 NMS 中（前面 NMS 那里传过来的）。然后 SBMS 保存 sbn 的是一个 HashMap，以这条新通知的 IBinder 对象作为 key。这里的 IBinder 在 SBMS 这里本地生成，所以是 Bn，所以通知的 IBinder 对象在 SS 中都是 Bn 来的。这个 key 被返回给 NMS 同时保存在这条记录对应的 NotificationRecord 的 statusBarKey 中。到后面 SystemUI 中标示通知 view 相关对象的时候也是拿一个 IBinder 对象区分的。 </p>
<p>然后直接调用 SBMS 的 IstatusBar 对象的 addNotification 函数去 SystemUI 中去处理通知 UI 表现相关的东西去了。</p>
<ul>
<li><strong>4.SystemUI</strong></li>
</ul>
<p>上面说到 SBMS 有一个 IStatusBar 对象。前面说了 SystemUI 的多 UI 风格，这里就是抽象地方表现之一。SystemUI 抽象了一个状态栏的抽象基类： BaseStatusBar 然后定义了一系列状态栏的功能接口，只要实现了这些接口，那么可以表现出不同的 UI 风格（”小屏”手机，大屏平板，超大屏电视等）。其中抽象出一个 IStatusBar 的 IBinder 接口提供 SS 中的服务调用 SystemUI 相关的接口，让 SystemUI 在 UI 上展现一条通知。然后 BaseStatusBar 的具体子类只要能满足 SS 中（具体是 SBMS）的接口需求就行。所以 BaseStatusBar 中在状态栏初始化的时候会向 SBMS 注册当前实现 IStatusBar 接口的对象（当前使用的 UI 风格）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ================= BaseStatusBar.java ========================</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span>() {</div><div class="line">        mWindowManager = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">        mWindowManagerService = WindowManagerGlobal.getWindowManagerService();</div><div class="line">        mDisplay = mWindowManager.getDefaultDisplay();</div><div class="line">        </div><div class="line">        <span class="comment">// 向 SM 获取 SBMS</span></div><div class="line">        mBarService = IStatusBarService.Stub.asInterface(</div><div class="line">                ServiceManager.getService(Context.STATUS_BAR_SERVICE));</div><div class="line"></div><div class="line">        <span class="comment">// Connect in to the status bar manager service</span></div><div class="line">        StatusBarIconList iconList = <span class="keyword">new</span> StatusBarIconList();</div><div class="line">        ArrayList&lt;IBinder&gt; notificationKeys = <span class="keyword">new</span> ArrayList&lt;IBinder&gt;();</div><div class="line">        ArrayList&lt;StatusBarNotification&gt; notifications = <span class="keyword">new</span> ArrayList&lt;StatusBarNotification&gt;();</div><div class="line">        mCommandQueue = <span class="keyword">new</span> CommandQueue(<span class="keyword">this</span>, iconList);</div><div class="line"></div><div class="line">        <span class="keyword">int</span>[] switches = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">7</span>];</div><div class="line">        ArrayList&lt;IBinder&gt; binders = <span class="keyword">new</span> ArrayList&lt;IBinder&gt;();</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="comment">// 调用 SBMS 的注册接口注册</span></div><div class="line">            mBarService.registerStatusBar(mCommandQueue, iconList, notificationKeys, notifications,</div><div class="line">                    switches, binders);</div><div class="line">        } <span class="keyword">catch</span> (RemoteException ex) {</div><div class="line">            <span class="comment">// If the system process isn't there we're doomed anyway.</span></div><div class="line">        }  </div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后你发现其实注册的不是 BaseStatusBar 自己，而是一个叫 CommandQueue 的东西：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ================= CommandQueue.java ========================</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * This class takes the functions from IStatusBar that come in on</span></div><div class="line"><span class="comment"> * binder pool threads and posts messages to get them onto the main</span></div><div class="line"><span class="comment"> * thread, and calls onto Callbacks.  It also takes care of</span></div><div class="line"><span class="comment"> * coalescing these calls so they don't stack up.  For the calls</span></div><div class="line"><span class="comment"> * are coalesced, note that they are all idempotent.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandQueue</span> <span class="keyword">extends</span> <span class="title">IStatusBar</span>.<span class="title">Stub</span> </span>{</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MASK = <span class="number">0xffff</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SHIFT  = <span class="number">16</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_MASK   = <span class="number">0xffff</span> &lt;&lt; MSG_SHIFT;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_SET_ICON    = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_REMOVE_ICON = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_ICON                       = <span class="number">1</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_ADD_NOTIFICATION           = <span class="number">2</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_UPDATE_NOTIFICATION        = <span class="number">3</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_REMOVE_NOTIFICATION        = <span class="number">4</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_DISABLE                    = <span class="number">5</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_EXPAND_NOTIFICATIONS       = <span class="number">6</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_COLLAPSE_PANELS            = <span class="number">7</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_EXPAND_SETTINGS            = <span class="number">8</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SET_SYSTEMUI_VISIBILITY    = <span class="number">9</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_TOP_APP_WINDOW_CHANGED     = <span class="number">10</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SHOW_IME_BUTTON            = <span class="number">11</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SET_HARD_KEYBOARD_STATUS   = <span class="number">12</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_TOGGLE_RECENT_APPS         = <span class="number">13</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_PRELOAD_RECENT_APPS        = <span class="number">14</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_CANCEL_PRELOAD_RECENT_APPS = <span class="number">15</span> &lt;&lt; MSG_SHIFT;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SET_NAVIGATION_ICON_HINTS  = <span class="number">16</span> &lt;&lt; MSG_SHIFT;</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">private</span> StatusBarIconList mList;</div><div class="line">    <span class="keyword">private</span> Callbacks mCallbacks;</div><div class="line">    <span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> H();</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="comment">// 这里的 interface 的接口，正好全是 IStatusBar.aidl 中的接口</span></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * These methods are called back on the main thread.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callbacks</span> </span>{</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addIcon</span>(String slot, <span class="keyword">int</span> index, <span class="keyword">int</span> viewIndex, StatusBarIcon icon);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateIcon</span>(String slot, <span class="keyword">int</span> index, <span class="keyword">int</span> viewIndex,</div><div class="line">                StatusBarIcon old, StatusBarIcon icon);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeIcon</span>(String slot, <span class="keyword">int</span> index, <span class="keyword">int</span> viewIndex);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNotification</span>(IBinder key, StatusBarNotification notification);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateNotification</span>(IBinder key, StatusBarNotification notification);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeNotification</span>(IBinder key);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disable</span>(<span class="keyword">int</span> state);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">animateExpandNotificationsPanel</span>();</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">animateCollapsePanels</span>(<span class="keyword">int</span> flags);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">animateExpandSettingsPanel</span>();</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSystemUiVisibility</span>(<span class="keyword">int</span> vis, <span class="keyword">int</span> mask);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">topAppWindowChanged</span>(<span class="keyword">boolean</span> visible);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImeWindowStatus</span>(IBinder token, <span class="keyword">int</span> vis, <span class="keyword">int</span> backDisposition);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHardKeyboardStatus</span>(<span class="keyword">boolean</span> available, <span class="keyword">boolean</span> enabled);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toggleRecentApps</span>();</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preloadRecentApps</span>();</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showSearchPanel</span>();</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hideSearchPanel</span>();</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelPreloadRecentApps</span>();</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNavigationIconHints</span>(<span class="keyword">int</span> hints);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="title">CommandQueue</span>(Callbacks callbacks, StatusBarIconList list) {</div><div class="line">        mCallbacks = callbacks;</div><div class="line">        mList = list;</div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNotification</span>(IBinder key, StatusBarNotification notification) {</div><div class="line">        <span class="keyword">synchronized</span> (mList) {</div><div class="line">            NotificationQueueEntry ne = <span class="keyword">new</span> NotificationQueueEntry();</div><div class="line">            ne.key = key;</div><div class="line">            ne.notification = notification;</div><div class="line">            mHandler.sendMessageDelayed(mHandler.obtainMessage(MSG_ADD_NOTIFICATION, <span class="number">0</span>, <span class="number">0</span>, ne), <span class="number">300</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>{</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> what = msg.what & MSG_MASK;</div><div class="line">            <span class="keyword">switch</span> (what) {</div><div class="line">... ...</div><div class="line">                <span class="keyword">case</span> MSG_ADD_NOTIFICATION: {   </div><div class="line">                    <span class="keyword">final</span> NotificationQueueEntry ne = (NotificationQueueEntry)msg.obj;</div><div class="line">                    mCallbacks.addNotification(ne.key, ne.notification);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                }</div><div class="line">... ...</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// ================= BaseStatusBar.java ========================</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseStatusBar</span> <span class="keyword">extends</span> <span class="title">SystemUI</span> <span class="keyword">implements</span></span></div><div class="line"><span class="class">        <span class="title">CommandQueue</span>.<span class="title">Callbacks</span> </span>{</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>看完上面的代码，就知道 SystemUI 中状态栏的设计架构了吧。就是说 IStatusBar.aidl 定义一系列接口给 SS 用，然后 BaseStatusBar 完成一些状态栏公用的工作（例如生成 notification row 的模板），其他的接口交由子类实现。这里我们以 PhoneStatusBar（好像 4.4 之后 android 原生的 UI 都是用这个了，想看 Tablet UI 的可以拿 4.2 玩一下） 来说明一下 addNotification 的流程。</p>
<p>SBMS IPC 调用 addNotification 之后把通知的 IBinder key 和 sbn 传了过来，我们来看下 PhoneStatusBar 中的具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNotification</span>(IBinder key, StatusBarNotification notification) {</div><div class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"addNotification score="</span> + notification.score);</div><div class="line">    <span class="comment">// 大部分工作在这里</span></div><div class="line">    StatusBarIconView iconView = addNotificationViews(key, notification);</div><div class="line">    <span class="keyword">if</span> (iconView == <span class="keyword">null</span>) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> immersive = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        immersive = ActivityManagerNative.getDefault().isTopActivityImmersive();</div><div class="line">        <span class="keyword">if</span> (DEBUG) {</div><div class="line">            Slog.d(TAG, <span class="string">"Top activity is "</span> + (immersive?<span class="string">"immersive"</span>:<span class="string">"not immersive"</span>));</div><div class="line">        }    </div><div class="line">    } <span class="keyword">catch</span> (RemoteException ex) {}</div><div class="line"></div><div class="line">    <span class="comment">// 如果通知设置了 fullScreenIntent，执行 fullScreenIntent 中设置的动作</span></div><div class="line">    <span class="comment">//（启动相应的 activity 或是发送相应的广播）</span></div><div class="line">    <span class="keyword">if</span> (notification.notification.fullScreenIntent != <span class="keyword">null</span>) {</div><div class="line">        <span class="comment">// Stop screensaver if the notification has a full-screen intent.</span></div><div class="line">        <span class="comment">// (like an incoming phone call)</span></div><div class="line">        awakenDreams();</div><div class="line"></div><div class="line">        <span class="comment">// not immersive & a full-screen alert should be shown</span></div><div class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Notification has fullScreenIntent; sending fullScreenIntent"</span>);</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            notification.notification.fullScreenIntent.send();</div><div class="line">        } <span class="keyword">catch</span> (PendingIntent.CanceledException e) { </div><div class="line">        }    </div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="comment">// usual case: status bar visible & not immersive</span></div><div class="line"></div><div class="line">        <span class="comment">// 如果没指定 fullScreenIntent 那么在状态栏上展现一下 ticker 动画</span></div><div class="line">        <span class="comment">// show the ticker if there isn't an intruder too</span></div><div class="line">        <span class="keyword">if</span> (mCurrentlyIntrudingNotification == <span class="keyword">null</span>) {</div><div class="line">            tick(<span class="keyword">null</span>, notification, <span class="keyword">true</span>);</div><div class="line">        }    </div><div class="line">    }    </div><div class="line"></div><div class="line">    <span class="comment">// Recalculate the position of the sliding windows and the titles.</span></div><div class="line">    setAreThereNotifications();</div><div class="line">    updateExpandedViewPos(EXPANDED_LEAVE_ALONE);</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里一开始就调用了基类 BaseStatusBar 中的 addNotificationViews 函数，这个函数就属于状态栏的共用函数之一，通知在 SystemUI 上的 UI 元素基本上都由这个函数生成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> StatusBarIconView <span class="title">addNotificationViews</span>(IBinder key,</div><div class="line">        StatusBarNotification notification) {</div><div class="line">    <span class="keyword">if</span> (DEBUG) {</div><div class="line">        Slog.d(TAG, <span class="string">"addNotificationViews(key="</span> + key + <span class="string">", notification="</span> + notification);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// 构造状态栏小图标</span></div><div class="line">    <span class="comment">// Construct the icon.</span></div><div class="line">    <span class="keyword">final</span> StatusBarIconView iconView = <span class="keyword">new</span> StatusBarIconView(mContext,</div><div class="line">            notification.pkg + <span class="string">"/0x"</span> + Integer.toHexString(notification.id),</div><div class="line">            notification.notification);</div><div class="line">    iconView.setScaleType(ImageView.ScaleType.CENTER_INSIDE);</div><div class="line">    </div><div class="line">    <span class="comment">// 构造状态栏小图标对应数据 -_-||            </span></div><div class="line">    <span class="keyword">final</span> StatusBarIcon ic = <span class="keyword">new</span> StatusBarIcon(notification.pkg,</div><div class="line">                notification.user,</div><div class="line">                notification.notification.icon,</div><div class="line">                notification.notification.iconLevel,</div><div class="line">                notification.notification.number,</div><div class="line">                notification.notification.tickerText);</div><div class="line">    <span class="comment">// 把数据设置给状态栏小图标</span></div><div class="line">    <span class="keyword">if</span> (!iconView.set(ic)) {</div><div class="line">        handleNotificationError(key, notification, <span class="string">"Couldn't create icon: "</span> + ic);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">    <span class="comment">// 构造 SystemUI 通知数据结构</span></div><div class="line">    <span class="comment">// Construct the expanded view.</span></div><div class="line">    NotificationData.Entry entry = <span class="keyword">new</span> NotificationData.Entry(key, notification, iconView);</div><div class="line">    <span class="comment">// 构造通知面板上的通知 view，并将其加入通知面板上 </span></div><div class="line">    <span class="keyword">if</span> (!inflateViews(entry, mPile)) {</div><div class="line">        handleNotificationError(key, notification, <span class="string">"Couldn't expand RemoteViews for: "</span></div><div class="line">                + notification);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">    </div><div class="line">    <span class="comment">// 保存通知数据</span></div><div class="line">    <span class="comment">// Add the expanded view and icon.</span></div><div class="line">    <span class="keyword">int</span> pos = mNotificationData.add(entry);</div><div class="line">    <span class="keyword">if</span> (DEBUG) {</div><div class="line">        Slog.d(TAG, <span class="string">"addNotificationViews: added at "</span> + pos);</div><div class="line">    }</div><div class="line">    updateExpansionStates();</div><div class="line">    <span class="comment">// 更新状态栏上的通知小图标（新的加入到状态栏上去）</span></div><div class="line">    updateNotificationIcons();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> iconView;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里 StatusBarIconView 别看是继承了 AnimatedImageView，其实最后 AnimatedImageView 最后是继承了 ImageView，也就是说状态栏上左上角那一排通知的小图标就是一堆 ImageView（右边那一排也是一样的，不过那一排叫 Status Icon，系统状态图标，和通知小图标是不一样的东西，刚开始容易搞混，这个东西后面我单独开一篇来说）。然后后面这里就是 framework 中最后一个模块 SystemUI 中持有的通知的数据结构了 NotificationData：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * The list of currently displaying notifications.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationData</span> </span>{</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>{</div><div class="line">        <span class="keyword">public</span> IBinder key;</div><div class="line">        <span class="keyword">public</span> StatusBarNotification notification;</div><div class="line">        <span class="keyword">public</span> StatusBarIconView icon;</div><div class="line">        <span class="keyword">public</span> View row; <span class="comment">// the outer expanded view</span></div><div class="line">        <span class="keyword">public</span> View content; <span class="comment">// takes the click events and sends the PendingIntent</span></div><div class="line">        <span class="keyword">public</span> View expanded; <span class="comment">// the inflated RemoteViews</span></div><div class="line">        <span class="keyword">public</span> ImageView largeIcon;</div><div class="line">        <span class="keyword">protected</span> View expandedLarge;</div><div class="line">        <span class="keyword">public</span> <span class="title">Entry</span>() {}</div><div class="line">        <span class="keyword">public</span> <span class="title">Entry</span>(IBinder key, StatusBarNotification n, StatusBarIconView ic) {</div><div class="line">            <span class="keyword">this</span>.key = key;</div><div class="line">            <span class="keyword">this</span>.notification = n;</div><div class="line">            <span class="keyword">this</span>.icon = ic; </div><div class="line">        } </div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="comment">// 保存的数据的最后是一个 ArrayList</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;Entry&gt; mEntries = <span class="keyword">new</span> ArrayList&lt;Entry&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;Entry&gt; mEntryCmp = <span class="keyword">new</span> Comparator&lt;Entry&gt;() {</div><div class="line">        <span class="comment">// sort first by score, then by when</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span>(Entry a, Entry b) {</div><div class="line">            <span class="keyword">final</span> StatusBarNotification na = a.notification;</div><div class="line">            <span class="keyword">final</span> StatusBarNotification nb = b.notification;</div><div class="line">            <span class="keyword">int</span> d = na.score - nb.score;</div><div class="line">            <span class="keyword">return</span> (d != <span class="number">0</span>)</div><div class="line">                ? d</div><div class="line">                : (<span class="keyword">int</span>)(na.notification.when - nb.notification.when);</div><div class="line">        }</div><div class="line">    };</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="comment">// 它的大多数接口都是封装对上面那个 ArrayList 的操作 </span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span>(Entry entry) {</div><div class="line">        <span class="keyword">int</span> i;</div><div class="line">        <span class="keyword">int</span> N = mEntries.size();</div><div class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) {</div><div class="line">            <span class="keyword">if</span> (mEntryCmp.compare(mEntries.get(i), entry) &gt; <span class="number">0</span>) {</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        mEntries.add(i, entry);</div><div class="line">        <span class="keyword">return</span> i;</div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个数据结构内部还有一个 Entry 类，可以看到 Entry 中不光有 sbn，还有好几个 view，这几个 view 就是 SystemUI 中一个通知的 UI 元素了。然后它的插入啊，删除啊都通过一个 Entry 的 ArrayList 来实现的。回到 addNotificationViews 中，后面有一个 inflateViews</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span>  <span class="keyword">boolean</span> <span class="title">inflateViews</span>(NotificationData.Entry entry, ViewGroup parent) {</div><div class="line">    <span class="keyword">int</span> minHeight =</div><div class="line">            mContext.getResources().getDimensionPixelSize(R.dimen.notification_min_height);</div><div class="line">    <span class="keyword">int</span> maxHeight =</div><div class="line">            mContext.getResources().getDimensionPixelSize(R.dimen.notification_max_height);</div><div class="line">    StatusBarNotification sbn = entry.notification;</div><div class="line">    <span class="comment">// oneU 是通知 normal view</span></div><div class="line">    <span class="comment">// large 是通知 big view</span></div><div class="line">    RemoteViews oneU = sbn.notification.contentView;</div><div class="line">    RemoteViews large = sbn.notification.bigContentView;</div><div class="line">    <span class="keyword">if</span> (oneU == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// create the row view</span></div><div class="line">    LayoutInflater inflater = (LayoutInflater)mContext.getSystemService(</div><div class="line">            Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">    <span class="comment">// new 通知的容器（notiifcation row），这个容器是模板来的。</span></div><div class="line">    <span class="comment">// 这个是用来装通知的 content view 和 big content view 的。</span></div><div class="line">    <span class="comment">// 这里注意一点：LayoutInflater 的第二参数 ViewGroup 如果不是 null 的话，那么 new 出来的 view </span></div><div class="line">    <span class="comment">// 会自动 add 到传递的 ViewGroup 中，所以这里在 new 出 notification row 后，</span></div><div class="line">    <span class="comment">// 就自动添加到前面传递过来的 mPile 中去了（这个是通知面板中显示通知的容器）。</span></div><div class="line">    View row = inflater.inflate(R.layout.status_bar_notification_row, parent, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="comment">// for blaming (see SwipeHelper.setLongPressListener)</span></div><div class="line">    row.setTag(sbn.pkg);</div><div class="line"></div><div class="line">    workAroundBadLayerDrawableOpacity(row);</div><div class="line">    View vetoButton = updateNotificationVetoButton(row, sbn);</div><div class="line">    vetoButton.setContentDescription(mContext.getString(</div><div class="line">            R.string.accessibility_remove_notification));</div><div class="line"></div><div class="line">    <span class="comment">// NB: the large icon is now handled entirely by the template</span></div><div class="line"></div><div class="line">    <span class="comment">// bind the click event to the content area</span></div><div class="line">    ViewGroup content = (ViewGroup)row.findViewById(R.id.content);</div><div class="line">    ViewGroup adaptive = (ViewGroup)row.findViewById(R.id.adaptive);</div><div class="line"></div><div class="line">    content.setDescendantFocusability(ViewGroup.FOCUS_BLOCK_DESCENDANTS);</div><div class="line"></div><div class="line">    <span class="comment">// 如果通知设置了点击动作，那么设置到通知的 view OnClick 时间中去</span></div><div class="line">    PendingIntent contentIntent = sbn.notification.contentIntent;</div><div class="line">    <span class="keyword">if</span> (contentIntent != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">final</span> View.OnClickListener listener = <span class="keyword">new</span> NotificationClicker(contentIntent,</div><div class="line">                sbn.pkg, sbn.tag, sbn.id);</div><div class="line">        content.setOnClickListener(listener);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        content.setOnClickListener(<span class="keyword">null</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// TODO(cwren) normalize variable names with those in updateNotification</span></div><div class="line">    View expandedOneU = <span class="keyword">null</span>;</div><div class="line">    View expandedLarge = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="comment">// 把通知的 content view（RemoteViews）加入到 notification row</span></div><div class="line">        expandedOneU = oneU.apply(mContext, adaptive, mOnClickHandler);</div><div class="line">        <span class="comment">// 如果通知有 big content view（RemoteViews） 也一起加入 notification row</span></div><div class="line">        <span class="keyword">if</span> (large != <span class="keyword">null</span>) {</div><div class="line">            expandedLarge = large.apply(mContext, adaptive, mOnClickHandler);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">catch</span> (RuntimeException e) {</div><div class="line">        <span class="keyword">final</span> String ident = sbn.pkg + <span class="string">"/0x"</span> + Integer.toHexString(sbn.id);</div><div class="line">        Slog.e(TAG, <span class="string">"couldn't inflate view for notification "</span> + ident, e);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (expandedOneU != <span class="keyword">null</span>) {</div><div class="line">        SizeAdaptiveLayout.LayoutParams params =</div><div class="line">                <span class="keyword">new</span> SizeAdaptiveLayout.LayoutParams(expandedOneU.getLayoutParams());</div><div class="line">        params.minHeight = minHeight;</div><div class="line">        params.maxHeight = minHeight;</div><div class="line">        adaptive.addView(expandedOneU, params);</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (expandedLarge != <span class="keyword">null</span>) {</div><div class="line">        SizeAdaptiveLayout.LayoutParams params =</div><div class="line">                <span class="keyword">new</span> SizeAdaptiveLayout.LayoutParams(expandedLarge.getLayoutParams());</div><div class="line">        params.minHeight = minHeight+<span class="number">1</span>;</div><div class="line">        params.maxHeight = maxHeight;</div><div class="line">        adaptive.addView(expandedLarge, params);</div><div class="line">    }</div><div class="line">    row.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    applyLegacyRowBackground(sbn, content);</div><div class="line"></div><div class="line">    row.setTag(R.id.expandable_tag, Boolean.valueOf(large != <span class="keyword">null</span>));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (MULTIUSER_DEBUG) { </div><div class="line">        TextView debug = (TextView) row.findViewById(R.id.debug_info);</div><div class="line">        <span class="keyword">if</span> (debug != <span class="keyword">null</span>) {</div><div class="line">            debug.setVisibility(View.VISIBLE);</div><div class="line">            debug.setText(<span class="string">"U "</span> + entry.notification.getUserId());</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="comment">// 设置一下 SystemUI 的通知数据</span></div><div class="line">    entry.row = row;</div><div class="line">    entry.content = content;</div><div class="line">    entry.expanded = expandedOneU;</div><div class="line">    entry.setLargeView(expandedLarge);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>要讲解的我都注释在代码里面了，这里就是稍微注意下 LayoutInflater.inflate 那里会自动把生成的 view 添加到通知面板上的通知容器中，如果第一次不注意会觉得奇怪，不知道在哪里把 notification row 加到通知面板中去的。可以看到其实 BaseStatusBar 又给通知做了一个模板套套，然后才是把应用设置（其实大多时候也是用 Notification 生成的模板）的通知的 content view 加到这个模板套套中，因为这个可以控制每一个 notification row 的大小。这样可以由系统控制最终通知显示的 UI 效果（notification row 的最后大小是由 SystemUI 决定的）。</p>
<p>这样通知面板上的 notification row 就弄好了，然后回到 addNotificationViews 中最后 updateNotificationIcons ，这个虽然不是 IStatusBar 的接口，但是 BaseStatusBar 中的抽象接口，留给子类实现的，BaseStatusBar 有好几这样的抽象几个，基本都是 UI 相关的（毕竟子类要实现不同的 UI 风格么）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">haltTicker</span>();</div><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setAreThereNotifications</span>();</div><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">updateNotificationIcons</span>();</div><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">tick</span>(IBinder key, StatusBarNotification n, <span class="keyword">boolean</span> firstTime);</div><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">updateExpandedViewPos</span>(<span class="keyword">int</span> expandedPosition);</div><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getExpandedViewMaxHeight</span>();</div><div class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">shouldDisableNavbarGestures</span>();</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后我们去 PhoneStatusBar 中看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateNotificationIcons</span>() {</div><div class="line">    <span class="keyword">if</span> (mNotificationIcons == <span class="keyword">null</span>) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    loadNotificationShade();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> LinearLayout.LayoutParams params</div><div class="line">        = <span class="keyword">new</span> LinearLayout.LayoutParams(mIconSize + <span class="number">2</span>*mIconHPadding, mNaturalBarHeight);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> N = mNotificationData.size();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (DEBUG) {</div><div class="line">        Slog.d(TAG, <span class="string">"refreshing icons: "</span> + N + <span class="string">" notifications, mNotificationIcons="</span> + mNotificationIcons);</div><div class="line">    }    </div><div class="line"></div><div class="line">    ArrayList&lt;View&gt; toShow = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> provisioned = isDeviceProvisioned();</div><div class="line">    <span class="comment">// If the device hasn't been through Setup, we only show system notifications</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) {</div><div class="line">        Entry ent = mNotificationData.get(N-i-<span class="number">1</span>);</div><div class="line">        <span class="keyword">if</span> (!((provisioned && ent.notification.score &gt;= HIDE_ICONS_BELOW_SCORE)</div><div class="line">                || showNotificationEvenIfUnprovisioned(ent.notification))) <span class="keyword">continue</span>;</div><div class="line">        <span class="keyword">if</span> (!notificationIsForCurrentUser(ent.notification)) <span class="keyword">continue</span>;</div><div class="line">        toShow.add(ent.icon);</div><div class="line">    }    </div><div class="line"></div><div class="line">    ArrayList&lt;View&gt; toRemove = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mNotificationIcons.getChildCount(); i++) {</div><div class="line">        View child = mNotificationIcons.getChildAt(i);</div><div class="line">        <span class="keyword">if</span> (!toShow.contains(child)) {</div><div class="line">            toRemove.add(child);</div><div class="line">        }    </div><div class="line">    }    </div><div class="line"></div><div class="line">    <span class="keyword">for</span> (View remove : toRemove) {</div><div class="line">        mNotificationIcons.removeView(remove);</div><div class="line">    }    </div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;toShow.size(); i++) {</div><div class="line">        View v = toShow.get(i);</div><div class="line">        <span class="keyword">if</span> (v.getParent() == <span class="keyword">null</span>) {</div><div class="line">            mNotificationIcons.addView(v, i, params);</div><div class="line">        }    </div><div class="line">    }    </div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>PhoneStatusBar 中的 mNotificationIcons 是一个叫 IconMerger 的东西，这个是继承自 LinearLayout 的一个自定义的布局。叫 IconMerger 是因为它有一个功能，当通知很多（状态栏的小图标很多）的情况下，它会把显示不下的图标合并显示成一个类似 “+” 号的图标表示显示不下了。这里我们就不去细看了。然后这里也不用细说什么就是玩 ViewGroup（mNotificationIcons）添加（删除）子 view（StatusBarIconView） 而已。然后到这里 BaseStatusBar 中的 addNotificationViews 就处理完了。然后最后回到 PhoneStatusBar 的 addNotification 最后那里，如果通知设置了 fullScreenIntent 就执行相应的操作，否则展现 ticker 动画效果（效果见前面的效果的那个 ticker view）。</p>
<p>到这里一条通知的发送流程就走完了。然后这里是以发送一条新通知来说的，前面看到系统有判断如果发送的这条通知前面已经在系统中存在了，那么就会更新对应的数据（NMS，SBMS中）和对应的 SystemUI 中的 UI 元素（会去通知容器中去找），鉴于这篇已经很长了，后面单独开一篇来说更新的事吧。</p>
<p>然后最后总结一下：这里涉及到系统里面的3个模块：NMS，SBMS 和 SystemUI。其中 NMS 直接是管理通知服务的，SBMS 是界面（SystemUI）系统功能（通知等）桥接，应用通过系统功能的接口（例如 NMS）使用系统提供的一系列 UI 接口。然后这些系统接口再通过系统界面的桥接（SBMS）让界面系统（SystemUI）展现相关 UI 元素（视图和控制分工明确，可以学习一下 android 的设计）。最后我们来列下相关模块的对应的数据结构（第一次看还是有点晕的）：</p>
<pre>
App                        --> Notification
NotificationManagerService --> mNotificationList (ArrayList<notificationrecord>)
StatusBarManagerService    --> mNotifications (HashMap<ibinder, statusbarnotification="">)
SystemUI                   --> mNotificationData(NotificationData.Entry[ArrayList])
                            |--> StatusBarIconView(StatusBarIcon)
                            |--> notification row
                            |--> Ticker
</ibinder,></notificationrecord></pre>

<h2 id="小技巧">小技巧</h2>
<p>看完上面流程分析，大家应该会发现默认状态栏的小图标和通知 content view 那个显示的图标都是用 Notification 的 icon 的，就是默认是一样的。但是有些时候想让它们不一样，没有没办法咧，仔细看上面的代码会发现方法是用的。因为 content view 在 Notification build 那里创建，而且 SystemUI 状态栏上的 StatusBarIconView 是在 SystemUI 这边创建的（NM 发送 notify 后），那么我们就有曲线救国的方法了：那就是在构造 Notification 的 content view 前把 icon 设置为 content view 想要的图标（如果不使用 Builder 就是在调用 setLatestEventInfo 前，如果使用 Builder 的话在 Builder 的接口中设），然后再改为状态栏想要的图标，最后再调用 notify 就行咯（大家看到我贴的效果图的这2个图标是不一样的了没，这里我可是没改系统实现的哦）。哎，还是上下代码比较直接：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">NotificationManager nm = (NotificationManager)getSystemService(</div><div class="line">    Context.NOTIFICATION_SERVICE);</div><div class="line">Notification n = <span class="keyword">new</span> Notification(</div><div class="line">    <span class="comment">// 这里先设置通知面板那通知要显示的图标</span></div><div class="line">    R.drawable.stat_sys_data_usb, </div><div class="line">    label, System.currentTimeMillis());</div><div class="line"><span class="comment">// 然后构造 content view 设置 notification row 那的图标</span></div><div class="line">n.setLatestEventInfo(<span class="keyword">this</span>, label, </div><div class="line">    <span class="string">"No. "</span> + ID + <span class="string">": info This is just for test notification bar info"</span>,</div><div class="line">    intent);</div><div class="line"><span class="comment">// 然后马上把 icon 改成状态栏想要显示的小图标</span></div><div class="line">n.icon = R.drawable.stat_sys_data_usb_small;</div><div class="line"><span class="comment">// 最后用 NM 发送通知，这样在 SystemUI 那生成的 StatusBarIcon 就和通知面板上的图标不一样了</span></div><div class="line">nm.notify(ID, n);</div><div class="line"></div></pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/android/">android</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-Framework/">Android Framework</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.light3moon.com/2015/02/06/Android SystemUI 分析——通知/" data-title="Android SystemUI 分析——通知 | Light.Moon" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/03/04/Android SystemUI 分析——状态栏图标/" title="Android SystemUI 分析——状态栏图标">
  <strong>上一篇:</strong><br/>
  <span>
  Android SystemUI 分析——状态栏图标</span>
</a>
</div>


<div class="next">
<a href="/2015/02/06/Android SystemUI 分析——最近任务列表/"  title="Android SystemUI 分析——最近任务列表">
 <strong>下一篇:</strong><br/> 
 <span>Android SystemUI 分析——最近任务列表
</span>
</a>
</div>

</nav>


	
<section class="comment">
	<div class="ds-thread" data-thread-key="Android SystemUI 分析——通知" data-title="Android SystemUI 分析——通知" 
      data-author-key="mingming" data-limit=10
      data-url="light3moon.com/2015/02/06/Android SystemUI 分析——通知/">
    </div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#UI_表现"><span class="toc-number">1.</span> <span class="toc-text">UI 表现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通知标示"><span class="toc-number">2.</span> <span class="toc-text">通知标示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Content"><span class="toc-number">3.</span> <span class="toc-text">Content</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#直接设置_Notification"><span class="toc-number">3.1.</span> <span class="toc-text">直接设置 Notification</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用_Notification-Builder"><span class="toc-number">3.2.</span> <span class="toc-text">使用 Notification.Builder</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#系统处理流程"><span class="toc-number">4.</span> <span class="toc-text">系统处理流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小技巧"><span class="toc-number">5.</span> <span class="toc-text">小技巧</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android-Development/" title="Android Development">Android Development<sup>31</sup></a></li>
		
			<li><a href="/categories/Android-Framework/" title="Android Framework">Android Framework<sup>46</sup></a></li>
		
			<li><a href="/categories/Basics-Knowledge/" title="Basics Knowledge">Basics Knowledge<sup>11</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>23</sup></a></li>
		
			<li><a href="/categories/MiniGUI/" title="MiniGUI">MiniGUI<sup>12</sup></a></li>
		
			<li><a href="/categories/Other/" title="Other">Other<sup>8</sup></a></li>
		
			<li><a href="/categories/Window/" title="Window">Window<sup>10</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/android/" title="android">android<sup>77</sup></a></li>
		
			<li><a href="/tags/basics/" title="basics">basics<sup>11</sup></a></li>
		
			<li><a href="/tags/install/" title="install">install<sup>9</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>27</sup></a></li>
		
			<li><a href="/tags/minigui/" title="minigui">minigui<sup>13</sup></a></li>
		
			<li><a href="/tags/opengl/" title="opengl">opengl<sup>3</sup></a></li>
		
			<li><a href="/tags/other/" title="other">other<sup>5</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>5</sup></a></li>
		
			<li><a href="/tags/window/" title="window">window<sup>11</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">哥的后勤处 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-qqzone"></i> <a href="http://user.qzone.qq.com/544630305" target="_blank">QQ 空间</a></li>
      <li><i class="fa fa-github"></i> <a href="https://github.com/mingming-killer" target="_blank">GitHub</a></li>
      
        
          <li><i class="fa fa-analytics"></i> <a href="http://tongji.baidu.com/web/welcome/ico?s=fa045dbd45ffce238b146e00f91ba6a3" target="_blank">战斗力</a></li>
        
      
      <li><i class="fa fa-markdown-help"></i> <a href="http://zh.wikipedia.org/wiki/Markdown" target="_blank">Makrdown</a></li>
    </ul>
</div>


  <div class="commentlist">
  <p class="asidetitle">最近冒泡的小伙伴 ╰(●&#39;◡&#39;●)╮</p>
    <ul>
      <ul class="ds-recent-comments" 
        data-num-items="6" 
        data-show-avatars="1" 
        data-show-title="1"   
        data-show-time="1" 
        data-show-admin="1" 
        data-excerpt-length="30">
      </ul>
      <!-- duoshou js begin load, one page only load once -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"mingming"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
      <!-- duoshou js load end -->
    </ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-book"></i> <a href="http://taoyuanxiaoqi.com" target="_blank">桃园小七的博客</a></li>
    </ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
<!--
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
-->

     <!-- this is defined in footer.styl, line holder -->
	<div class="line">
	</div>
     
<!--
	<div class="social-font clearfix">
		
		
		
		
		
		<a href="https://github.com/mingming-killer" target="_blank" title="github"></a>
		
        	
		<a href="http://user.qzone.qq.com/544630305" target="_blank" title="qqzone"></a>
		         
	</div>
-->

		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/mingming-killer/Lightmoon" target="_blank" title="Lightmoon">Lightmoon</a> © 2015 
		
		<a href="http://www.light3moon.com" target="_blank" title="Mingming">Mingming</a>
		
		</p>

  <!-- baidu search verification -->
  
    <meta name="baidu-site-verification" content="w1BSX6yZ9k" />
  

  <!-- swiftype search verification -->
  

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"mingming"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fa045dbd45ffce238b146e00f91ba6a3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>
