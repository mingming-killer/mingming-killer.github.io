
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

  
    <title>Android SystemUI 分析——状态栏图标 | Light.Moon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Mingming">
    
    <meta name="description" content="通知篇说了一下有关 Notification 相关的东西，其中 Notification 有一个 UI 表现就是状态栏的图标，不过这篇说的是另外一种东西，虽然 UI 表现上和 Notification 的状态栏图标一样，但是使用上是不一样的。还是先照例把相关代码位置啰嗦一下（4.2.2）：
1234">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/apple_icon.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/apple_icon.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
		<div id="header_author">
		</div>
		

         <!--
         
           <div id="imglogo">
           <a href="/"><img src="/img/logo.svg" alt="Light.Moon" title="Light.Moon"/></a>
           </div>
         
         -->

			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Light.Moon">Light.Moon</a></h1>
				<h2 class="blog-motto">〜(￣△￣〜) 三月学长的根据地 (〜￣△￣)〜</h2>
			</div>

			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/1986/12/20/文章索引">索引</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					

                      <form class="search" action=http://search.light3moon.com/cse/search target="_blank">
                      <label>搜索</label>
                      <!--
                      <input name="s" type="hidden" value="undefined">
                      -->
                      <input name="s" type="hidden" value="12628367885198549364">
                      <input type="text" name="q" size="30" placeholder="搜索"> <br>

                      
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/03/04/Android SystemUI 分析——状态栏图标/" title="Android SystemUI 分析——状态栏图标" itemprop="url">Android SystemUI 分析——状态栏图标</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.light3moon.com" title="Mingming">Mingming</a>
    </p>
  <p class="article-time">
    <time datetime="2015-03-04T02:20:16.000Z" itemprop="datePublished">2015 3月 4</time>
    更新日期:<time datetime="2015-03-04T02:20:16.000Z" itemprop="dateModified">2015 3月 4</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#区分"><span class="toc-number">1.</span> <span class="toc-text">区分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#接口"><span class="toc-number">2.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#固定的数据"><span class="toc-number">3.</span> <span class="toc-text">固定的数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SystemUI_的处理"><span class="toc-number">4.</span> <span class="toc-text">SystemUI 的处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
		</div>
		
		<p>通知篇说了一下有关 Notification 相关的东西，其中 Notification 有一个 UI 表现就是状态栏的图标，不过这篇说的是另外一种东西，虽然 UI 表现上和 Notification 的状态栏图标一样，但是使用上是不一样的。还是先照例把相关代码位置啰嗦一下（4.2.2）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 应用接口相关代码</span></div><div class="line">frameworks/base/core/java/android/app/StatusBarManager.java</div><div class="line"></div><div class="line"><span class="comment"># 系统内部接口相关代码</span></div><div class="line">frameworks/base/core/java/com/android/internal/statusbar/IStatusBarService.aidl</div><div class="line">frameworks/base/core/java/com/android/internal/statusbar/IStatusBar.aidl</div><div class="line">frameworks/base/core/java/com/android/internal/statusbar/StatusBarIcon.java</div><div class="line"></div><div class="line"><span class="comment"># System Server 相关代码</span></div><div class="line">frameworks/base/services/java/com/android/server/StatusBarManagerService.java</div><div class="line"></div><div class="line"><span class="comment"># SystemUI 相关代码</span></div><div class="line">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/StatusBarIconView.java</div><div class="line">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/BaseStatusBar.java</div><div class="line">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/CommandQueue.java</div><div class="line">frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/PhoneStatusBar.java</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="区分">区分</h2>
<p>我们先来看一张图：</p>
<p><img src="http://7u2hy4.com1.z0.glb.clouddn.com/android/SystemUI-status-bar-icon/status-icon.png" alt=""></p>
<p>图中状态栏左边那一堆图标是通知篇说的 Notification 的小图标，右边那一堆就是这篇要说的系统状态图标。虽然这篇的名字是状态栏图标，但是因为通知篇说过 Notification 的了，所以这里只说系统的状态图标。通知的图标是每一个通知一个，然后如果通知太多的话，后面会显示一个 “+” 的图标代表有更多的通知图标，所以说左边通知的图标是不确定的，是由运行不同的程序来决定的。而系统状态图标是固定的，在 framework 中代码写死一共有多少种系统状态，然后系统运行不同功能的时候显示某个状态的图标，完成后，图标消失。例如说，设置（关闭）闹钟、开启（关闭）飞行模式、开启（关闭）静音。这里稍微注意下，只有图上右边框出来的部分（只是一小部分而已）才是系统状态，wifi、电量信息和时间不属于系统状态图标的。</p>
<h2 id="接口">接口</h2>
<p>我们先来看系统状态图标的接口，接口依旧在 StatusBarManager（SBM） 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* @hide */</span></div><div class="line">interface IStatusBarService</div><div class="line">{</div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">void</span> setIcon(String slot, String iconPackage, <span class="keyword">int</span> iconId, <span class="keyword">int</span> iconLevel, String contentDescription);</div><div class="line">    <span class="keyword">void</span> setIconVisibility(String slot, <span class="keyword">boolean</span> visible);</div><div class="line">    <span class="keyword">void</span> removeIcon(String slot);</div><div class="line"></div><div class="line">... ...</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>对外接口很简单就3个：</p>
<ul>
<li><strong>setIcon</strong>: 设置一个状态图标，主要参数是图标</li>
<li><strong>setIconVisibility</strong>: 设置一个状态图标显示（隐藏）</li>
<li><strong>removeIcon</strong>: 移除一个状态图标</li>
</ul>
<p>值得一提的是，这些接口都是系统内部使用的，因为整个 SBM 都是 hide 的（aidl、java 都是）。应用只能通过一些别的方法间接的去改变系统状态图标，无法直接更改。例如要让系统状态显示设置了闹钟，就要发送 android.intent.action.ALARM_CHANGED 广播（SystemUI 中有接收这个广播的地方，然后调用上面的接口来改变系统状态图标显示）。</p>
<p>这个设计还是必须的，因为如果随便开放接口给第三方应用直接改系统状态显示，有些捣乱的应用就要乱来了。不过虽然是 hide 的，java 有反射可以干坏事，不过下面会说到，接口里面权限检测的，所以反射也干不了坏事。</p>
<h2 id="固定的数据">固定的数据</h2>
<p>看完上面接口，是不是觉得 setIcon 为什么不叫 addIcon，来看下系统的实现（设计）就明白了。我们直接去 StatusBarManagerService（SBMS）里去看，不看 Bp 端的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// slot 是标示</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIcon</span>(String slot, String iconPackage, <span class="keyword">int</span> iconId, <span class="keyword">int</span> iconLevel,</div><div class="line">        String contentDescription) {</div><div class="line">    <span class="comment">// 检测调用者的权限</span></div><div class="line">    enforceStatusBar();</div><div class="line"></div><div class="line">    <span class="comment">// 喜闻乐见的 binder 业务函数同步锁</span></div><div class="line">    <span class="keyword">synchronized</span> (mIcons) {</div><div class="line">        <span class="comment">// 通过 slot 来查找 status bar icon 的数据索引</span></div><div class="line">        <span class="keyword">int</span> index = mIcons.getSlotIndex(slot);</div><div class="line">        <span class="comment">// 找不到的话，报异常</span></div><div class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"invalid status bar icon slot: "</span> + slot);</div><div class="line">        }   </div><div class="line"></div><div class="line">        <span class="comment">// new 数据对象</span></div><div class="line">        StatusBarIcon icon = <span class="keyword">new</span> StatusBarIcon(iconPackage, UserHandle.OWNER, iconId,</div><div class="line">                iconLevel, <span class="number">0</span>,</div><div class="line">                contentDescription);</div><div class="line">        <span class="comment">//Slog.d(TAG, "setIcon slot=" + slot + " index=" + index + " icon=" + icon);</span></div><div class="line">        mIcons.setIcon(index, icon);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mBar != <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                <span class="comment">// 最后还得通过 IPC 调用到 UI（SystemUI）通知下 UI 更新数据</span></div><div class="line">                mBar.setIcon(index, icon);</div><div class="line">            } <span class="keyword">catch</span> (RemoteException ex) {</div><div class="line">            }   </div><div class="line">        }   </div><div class="line">    }   </div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>最开始有前面说的权限检测：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enforceStatusBar</span>() {</div><div class="line">    mContext.enforceCallingOrSelfPermission(android.Manifest.permission.STATUS_BAR,</div><div class="line">            <span class="string">"StatusBarManagerService"</span>);    </div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>检测下调用者是否有权限调用 SBMS，估计应该是要 system app 才行吧。然后有一个叫 StatusBarIconList mIcons 的数据结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatusBarIconList</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>{</div><div class="line">    <span class="comment">// 主要是封装了一个 StatusBarIcon 数组，然后对应一个 Slots 的 String 数组</span></div><div class="line">    <span class="keyword">private</span> String[] mSlots;</div><div class="line">    <span class="keyword">private</span> StatusBarIcon[] mIcons;</div><div class="line">   </div><div class="line">    <span class="keyword">public</span> <span class="title">StatusBarIconList</span>() {</div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defineSlots</span>(String[] slots) {</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = slots.length;    </div><div class="line">        String[] s = mSlots = <span class="keyword">new</span> String[N];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) {      </div><div class="line">            s[i] = slots[i];</div><div class="line">        }</div><div class="line">        mIcons = <span class="keyword">new</span> StatusBarIcon[N]; </div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSlotIndex</span>(String slot) {</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mSlots.length;   </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) {      </div><div class="line">            <span class="keyword">if</span> (slot.equals(mSlots[i])) {  </div><div class="line">                <span class="keyword">return</span> i;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIcon</span>(<span class="keyword">int</span> index, StatusBarIcon icon) {</div><div class="line">        mIcons[index] = icon.clone();  </div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeIcon</span>(<span class="keyword">int</span> index) {</div><div class="line">        mIcons[index] = <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>名字也很形象，内部是用一个数组封装了下 StatusBarIcon，然后以 String 为标志（我觉得内部用 HashMap<string, statusbaricon=""> 会更好一些）。这里数据用得和 Notification 是一样的，都是 StatusBarIcon。然后关键点的方法也贴出来了，都比较简单一些贴这，后面提到的话翻回来看吧。前面说到系统状态图标是固定的，所以这里没有任何动态添加 StatusBarIcon 的接口，只有一个 defineSlots 的接口。之后，这个数组长度就固定了，哦，我收回我前面说用 HashMap 更好的话，长度固定的话，用数组最快。</string,></p>
<p>然后这个数组是在 SBMS 构造函数那里初始化的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Construct the service, add the status bar view to the window manager</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="title">StatusBarManagerService</span>(Context context, WindowManagerService windowManager) {</div><div class="line">    mContext = context;</div><div class="line">    mWindowManager = windowManager;</div><div class="line">    mWindowManager.setOnHardKeyboardStatusChangeListener(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Resources res = context.getResources();</div><div class="line">    mIcons.defineSlots(res.getStringArray(com.android.internal.R.array.config_statusBarIcons));</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>xml 中的数组在这：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- Do not translate. Defines the slots for the right-hand side icons.  That is to say, the</span></div><div class="line"><span class="comment">     icons in the status bar that are not notifications. --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">string-array</span> <span class="attribute">name</span>=<span class="value">"config_statusBarIcons"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>ime<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>sync_failing<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>sync_active<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>gps<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>bluetooth<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>nfc<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>tty<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>speakerphone<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>mute<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>volume<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>wifi<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>cdma_eri<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>data_connection<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>phone_evdo_signal<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>phone_signal<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>battery<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>alarm_clock<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>secure<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="title">item</span>&gt;</span><span class="tag">&lt;<span class="title">xliff:g</span> <span class="attribute">id</span>=<span class="value">"id"</span>&gt;</span>clock<span class="tag">&lt;/<span class="title">xliff:g</span>&gt;</span><span class="tag">&lt;/<span class="title">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">string-array</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure>

<p>4.2 的原生系统有上面 19 个系统状态图标。我们接下来把剩下2个接口也看完：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// setIconVisibility 其实是通过 setIcon 改变 StatusBarIcon 中的一个属性而已</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIconVisibility</span>(String slot, <span class="keyword">boolean</span> visible) {</div><div class="line">    enforceStatusBar();</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (mIcons) {        </div><div class="line">        <span class="keyword">int</span> index = mIcons.getSlotIndex(slot);</div><div class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"invalid status bar icon slot: "</span> + slot);</div><div class="line">        }</div><div class="line"></div><div class="line">        StatusBarIcon icon = mIcons.getIcon(index);</div><div class="line">        <span class="keyword">if</span> (icon == <span class="keyword">null</span>) {            </div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (icon.visible != visible) { </div><div class="line">            icon.visible = visible;        </div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mBar != <span class="keyword">null</span>) {            </div><div class="line">                <span class="keyword">try</span> {</div><div class="line">                    mBar.setIcon(index, icon);     </div><div class="line">                } <span class="keyword">catch</span> (RemoteException ex) { </div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// 这个是从 StatusBarIconList 找到对应的数据，然后置 NULL</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeIcon</span>(String slot) { </div><div class="line">    enforceStatusBar();</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (mIcons) {        </div><div class="line">        <span class="keyword">int</span> index = mIcons.getSlotIndex(slot);</div><div class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"invalid status bar icon slot: "</span> + slot);</div><div class="line">        }</div><div class="line"></div><div class="line">        mIcons.removeIcon(index);      </div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mBar != <span class="keyword">null</span>) {            </div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                mBar.removeIcon(index);        </div><div class="line">            } <span class="keyword">catch</span> (RemoteException ex) { </div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="SystemUI_的处理">SystemUI 的处理</h2>
<p>上面 SBMS 虽然有3个接口，但是 UI 这边就只有2个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* @hide */</span></div><div class="line">oneway interface IStatusBar</div><div class="line">{</div><div class="line">    <span class="keyword">void</span> setIcon(<span class="keyword">int</span> index, in StatusBarIcon icon);</div><div class="line">    <span class="keyword">void</span> removeIcon(<span class="keyword">int</span> index);</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>上面 SBMS 的实现也看到了，也只是用到 UI 这边2个接口。前面通知篇分析了 SystemUI 状态栏的一些设计和 UI 和 SS 那些关系的，这里就省略了（忘了的回去看一下）。桥接依旧在 CommandQueue：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIcon</span>(<span class="keyword">int</span> index, StatusBarIcon icon) {</div><div class="line">        <span class="keyword">synchronized</span> (mList) {</div><div class="line">            <span class="keyword">int</span> what = MSG_ICON | index;</div><div class="line">            mHandler.removeMessages(what);</div><div class="line">            mHandler.obtainMessage(what, OP_SET_ICON, <span class="number">0</span>, icon.clone()).sendToTarget();</div><div class="line">        }   </div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeIcon</span>(<span class="keyword">int</span> index) {</div><div class="line">        <span class="keyword">synchronized</span> (mList) {</div><div class="line">            <span class="keyword">int</span> what = MSG_ICON | index;</div><div class="line">            mHandler.removeMessages(what);</div><div class="line">            mHandler.obtainMessage(what, OP_REMOVE_ICON, <span class="number">0</span>, <span class="keyword">null</span>).sendToTarget();</div><div class="line">        }   </div><div class="line">    } </div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>{</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> what = msg.what & MSG_MASK;</div><div class="line">            <span class="keyword">switch</span> (what) {</div><div class="line">                <span class="keyword">case</span> MSG_ICON: {</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> index = msg.what & INDEX_MASK;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> viewIndex = mList.getViewIndex(index);</div><div class="line">                    <span class="keyword">switch</span> (msg.arg1) {</div><div class="line">                        <span class="keyword">case</span> OP_SET_ICON: {</div><div class="line">                            StatusBarIcon icon = (StatusBarIcon)msg.obj;</div><div class="line">                            StatusBarIcon old = mList.getIcon(index);</div><div class="line">                            <span class="keyword">if</span> (old == <span class="keyword">null</span>) {</div><div class="line">                                mList.setIcon(index, icon);</div><div class="line">                                mCallbacks.addIcon(mList.getSlot(index), index, viewIndex, icon);</div><div class="line">                            } <span class="keyword">else</span> {</div><div class="line">                                mList.setIcon(index, icon);</div><div class="line">                                mCallbacks.updateIcon(mList.getSlot(index), index, viewIndex,</div><div class="line">                                        old, icon);</div><div class="line">                            }</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        }</div><div class="line">                        <span class="keyword">case</span> OP_REMOVE_ICON:</div><div class="line">                            <span class="keyword">if</span> (mList.getIcon(index) != <span class="keyword">null</span>) {</div><div class="line">                                mList.removeIcon(index);</div><div class="line">                                mCallbacks.removeIcon(mList.getSlot(index), index, viewIndex);</div><div class="line">                            }</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                    }</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                }</div><div class="line">... ...</div><div class="line"></div><div class="line">            }           </div><div class="line">        }                   </div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>经过桥接的 CommandQueue 最后交给 UI 实现的接口又变成3个了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * These methods are called back on the main thread.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callbacks</span> </span>{</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addIcon</span>(String slot, <span class="keyword">int</span> index, <span class="keyword">int</span> viewIndex, StatusBarIcon icon);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateIcon</span>(String slot, <span class="keyword">int</span> index, <span class="keyword">int</span> viewIndex,</div><div class="line">                StatusBarIcon old, StatusBarIcon icon);</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeIcon</span>(String slot, <span class="keyword">int</span> index, <span class="keyword">int</span> viewIndex);</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后 UI 这边又有一个 StatusBarIconList 的 mList，最后这个 list 是在这的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// =================== BaseStatusBar.java ===================</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span>() {</div><div class="line">        mWindowManager = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">        mWindowManagerService = WindowManagerGlobal.getWindowManagerService();</div><div class="line">        mDisplay = mWindowManager.getDefaultDisplay();</div><div class="line"></div><div class="line">        mProvisioningObserver.onChange(<span class="keyword">false</span>); <span class="comment">// set up</span></div><div class="line">        mContext.getContentResolver().registerContentObserver(</div><div class="line">                Settings.Global.getUriFor(Settings.Global.DEVICE_PROVISIONED), <span class="keyword">true</span>,</div><div class="line">                mProvisioningObserver);</div><div class="line"></div><div class="line">        mBarService = IStatusBarService.Stub.asInterface(</div><div class="line">                ServiceManager.getService(Context.STATUS_BAR_SERVICE));</div><div class="line"></div><div class="line">        <span class="comment">// 在 SystemUI 这里又 new 了一个 StatusBarIconList 出来</span></div><div class="line">        <span class="comment">// Connect in to the status bar manager service</span></div><div class="line">        StatusBarIconList iconList = <span class="keyword">new</span> StatusBarIconList();</div><div class="line">        ArrayList&lt;IBinder&gt; notificationKeys = <span class="keyword">new</span> ArrayList&lt;IBinder&gt;();</div><div class="line">        ArrayList&lt;StatusBarNotification&gt; notifications = <span class="keyword">new</span> ArrayList&lt;StatusBarNotification&gt;();</div><div class="line">        mCommandQueue = <span class="keyword">new</span> CommandQueue(<span class="keyword">this</span>, iconList);</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    }</div><div class="line"></div><div class="line"><span class="comment">// ================== CommandQueue.java =====================</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="title">CommandQueue</span>(Callbacks callbacks, StatusBarIconList list) {</div><div class="line">        mCallbacks = callbacks;</div><div class="line">        mList = list;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>比起通知，系统状态数据只存了2份（SBMS，SystemUI），还算好的了（通知存了3份： NM，SBMS，SystemUI）。然后从上面的代码来看，3个接口主要是：</p>
<ul>
<li><strong>addIcon</strong>: 如果调用的 setIcon 的 slot 没有在 SystemUI 中的数据有记录，那么会调用这个，让 SystemUI 添加一个新的状态图标（StatusBarIconView）</li>
<li><strong>updateIcon</strong>: 如果调用的 setIcon 的 slot 在 SystemUI 中有记录，那么会调用这个，让 SystemUI 更新下已有的状态图标状态</li>
<li><strong>removeIcon</strong>: 让 SystemUI 移除一个已经添加的状态图标</li>
</ul>
<p>我们以 PhoneStatusBar 为例，来看下相关的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneStatusBar</span> <span class="keyword">extends</span> <span class="title">BaseStatusBar</span> </span>{</div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="comment">// mSystemIconArea 是包括 wifi、电量、时间和系统状态图标一起的容器（在右边那一大堆）</span></div><div class="line">    <span class="comment">// right-hand icons</span></div><div class="line">    LinearLayout mSystemIconArea;</div><div class="line">            </div><div class="line">    <span class="comment">// mStatusIcons 是单独系统状态图标，包含在上面的 mSystemIconArea 里面</span></div><div class="line">    <span class="comment">// left-hand icons</span></div><div class="line">    LinearLayout mStatusIcons;</div><div class="line">    <span class="comment">// mNotificationIcons 是左边的通知的图标</span></div><div class="line">    <span class="comment">// the icons themselves</span></div><div class="line">    IconMerger mNotificationIcons;</div><div class="line">    <span class="comment">// [+&gt;</span></div><div class="line">    View mMoreIcon; </div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ================================================================================</span></div><div class="line">    <span class="comment">// Constructing the view</span></div><div class="line">    <span class="comment">// ================================================================================</span></div><div class="line">    <span class="keyword">protected</span> PhoneStatusBarView <span class="title">makeStatusBarView</span>() {</div><div class="line">... ...</div><div class="line"></div><div class="line">        mSystemIconArea = (LinearLayout) mStatusBarView.findViewById(R.id.system_icon_area);</div><div class="line">        mStatusIcons = (LinearLayout)mStatusBarView.findViewById(R.id.statusIcons);</div><div class="line">        mNotificationIcons = (IconMerger)mStatusBarView.findViewById(R.id.notificationIcons);</div><div class="line">        mNotificationIcons.setOverflowIndicator(mMoreIcon);</div><div class="line">        mStatusBarContents = (LinearLayout)mStatusBarView.findViewById(R.id.status_bar_contents);</div><div class="line">        mTickerView = mStatusBarView.findViewById(R.id.ticker);</div><div class="line"></div><div class="line">... ...</div><div class="line">        <span class="keyword">return</span> mStatusBarView;</div><div class="line">    }</div><div class="line"></div><div class="line">... ....</div><div class="line"></div><div class="line">    <span class="comment">// 实现比较简单就是 new 一个 view（StatusBarIconView）出来，然后添加到 parent 里面</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addIcon</span>(String slot, <span class="keyword">int</span> index, <span class="keyword">int</span> viewIndex, StatusBarIcon icon) {</div><div class="line">        <span class="keyword">if</span> (SPEW) Slog.d(TAG, <span class="string">"addIcon slot="</span> + slot + <span class="string">" index="</span> + index + <span class="string">" viewIndex="</span> + viewIndex</div><div class="line">                + <span class="string">" icon="</span> + icon);</div><div class="line">        StatusBarIconView view = <span class="keyword">new</span> StatusBarIconView(mContext, slot, <span class="keyword">null</span>);</div><div class="line">        view.set(icon);</div><div class="line">        mStatusIcons.addView(view, viewIndex, <span class="keyword">new</span> LinearLayout.LayoutParams(mIconSize, mIconSize));</div><div class="line">    }</div><div class="line">        </div><div class="line">    <span class="comment">// 更新状态的还要去 StatusBarIconView 里面去看</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateIcon</span>(String slot, <span class="keyword">int</span> index, <span class="keyword">int</span> viewIndex,</div><div class="line">            StatusBarIcon old, StatusBarIcon icon) {</div><div class="line">        <span class="keyword">if</span> (SPEW) Slog.d(TAG, <span class="string">"updateIcon slot="</span> + slot + <span class="string">" index="</span> + index + <span class="string">" viewIndex="</span> + viewIndex</div><div class="line">                + <span class="string">" old="</span> + old + <span class="string">" icon="</span> + icon);</div><div class="line">        StatusBarIconView view = (StatusBarIconView)mStatusIcons.getChildAt(viewIndex);</div><div class="line">        view.set(icon);</div><div class="line">    }</div><div class="line">            </div><div class="line">    <span class="comment">// 移除的，就是 removeView 而已</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeIcon</span>(String slot, <span class="keyword">int</span> index, <span class="keyword">int</span> viewIndex) {</div><div class="line">        <span class="keyword">if</span> (SPEW) Slog.d(TAG, <span class="string">"removeIcon slot="</span> + slot + <span class="string">" index="</span> + index + <span class="string">" viewIndex="</span> + viewIndex);</div><div class="line">        mStatusIcons.removeViewAt(viewIndex);</div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>实现都比较简单，然后去 StatusBarIconView 里面看看更新状态的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Returns whether the set succeeded.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">set</span>(StatusBarIcon icon) {</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> iconEquals = mIcon != <span class="keyword">null</span></div><div class="line">            && streq(mIcon.iconPackage, icon.iconPackage)</div><div class="line">            && mIcon.iconId == icon.iconId;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> levelEquals = iconEquals</div><div class="line">            && mIcon.iconLevel == icon.iconLevel;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> visibilityEquals = mIcon != <span class="keyword">null</span></div><div class="line">            && mIcon.visible == icon.visible;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> numberEquals = mIcon != <span class="keyword">null</span></div><div class="line">            && mIcon.number == icon.number;</div><div class="line">    mIcon = icon.clone();</div><div class="line">    setContentDescription(icon.contentDescription);</div><div class="line">    <span class="comment">// 图标变化</span></div><div class="line">    <span class="keyword">if</span> (!iconEquals) {</div><div class="line">        Drawable drawable = getIcon(icon);</div><div class="line">        <span class="keyword">if</span> (drawable == <span class="keyword">null</span>) {</div><div class="line">            Slog.w(TAG, <span class="string">"No icon for slot "</span> + mSlot);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        }   </div><div class="line">        setImageDrawable(drawable);</div><div class="line">    }   </div><div class="line">    <span class="comment">// 图标索引变化</span></div><div class="line">    <span class="keyword">if</span> (!levelEquals) {</div><div class="line">        setImageLevel(icon.iconLevel);</div><div class="line">    }   </div><div class="line"></div><div class="line">    <span class="comment">// 这个 number 暂时没管是什么东西</span></div><div class="line">    <span class="keyword">if</span> (!numberEquals) {</div><div class="line">        <span class="keyword">if</span> (icon.number &gt; <span class="number">0</span> && mContext.getResources().getBoolean(</div><div class="line">                    R.bool.config_statusBarShowNumber)) {</div><div class="line">            <span class="keyword">if</span> (mNumberBackground == <span class="keyword">null</span>) {</div><div class="line">                mNumberBackground = getContext().getResources().getDrawable(</div><div class="line">                        R.drawable.ic_notification_overlay);</div><div class="line">            }   </div><div class="line">            placeNumber();</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            mNumberBackground = <span class="keyword">null</span>;</div><div class="line">            mNumberText = <span class="keyword">null</span>;</div><div class="line">        }   </div><div class="line">        invalidate();</div><div class="line">    }   </div><div class="line">    <span class="comment">// 显示/隐藏状态变化</span></div><div class="line">    <span class="keyword">if</span> (!visibilityEquals) {</div><div class="line">        setVisibility(icon.visible ? VISIBLE : GONE);</div><div class="line">    }   </div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>通过上面可以看到前面 SBMS 的 setIconVisibility 改变 StatusBarIcon 的 visible 属性，最后到 UI 这就是变成改变状态图标的 view 的 VISIBLE（GONE）属性。</p>
<p>然后前面说 4.2 系统的状态图标数组有 19 个，一般状态栏应该是放不下的。其实不用担心，因为虽然数据数组有 19 个，但是只是 NULL 的占位而已。要调用 SBMS 的 setIcon 才会正在填充数据进去，进而通知 UI 添加状态图标 view 到 WindowManager（WM）中（显示在界面上）。dumpsys 一下 SBMS 会发现 4.2 默认系统的状态图标有下面几个：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">Icon list:</div><div class="line">   <span class="number">0</span>: (ime) StatusBarIcon(pkg=com.sohu.inputmethod.sogouuser=<span class="number">0</span> id=<span class="number">0</span>x7f020076 level=<span class="number">0</span> visible=<span class="literal">true</span> num=<span class="number">0</span> )</div><div class="line">   <span class="number">1</span>: (sync_failing) StatusBarIcon(pkg=com.android.systemuiuser=<span class="number">0</span> id=<span class="number">0</span>x7f020187 level=<span class="number">0</span> visible=<span class="literal">false</span> num=<span class="number">0</span> )</div><div class="line">   <span class="number">2</span>: (sync_active) StatusBarIcon(pkg=com.android.systemuiuser=<span class="number">0</span> id=<span class="number">0</span>x7f020186 level=<span class="number">0</span> visible=<span class="literal">false</span> num=<span class="number">0</span> )</div><div class="line">   <span class="number">3</span>: (gps) null</div><div class="line">   <span class="number">4</span>: (bluetooth) StatusBarIcon(pkg=com.android.systemuiuser=<span class="number">0</span> id=<span class="number">0</span>x7f020154 level=<span class="number">0</span> visible=<span class="literal">false</span> num=<span class="number">0</span> )</div><div class="line">   <span class="number">5</span>: (nfc) null</div><div class="line">   <span class="number">6</span>: (tty) StatusBarIcon(pkg=com.android.systemuiuser=<span class="number">0</span> id=<span class="number">0</span>x7f020188 level=<span class="number">0</span> visible=<span class="literal">false</span> num=<span class="number">0</span> )</div><div class="line">   <span class="number">7</span>: (speakerphone) null</div><div class="line">   <span class="number">8</span>: (mute) null</div><div class="line">   <span class="number">9</span>: (volume) StatusBarIcon(pkg=com.android.systemuiuser=<span class="number">0</span> id=<span class="number">0</span>x7f020171 level=<span class="number">0</span> visible=<span class="literal">true</span> num=<span class="number">0</span> )</div><div class="line">  <span class="number">10</span>: (wifi) null</div><div class="line">  <span class="number">11</span>: (cdma_eri) StatusBarIcon(pkg=com.android.systemuiuser=<span class="number">0</span> id=<span class="number">0</span>x7f020173 level=<span class="number">0</span> visible=<span class="literal">false</span> num=<span class="number">0</span> )</div><div class="line">  <span class="number">12</span>: (data_connection) null</div><div class="line">  <span class="number">13</span>: (phone_evdo_signal) null</div><div class="line">  <span class="number">14</span>: (phone_signal) null</div><div class="line">  <span class="number">15</span>: (battery) null</div><div class="line">  <span class="number">16</span>: (alarm_clock) StatusBarIcon(pkg=com.android.systemuiuser=<span class="number">0</span> id=<span class="number">0</span>x7f02013a level=<span class="number">0</span> visible=<span class="literal">true</span> num=<span class="number">0</span> )</div><div class="line">  <span class="number">17</span>: (secure) null</div><div class="line">  <span class="number">18</span>: (clock) null</div><div class="line">Notification list:</div><div class="line">   <span class="number">0</span>: StatusBarNotification(pkg=com.android.systemui id=<span class="number">17303780</span> tag=null score=<span class="number">0</span> notn=Notification(pri=<span class="number">0</span> contentView=com.android.systemui/<span class="number">0</span>x1090099 vibrate=null sound=file:///system/media/audio/notificati</div><div class="line">  mDisabled=<span class="number">0</span>x3e10000</div><div class="line">  mDisableRecords.size=<span class="number">2</span></div><div class="line">    [<span class="number">0</span>] userId=<span class="number">0</span> what=<span class="number">0</span>x3010000 pkg=android token=android.os.Binder@<span class="number">4162</span>e520</div><div class="line">    [<span class="number">1</span>] userId=<span class="number">0</span> what=<span class="number">0</span>xe00000 pkg=WindowManager.LayoutParams token=android.os.Binder@<span class="number">419</span>f0da0</div><div class="line"></div></pre></td></tr></table></figure>

<p>19 个列表中有很多是空的（null）的，要让系统显示那些状态，需要调用 SBMS 的 setIcon 设置才会填充图标数据。4.2 中主要在 SystemUI 的 PhoneStatusBarPolicy 中设置的（以 Phone UI 为例子）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="title">PhoneStatusBarPolicy</span>(Context context) {</div><div class="line">    mContext = context;</div><div class="line">    mService = (StatusBarManager)context.getSystemService(Context.STATUS_BAR_SERVICE);</div><div class="line"></div><div class="line">    <span class="comment">// listen for broadcasts</span></div><div class="line">    IntentFilter filter = <span class="keyword">new</span> IntentFilter();</div><div class="line">    filter.addAction(Intent.ACTION_ALARM_CHANGED);</div><div class="line">    filter.addAction(Intent.ACTION_SYNC_STATE_CHANGED);</div><div class="line">    filter.addAction(AudioManager.RINGER_MODE_CHANGED_ACTION);</div><div class="line">    filter.addAction(BluetoothAdapter.ACTION_STATE_CHANGED);</div><div class="line">    filter.addAction(BluetoothAdapter.ACTION_CONNECTION_STATE_CHANGED);</div><div class="line">    filter.addAction(TelephonyIntents.ACTION_SIM_STATE_CHANGED);</div><div class="line">    filter.addAction(TtyIntent.TTY_ENABLED_CHANGE_ACTION);</div><div class="line">    mContext.registerReceiver(mIntentReceiver, filter, <span class="keyword">null</span>, mHandler);</div><div class="line"></div><div class="line">    <span class="comment">// storage</span></div><div class="line">    mStorageManager = (StorageManager) context.getSystemService(Context.STORAGE_SERVICE);</div><div class="line">    mStorageManager.registerListener(</div><div class="line">            <span class="keyword">new</span> com.android.systemui.usb.StorageNotification(context));</div><div class="line"></div><div class="line">    <span class="comment">// TTY status</span></div><div class="line">    mService.setIcon(<span class="string">"tty"</span>,  R.drawable.stat_sys_tty_mode, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">    mService.setIconVisibility(<span class="string">"tty"</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Cdma Roaming Indicator, ERI</span></div><div class="line">    mService.setIcon(<span class="string">"cdma_eri"</span>, R.drawable.stat_sys_roaming_cdma_0, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">    mService.setIconVisibility(<span class="string">"cdma_eri"</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="comment">// bluetooth status</span></div><div class="line">    BluetoothAdapter adapter = BluetoothAdapter.getDefaultAdapter();</div><div class="line">    <span class="keyword">int</span> bluetoothIcon = R.drawable.stat_sys_data_bluetooth;</div><div class="line">    <span class="keyword">if</span> (adapter != <span class="keyword">null</span>) {</div><div class="line">        mBluetoothEnabled = (adapter.getState() == BluetoothAdapter.STATE_ON);</div><div class="line">        <span class="keyword">if</span> (adapter.getConnectionState() == BluetoothAdapter.STATE_CONNECTED) {</div><div class="line">            bluetoothIcon = R.drawable.stat_sys_data_bluetooth_connected;</div><div class="line">        }   </div><div class="line">    }   </div><div class="line">    mService.setIcon(<span class="string">"bluetooth"</span>, bluetoothIcon, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">    mService.setIconVisibility(<span class="string">"bluetooth"</span>, mBluetoothEnabled);</div><div class="line"></div><div class="line">    <span class="comment">// Alarm clock</span></div><div class="line">    mService.setIcon(<span class="string">"alarm_clock"</span>, R.drawable.stat_sys_alarm, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">    mService.setIconVisibility(<span class="string">"alarm_clock"</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Sync state</span></div><div class="line">    mService.setIcon(<span class="string">"sync_active"</span>, R.drawable.stat_sys_sync, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">    mService.setIcon(<span class="string">"sync_failing"</span>, R.drawable.stat_sys_sync_error, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">    mService.setIconVisibility(<span class="string">"sync_active"</span>, <span class="keyword">false</span>);</div><div class="line">    mService.setIconVisibility(<span class="string">"sync_failing"</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="comment">// volume</span></div><div class="line">    mService.setIcon(<span class="string">"volume"</span>, R.drawable.stat_sys_ringer_silent, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">    mService.setIconVisibility(<span class="string">"volume"</span>, <span class="keyword">false</span>);</div><div class="line">    updateVolume();</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后稍微贴一下 PhoneStatusBarPolicy 中更新这些状态的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">private</span> BroadcastReceiver mIntentReceiver = <span class="keyword">new</span> BroadcastReceiver() {</div><div class="line">        <span class="annotation">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span>(Context context, Intent intent) {</div><div class="line">            String action = intent.getAction();</div><div class="line">            <span class="comment">// 前面的说的 SystemUI 注册闹钟状态设置的广播，间接对外提供接口</span></div><div class="line">            <span class="keyword">if</span> (action.equals(Intent.ACTION_ALARM_CHANGED)) {</div><div class="line">                updateAlarm(intent);           </div><div class="line">            }</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(Intent.ACTION_SYNC_STATE_CHANGED)) {</div><div class="line">                updateSyncState(intent);       </div><div class="line">            }</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(BluetoothAdapter.ACTION_STATE_CHANGED) ||</div><div class="line">                    action.equals(BluetoothAdapter.ACTION_CONNECTION_STATE_CHANGED)) {</div><div class="line">                updateBluetooth(intent);       </div><div class="line">            }</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(AudioManager.RINGER_MODE_CHANGED_ACTION)) {</div><div class="line">                updateVolume();                </div><div class="line">            }</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(TelephonyIntents.ACTION_SIM_STATE_CHANGED)) {</div><div class="line">                updateSimState(intent);        </div><div class="line">            }</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(TtyIntent.TTY_ENABLED_CHANGE_ACTION)) {</div><div class="line">                updateTTY(intent);             </div><div class="line">            }</div><div class="line">        }</div><div class="line">    };</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="comment">// 贴一个就行了，其他的差不多的</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">updateAlarm</span>(Intent intent) {</div><div class="line">        <span class="keyword">boolean</span> alarmSet = intent.getBooleanExtra(<span class="string">"alarmSet"</span>, <span class="keyword">false</span>);</div><div class="line">        mService.setIconVisibility(<span class="string">"alarm_clock"</span>, alarmSet);</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>还有一个输入法的在这里（InputMethodManagerService.java）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateStatusIcon</span>(IBinder token, String packageName, <span class="keyword">int</span> iconId) {</div><div class="line">    <span class="keyword">int</span> uid = Binder.getCallingUid();</div><div class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="keyword">if</span> (token == <span class="keyword">null</span> || mCurToken != token) {</div><div class="line">            Slog.w(TAG, <span class="string">"Ignoring setInputMethod of uid "</span> + uid + <span class="string">" token: "</span> + token);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        }</div><div class="line">        </div><div class="line">        <span class="keyword">synchronized</span> (mMethodMap) {</div><div class="line">            <span class="keyword">if</span> (iconId == <span class="number">0</span>) {</div><div class="line">                <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"hide the small icon for the input method"</span>);</div><div class="line">                <span class="keyword">if</span> (mStatusBar != <span class="keyword">null</span>) {</div><div class="line">                    mStatusBar.setIconVisibility(<span class="string">"ime"</span>, <span class="keyword">false</span>);</div><div class="line">                }   </div><div class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (packageName != <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"show a small icon for the input method"</span>);</div><div class="line">                CharSequence contentDescription = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">try</span> {</div><div class="line">                    <span class="comment">// Use PackageManager to load label</span></div><div class="line">                    <span class="keyword">final</span> PackageManager packageManager = mContext.getPackageManager();</div><div class="line">                    contentDescription = packageManager.getApplicationLabel(</div><div class="line">                            mIPackageManager.getApplicationInfo(packageName, <span class="number">0</span>,</div><div class="line">                                    mSettings.getCurrentUserId()));</div><div class="line">                } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">                    <span class="comment">/* ignore */</span> </div><div class="line">                }   </div><div class="line">                <span class="keyword">if</span> (mStatusBar != <span class="keyword">null</span>) {</div><div class="line">                    mStatusBar.setIcon(<span class="string">"ime"</span>, packageName, iconId, <span class="number">0</span>,</div><div class="line">                            contentDescription  != <span class="keyword">null</span></div><div class="line">                                    ? contentDescription.toString() : <span class="keyword">null</span>);</div><div class="line">                    mStatusBar.setIconVisibility(<span class="string">"ime"</span>, <span class="keyword">true</span>);</div><div class="line">                }</div><div class="line">            }   </div><div class="line">        }               </div><div class="line">    } <span class="keyword">finally</span> {</div><div class="line">        Binder.restoreCallingIdentity(ident);</div><div class="line">    }       </div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="总结">总结</h2>
<p>这篇内容比较简单。系统状态图标数据和通知的状态栏图标是一样的，都是 StautsBarIcon，视图也是一样的（StatusBarIconView），因为它们 UI 表现是一样的。只不过一个是显示应用的信息，一个是显示系统的状态信息；一个可以动态改变数量，一个固定数量而已。不过还是这2种不同系统 UI 元素还是要区分一些，不然有些时候搞混了，就找不到在哪定制这些东西了。</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/android/">android</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-Framework/">Android Framework</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.light3moon.com/2015/03/04/Android SystemUI 分析——状态栏图标/" data-title="Android SystemUI 分析——状态栏图标 | Light.Moon" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/03/06/下载 Android 源码问题总结/" title="下载 Android 源码问题总结">
  <strong>上一篇:</strong><br/>
  <span>
  下载 Android 源码问题总结</span>
</a>
</div>


<div class="next">
<a href="/2015/02/06/Android SystemUI 分析——通知/"  title="Android SystemUI 分析——通知">
 <strong>下一篇:</strong><br/> 
 <span>Android SystemUI 分析——通知
</span>
</a>
</div>

</nav>


	
<section class="comment">
	<div class="ds-thread" data-thread-key="Android SystemUI 分析——状态栏图标" data-title="Android SystemUI 分析——状态栏图标" 
      data-author-key="mingming" data-limit=10
      data-url="light3moon.com/2015/03/04/Android SystemUI 分析——状态栏图标/">
    </div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#区分"><span class="toc-number">1.</span> <span class="toc-text">区分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#接口"><span class="toc-number">2.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#固定的数据"><span class="toc-number">3.</span> <span class="toc-text">固定的数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SystemUI_的处理"><span class="toc-number">4.</span> <span class="toc-text">SystemUI 的处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android-Development/" title="Android Development">Android Development<sup>33</sup></a></li>
		
			<li><a href="/categories/Android-Framework/" title="Android Framework">Android Framework<sup>46</sup></a></li>
		
			<li><a href="/categories/Basics-Knowledge/" title="Basics Knowledge">Basics Knowledge<sup>11</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>24</sup></a></li>
		
			<li><a href="/categories/MiniGUI/" title="MiniGUI">MiniGUI<sup>12</sup></a></li>
		
			<li><a href="/categories/Other/" title="Other">Other<sup>8</sup></a></li>
		
			<li><a href="/categories/Server/" title="Server">Server<sup>1</sup></a></li>
		
			<li><a href="/categories/Window/" title="Window">Window<sup>10</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		
			<li><a href="/tags/android/" title="android">android<sup>79</sup></a></li>
		
			<li><a href="/tags/basics/" title="basics">basics<sup>11</sup></a></li>
		
			<li><a href="/tags/install/" title="install">install<sup>9</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>27</sup></a></li>
		
			<li><a href="/tags/minigui/" title="minigui">minigui<sup>13</sup></a></li>
		
			<li><a href="/tags/opengl/" title="opengl">opengl<sup>3</sup></a></li>
		
			<li><a href="/tags/other/" title="other">other<sup>5</sup></a></li>
		
			<li><a href="/tags/server/" title="server">server<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>5</sup></a></li>
		
			<li><a href="/tags/window/" title="window">window<sup>11</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">哥的后勤处 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-qqzone"></i> <a href="http://user.qzone.qq.com/544630305" target="_blank">QQ 空间</a></li>
      <li><i class="fa fa-github"></i> <a href="https://github.com/mingming-killer" target="_blank">GitHub</a></li>
      
        
          <li><i class="fa fa-analytics"></i> <a href="http://tongji.baidu.com/web/welcome/ico?s=fa045dbd45ffce238b146e00f91ba6a3" target="_blank">战斗力</a></li>
        
      
      <li><i class="fa fa-markdown-help"></i> <a href="http://zh.wikipedia.org/wiki/Markdown" target="_blank">Makrdown</a></li>
    </ul>
</div>


  <div class="commentlist">
  <p class="asidetitle">最近冒泡的小伙伴 ╰(●&#39;◡&#39;●)╮</p>
    <ul>
      <ul class="ds-recent-comments" 
        data-num-items="6" 
        data-show-avatars="1" 
        data-show-title="1"   
        data-show-time="1" 
        data-show-admin="1" 
        data-excerpt-length="30">
      </ul>
      <!-- duoshou js begin load, one page only load once -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"mingming"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
      <!-- duoshou js load end -->
    </ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-book"></i> <a href="http://taoyuanxiaoqi.com" target="_blank">桃园小七的博客</a></li>
    </ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
<!--
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
-->

     <!-- this is defined in footer.styl, line holder -->
	<div class="line">
	</div>
     
<!--
	<div class="social-font clearfix">
		
		
		
		
		
		<a href="https://github.com/mingming-killer" target="_blank" title="github"></a>
		
        	
		<a href="http://user.qzone.qq.com/544630305" target="_blank" title="qqzone"></a>
		         
	</div>
-->

		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/mingming-killer/Lightmoon" target="_blank" title="Lightmoon">Lightmoon</a> © 2016 
		
		<a href="http://www.light3moon.com" target="_blank" title="Mingming">Mingming</a>
		
		</p>

  <!-- baidu search verification -->
  
    <meta name="baidu-site-verification" content="w1BSX6yZ9k" />
  

  <!-- swiftype search verification -->
  

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"mingming"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fa045dbd45ffce238b146e00f91ba6a3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>
