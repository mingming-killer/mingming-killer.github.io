
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

  
    <title>Android x86 在 X window system 上的调研 | Light.Moon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Mingming">
    
    <meta name="description" content="这个是以前弄到一个项目：把 Android 应用程序跑到 Meego。那个时候 Android 官方还不支持 X86 平台，所以折腾，现在 Android 官方支持了，这个其实就没什么用了，权当纪念一下以前扯蛋的项目吧。
需求
我们的最终目的是为了让 Android 在 Meego 上（GUI 是 ">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/apple_icon.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/apple_icon.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
		<div id="header_author">
		</div>
		

         <!--
         
           <div id="imglogo">
           <a href="/"><img src="/img/logo.svg" alt="Light.Moon" title="Light.Moon"/></a>
           </div>
         
         -->

			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Light.Moon">Light.Moon</a></h1>
				<h2 class="blog-motto">三月学长的小站</h2>
			</div>

			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/1986/12/20/文章索引">索引</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					

                      <form class="search" action=http://search.light3moon.com/cse/search target="_blank">
                      <label>搜索</label>
                      <!--
                      <input name="s" type="hidden" value="undefined">
                      -->
                      <input name="s" type="hidden" value="12628367885198549364">
                      <input type="text" name="q" size="30" placeholder="搜索"> <br>

                      
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/01/27/Android x86 在 X window system 上的调研/" title="Android x86 在 X window system 上的调研" itemprop="url">Android x86 在 X window system 上的调研</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.light3moon.com" title="Mingming">Mingming</a>
    </p>
  <p class="article-time">
    <time datetime="2015-01-27T15:14:16.000Z" itemprop="datePublished">2015 1月 27</time>
    更新日期:<time datetime="2015-01-27T15:14:16.000Z" itemprop="dateModified">2015 1月 27</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#需求"><span class="toc-number">1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相关名词"><span class="toc-number">2.</span> <span class="toc-text">相关名词</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现思路"><span class="toc-number">3.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Xlib_分析"><span class="toc-number">4.</span> <span class="toc-text">Xlib 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Xlib_基本数据结构"><span class="toc-number">4.1.</span> <span class="toc-text">Xlib 基本数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本使用流程"><span class="toc-number">4.2.</span> <span class="toc-text">基本使用流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Xlib_线索"><span class="toc-number">4.3.</span> <span class="toc-text">Xlib 线索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#X_server_分析"><span class="toc-number">5.</span> <span class="toc-text">X server 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#X_server_基本数据结构"><span class="toc-number">5.1.</span> <span class="toc-text">X server 基本数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GLX_分析"><span class="toc-number">6.</span> <span class="toc-text">GLX 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GLX_基本数据结构"><span class="toc-number">6.1.</span> <span class="toc-text">GLX 基本数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GLX_线索"><span class="toc-number">6.2.</span> <span class="toc-text">GLX 线索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SDL_分析"><span class="toc-number">7.</span> <span class="toc-text">SDL 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SDL_基本数据结构"><span class="toc-number">7.1.</span> <span class="toc-text">SDL 基本数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SDL_线索"><span class="toc-number">7.2.</span> <span class="toc-text">SDL 线索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mutter（Clutter）分析"><span class="toc-number">8.</span> <span class="toc-text">Mutter（Clutter）分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Clutter_绘制流程"><span class="toc-number">8.1.</span> <span class="toc-text">Clutter 绘制流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Clutter_基本数据结构"><span class="toc-number">8.2.</span> <span class="toc-text">Clutter 基本数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Clutter_线索"><span class="toc-number">8.3.</span> <span class="toc-text">Clutter 线索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cogl_分析"><span class="toc-number">9.</span> <span class="toc-text">Cogl 分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附件"><span class="toc-number">11.</span> <span class="toc-text">附件</span></a></li></ol>
		</div>
		
		<p>这个是以前弄到一个项目：把 Android 应用程序跑到 Meego。那个时候 Android 官方还不支持 X86 平台，所以折腾，现在 Android 官方支持了，这个其实就没什么用了，权当纪念一下以前扯蛋的项目吧。</p>
<h2 id="需求">需求</h2>
<p>我们的最终目的是为了让 Android 在 Meego 上（GUI 是 x86 的 X window system）能有接近原生的运行速度。这样的话就不能再采用 demo 里的 vfb 的做法。而应该是让 Android 直接在屏幕上进行绘制（显存中），并且充分的利用平台的硬件加速能力（Intel 945GME），例如使用硬件的 OpenGL 实现等。这样的话就需要利用 X window system 中的原生底层接口来实现 Android 的低层图形驱动模块。所以需要调研 X window system 的一些原理、用法、如何利用硬件加速的。</p>
<h2 id="相关名词">相关名词</h2>
<p>先大概的说一下一些相关的名词吧：（为了方便起见，以下的 Meego 都是说的 netbook 1.1 版本）</p>
<ul>
<li><p><strong>X window system</strong><br>由于其主版本号是 11，因此又叫 X11 。X11 是 linux 上的一个窗口系统，采用 C/S 模型，因此它可以方便的使用于网络中（分布式结构）。但是这也给我们的项目提供了困难，因为上网本上的 Meego 是确定只在本地使用的。X11 会有一个服务端，每一显示设备都是它的一个客户端。客户端通过发送请求到服务端申请显示设备，通过发送请求让服务器绘制图像显示到指定的显示设备上（一般是自己申请的那个）。Meego 上使用的 Xlib 是 1.3.3 的，Xorg-server 是 1.9.0 的，好像在后面的源码路径上都找不到版本一样的，只能找一些接近的了。源码在： <a href="http://www.x.org/releases/" title="X11源代码路径" target="_blank" rel="external">X11源代码路径</a>。</p>
</li>
<li><p><strong>Xlib</strong><br>X11 有很多个模块。Xlib 是它的基本模块，提供了一些基本的图形访问接口。此外 X11 还可以有一些列的扩展接口，只要符合 X11 的扩展规范，就可以。X11 上的 OpenGL 就是通过 X11 的扩展来衔接的。</p>
</li>
<li><p><strong>GLX</strong><br>OpenGL 是一个 3D 图形库，它是独立于窗口系统的。但是如果要在窗口系统中使用，这就必须要和窗口系统建立起联系，例如说如何在窗口中渲染 3D 图形等等。这样就需要一个桥梁来建立起 OpenGL 和本地窗口系统的衔接。在 X11 上这个就是 GLX 要做的事情（类似于嵌入式系统上的 EGL）。Meego 上使用的是 1.4 版本。其其源代码包括在 Mesa 里面。GLX 走的是 X11 的协议，是通过和 X server 打交道来进行渲染的，因此又叫作间接渲染（indirect render）。</p>
</li>
<li><p><strong>DRM &amp; DRI</strong><br>DRI 全称 Direct Rendering Infrastructure。由于 X11 是采用 C/S 架构的，客户端的任何操作都需要和服务器进行通讯，在实时的 3D 渲染上性能无法接受。因此就出现了 DRI 这种框架，在 X11 上能够允许直接访问硬件渲染器（显卡），从而直接将 3D 图形渲染到屏幕上，绕过 X11 ，提升性能，这种叫作直接渲染（direct render）。DRI 为上层 3D 库提供访问底层硬件的接口。DRM 全称 Direct Rendering Manager，从字面上理解为直接渲染管理器，是真正操作硬件的层次。各个硬件厂商负责提供各自硬件的 drm 模块（开源的提供源码、不开源的提供二进制文件）。DRI 通过调用 DRM 的接口来实现上层 3D 图形库的接口。HP mini 上使用的是 Intel 的 945GME 显卡，使用的 DRM 源码在：git://git.kernel.org/pub/scm/linux/kernel/git/ickle/drm-intel（git 路径）。DRI 的源码则在 Mesa 中。</p>
</li>
<li><p><strong>Mesa</strong><br>OpenGL 只是一个规范，它的实现有很多种。Mesa 是 OpenGL 在 linux 上的一个实现。Mesa 自身提供一套纯软件的 OpenGL 实现，能在各个平台运行 OpenGL 程序，不过速度非常慢。其中 Mesa 会根据系统平台的 dri 和 drm 情况调用硬件的 OpenGL 实现，这时就是硬件的 3D 加速，速度会比纯软件的快得多。从上面来看流程应该是： 3D app —&gt; Mesa(OpenGL API) —&gt; dri —&gt; drm —&gt; hardware。Meego 上使用的是 Mesa 7.9 。源码在：<a href="ftp://ftp.freedesktop.org/pub/mesa/" title="Mesa 源代码路径" target="_blank" rel="external">Mesa 源代码路径</a>。</p>
</li>
<li><p><strong>SDL</strong><br>SDL 是一个开源跨平台的图形库，它小巧、简单、快速，提供在 linux 上简单的 GUI 接口。目前的 vfb 就是用 SDL 实现的，在这个方面它比 Qt 简介、方便。在 Meego 上使用的是 1.2.14 版本。源代码在 <a href="http://www.libsdl.org/download-1.2.php" title="SDL源代码路径" target="_blank" rel="external">SDL源代码路径</a>。</p>
</li>
<li><p><strong>Mutter Window Manager</strong><br>X11 只是提供了一些基本的 GUI 元素，但是对于窗口如果显示、窗口移动了怎么办、窗口尺寸改变了又怎么办、多个窗口重叠在一起怎么显示等等，X11 是不会管的。这个些就需要一个叫做窗口管理系统的软件来管理。Meego 上使用的窗口管理系统就是 Mutter Window Manager 。一般 X11 上的窗口管理系统都是基于 Xlib 开发的。源代码在：<a href="http://ftp.acc.umu.se/pub/GNOME/sources/mutter/" title="Mutter源代码路径" target="_blank" rel="external">Mutter源代码路径</a> （在 Meego 源代码里也有）。</p>
</li>
<li><p><strong>Clutter</strong><br>Clutter是一个跨平台的图形库，能够支持 OpenGL。Mutter Window Manager 使用的图形库是就是 Clutter。Clutter 采用 glib 提供的 gobject 实现面向对象设计，采用多种 backend 的架构，实现了跨平台。在 linux 上使用的 backend 是 GLX 和 X11 。Meego 上使用的 Clutter 版本是 1.2.8。源码在：<a href="http://source.clutter-project.org/sources" title="Clutter源代码路径" target="_blank" rel="external">Clutter源代码路径</a></p>
</li>
<li><p><strong>Cogl</strong><br>在 Clutter 中使用的 OpenGL 接口。源代码包含在 Clutter 中。</p>
</li>
</ul>
<h2 id="实现思路">实现思路</h2>
<p>在 Android x86 的代码里，底层有一个叫 gralloc 的模块，是用来管理和分配显存的。我们只要能向 X11 拿到显存地址，就可以分配给上层 Android 程序，从而让 Android 直接绘制到屏幕上（相当于使用本地的一些接口实现 gralloc），这样可以去掉 vfb，这样可以让 Android 原生的跑在 X11 上。并且 Android 在 2D 的块传送上还有一个专门的硬件加速的 copyblt 的模块，我们如果通过 X11 的一些接口，或者是说直接通过显卡驱动的一些接口实现这个模块，也就能相应的完成 Android 2D 加速。至于 OpenGL 的 3D 模块，Android 完整的实现了一套软件的 OpenGL（好像是 ES 的），我们是不是可以用 Mesa 3D 的替换原来的。因此先需要了解 X11 上的绘图相关的东西，看看如果获取显存地址（像素地址）。</p>
<h2 id="Xlib_分析">Xlib 分析</h2>
<p>Xlib 是 X11 上最基本的东西了，这个是肯定是要研究下的。</p>
<h3 id="Xlib_基本数据结构">Xlib 基本数据结构</h3>
<ul>
<li><strong>Display</strong><br>若干个屏幕(Screen)以及一套输入设备（键盘和鼠标）构成一个 Display，Display 概念的关键就是有一套完整的输入输出。屏幕不一定必须是一个，可以有多个，各个屏幕可以用来显示相同的内容，也可以用来构成矩阵显示一个大屏幕的内容。X11 中客户端通过打开 Display 和服务器相连接。要在 X11 上创建一个窗口，第一步就是需要打开一个 Display。它的数据结构是：</li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在 X11/Xlib.h 中的定义</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line"><span class="preprocessor">#ifdef XLIB_ILLEGAL_ACCESS</span></div><div class="line">_XDisplay</div><div class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></div><div class="line">{</div><div class="line">	XExtData *ext_data;	<span class="comment">/* hook for extension to hang data */</span></div><div class="line">	<span class="keyword">struct</span> _XPrivate *private1;</div><div class="line">	<span class="keyword">int</span> fd;			<span class="comment">/* Network socket. */</span></div><div class="line">	<span class="keyword">int</span> private2;</div><div class="line">	<span class="keyword">int</span> proto_major_version;<span class="comment">/* major version of server's X protocol */</span></div><div class="line">	<span class="keyword">int</span> proto_minor_version;<span class="comment">/* minor version of servers X protocol */</span></div><div class="line">	<span class="keyword">char</span> *vendor;		<span class="comment">/* vendor of the server hardware */</span></div><div class="line">        XID private3;</div><div class="line">	XID private4;</div><div class="line">	XID private5;</div><div class="line">	<span class="keyword">int</span> private6;</div><div class="line">	XID (*resource_alloc)(	<span class="comment">/* allocator function */</span></div><div class="line">		<span class="keyword">struct</span> _XDisplay*</div><div class="line">	);</div><div class="line">	<span class="keyword">int</span> byte_order;		<span class="comment">/* screen byte order, LSBFirst, MSBFirst */</span></div><div class="line">	<span class="keyword">int</span> bitmap_unit;	<span class="comment">/* padding and data requirements */</span></div><div class="line">	<span class="keyword">int</span> bitmap_pad;		<span class="comment">/* padding requirements on bitmaps */</span></div><div class="line">	<span class="keyword">int</span> bitmap_bit_order;	<span class="comment">/* LeastSignificant or MostSignificant */</span></div><div class="line">	<span class="keyword">int</span> nformats;		<span class="comment">/* number of pixmap formats in list */</span></div><div class="line">	ScreenFormat *pixmap_format;	<span class="comment">/* pixmap format list */</span></div><div class="line">	<span class="keyword">int</span> private8;</div><div class="line">	<span class="keyword">int</span> release;		<span class="comment">/* release of the server */</span></div><div class="line">	<span class="keyword">struct</span> _XPrivate *private9, *private10;</div><div class="line">	<span class="keyword">int</span> qlen;		<span class="comment">/* Length of input event queue */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> last_request_read; <span class="comment">/* seq number of last event read */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> request;	<span class="comment">/* sequence number of last request. */</span></div><div class="line">	XPointer private11;</div><div class="line">	XPointer private12;</div><div class="line">	XPointer private13;</div><div class="line">	XPointer private14;</div><div class="line">	<span class="keyword">unsigned</span> max_request_size; <span class="comment">/* maximum number 32 bit words in request*/</span></div><div class="line">	<span class="keyword">struct</span> _XrmHashBucketRec *db;</div><div class="line">	<span class="keyword">int</span> (*private15)(</div><div class="line">		<span class="keyword">struct</span> _XDisplay*</div><div class="line">		);</div><div class="line">	<span class="keyword">char</span> *display_name;	<span class="comment">/* "host:display" string used on this connect*/</span></div><div class="line">	<span class="keyword">int</span> default_screen;	<span class="comment">/* default screen for operations */</span></div><div class="line">	<span class="keyword">int</span> nscreens;		<span class="comment">/* number of screens on this server*/</span></div><div class="line">	Screen *screens;	<span class="comment">/* pointer to list of screens */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> motion_buffer;	<span class="comment">/* size of motion buffer */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> private16;</div><div class="line">	<span class="keyword">int</span> min_keycode;	<span class="comment">/* minimum defined keycode */</span></div><div class="line">	<span class="keyword">int</span> max_keycode;	<span class="comment">/* maximum defined keycode */</span></div><div class="line">	XPointer private17;</div><div class="line">	XPointer private18;</div><div class="line">	<span class="keyword">int</span> private19;</div><div class="line">	<span class="keyword">char</span> *xdefaults;	<span class="comment">/* contents of defaults from server */</span></div><div class="line">	<span class="comment">/* there is more to this structure, but it is private to Xlib */</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// 在 X11/Xlibint.h 中的定义</span></div><div class="line"><span class="keyword">struct</span> _XDisplay</div><div class="line">{</div><div class="line">	XExtData *ext_data;	<span class="comment">/* hook for extension to hang data */</span></div><div class="line">	<span class="keyword">struct</span> _XFreeFuncs *free_funcs; <span class="comment">/* internal free functions */</span></div><div class="line">	<span class="keyword">int</span> fd;			<span class="comment">/* Network socket. */</span></div><div class="line">	<span class="keyword">int</span> conn_checker;         <span class="comment">/* ugly thing used by _XEventsQueued */</span></div><div class="line">	<span class="keyword">int</span> proto_major_version;<span class="comment">/* maj. version of server's X protocol */</span></div><div class="line">	<span class="keyword">int</span> proto_minor_version;<span class="comment">/* minor version of server's X protocol */</span></div><div class="line">	<span class="keyword">char</span> *vendor;		<span class="comment">/* vendor of the server hardware */</span></div><div class="line">        XID resource_base;	<span class="comment">/* resource ID base */</span></div><div class="line">	XID resource_mask;	<span class="comment">/* resource ID mask bits */</span></div><div class="line">	XID resource_id;	<span class="comment">/* allocator current ID */</span></div><div class="line">	<span class="keyword">int</span> resource_shift;	<span class="comment">/* allocator shift to correct bits */</span></div><div class="line">	XID (*resource_alloc)(	<span class="comment">/* allocator function */</span></div><div class="line">		<span class="keyword">struct</span> _XDisplay*</div><div class="line">		);</div><div class="line">	<span class="keyword">int</span> byte_order;		<span class="comment">/* screen byte order, LSBFirst, MSBFirst */</span></div><div class="line">	<span class="keyword">int</span> bitmap_unit;	<span class="comment">/* padding and data requirements */</span></div><div class="line">	<span class="keyword">int</span> bitmap_pad;		<span class="comment">/* padding requirements on bitmaps */</span></div><div class="line">	<span class="keyword">int</span> bitmap_bit_order;	<span class="comment">/* LeastSignificant or MostSignificant */</span></div><div class="line">	<span class="keyword">int</span> nformats;		<span class="comment">/* number of pixmap formats in list */</span></div><div class="line">	ScreenFormat *pixmap_format;	<span class="comment">/* pixmap format list */</span></div><div class="line">	<span class="keyword">int</span> vnumber;		<span class="comment">/* Xlib's X protocol version number. */</span></div><div class="line">	<span class="keyword">int</span> release;		<span class="comment">/* release of the server */</span></div><div class="line">	<span class="keyword">struct</span> _XSQEvent *head, *tail;	<span class="comment">/* Input event queue. */</span></div><div class="line">	<span class="keyword">int</span> qlen;		<span class="comment">/* Length of input event queue */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> last_request_read; <span class="comment">/* seq number of last event read */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> request;	<span class="comment">/* sequence number of last request. */</span></div><div class="line">	<span class="keyword">char</span> *last_req;		<span class="comment">/* beginning of last request, or dummy */</span></div><div class="line">	<span class="keyword">char</span> *buffer;		<span class="comment">/* Output buffer starting address. */</span></div><div class="line">	<span class="keyword">char</span> *bufptr;		<span class="comment">/* Output buffer index pointer. */</span></div><div class="line">	<span class="keyword">char</span> *bufmax;		<span class="comment">/* Output buffer maximum+1 address. */</span></div><div class="line">	<span class="keyword">unsigned</span> max_request_size; <span class="comment">/* maximum number 32 bit words in request*/</span></div><div class="line">	<span class="keyword">struct</span> _XrmHashBucketRec *db;</div><div class="line">	<span class="keyword">int</span> (*synchandler)(	<span class="comment">/* Synchronization handler */</span></div><div class="line">		<span class="keyword">struct</span> _XDisplay*</div><div class="line">		);</div><div class="line">	<span class="keyword">char</span> *display_name;	<span class="comment">/* "host:display" string used on this connect*/</span></div><div class="line">	<span class="keyword">int</span> default_screen;	<span class="comment">/* default screen for operations */</span></div><div class="line">	<span class="keyword">int</span> nscreens;		<span class="comment">/* number of screens on this server*/</span></div><div class="line">	Screen *screens;	<span class="comment">/* pointer to list of screens */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> motion_buffer;	<span class="comment">/* size of motion buffer */</span></div><div class="line">	<span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;	   <span class="comment">/* internal connection flags */</span></div><div class="line">	<span class="keyword">int</span> min_keycode;	<span class="comment">/* minimum defined keycode */</span></div><div class="line">	<span class="keyword">int</span> max_keycode;	<span class="comment">/* maximum defined keycode */</span></div><div class="line">	KeySym *keysyms;	<span class="comment">/* This server's keysyms */</span></div><div class="line">	XModifierKeymap *modifiermap;	<span class="comment">/* This server's modifier keymap */</span></div><div class="line">	<span class="keyword">int</span> keysyms_per_keycode;<span class="comment">/* number of rows */</span></div><div class="line">	<span class="keyword">char</span> *xdefaults;	<span class="comment">/* contents of defaults from server */</span></div><div class="line">	<span class="keyword">char</span> *scratch_buffer;	<span class="comment">/* place to hang scratch buffer */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> scratch_length;	<span class="comment">/* length of scratch buffer */</span></div><div class="line">	<span class="keyword">int</span> ext_number;		<span class="comment">/* extension number on this display */</span></div><div class="line">	<span class="keyword">struct</span> _XExten *ext_procs; <span class="comment">/* extensions initialized on this display */</span></div><div class="line">	<span class="comment">/*</span></div><div class="line"><span class="comment">	 * the following can be fixed size, as the protocol defines how</span></div><div class="line"><span class="comment">	 * much address space is available.</span></div><div class="line"><span class="comment">	 * While this could be done using the extension vector, there</span></div><div class="line"><span class="comment">	 * may be MANY events processed, so a search through the extension</span></div><div class="line"><span class="comment">	 * list to find the right procedure for each event might be</span></div><div class="line"><span class="comment">	 * expensive if many extensions are being used.</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	Bool (*event_vec[<span class="number">128</span>])(	<span class="comment">/* vector for wire to event */</span></div><div class="line">		Display *	<span class="comment">/* dpy */</span>,</div><div class="line">		XEvent *	<span class="comment">/* re */</span>,</div><div class="line">		xEvent *	<span class="comment">/* event */</span></div><div class="line">		);</div><div class="line">	Status (*wire_vec[<span class="number">128</span>])( <span class="comment">/* vector for event to wire */</span></div><div class="line">		Display *	<span class="comment">/* dpy */</span>,</div><div class="line">		XEvent *	<span class="comment">/* re */</span>,</div><div class="line">		xEvent *	<span class="comment">/* event */</span></div><div class="line">		);</div><div class="line">	KeySym lock_meaning;	   <span class="comment">/* for XLookupString */</span></div><div class="line">	<span class="keyword">struct</span> _XLockInfo *lock;   <span class="comment">/* multi-thread state, display lock */</span></div><div class="line">	<span class="keyword">struct</span> _XInternalAsync *async_handlers; <span class="comment">/* for internal async */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> bigreq_size; <span class="comment">/* max size of big requests */</span></div><div class="line">	<span class="keyword">struct</span> _XLockPtrs *lock_fns; <span class="comment">/* pointers to threads functions */</span></div><div class="line">	<span class="keyword">void</span> (*idlist_alloc)(	   <span class="comment">/* XID list allocator function */</span></div><div class="line">		Display *	<span class="comment">/* dpy */</span>,</div><div class="line">		XID *		<span class="comment">/* ids */</span>,</div><div class="line">		<span class="keyword">int</span>		<span class="comment">/* count */</span></div><div class="line">		);</div><div class="line">	<span class="comment">/* things above this line should not move, for binary compatibility */</span></div><div class="line">	<span class="keyword">struct</span> _XKeytrans *key_bindings; <span class="comment">/* for XLookupString */</span></div><div class="line">	Font cursor_font;	   <span class="comment">/* for XCreateFontCursor */</span></div><div class="line">	<span class="keyword">struct</span> _XDisplayAtoms *atoms; <span class="comment">/* for XInternAtom */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mode_switch;  <span class="comment">/* keyboard group modifiers */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_lock;  <span class="comment">/* keyboard numlock modifiers */</span></div><div class="line">	<span class="keyword">struct</span> _XContextDB *context_db; <span class="comment">/* context database */</span></div><div class="line">	Bool (**error_vec)(	<span class="comment">/* vector for wire to error */</span></div><div class="line">		Display     *	<span class="comment">/* display */</span>,</div><div class="line">		XErrorEvent *	<span class="comment">/* he */</span>,</div><div class="line">		xError      *	<span class="comment">/* we */</span></div><div class="line">		);</div><div class="line">	<span class="comment">/*</span></div><div class="line"><span class="comment">	 * Xcms information</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	<span class="keyword">struct</span> {</div><div class="line">	   XPointer defaultCCCs;  <span class="comment">/* pointer to an array of default XcmsCCC */</span></div><div class="line">	   XPointer clientCmaps;  <span class="comment">/* pointer to linked list of XcmsCmapRec */</span></div><div class="line">	   XPointer perVisualIntensityMaps;</div><div class="line">				  <span class="comment">/* linked list of XcmsIntensityMap */</span></div><div class="line">	} cms;</div><div class="line">	<span class="keyword">struct</span> _XIMFilter *im_filters;</div><div class="line">	<span class="keyword">struct</span> _XSQEvent *qfree; <span class="comment">/* unallocated event queue elements */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> next_event_serial_num; <span class="comment">/* inserted into next queue elt */</span></div><div class="line">	<span class="keyword">struct</span> _XExten *flushes; <span class="comment">/* Flush hooks */</span></div><div class="line">	<span class="keyword">struct</span> _XConnectionInfo *im_fd_info; <span class="comment">/* _XRegisterInternalConnection */</span></div><div class="line">	<span class="keyword">int</span> im_fd_length;	<span class="comment">/* number of im_fd_info */</span></div><div class="line">	<span class="keyword">struct</span> _XConnWatchInfo *conn_watchers; <span class="comment">/* XAddConnectionWatch */</span></div><div class="line">	<span class="keyword">int</span> watcher_count;	<span class="comment">/* number of conn_watchers */</span></div><div class="line">	XPointer filedes;	<span class="comment">/* struct pollfd cache for _XWaitForReadable */</span></div><div class="line">	<span class="keyword">int</span> (*savedsynchandler)( <span class="comment">/* user synchandler when Xlib usurps */</span></div><div class="line">		Display *	<span class="comment">/* dpy */</span></div><div class="line">		);</div><div class="line">	XID resource_max;	<span class="comment">/* allocator max ID */</span></div><div class="line">	<span class="keyword">int</span> xcmisc_opcode;	<span class="comment">/* major opcode for XC-MISC */</span></div><div class="line">	<span class="keyword">struct</span> _XkbInfoRec *xkb_info; <span class="comment">/* XKB info */</span></div><div class="line">	<span class="keyword">struct</span> _XtransConnInfo *trans_conn; <span class="comment">/* transport connection object */</span></div><div class="line">	<span class="keyword">struct</span> _X11XCBPrivate *xcb; <span class="comment">/* XCB glue private data */</span></div><div class="line"></div><div class="line">	<span class="comment">/* Generic event cookie handling */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> next_cookie; <span class="comment">/* next event cookie */</span></div><div class="line">	<span class="comment">/* vector for wire to generic event, index is (extension - 128) */</span></div><div class="line">	Bool (*generic_event_vec[<span class="number">128</span>])(</div><div class="line">		Display *	<span class="comment">/* dpy */</span>,</div><div class="line">		XGenericEventCookie *	<span class="comment">/* Xlib event */</span>,</div><div class="line">		xEvent *	<span class="comment">/* wire event */</span>);</div><div class="line">	<span class="comment">/* vector for event copy, index is (extension - 128) */</span></div><div class="line">	Bool (*generic_event_copy_vec[<span class="number">128</span>])(</div><div class="line">		Display *	<span class="comment">/* dpy */</span>,</div><div class="line">		XGenericEventCookie *	<span class="comment">/* in */</span>,</div><div class="line">		XGenericEventCookie *   <span class="comment">/* out*/</span>);</div><div class="line">	<span class="keyword">void</span> *cookiejar;  <span class="comment">/* cookie events returned but not claimed */</span></div><div class="line">};</div><div class="line"></div></pre></td></tr></table></figure>

<p>其中第一个定义是暴露给外部应用程序使用的，第二个定义在 X11 内部使用的。可以看到第一个里面的一些 private* ，在第二个中都有了相应的定义，并且它们所占用的存储空间都是一样的，而且第一个在最后还提示了，后面的部分是 Xlib 私有的。</p>
<ul>
<li><strong>Screen</strong><br>Screen 的层次在 Display 之下，是 X server 显示管理的次级单位。一个 Screen 对应一个根窗口（root window），根窗口的大小与 Screen 相同。如果在命令行执行 “X” 的话，启动了 X server，这时在屏幕上看到一个单调的桌面，以及一个 “X” 形的鼠标，不过因为没有启动 window manager，所以什么都不能做，只能动动鼠标。这时你看到的这个单调的“桌面”正是根窗口。它的数据结构如下：</li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在 X11/xlib.h 中的定义</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> {</div><div class="line">	XExtData *ext_data;	<span class="comment">/* hook for extension to hang data */</span></div><div class="line">	<span class="keyword">struct</span> _XDisplay *display;<span class="comment">/* back pointer to display structure */</span></div><div class="line">	Window root;		<span class="comment">/* Root window id. */</span></div><div class="line">	<span class="keyword">int</span> width, height;	<span class="comment">/* width and height of screen */</span></div><div class="line">	<span class="keyword">int</span> mwidth, mheight;	<span class="comment">/* width and height of  in millimeters */</span></div><div class="line">	<span class="keyword">int</span> ndepths;		<span class="comment">/* number of depths possible */</span></div><div class="line">	Depth *depths;		<span class="comment">/* list of allowable depths on the screen */</span></div><div class="line">	<span class="keyword">int</span> root_depth;		<span class="comment">/* bits per pixel */</span></div><div class="line">	Visual *root_visual;	<span class="comment">/* root visual */</span></div><div class="line">	GC default_gc;		<span class="comment">/* GC for the root root visual */</span></div><div class="line">	Colormap cmap;		<span class="comment">/* default color map */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> white_pixel;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> black_pixel;	<span class="comment">/* White and Black pixel values */</span></div><div class="line">	<span class="keyword">int</span> max_maps, min_maps;	<span class="comment">/* max and min color maps */</span></div><div class="line">	<span class="keyword">int</span> backing_store;	<span class="comment">/* Never, WhenMapped, Always */</span></div><div class="line">	Bool save_unders;</div><div class="line">	<span class="keyword">long</span> root_input_mask;	<span class="comment">/* initial root input mask */</span></div><div class="line">} Screen;</div><div class="line"></div></pre></td></tr></table></figure>

<p>其中包括的一些看看注释也就知道是什么了。</p>
<ul>
<li><strong>GC</strong><br>Graphic Context：X11 上的绘图上下文，类似于 MiniGUI 里的 DC 概念。它的数据结构是：</li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在 X11/xlib.h 中的定义</span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Data structure for setting graphics context.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> {</div><div class="line">	<span class="keyword">int</span> function;		<span class="comment">/* logical operation */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> plane_mask;<span class="comment">/* plane mask */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> foreground;<span class="comment">/* foreground pixel */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> background;<span class="comment">/* background pixel */</span></div><div class="line">	<span class="keyword">int</span> line_width;		<span class="comment">/* line width */</span></div><div class="line">	<span class="keyword">int</span> line_style;	 	<span class="comment">/* LineSolid, LineOnOffDash, LineDoubleDash */</span></div><div class="line">	<span class="keyword">int</span> cap_style;	  	<span class="comment">/* CapNotLast, CapButt,</span></div><div class="line"><span class="comment">				   CapRound, CapProjecting */</span></div><div class="line">	<span class="keyword">int</span> join_style;	 	<span class="comment">/* JoinMiter, JoinRound, JoinBevel */</span></div><div class="line">	<span class="keyword">int</span> fill_style;	 	<span class="comment">/* FillSolid, FillTiled,</span></div><div class="line"><span class="comment">				   FillStippled, FillOpaeueStippled */</span></div><div class="line">	<span class="keyword">int</span> fill_rule;	  	<span class="comment">/* EvenOddRule, WindingRule */</span></div><div class="line">	<span class="keyword">int</span> arc_mode;		<span class="comment">/* ArcChord, ArcPieSlice */</span></div><div class="line">	Pixmap tile;		<span class="comment">/* tile pixmap for tiling operations */</span></div><div class="line">	Pixmap stipple;		<span class="comment">/* stipple 1 plane pixmap for stipping */</span></div><div class="line">	<span class="keyword">int</span> ts_x_origin;	<span class="comment">/* offset for tile or stipple operations */</span></div><div class="line">	<span class="keyword">int</span> ts_y_origin;</div><div class="line">        Font font;	        <span class="comment">/* default text font for text operations */</span></div><div class="line">	<span class="keyword">int</span> subwindow_mode;     <span class="comment">/* ClipByChildren, IncludeInferiors */</span></div><div class="line">	Bool graphics_exposures;<span class="comment">/* boolean, should exposures be generated */</span></div><div class="line">	<span class="keyword">int</span> clip_x_origin;	<span class="comment">/* origin for clipping */</span></div><div class="line">	<span class="keyword">int</span> clip_y_origin;</div><div class="line">	Pixmap clip_mask;	<span class="comment">/* bitmap clipping; other calls for rects */</span></div><div class="line">	<span class="keyword">int</span> dash_offset;	<span class="comment">/* patterned/dashed line information */</span></div><div class="line">	<span class="keyword">char</span> dashes;</div><div class="line">} XGCValues;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Graphics context.  The contents of this structure are implementation</span></div><div class="line"><span class="comment"> * dependent.  A GC should be treated as opaque by application code.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _XGC</div><div class="line"><span class="preprocessor">#ifdef XLIB_ILLEGAL_ACCESS</span></div><div class="line">{</div><div class="line">    XExtData *ext_data;	<span class="comment">/* hook for extension to hang data */</span></div><div class="line">    GContext gid;	<span class="comment">/* protocol ID for graphics context */</span></div><div class="line">    <span class="comment">/* there is more to this structure, but it is private to Xlib */</span></div><div class="line">}</div><div class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></div><div class="line">*GC;</div><div class="line"></div><div class="line"><span class="comment">// 在 X11/xlibint.h 中的定义</span></div><div class="line"><span class="keyword">struct</span> _XGC</div><div class="line">{</div><div class="line">    XExtData *ext_data;	<span class="comment">/* hook for extension to hang data */</span></div><div class="line">    GContext gid;	<span class="comment">/* protocol ID for graphics context */</span></div><div class="line">    Bool rects;		<span class="comment">/* boolean: TRUE if clipmask is list of rectangles */</span></div><div class="line">    Bool dashes;	<span class="comment">/* boolean: TRUE if dash-list is really a list */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> dirty;<span class="comment">/* cache dirty bits */</span></div><div class="line">    XGCValues values;	<span class="comment">/* shadow structure of values */</span></div><div class="line">};</div><div class="line"></div></pre></td></tr></table></figure>

<p>和 Display 的定义类似的，暴露的结构数据比较少。</p>
<ul>
<li><strong>Window</strong><br>这个就是 X11 里的窗口的概念了。不过它的定义和别的 GUI 不太一样。它在 X11/X.h 里被简单的定义成： </li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在 X11/X.h 中定义</span></div><div class="line"><span class="keyword">typedef</span> CARD32 XID;</div><div class="line"><span class="keyword">typedef</span> XID Window;</div><div class="line"></div><div class="line"><span class="comment">// 在 X11/Xmd.h 中定义</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> CARD32;</div><div class="line"></div></pre></td></tr></table></figure>

<p>可以看得到这个其实是一个 32位 的 ID 号。而不像其它 GUI 中包括一些什么窗口的标题、矩形区域大小、绘图上下文等等。这些可能保存在 X 服务器那一端吧，因为 X11 是 C/S 架构的，所以通过一个唯一的 ID 号来进行传送效率会比较高吧。这里需要说明下，这个就已经是 X11 上能够绘制图像的东西了，可以说类似 MiniGUI Surface 一样的东西了，只不过你无法通过这个变量直接拿到里面的数据。要想获得一些相关的数据，好像需要通过 X11 的协议向 X 服务器发送相应的请求。</p>
<ul>
<li><p><strong>Pixmap</strong><br>这个是 X11 上另一个可以绘制图像的东西。它和上面 Window 的区别在于：Window 的绘制是直接在屏幕上的，而 Pixmap 的绘制是离屏的（类似 MiniGUI 的 on-screen surface 和 off-screen surface）。它在 X11/X.h 中也被简单的定义成：typedef XID Pixmap; 。同样是一个 ID 号。</p>
</li>
<li><p><strong>Drawable</strong><br>这个也是一个 ID 号： typedef XID Drawable; 。上面说了 X11 中可以绘制的东西分为2种：on-screen 的 Window 和 off-sreen 的 Pixmap，这个 Drawable 就是指向其中的某一种的。也就是说一个 Drawable 不是 Window 就是 Pixmap，这里可能是为了方便某些地方的统一处理吧。</p>
</li>
</ul>
<h3 id="基本使用流程">基本使用流程</h3>
<p>下面说下在 X11 上创建一个窗口的基本流程：</p>
<ul>
<li><p><strong>XOpenDisplay</strong><br>首先需要调用 XOpenDisplay  打开显示设备。这个函数会返回一个 Display 指针。一般传入 NULL 会使用环境变量中 DISPLAY 设定的值。</p>
</li>
<li><p><strong>DefaultScreen</strong><br>然后调用 DefaultScreen 得到默认的 Screen。一般是传入 XOpenDisplay 得到的 display。</p>
</li>
<li><p><strong>XCreateWindow</strong><br>然后是通过 XCreateWindow 创建窗口。这个 API 需要传入大量的参数：例如 display 指针、父窗口 ID 号（第一个窗口的父窗口是 root window）、矩形区域、色深、颜色格式、窗口属性数组等等。这个具体的看附件的教程资料吧，东西太多了。有个简单的接口叫 XCreateSimpleWindow 。</p>
</li>
<li><p><strong>XMapWindow</strong><br>创建了窗口后，不会马上显示，需要用这个 API 之后才会显示。</p>
</li>
<li><p><strong>XCreateGC</strong><br>通过之前创建的 display 和 drawable（window）创建 GC，通过这个 GC 就可以在创建的 window 上进行绘图了。 附件里有个小例子。</p>
</li>
</ul>
<h3 id="Xlib_线索">Xlib 线索</h3>
<p>查找了下 Xlib 的 API 手册，没发现有可以直接使用的 API 能拿到像素地址的。不过想想也是，应该是没有哪个 GUI 库会直接提供 API 让应用程序来直接读写 surface 的像素地址的，因为这样对于普通的应用程序来说还是比较危险的，很容易造成显示上的问题。特别是对于 C/S 架构的 X11 来说。并且通过前面的讨论也无法直接从一些核心的图形数据结构上直接拿到（像 Window 这样的类型直接就是一个 ID 号）。API 手册上有几个 API 倒是可以把 Drawable 中的像素数据复制出来，但是是复制出来的，不是 Drawable 原始的像素数据。但是既然它能够从 Drawable 中复制出数据，那就是说明它肯定是可以访问得到 Drawable 原始的像素数据的，至少可以拿得到它的地址。所以我觉得我们可以参照下这些 API 的实现，自己改装下，应该也可以拿得到像素数据地址。其中的一个 API 是：</p>
<ul>
<li><strong>XGetImage</strong></li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 这个函数的流程是先通过 GetReq 填写向 X 服务器要发送的请求。</span></div><div class="line"><span class="comment">// 然后调用 _XReply 向 X 服务器发送获取给定窗口图像的请求，并且等待服务器返回数据。</span></div><div class="line"><span class="comment">// 然后当 _XReply 正确返回后，调用 _XReadPad 通过 X 服务器返回过来的偏移量计算出图像的像素地址。</span></div><div class="line"><span class="comment">// 然后根据这个像素地址调用 XCreateImage 创建一个新的 XImage ，最后返回。</span></div><div class="line"><span class="comment">// 这里返回的是复制过的，所以我们可以参考它是如果像 X11 拿像素地址的</span></div><div class="line"><span class="comment">// _XReply 和 _XReadPad 的代码就不贴了，都是在 Xlib 库的源代码里的</span></div><div class="line">XImage *XGetImage (</div><div class="line">     <span class="keyword">register</span> Display *dpy,</div><div class="line">     Drawable d,</div><div class="line">     <span class="keyword">int</span> x,</div><div class="line">     <span class="keyword">int</span> y,</div><div class="line">     <span class="keyword">unsigned</span> <span class="keyword">int</span> width,</div><div class="line">     <span class="keyword">unsigned</span> <span class="keyword">int</span> height,</div><div class="line">     <span class="keyword">unsigned</span> <span class="keyword">long</span> plane_mask,</div><div class="line">     <span class="keyword">int</span> format)	<span class="comment">/* either XYPixmap or ZPixmap */</span></div><div class="line">{</div><div class="line">	xGetImageReply rep;</div><div class="line">	<span class="keyword">register</span> xGetImageReq *req;</div><div class="line">	<span class="keyword">char</span> *data;</div><div class="line">	<span class="keyword">long</span> nbytes;</div><div class="line">	XImage *image;</div><div class="line">	LockDisplay(dpy);</div><div class="line">	GetReq (GetImage, req);</div><div class="line">	<span class="comment">/*</span></div><div class="line"><span class="comment">	 * first set up the standard stuff in the request</span></div><div class="line"><span class="comment">	 */</span></div><div class="line">	req-&gt;drawable = d;</div><div class="line">	req-&gt;x = x;</div><div class="line">	req-&gt;y = y;</div><div class="line">	req-&gt;width = width;</div><div class="line">	req-&gt;height = height;</div><div class="line">	req-&gt;planeMask = plane_mask;</div><div class="line">	req-&gt;format = format;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (_XReply (dpy, (xReply *) &rep, <span class="number">0</span>, xFalse) == <span class="number">0</span> ||</div><div class="line">	    rep.length == <span class="number">0</span>) {</div><div class="line">		UnlockDisplay(dpy);</div><div class="line">		SyncHandle();</div><div class="line">		<span class="keyword">return</span> (XImage *)NULL;</div><div class="line">	}</div><div class="line"></div><div class="line">	nbytes = (<span class="keyword">long</span>)rep.length &lt;&lt; <span class="number">2</span>;</div><div class="line">	data = (<span class="keyword">char</span> *) Xmalloc((<span class="keyword">unsigned</span>) nbytes);</div><div class="line">	<span class="keyword">if</span> (! data) {</div><div class="line">	    _XEatData(dpy, (<span class="keyword">unsigned</span> <span class="keyword">long</span>) nbytes);</div><div class="line">	    UnlockDisplay(dpy);</div><div class="line">	    SyncHandle();</div><div class="line">	    <span class="keyword">return</span> (XImage *) NULL;</div><div class="line">	}</div><div class="line">        _XReadPad (dpy, data, nbytes);</div><div class="line">        <span class="keyword">if</span> (format == XYPixmap)</div><div class="line">	   image = XCreateImage(dpy, _XVIDtoVisual(dpy, rep.visual),</div><div class="line">		  Ones (plane_mask &</div><div class="line">			(((<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0xFFFFFFFF</span>) &gt;&gt; (<span class="number">32</span> - rep.depth))),</div><div class="line">		  format, <span class="number">0</span>, data, width, height, dpy-&gt;bitmap_pad, <span class="number">0</span>);</div><div class="line">	<span class="keyword">else</span> <span class="comment">/* format == ZPixmap */</span></div><div class="line">           image = XCreateImage (dpy, _XVIDtoVisual(dpy, rep.visual),</div><div class="line">		 rep.depth, ZPixmap, <span class="number">0</span>, data, width, height,</div><div class="line">		  _XGetScanlinePad(dpy, (<span class="keyword">int</span>) rep.depth), <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!image)</div><div class="line">	    Xfree(data);</div><div class="line">	UnlockDisplay(dpy);</div><div class="line">	SyncHandle();</div><div class="line">	<span class="keyword">return</span> (image);</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>不过这个函数需要调用一些 Xlib 内部使用的函数。不知道能不能方便的扣出来使用。并且估计这个拿到的应该是虚拟地址，而不是物理地址。</p>
<h2 id="X_server_分析">X server 分析</h2>
<p>X11 很多东西都是通过向 X server 发送请求来完成的。所有其实有很多核心的东西是在 X server 这边的。包括低层的打开 framebuffer 设备等等，应该都是在 X server 这边实现的。</p>
<h3 id="X_server_基本数据结构">X server 基本数据结构</h3>
<p>之前在 Xlib 那边说过很多结构都是一个 ID 号，其实在 X server 这边都对应一个数据结构。</p>
<ul>
<li><strong>Screen</strong></li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _Screen {</div><div class="line">    <span class="keyword">int</span>			myNum;	<span class="comment">/* index of this instance in Screens[] */</span></div><div class="line">    ATOM		id;</div><div class="line">    <span class="keyword">short</span>		x, y, width, height;</div><div class="line">    <span class="keyword">short</span>		mmWidth, mmHeight;</div><div class="line">    <span class="keyword">short</span>		numDepths;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>      	rootDepth;</div><div class="line">    DepthPtr       	allowedDepths;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>      	rootVisual;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	defColormap;</div><div class="line">    <span class="keyword">short</span>		minInstalledCmaps, maxInstalledCmaps;</div><div class="line">    <span class="keyword">char</span>                backingStoreSupport, saveUnderSupport;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	whitePixel, blackPixel;</div><div class="line">    GCPtr		GCperDepth[MAXFORMATS+<span class="number">1</span>];</div><div class="line">			<span class="comment">/* next field is a stipple to use as default in</span></div><div class="line"><span class="comment">			   a GC.  we don't build default tiles of all depths</span></div><div class="line"><span class="comment">			   because they are likely to be of a color</span></div><div class="line"><span class="comment">			   different from the default fg pixel, so</span></div><div class="line"><span class="comment">			   we don't win anything by building</span></div><div class="line"><span class="comment">			   a standard one.</span></div><div class="line"><span class="comment">			*/</span></div><div class="line">    PixmapPtr		PixmapPerDepth[<span class="number">1</span>];</div><div class="line">    pointer		devPrivate;</div><div class="line">    <span class="keyword">short</span>       	numVisuals;</div><div class="line">    VisualPtr		visuals;</div><div class="line">    WindowPtr		root;</div><div class="line">    ScreenSaverStuffRec screensaver;</div><div class="line"></div><div class="line">    <span class="comment">/* Random screen procedures */</span></div><div class="line"></div><div class="line">    CloseScreenProcPtr		CloseScreen;</div><div class="line">    QueryBestSizeProcPtr	QueryBestSize;</div><div class="line">    SaveScreenProcPtr		SaveScreen;</div><div class="line">    GetImageProcPtr		GetImage;</div><div class="line">    GetSpansProcPtr		GetSpans;</div><div class="line">    SourceValidateProcPtr	SourceValidate;</div><div class="line"></div><div class="line">    <span class="comment">/* Window Procedures */</span></div><div class="line"></div><div class="line">    CreateWindowProcPtr		CreateWindow;</div><div class="line">    DestroyWindowProcPtr	DestroyWindow;</div><div class="line">    PositionWindowProcPtr	PositionWindow;</div><div class="line">    ChangeWindowAttributesProcPtr ChangeWindowAttributes;</div><div class="line">    RealizeWindowProcPtr	RealizeWindow;</div><div class="line">    UnrealizeWindowProcPtr	UnrealizeWindow;</div><div class="line">    ValidateTreeProcPtr		ValidateTree;</div><div class="line">    PostValidateTreeProcPtr	PostValidateTree;</div><div class="line">    WindowExposuresProcPtr	WindowExposures;</div><div class="line">    CopyWindowProcPtr		CopyWindow;</div><div class="line">    ClearToBackgroundProcPtr	ClearToBackground;</div><div class="line">    ClipNotifyProcPtr		ClipNotify;</div><div class="line">    RestackWindowProcPtr	RestackWindow;</div><div class="line"></div><div class="line">    <span class="comment">/* Pixmap procedures */</span></div><div class="line"></div><div class="line">    CreatePixmapProcPtr		CreatePixmap;</div><div class="line">    DestroyPixmapProcPtr	DestroyPixmap;</div><div class="line"></div><div class="line">    <span class="comment">/* Backing store procedures */</span></div><div class="line"></div><div class="line">    SaveDoomedAreasProcPtr	SaveDoomedAreas;</div><div class="line">    RestoreAreasProcPtr		RestoreAreas;</div><div class="line">    ExposeCopyProcPtr		ExposeCopy;</div><div class="line">    TranslateBackingStoreProcPtr TranslateBackingStore;</div><div class="line">    ClearBackingStoreProcPtr	ClearBackingStore;</div><div class="line">    DrawGuaranteeProcPtr	DrawGuarantee;</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * A read/write copy of the lower level backing store vector is needed now</span></div><div class="line"><span class="comment">     * that the functions can be wrapped.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    BSFuncRec			BackingStoreFuncs;</div><div class="line">    </div><div class="line">    <span class="comment">/* Font procedures */</span></div><div class="line"></div><div class="line">    RealizeFontProcPtr		RealizeFont;</div><div class="line">    UnrealizeFontProcPtr	UnrealizeFont;</div><div class="line"></div><div class="line">    <span class="comment">/* Cursor Procedures */</span></div><div class="line"></div><div class="line">    ConstrainCursorProcPtr	ConstrainCursor;</div><div class="line">    CursorLimitsProcPtr		CursorLimits;</div><div class="line">    DisplayCursorProcPtr	DisplayCursor;</div><div class="line">    RealizeCursorProcPtr	RealizeCursor;</div><div class="line">    UnrealizeCursorProcPtr	UnrealizeCursor;</div><div class="line">    RecolorCursorProcPtr	RecolorCursor;</div><div class="line">    SetCursorPositionProcPtr	SetCursorPosition;</div><div class="line"></div><div class="line">    <span class="comment">/* GC procedures */</span></div><div class="line"></div><div class="line">    CreateGCProcPtr		CreateGC;</div><div class="line"></div><div class="line">    <span class="comment">/* Colormap procedures */</span></div><div class="line"></div><div class="line">    CreateColormapProcPtr	CreateColormap;</div><div class="line">    DestroyColormapProcPtr	DestroyColormap;</div><div class="line">    InstallColormapProcPtr	InstallColormap;</div><div class="line">    UninstallColormapProcPtr	UninstallColormap;</div><div class="line">    ListInstalledColormapsProcPtr ListInstalledColormaps;</div><div class="line">    StoreColorsProcPtr		StoreColors;</div><div class="line">    ResolveColorProcPtr		ResolveColor;</div><div class="line"></div><div class="line">    <span class="comment">/* Region procedures */</span></div><div class="line"></div><div class="line">    BitmapToRegionProcPtr	BitmapToRegion;</div><div class="line">    SendGraphicsExposeProcPtr	SendGraphicsExpose;</div><div class="line"></div><div class="line">    <span class="comment">/* os layer procedures */</span></div><div class="line"></div><div class="line">    ScreenBlockHandlerProcPtr	BlockHandler;</div><div class="line">    ScreenWakeupHandlerProcPtr	WakeupHandler;</div><div class="line"></div><div class="line">    pointer blockData;</div><div class="line">    pointer wakeupData;</div><div class="line"></div><div class="line">    <span class="comment">/* anybody can get a piece of this array */</span></div><div class="line">    PrivateRec	*devPrivates;</div><div class="line"></div><div class="line">    CreateScreenResourcesProcPtr CreateScreenResources;</div><div class="line">    ModifyPixmapHeaderProcPtr	ModifyPixmapHeader;</div><div class="line"></div><div class="line">    GetWindowPixmapProcPtr	GetWindowPixmap;</div><div class="line">    SetWindowPixmapProcPtr	SetWindowPixmap;</div><div class="line">    GetScreenPixmapProcPtr	GetScreenPixmap;</div><div class="line">    SetScreenPixmapProcPtr	SetScreenPixmap;</div><div class="line"></div><div class="line">    PixmapPtr pScratchPixmap;		<span class="comment">/* scratch pixmap "pool" */</span></div><div class="line"></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>		totalPixmapSize;</div><div class="line"></div><div class="line">    MarkWindowProcPtr		MarkWindow;</div><div class="line">    MarkOverlappedWindowsProcPtr MarkOverlappedWindows;</div><div class="line">    ChangeSaveUnderProcPtr	ChangeSaveUnder;</div><div class="line">    PostChangeSaveUnderProcPtr	PostChangeSaveUnder;</div><div class="line">    ConfigNotifyProcPtr		ConfigNotify;</div><div class="line">    MoveWindowProcPtr		MoveWindow;</div><div class="line">    ResizeWindowProcPtr		ResizeWindow;</div><div class="line">    GetLayerWindowProcPtr	GetLayerWindow;</div><div class="line">    HandleExposuresProcPtr	HandleExposures;</div><div class="line">    ReparentWindowProcPtr	ReparentWindow;</div><div class="line"></div><div class="line">    SetShapeProcPtr		SetShape;</div><div class="line"></div><div class="line">    ChangeBorderWidthProcPtr	ChangeBorderWidth;</div><div class="line">    MarkUnrealizedWindowProcPtr	MarkUnrealizedWindow;</div><div class="line"></div><div class="line">    <span class="comment">/* Device cursor procedures */</span></div><div class="line">    DeviceCursorInitializeProcPtr DeviceCursorInitialize;</div><div class="line">    DeviceCursorCleanupProcPtr    DeviceCursorCleanup;</div><div class="line">} ScreenRec;</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个 Screen 是 X server 这边使用的，和 Xlib 那边的不一样。其中有很多回调函数指针，从名字可以看到很多都是一些核心的图形功能的，例如创建窗口、创建GC 等等。这些回调函数在初始化时被设置成和 framebuffer 操作相关的函数。这个在 xserver 的代码目录的 fb/fbscreen.c 的 fbSetupScreen 函数里可以看得到，而这个函数会在初始化的时候被调用，具体的大家可以自己去跟下代码。</p>
<ul>
<li><strong>GC</strong></li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* there is padding in the bit fields because the Sun compiler doesn't</span></div><div class="line"><span class="comment"> * force alignment to 32-bit boundaries.  losers.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _GC {</div><div class="line">    ScreenPtr		pScreen;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>	depth;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>	alu;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>	lineWidth;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>	dashOffset;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>	numInDashList;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>	*dash;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	lineStyle : <span class="number">2</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	capStyle : <span class="number">2</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	joinStyle : <span class="number">2</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	fillStyle : <span class="number">2</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	fillRule : <span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> 	arcMode : <span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	subWindowMode : <span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	graphicsExposures : <span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	clientClipType : <span class="number">2</span>; <span class="comment">/* CT_&lt;kind&gt; */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	miTranslate:<span class="number">1</span>; <span class="comment">/* should mi things translate? */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	tileIsPixel:<span class="number">1</span>; <span class="comment">/* tile is solid pixel */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	fExpose:<span class="number">1</span>;     <span class="comment">/* Call exposure handling */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	freeCompClip:<span class="number">1</span>;  <span class="comment">/* Free composite clip */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	scratch_inuse:<span class="number">1</span>; <span class="comment">/* is this GC in a pool for reuse? */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>	unused:<span class="number">13</span>; <span class="comment">/* see comment above */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	planemask;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	fgPixel;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	bgPixel;</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * alas -- both tile and stipple must be here as they</span></div><div class="line"><span class="comment">     * are independently specifiable</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    PixUnion		tile;</div><div class="line">    PixmapPtr		stipple;</div><div class="line">    DDXPointRec		patOrg;		<span class="comment">/* origin for (tile, stipple) */</span></div><div class="line">    <span class="keyword">struct</span> _Font	*font;</div><div class="line">    DDXPointRec		clipOrg;</div><div class="line">    DDXPointRec		lastWinOrg;	<span class="comment">/* position of window last validated */</span></div><div class="line">    pointer		clientClip;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	stateChanges;	<span class="comment">/* masked with GC_&lt;kind&gt; */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>       serialNumber;</div><div class="line">    GCFuncs		*funcs;</div><div class="line">    GCOps		*ops;</div><div class="line">    PrivateRec		*devPrivates;</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * The following were moved here from private storage to allow device-</span></div><div class="line"><span class="comment">     * independent access to them from screen wrappers.</span></div><div class="line"><span class="comment">     * --- 1997.11.03  Marc Aurele La France (tsi@xfree86.org)</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    PixmapPtr		pRotatedPixmap; <span class="comment">/* tile/stipple rotated for alignment */</span></div><div class="line">    RegionPtr		pCompositeClip;</div><div class="line">    <span class="comment">/* fExpose & freeCompClip defined above */</span></div><div class="line">} GC;</div><div class="line"></div></pre></td></tr></table></figure>

<p>同样是 X server 这边使用的 GC。其中 ops 这个结构里是一大堆类似 GDI 的回调函数指针（），也是在初始化的时候被设置的。具体的还没怎么仔细看。</p>
<ul>
<li><strong>Window</strong></li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _Window {</div><div class="line">    DrawableRec	drawable;</div><div class="line">    PrivateRec		*devPrivates;</div><div class="line">    WindowPtr		parent;		<span class="comment">/* ancestor chain */</span></div><div class="line">    WindowPtr		nextSib;	<span class="comment">/* next lower sibling */</span></div><div class="line">    WindowPtr		prevSib;	<span class="comment">/* next higher sibling */</span></div><div class="line">    WindowPtr		firstChild;	<span class="comment">/* top-most child */</span></div><div class="line">    WindowPtr		lastChild;	<span class="comment">/* bottom-most child */</span></div><div class="line">    RegionRec		clipList;	<span class="comment">/* clipping rectangle for output */</span></div><div class="line">    RegionRec		borderClip;	<span class="comment">/* NotClippedByChildren + border */</span></div><div class="line">    <span class="keyword">union</span> _Validate	*valdata;</div><div class="line">    RegionRec		winSize;</div><div class="line">    RegionRec		borderSize;</div><div class="line">    DDXPointRec		origin;		<span class="comment">/* position relative to parent */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>	borderWidth;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>	deliverableEvents; <span class="comment">/* all masks from all clients */</span></div><div class="line">    Mask		eventMask;      <span class="comment">/* mask from the creating client */</span></div><div class="line">    PixUnion		background;</div><div class="line">    PixUnion		border;</div><div class="line">    pointer		backStorage;	<span class="comment">/* null when BS disabled */</span></div><div class="line">    WindowOptPtr	optional;</div><div class="line">    <span class="keyword">unsigned</span>		backgroundState:<span class="number">2</span>; <span class="comment">/* None, Relative, Pixel, Pixmap */</span></div><div class="line">    <span class="keyword">unsigned</span>		borderIsPixel:<span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span>		cursorIsNone:<span class="number">1</span>;	<span class="comment">/* else real cursor (might inherit) */</span></div><div class="line">    <span class="keyword">unsigned</span>		backingStore:<span class="number">2</span>;</div><div class="line">    <span class="keyword">unsigned</span>		saveUnder:<span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span>		DIXsaveUnder:<span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span>		bitGravity:<span class="number">4</span>;</div><div class="line">    <span class="keyword">unsigned</span>		winGravity:<span class="number">4</span>;</div><div class="line">    <span class="keyword">unsigned</span>		overrideRedirect:<span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span>		visibility:<span class="number">2</span>;</div><div class="line">    <span class="keyword">unsigned</span>		mapped:<span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span>		realized:<span class="number">1</span>;	<span class="comment">/* ancestors are all mapped */</span></div><div class="line">    <span class="keyword">unsigned</span>		viewable:<span class="number">1</span>;	<span class="comment">/* realized && InputOutput */</span></div><div class="line">    <span class="keyword">unsigned</span>		dontPropagate:<span class="number">3</span>;<span class="comment">/* index into DontPropagateMasks */</span></div><div class="line">    <span class="keyword">unsigned</span>		forcedBS:<span class="number">1</span>;	<span class="comment">/* system-supplied backingStore */</span></div><div class="line">    <span class="keyword">unsigned</span>		redirectDraw:<span class="number">2</span>;	<span class="comment">/* COMPOSITE rendering redirect */</span></div><div class="line">    <span class="keyword">unsigned</span>		forcedBG:<span class="number">1</span>;	<span class="comment">/* must have an opaque background */</span></div><div class="line"><span class="preprocessor">#ifdef ROOTLESS</span></div><div class="line">    <span class="keyword">unsigned</span>		rootlessUnhittable:<span class="number">1</span>;	<span class="comment">/* doesn't hit-test */</span></div><div class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></div><div class="line">} WindowRec;</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个就有点类似 MiniGUI 里的 MainWnd 结构了，有剪切域、父子指针、私有结构、DC（Drawable）等这些东西。</p>
<ul>
<li><strong>Pixmap</strong></li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _Pixmap {</div><div class="line">    DrawableRec		drawable;</div><div class="line">    PrivateRec		*devPrivates;</div><div class="line">    <span class="keyword">int</span>			refcnt;</div><div class="line">    <span class="keyword">int</span>			devKind; <span class="comment">/* This is the pitch of the pixmap, typically width*bpp/8. */</span></div><div class="line">    DevUnion		devPrivate; <span class="comment">/* When !NULL, devPrivate.ptr points to the raw pixel data. */</span></div><div class="line"><span class="preprocessor">#ifdef COMPOSITE</span></div><div class="line">    <span class="keyword">short</span>		screen_x;</div><div class="line">    <span class="keyword">short</span>		screen_y;</div><div class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></div><div class="line">    <span class="keyword">unsigned</span>		usage_hint; <span class="comment">/* see CREATE_PIXMAP_USAGE_* */</span></div><div class="line">} PixmapRec;</div><div class="line"></div></pre></td></tr></table></figure>

<p>其实从 X server 的代码里看，X 中的 surface 都应该是 Pixmap 类型来的。就算是之前说的 Window 类型，它也会从它的结构里取出 Pixmap 变量来进行操作。看代码，估计 pixels 数据就在 devPrivates 这个指针指向的结构里面。不过这个类型的定义我还没看到在哪，不知道被藏到哪个地方去了。</p>
<ul>
<li><strong>Drawable</strong></li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _Drawable {</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>	type;	<span class="comment">/* DRAWABLE_&lt;type&gt; */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>	<span class="keyword">class</span>;	<span class="comment">/* specific to type */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>	depth;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>	bitsPerPixel;</div><div class="line">    XID			id;	<span class="comment">/* resource id */</span></div><div class="line">    <span class="keyword">short</span>		x;	<span class="comment">/* window: screen absolute, pixmap: 0 */</span></div><div class="line">    <span class="keyword">short</span>		y;	<span class="comment">/* window: screen absolute, pixmap: 0 */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>	width;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>	height;</div><div class="line">    ScreenPtr		pScreen;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>	serialNumber;</div><div class="line">} DrawableRec;</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="GLX_分析">GLX 分析</h2>
<p>GLX 是衔接 OpenGL 和 X11 的桥梁，OpenGL 是通过 GLX 来获取渲染的 Buffer 地址的。也许我们可以通过 GLX 来获取像素地址。</p>
<h3 id="GLX_基本数据结构">GLX 基本数据结构</h3>
<ul>
<li><strong>GLXContext</strong><br>这个是 GLX 的绘图上下文，类似 X11 的 GC，MiniGUI 的 DC。在 Mesa-7.9 里的定义是：</li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> __GLXcontextRec *GLXContext;</div><div class="line"><span class="keyword">typedef</span> XID GLXPixmap;</div><div class="line"><span class="keyword">typedef</span> XID GLXDrawable;</div><div class="line"><span class="comment">/* GLX 1.3 and later */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> __GLXFBConfigRec *GLXFBConfig;</div><div class="line"><span class="keyword">typedef</span> XID GLXFBConfigID;</div><div class="line"><span class="keyword">typedef</span> XID GLXContextID;</div><div class="line"><span class="keyword">typedef</span> XID GLXWindow;</div><div class="line"><span class="keyword">typedef</span> XID GLXPbuffer;</div><div class="line"></div><div class="line"><span class="comment">/* The GLX API dispatcher (i.e. this code) is being built into stand-alone</span></div><div class="line"><span class="comment"> * Mesa.  We don't know anything about XFree86 or real GLX so we define a</span></div><div class="line"><span class="comment"> * minimal __GLXContextRec here so some of the functions in this file can</span></div><div class="line"><span class="comment"> * work properly.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> __GLXcontextRec {</div><div class="line">   Display *currentDpy;</div><div class="line">   GLboolean isDirect;</div><div class="line">   GLXDrawable currentDrawable;</div><div class="line">   GLXDrawable currentReadable;</div><div class="line">   XID xid;</div><div class="line">} __GLXcontext;</div><div class="line"></div></pre></td></tr></table></figure>

<p>从注视可以看得到，这个其实并不是 HP mini 上 Meego 使用的 GLX 的定义，因为这个应该是和具体的硬件驱动有关的（drm-intel ？？），但是从上面也看得到这个 GLXContext 的最小结构是什么。包括有 X11 的显示设备指针 Display*、是否是直接渲染的标志（DRI）、当前的 Drawable （这个应该就是 surface）、最后一个是一个 ID 号。</p>
<ul>
<li><p><strong>GLXDrawable</strong><br>这个的定义也在上面，基本上就是等同于 X11 的 Drawable，并且在 OpenGL 的官方文档中也是这么直接了当的说的（官方的 glx 1.3 说明文档在附件中）。它也是可以指向 GLXWindow 或是 GLXPixmap。</p>
</li>
<li><p><strong>GLXWindow</strong><br>上面已经说的很清楚了，等于 X11 的 Window。</p>
</li>
<li><p><strong>GLXPixmap</strong><br>上面也说清楚了，等于 X11 的 Pixmap。</p>
</li>
</ul>
<h3 id="GLX_线索">GLX 线索</h3>
<p>从这里看来从 GLX 的核心数据结构里也无法直接拿到像素地址。最后还是走到 X11 那里去了。不过也许可以通过 GLX 访问 DRI 的一些接口，从而拿到物理的显存地址。不过这个我还没研究过。</p>
<h2 id="SDL_分析">SDL 分析</h2>
<p>SDL 是之前用于 vfb 的一个图形库，它比较简单，接近底层，应该是会有可能从它这里拿到像素地址，并且它已经把 OpenGL 封装好了。</p>
<h3 id="SDL_基本数据结构">SDL 基本数据结构</h3>
<ul>
<li><strong>SDL_Surface</strong></li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> SDL_Surface {</div><div class="line">	Uint32 flags;				<span class="comment">/**&lt; Read-only */</span></div><div class="line">	SDL_PixelFormat *format;		<span class="comment">/**&lt; Read-only */</span></div><div class="line">	<span class="keyword">int</span> w, h;				<span class="comment">/**&lt; Read-only */</span></div><div class="line">	Uint16 pitch;				<span class="comment">/**&lt; Read-only */</span></div><div class="line">	<span class="keyword">void</span> *pixels;				<span class="comment">/**&lt; Read-write */</span></div><div class="line">	<span class="keyword">int</span> offset;				<span class="comment">/**&lt; Private */</span></div><div class="line"></div><div class="line">	<span class="comment">/** Hardware-specific surface info */</span></div><div class="line">	<span class="keyword">struct</span> private_hwdata *hwdata;</div><div class="line"></div><div class="line">	<span class="comment">/** clipping information */</span></div><div class="line">	SDL_Rect clip_rect;			<span class="comment">/**&lt; Read-only */</span></div><div class="line">	Uint32 unused1;				<span class="comment">/**&lt; for binary compatibility */</span></div><div class="line"></div><div class="line">	<span class="comment">/** Allow recursive locks */</span></div><div class="line">	Uint32 locked;				<span class="comment">/**&lt; Private */</span></div><div class="line"></div><div class="line">	<span class="comment">/** info for fast blit mapping to other surfaces */</span></div><div class="line">	<span class="keyword">struct</span> SDL_BlitMap *<span class="built_in">map</span>;		<span class="comment">/**&lt; Private */</span></div><div class="line"></div><div class="line">	<span class="comment">/** format version, bumped at every change to invalidate blit maps */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> format_version;		<span class="comment">/**&lt; Private */</span></div><div class="line"></div><div class="line">	<span class="comment">/** Reference count -- used when freeing surface */</span></div><div class="line">	<span class="keyword">int</span> refcount;				<span class="comment">/**&lt; Read-mostly */</span></div><div class="line">} SDL_Surface;</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个是很直接的一个数据的结构，和 MiniGUI 的 Surface 很像（好像 MiniGUI 也借鉴了 SDL 的一些东西）。其中的 pixels 确实就是像素地址。但是不同的 video （MiniGUI 的 gal 概念），这个值的含义确实不一样的。在 X11 的 video 中这个地址不是直接的窗口的像素地址。而是一个 SDL 自己创建的基于 Display 的一个共享 XImage 对象的内存的地址。SDL 自己创建这个 XImage，然后 SDL 所有的绘制接口都在这个 XImage 上进行，最后在 SDL_UpdateRect 的时候再讲这个共享的 XImage 送到 X11 上，然后屏幕上才会显示更新的。我曾经试过了直接写这个地址，屏幕是不会变化的，必须要调用 SDL_UpdateRect 后，屏幕才会有变化。而且 SDL 的代码里就是这样写的，可以自己去看：在 /src/video/x11/SDL_x11image.c 里。而且这还是要 SDL 能够创建硬件的 surface 才行，要是颜色格式不对，导致 SDL 使用软件 surface 的话，那就完全软件来实现这些画图工作了。并且还有一点，这还不能开启 SDL 的 OpenGL 窗口，如果开启了 OpenGL 窗口的话，这个 surface 就基本没啥用了（这个时候 surface 里的一些相关数据基本上全是0），都必须要用 OpenGL 的接口才能画得出东西来了。如果你想继续画 2D 的东西的话，按照 SDL 官网的建议，要自己创建一个软件的 SDL_Surface ，画好后，把它转化成 OpenGL texture，然后贴到 OpenGL 的模型上。X11 video 的私有结构数据里包括了一些 X11 显示相关的变量：Display、Window 等，代码就不贴了，在 src/video/SDL_x11video.h 里。X11 video 的 gl 私有数据则包括了 GLX 绘图上下文：GLXContext 等，同样不贴代码了，在 src/video/SDL_x11gl_c.h 里。</p>
<h3 id="SDL_线索">SDL 线索</h3>
<p>从上面可以看得出 2D 的 SDL 的话，要获取窗口的像素地址，还是需要走 X11 的路线。而 OpenGL 的 SDL，则需要走 GLX 的路线。看样子从这里得不到什么好处呢。</p>
<h2 id="Mutter（Clutter）分析">Mutter（Clutter）分析</h2>
<p>做为窗口管理系统，它会负责处理当多个窗口重叠在一起时如果混合显示。现在某些桌面开启了某些特效之后，一些窗口会透过底下的窗口显示。因为有些功能，Mutter 这也许可以拿得到窗口的 surface 像素地址。</p>
<h3 id="Clutter_绘制流程">Clutter 绘制流程</h3>
<p>和上面的分析不一样，先介绍下 Mutter（Clutter）的绘制流程（我是跟踪 Mutter 显示一个窗口的流程的）。现在是在 Mutter 这边：</p>
<ol>
<li>在 Mutter 中显示窗口的 API 是 meta_compositor_show_window ，这个函数里会调用 meta_compositor_show_window 。</li>
<li>meta_compositor_show_window 最后回调用 Clutter 的 clutter_actor_show_all 。</li>
</ol>
<p>现在是到 Clutter 这边来了，先说 Clutter 中的一些基本概念。在 Clutter 中有一个叫 Stage 的东西，这个类似 Window 的概念；然后还有一个叫 Actor 的东西，这个类似于 Window 里面的控件、widget 之类的。所有的 Actor 都在 Stage 中，然后各自负责自己的东西（绘制、移动等等），然后在 Stage 上展示出来。从概念上来说将 GUI 类比成演员在舞台上表演、然后开发人员是导演，指挥这些演员演出，感觉还是挺形象的。Clutter 也是采用 backend 的设计来实现跨平台的，在 linux 上的 backend 是 GLX 和 X11 （代码里是只有 GLX 这个 backend 的，但是 GLX 继承自 X11）。</p>
<ol>
<li>clutter_actor_show_all 会调用 ClutterActorClass 的 show_all 函数指针，这个在 ClutterActorClass 类初始化的时候（之前说了 Clutter 是采用 gobject 的东西来设计的）是指向 clutter_actor_show 的。</li>
<li>clutter_actor_show 会调用 clutter_actor_queue_redraw 。</li>
<li>clutter_actor_queue_redraw 会调用 clutter_actor_queue_redraw_with_origin。</li>
<li>clutter_queue_redraw_with_origin 里会发射一个 gtk 的信号，看注释说默认的处理函数是 clutter_redraw。</li>
<li>clutter_redraw 会将一个重绘的标志置为 TRUE，然后开启一个时钟（定时器？？）。</li>
<li>在时钟的回调函数里会调用 _clutter_stage_do_update。</li>
<li>_clutter_stage_do_update 会调用 _clutter_do_redraw。</li>
<li>_clutter_do_redraw 会调用 _clutter_bakcend_redraw。</li>
<li>_clutter_backend_redraw 会调用当前 backend 的 redraw，这里是 clutter_backend_glx_redraw 。</li>
<li>clutter_backend_glx_redraw 会调用 clutter_stage_glx_redraw 。</li>
<li>在 clutter_stage_glx_redraw 会调用 clutter_actor_paint 让 actor 重画（这个函数好像是让 actor 真正的渲染到 display 上，这个 display 应该是 X11 里的那个 display 结构）。然后会根据当前是否支持 copy_sub_buffer 这个操作（这个是根据是否能取得到 glXCopySubBufferMESA 这个函数的实现来决定的），如果支持则调用 copy_sub_buffer，如果不支持则调用 glXSwapBuffers。最后的这个操作感觉像是将渲染好的 buffer 输出到最后的屏幕上显示。Clutter 也不是直接操作屏幕的么？？这个目前还没搞清楚。</li>
</ol>
<p>到这里绘制流程就走得差不多了，这里可以看得到最后还是通过各个 backend 来进行绘制的，和 SDL 差不多。GLX 的 backend 会调用 Cogl 的 API 进行一些渲染（好像不光是 3D 的）。这里 GLX backend 感觉是带 OpenGL 支持的，X11 则是普通的 2D 的。因为从代码里可以看到 Clutter 专门区分了2个窗口：一个是 glxwin，一个是 xwin。</p>
<h3 id="Clutter_基本数据结构">Clutter 基本数据结构</h3>
<p>我们来看看 Clutter backend 的基本数据结构吧：</p>
<ul>
<li><strong>ClutterBackendGLX、ClutterBackendX11</strong></li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> _ClutterBackendGLX</div><div class="line">{</div><div class="line">  ClutterBackendX11 parent_instance;</div><div class="line"></div><div class="line">  <span class="keyword">int</span>                    error_base;</div><div class="line">  <span class="keyword">int</span>                    event_base;</div><div class="line"></div><div class="line">  <span class="comment">/* Single context for all wins */</span></div><div class="line">  gboolean               found_fbconfig;</div><div class="line">  GLXFBConfig            fbconfig;</div><div class="line">  GLXContext             gl_context;</div><div class="line">  Window                 dummy_xwin;</div><div class="line">  GLXWindow              dummy_glxwin;</div><div class="line"></div><div class="line">  <span class="comment">/* Vblank stuff */</span></div><div class="line">  GetVideoSyncProc       get_video_sync;</div><div class="line">  WaitVideoSyncProc      wait_video_sync;</div><div class="line">  SwapIntervalProc       swap_interval;</div><div class="line">  gint                   dri_fd;</div><div class="line">  ClutterGLXVBlankType   vblank_type;</div><div class="line"></div><div class="line">  CopySubBufferProc      copy_sub_buffer;</div><div class="line"></div><div class="line">  <span class="comment">/* props */</span></div><div class="line">  Atom atom_WM_STATE;</div><div class="line">  Atom atom_WM_STATE_FULLSCREEN;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct</span> _ClutterBackendX11</div><div class="line">{</div><div class="line">  ClutterBackend parent_instance;</div><div class="line"></div><div class="line">  Display *xdpy;</div><div class="line">  Window   xwin_root;</div><div class="line">  Screen  *xscreen;</div><div class="line">  <span class="keyword">int</span>      xscreen_num;</div><div class="line">  gchar   *display_name;</div><div class="line"></div><div class="line">  <span class="comment">/* event source */</span></div><div class="line">  GSource *event_source;</div><div class="line">  GSList  *event_filters;</div><div class="line"></div><div class="line">  <span class="comment">/* props */</span></div><div class="line">  Atom atom_NET_WM_PID;</div><div class="line">  Atom atom_NET_WM_PING;</div><div class="line">  Atom atom_NET_WM_STATE;</div><div class="line">  Atom atom_NET_WM_STATE_FULLSCREEN;</div><div class="line">  Atom atom_NET_WM_USER_TIME;</div><div class="line">  Atom atom_WM_PROTOCOLS;</div><div class="line">  Atom atom_WM_DELETE_WINDOW;</div><div class="line">  Atom atom_XEMBED;</div><div class="line">  Atom atom_XEMBED_INFO;</div><div class="line">  Atom atom_NET_WM_NAME;</div><div class="line">  Atom atom_UTF8_STRING;</div><div class="line"></div><div class="line">  <span class="keyword">int</span> xi_event_base;</div><div class="line">  <span class="keyword">int</span> event_types[CLUTTER_X11_XINPUT_LAST_EVENT];</div><div class="line">  gboolean have_xinput;</div><div class="line"></div><div class="line">  Time last_event_time;</div><div class="line"></div><div class="line">  ClutterDeviceManager *device_manager;</div><div class="line">};</div><div class="line"></div></pre></td></tr></table></figure>

<p>X11 里的是 X11 显示的一些基本变量：Display、Window、Screen 等；而 GLX 的则是 GLX 里的基本东西：GLXContext、GLXWindow 等。</p>
<ul>
<li><strong>ClutterStageGLX、ClutterStageX11</strong></li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> _ClutterStageGLX</div><div class="line">{</div><div class="line">  ClutterStageX11 parent_instance;</div><div class="line"></div><div class="line">  <span class="keyword">int</span> pending_swaps;</div><div class="line"></div><div class="line">  GLXPixmap glxpixmap;</div><div class="line">  GLXWindow glxwin;</div><div class="line"></div><div class="line">  gboolean initialized_redraw_clip;</div><div class="line">  ClutterGeometry bounding_redraw_clip;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct</span> _ClutterStageX11</div><div class="line">{</div><div class="line">  ClutterGroup parent_instance;</div><div class="line"></div><div class="line">  guint        is_foreign_xwin      : <span class="number">1</span>;</div><div class="line">  guint        fullscreening        : <span class="number">1</span>;</div><div class="line">  guint        is_cursor_visible    : <span class="number">1</span>;</div><div class="line">  guint        viewport_initialized : <span class="number">1</span>;</div><div class="line"></div><div class="line">  Window       xwin;</div><div class="line">  gint         xwin_width;</div><div class="line">  gint         xwin_height; <span class="comment">/* FIXME target_width / height */</span></div><div class="line">  gchar       *title;</div><div class="line"></div><div class="line">  ClutterStageState  state;</div><div class="line"></div><div class="line">  ClutterStageX11State wm_state;</div><div class="line"></div><div class="line">  <span class="keyword">int</span> event_types[CLUTTER_X11_XINPUT_LAST_EVENT];</div><div class="line">  GList *devices;</div><div class="line"></div><div class="line">  ClutterStage *wrapper;</div><div class="line">};</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里也是和上面的差不多的，至于是不是和上面的是重复的，我还没仔细看。</p>
<h3 id="Clutter_线索">Clutter 线索</h3>
<p>这里也和 SDL 差不多了，最后都是 X11 底层的东西来完成绘制的。不过这里用的是 GLX 的接口（ GLX 也算是用 X11 的了吧）。不过根据这里的线索到 Mesa 的 GLX 去看看，好像能看到像 glXCopySubBufferMESA 这个函数的实现，应该是 src/glx/glxcmds.c 里的 __glXCopySubBufferMESA 吧，这个函数好像类似硬件的 blit 的感觉。这个函数里如果是走 DRI 的话，就直接调用 DRI 的回调函数；如果不是 DRI 的话，就只能通过向 X 服务器发请求的方式来实现。这个也许就是之前说的 GLX 中的线索吧。</p>
<h2 id="Cogl_分析">Cogl 分析</h2>
<p>这个目前还没什么仔细看。</p>
<h2 id="总结">总结</h2>
<p>从上面的讨论看到，如果抛开 OpenGL 的支持不管的话，就光要 Android 能直接画东西到 X11 的屏幕上，估计还是得要通过 Xlib 的接口，自己向 X 服务器发送一些申请，然后计算出像素地址。</p>
<h2 id="附件">附件</h2>
<p><a href="http://s.yunio.com/7xUt2x" title="GLX 1.3 官方说明文档" target="_blank" rel="external">GLX 1.3 官方说明文档</a><br><a href="http://s.yunio.com/AYxGTn" title="Xlib编程指南" target="_blank" rel="external">Xlib编程指南</a><br><a href="http://s.yunio.com/1LPFWz" title="x11_sample" target="_blank" rel="external">x11_sample</a></p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/android/">android</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-Framework/">Android Framework</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.light3moon.com/2015/01/27/Android x86 在 X window system 上的调研/" data-title="Android x86 在 X window system 上的调研 | Light.Moon" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/01/27/Android Root Recovery 学习笔记/" title="Android Root Recovery 学习笔记">
  <strong>上一篇:</strong><br/>
  <span>
  Android Root Recovery 学习笔记</span>
</a>
</div>


<div class="next">
<a href="/2015/01/27/开启 Android SDK 所有的 API 的方法/"  title="开启 Android SDK 所有的 API 的方法">
 <strong>下一篇:</strong><br/> 
 <span>开启 Android SDK 所有的 API 的方法
</span>
</a>
</div>

</nav>


	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#需求"><span class="toc-number">1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相关名词"><span class="toc-number">2.</span> <span class="toc-text">相关名词</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现思路"><span class="toc-number">3.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Xlib_分析"><span class="toc-number">4.</span> <span class="toc-text">Xlib 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Xlib_基本数据结构"><span class="toc-number">4.1.</span> <span class="toc-text">Xlib 基本数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本使用流程"><span class="toc-number">4.2.</span> <span class="toc-text">基本使用流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Xlib_线索"><span class="toc-number">4.3.</span> <span class="toc-text">Xlib 线索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#X_server_分析"><span class="toc-number">5.</span> <span class="toc-text">X server 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#X_server_基本数据结构"><span class="toc-number">5.1.</span> <span class="toc-text">X server 基本数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GLX_分析"><span class="toc-number">6.</span> <span class="toc-text">GLX 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GLX_基本数据结构"><span class="toc-number">6.1.</span> <span class="toc-text">GLX 基本数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GLX_线索"><span class="toc-number">6.2.</span> <span class="toc-text">GLX 线索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SDL_分析"><span class="toc-number">7.</span> <span class="toc-text">SDL 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SDL_基本数据结构"><span class="toc-number">7.1.</span> <span class="toc-text">SDL 基本数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SDL_线索"><span class="toc-number">7.2.</span> <span class="toc-text">SDL 线索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mutter（Clutter）分析"><span class="toc-number">8.</span> <span class="toc-text">Mutter（Clutter）分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Clutter_绘制流程"><span class="toc-number">8.1.</span> <span class="toc-text">Clutter 绘制流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Clutter_基本数据结构"><span class="toc-number">8.2.</span> <span class="toc-text">Clutter 基本数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Clutter_线索"><span class="toc-number">8.3.</span> <span class="toc-text">Clutter 线索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cogl_分析"><span class="toc-number">9.</span> <span class="toc-text">Cogl 分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附件"><span class="toc-number">11.</span> <span class="toc-text">附件</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android-Development/" title="Android Development">Android Development<sup>32</sup></a></li>
		
			<li><a href="/categories/Android-Framework/" title="Android Framework">Android Framework<sup>49</sup></a></li>
		
			<li><a href="/categories/Basics-Knowledge/" title="Basics Knowledge">Basics Knowledge<sup>11</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>24</sup></a></li>
		
			<li><a href="/categories/MiniGUI/" title="MiniGUI">MiniGUI<sup>12</sup></a></li>
		
			<li><a href="/categories/Other/" title="Other">Other<sup>9</sup></a></li>
		
			<li><a href="/categories/Performance/" title="Performance">Performance<sup>4</sup></a></li>
		
			<li><a href="/categories/VR/" title="VR">VR<sup>2</sup></a></li>
		
			<li><a href="/categories/Window/" title="Window">Window<sup>10</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/android/" title="android">android<sup>85</sup></a></li>
		
			<li><a href="/tags/basics/" title="basics">basics<sup>11</sup></a></li>
		
			<li><a href="/tags/install/" title="install">install<sup>9</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>28</sup></a></li>
		
			<li><a href="/tags/minigui/" title="minigui">minigui<sup>13</sup></a></li>
		
			<li><a href="/tags/opengl/" title="opengl">opengl<sup>5</sup></a></li>
		
			<li><a href="/tags/other/" title="other">other<sup>5</sup></a></li>
		
			<li><a href="/tags/server/" title="server">server<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>5</sup></a></li>
		
			<li><a href="/tags/vr/" title="vr">vr<sup>4</sup></a></li>
		
			<li><a href="/tags/window/" title="window">window<sup>11</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">我的链接</p>
    <ul>
      <li><i class="fa fa-github"></i> <a href="https://github.com/mingming-killer" target="_blank">GitHub</a></li>
      
        
          <li><i class="fa fa-analytics"></i> <a href="http://tongji.baidu.com/web/welcome/ico?s=fa045dbd45ffce238b146e00f91ba6a3" target="_blank">网站数据统计</a></li>
        
      
      <li><i class="fa fa-markdown-help"></i> <a href="http://zh.wikipedia.org/wiki/Markdown" target="_blank">Makrdown</a></li>
    </ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <li><i class="fa fa-book"></i> <a href="http://taoyuanxiaoqi.com" target="_blank">桃园小七的博客</a></li>
      <li><i class="fa fa-book"></i> <a href="https://dongka.github.io" target="_blank">Dongka的博客</a></li>
    </ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
<!--
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
-->

     <!-- this is defined in footer.styl, line holder -->
	<div class="line">
	</div>
     
<!--
	<div class="social-font clearfix">
		
		
		
		
		
		<a href="https://github.com/mingming-killer" target="_blank" title="github"></a>
		
        	         
	</div>
-->

		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/mingming-killer/Lightmoon" target="_blank" title="Lightmoon">Lightmoon</a> © 2021 
		
		<a href="http://www.light3moon.com" target="_blank" title="Mingming">Mingming</a>
		
		</p>

  <!-- baidu search verification -->
  
    <meta name="baidu-site-verification" content="w1BSX6yZ9k" />
  

  <!-- swiftype search verification -->
  

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fa045dbd45ffce238b146e00f91ba6a3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>
