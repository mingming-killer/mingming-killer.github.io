
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

  
    <title>工作小笔记——Android 动态切换系统字体 | Light.Moon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Mingming">
    
    <meta name="description" content="最近在调研一个东西，就是动态切换 android 的系统字体。我的手机是三棒的 Galaxy SIII，系统设置中自带的了这个功能：

既然别人都弄出来了，应该是可行的。于是开始琢磨（这里事先申明下，以下是基于 4.1.2 的源码的）。
初步了解
经过几番百度， Typeface（framework">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/apple_icon.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/apple_icon.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
		<div id="header_author">
		</div>
		

         <!--
         
           <div id="imglogo">
           <a href="/"><img src="/img/logo.svg" alt="Light.Moon" title="Light.Moon"/></a>
           </div>
         
         -->

			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Light.Moon">Light.Moon</a></h1>
				<h2 class="blog-motto">〜(￣△￣〜) 三月学长的根据地 (〜￣△￣)〜</h2>
			</div>

			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/1986/12/20/文章索引">索引</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					

                      <form class="search" action=http://search.light3moon.com/cse/search target="_blank">
                      <label>搜索</label>
                      <!--
                      <input name="s" type="hidden" value="undefined">
                      -->
                      <input name="s" type="hidden" value="12628367885198549364">
                      <input type="text" name="q" size="30" placeholder="搜索"> <br>

                      
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/01/31/工作小笔记——Android 动态切换系统字体/" title="工作小笔记——Android 动态切换系统字体" itemprop="url">工作小笔记——Android 动态切换系统字体</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.light3moon.com" title="Mingming">Mingming</a>
    </p>
  <p class="article-time">
    <time datetime="2015-01-31T02:19:16.000Z" itemprop="datePublished">2015 1月 31</time>
    更新日期:<time datetime="2015-01-31T02:19:16.000Z" itemprop="dateModified">2015 1月 31</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#初步了解"><span class="toc-number">1.</span> <span class="toc-text">初步了解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本思路"><span class="toc-number">2.</span> <span class="toc-text">基本思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-替换默认字体"><span class="toc-number">3.</span> <span class="toc-text">1.替换默认字体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-_更新应用"><span class="toc-number">4.</span> <span class="toc-text">2. 更新应用</span></a></li></ol>
		</div>
		
		<p>最近在调研一个东西，就是动态切换 android 的系统字体。我的手机是三棒的 Galaxy SIII，系统设置中自带的了这个功能：</p>
<p><img src="http://7u2hy4.com1.z0.glb.clouddn.com/android/Worknote-switch-sysfont/1.jpeg" alt=""></p>
<p>既然别人都弄出来了，应该是可行的。于是开始琢磨（这里事先申明下，以下是基于 4.1.2 的源码的）。</p>
<h2 id="初步了解">初步了解</h2>
<p>经过几番百度， Typeface（frameworks/base/graphics/java/android/graphics/Typeface.java） 这个类。这个类有好几个 public static final 的变量:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* The default NORMAL typeface object */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Typeface DEFAULT;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * The default BOLD typeface object. Note: this may be not actually be</span></div><div class="line"><span class="comment"> * bold, depending on what fonts are installed. Call getStyle() to know</span></div><div class="line"><span class="comment"> * for sure.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Typeface DEFAULT_BOLD;</div><div class="line"><span class="comment">/* The NORMAL style of the default sans serif typeface. */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Typeface SANS_SERIF;</div><div class="line"><span class="comment">/* The NORMAL style of the default serif typeface. */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Typeface SERIF;</div><div class="line"><span class="comment">/* The NORMAL style of the default monospace typeface. */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Typeface MONOSPACE;</div><div class="line"></div></pre></td></tr></table></figure>

<ul>
<li><p><strong>DEFAULT</strong><br>默认字体。</p>
</li>
<li><p><strong>DEFAULT_BOLD</strong><br>默认的粗体字体，不过这个不一定是粗体，和就用的字体有关，如果你用的字体不是粗体，这个就不是粗体。</p>
</li>
<li><p><strong>SANS_SERIF</strong><br>正常样式的无衬线字体。</p>
</li>
<li><p><strong>SERIF</strong><br>正常样式的衬线字体。</p>
</li>
<li><p><strong>MONOSPACE</strong><br>正常样式的等宽字体。</p>
</li>
</ul>
<p>至于什么是衬线字、无衬线字、等宽字百度吧。然后还有4种样式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Style</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NORMAL = <span class="number">0</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BOLD = <span class="number">1</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ITALIC = <span class="number">2</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BOLD_ITALIC = <span class="number">3</span>;</div><div class="line"></div></pre></td></tr></table></figure>

<p>分别是正常、粗体、斜体、粗斜体。默认系统里面是有9个字体文件的：</p>
<p><img src="http://7u2hy4.com1.z0.glb.clouddn.com/android/Worknote-switch-sysfont/2.jpeg" alt=""></p>
<p>那个 Fallback 是备用字体。Droid Sans Fallback 包含了东亚字符。当需要显示的字符在 Droid Sans 字体中不存在（如汉字），即没有对应编码的字符时，系统会到 Droid Sans Fallback 中去寻找相应编码的字符，如果找到，则使用 Droid Sans Fallback 字体来显示它，如果仍然找不到该编码对应的字符，则系统无法在屏幕上显示出这个字符。</p>
<p>所以要动态字体能够比较好的适应系统，虽然不一定要覆盖全这9种字体文件，但是至少要有4种会比较好，例如 <code>sans_serif</code> 的 Regular, Bold, Italic, BoldItalic 。这里只是简单的研究下，所以只去找个几个别的字体的 Regular 的。</p>
<p>然后，这些 static 变量都是 static 初始化的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> {</div><div class="line">    DEFAULT         = create((String) null, <span class="number">0</span>);</div><div class="line">    DEFAULT_BOLD    = create((String) null, Typeface.BOLD);</div><div class="line">    SANS_SERIF      = create(<span class="string">"sans-serif"</span>, <span class="number">0</span>);</div><div class="line">    SERIF           = create(<span class="string">"serif"</span>, <span class="number">0</span>);</div><div class="line">    MONOSPACE       = create(<span class="string">"monospace"</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    sDefaults = <span class="keyword">new</span> Typeface[] {</div><div class="line">        DEFAULT,</div><div class="line">        DEFAULT_BOLD,</div><div class="line">        create((String) null, Typeface.ITALIC),</div><div class="line">        create((String) null, Typeface.BOLD_ITALIC),</div><div class="line">    };</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个 create 是通过 jni 去调用 skia 的接口创建 SkTypeface 的。而创建相应的 SkTypeface 是根据系统加载的默认字体来决定的。系统的默认字体文件在 /system/fonts 下，配置也是在这个下面，是 <code>system_fonts.xml</code> 和 <code>fallback_fonts.xml</code> 。</p>
<p>而加载默认字体的代码在：<br><code>external/skia/src/ports/SkFontHost_android.cpp</code> 里面：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> loadSystemFontsLocked() {</div><div class="line"><span class="preprocessor">#<span class="keyword">if</span> !defined(SK_BUILD_FOR_ANDROID_NDK)</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> prevLanguage[<span class="number">3</span>];</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> prevRegion[<span class="number">3</span>];</div><div class="line">    <span class="keyword">char</span> language[<span class="number">3</span>] = <span class="string">""</span>; </div><div class="line">    <span class="keyword">char</span> region[<span class="number">3</span>] = <span class="string">""</span>; </div><div class="line"></div><div class="line">    getLocale(language, region);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!gDefaultNormal) {</div><div class="line">        <span class="built_in">strncpy</span>(prevLanguage, language, <span class="number">2</span>); </div><div class="line">        <span class="built_in">strncpy</span>(prevRegion, region, <span class="number">2</span>); </div><div class="line">        initSystemFontsLocked();</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(language, prevLanguage, <span class="number">2</span>) || <span class="built_in">strncmp</span>(region, prevRegion, <span class="number">2</span>)) {</div><div class="line">        <span class="built_in">strncpy</span>(prevLanguage, language, <span class="number">2</span>); </div><div class="line">        <span class="built_in">strncpy</span>(prevRegion, region, <span class="number">2</span>); </div><div class="line">        reloadFallbackFontsLocked();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#<span class="keyword">else</span></span></div><div class="line">    <span class="keyword">if</span> (!gDefaultNormal) {</div><div class="line">        initSystemFontsLocked();</div><div class="line">        reloadFallbackFontsLocked();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里流程我没太仔细研究，因为是初步调研，最关键的是后面没下文了，所以没啥动力了。然后去解析前面那2个 xml 里面的内容，然后加载字体文件。然后上层 java 层的 Typeface 预先创建了几个默认的字形对象（Typeface）。然后应用可以直接引用这几个 static 的变量，也可以通过这几个变量创建出不同的样式（系统默认没创建完所有样式的 Typeface 变量，而且系统也没提供完所有 Typeface 的样式的字体文件，自己数数看，默认、衬线、无衬线、等宽4种类型，每种4种样式，默认字体才9个，还有一个是时钟专用的，就是才8个而已）。</p>
<h2 id="基本思路">基本思路</h2>
<p>有个初步了解后，那么基本思路就出来了。就是在 framework 里面弄一个界面（三棒的是在 Settings 里面的），读取特定路径下的可变化字体。然后替换默认字体，最后让应用更新一下就行了。基本思路虽然简单，其实实践起来有不少问题的。下面慢慢来说。</p>
<h2 id="1-替换默认字体">1.替换默认字体</h2>
<p>这点其实挺麻烦，因为系统使用的字体很多。要想完全换完，你得提供配套的可换的字体。这里你自己就得设计一下一套字体的规范了，例如必须要包含 Regular，其它的可选。然后那几种类型必须要有一个。然后这样肯定 ttf 文件不止一个，那么可以认为规定下 ttf 命名规范： <code>字体-类型.ttf</code> 。例如说： <code>Chococooky-Regular.ttf</code> 然后 UI 选择界面那里就只用出现一个名字： Chococooky 就代表了这一整套字体。然后自己把数据结构设计好，扫描的时候把 Chococooky 开头的都算上，然后根据后面的后缀判断这是什么类型、样式的。</p>
<p>这里可以规定一个目录，可以在 data 分区，专门放自定义可更换的字体。放 data 分区也方便以后在线更新。或者现在很多是把字体打包到 apk 里面了，这也好办，选中某个字体 apk 的时候，把里面的 ttf 复制到 data 分区就好了。不要不复制出 apk ，因为改系统字体，开机要加载的，如果单纯放 apk 里，不太稳定，还是复制到 data 分区的某一个目录比较靠谱。</p>
<p>然后正确的做法，应该是选中了之后，应该根据这套字体 ttf 文件的数量（种类、样式），生成类似 <code>system_fonts</code> 类似的文件，也放到 data 分区这个目录下，然后可以在 SystemProperties 增加一条属性，来记得当前使用的字体情况。这个就可以自由发挥了，例如说：</p>
<pre config="brush:bash;toolbar:false;">
SystemProperties.get("persist.sys.customfont", "default");
</pre>

<p>例如取得是 “default” 就去解析默认的 <code>system_fonts.xml</code> ，如果取得是 “custom” 的去解析 data 分区下那个 <code>system_fonts.xml</code> 。然后加载指定的字体。</p>
<p>当然这个得改 skia 里面那个 SkFontHost_android.cpp 里面那几加载字体相关的函数。我前面说了，我这个是粗略的研究，就懒得改 skia ，于是我暂时是把 java 层 Typeface 那几个 static 变量给改了（改 skia，也要做这一步的）。把他们的 final 属性去掉了，然后增加一些处理，例如根据 SystemProperties 直接去 data 分区加载自定义的 ttf 字体。</p>
<p>我这里做简单测试，就一种字体就只放了 Regular 的，然后扫描，就只认一个 ttf。然后贴下我改的代码，简单粗暴，当然这样换，肯定是换不全的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ===========================================</span></div><div class="line"><span class="comment">// add by hmm@dw.gdbbk.com</span></div><div class="line"><span class="comment">// change system default api</span></div><div class="line"><span class="comment">// ===========================================</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> Typeface DEFAULT_INTERNAL;</div><div class="line"><span class="keyword">static</span> Typeface DEFAULT_BOLD_INTERNAL;</div><div class="line"><span class="keyword">static</span> Typeface SANS_SERIF_INTERNAL;</div><div class="line"><span class="keyword">static</span> Typeface SERIF_INTERNAL;</div><div class="line"><span class="keyword">static</span> Typeface MONOSPACE_INTERNAL;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateDefaultFont</span>() {</div><div class="line">    <span class="comment">// change default font.</span></div><div class="line">    setCustomFont();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> setCustomFont() {</div><div class="line">    <span class="keyword">boolean</span> useDefault = <span class="keyword">false</span>;    </div><div class="line">    Typeface font = <span class="keyword">null</span>; </div><div class="line">    String fontPath = SystemProperties.get(<span class="string">"persist.sys.customfont"</span>, <span class="string">"default"</span>);</div><div class="line">    <span class="keyword">if</span> (<span class="string">"default"</span>.equals(fontPath)) { </div><div class="line">        Slog.i(TAG, <span class="string">"use the default system font !!"</span>);</div><div class="line">        font = DEFAULT_INTERNAL;       </div><div class="line">        useDefault = <span class="keyword">true</span>;</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            font = createFromFile(fontPath);</div><div class="line">        } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            e.printStackTrace() ;</div><div class="line">            Slog.e(TAG, <span class="string">"load custom font: "</span> + fontPath + <span class="string">" failed !!"</span>);</div><div class="line">            font = <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != font) {</div><div class="line">        Slog.i(<span class="string">"test"</span>, <span class="string">"system: use the custom font: "</span> + fontPath + <span class="string">" as system font. old-default="</span> + DEFAULT + <span class="string">", new="</span> + font);</div><div class="line">        DEFAULT = font;</div><div class="line">        <span class="keyword">if</span> (useDefault) {</div><div class="line">            DEFAULT_BOLD = DEFAULT_BOLD_INTERNAL;</div><div class="line">            SANS_SERIF = SANS_SERIF_INTERNAL;</div><div class="line">            SERIF = SERIF_INTERNAL;</div><div class="line">            MONOSPACE = MONOSPACE_INTERNAL;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            DEFAULT_BOLD = font;</div><div class="line">            SANS_SERIF = font;</div><div class="line">            SERIF = font;</div><div class="line">            MONOSPACE = font;</div><div class="line">        }</div><div class="line"></div><div class="line">        sDefaults[<span class="number">0</span>] = DEFAULT;</div><div class="line">        sDefaults[<span class="number">1</span>] = DEFAULT_BOLD;</div><div class="line">        sDefaults[<span class="number">2</span>] = DEFAULT;</div><div class="line">        sDefaults[<span class="number">3</span>] = DEFAULT;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> {</div><div class="line">    <span class="comment">//DEFAULT         = create((String) null, 0);</span></div><div class="line">    <span class="comment">//DEFAULT_BOLD    = create((String) null, Typeface.BOLD);</span></div><div class="line">    <span class="comment">//SANS_SERIF      = create("sans-serif", 0);</span></div><div class="line">    <span class="comment">//SERIF           = create("serif", 0);</span></div><div class="line">    <span class="comment">//MONOSPACE       = create("monospace", 0);</span></div><div class="line"></div><div class="line">    DEFAULT = DEFAULT_INTERNAL = create((String) <span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line">    DEFAULT_BOLD = DEFAULT_BOLD_INTERNAL  = create((String) <span class="keyword">null</span>, Typeface.BOLD);</div><div class="line">    SANS_SERIF = SANS_SERIF_INTERNAL = create(<span class="string">"sans-serif"</span>, <span class="number">0</span>);</div><div class="line">    SERIF = SERIF_INTERNAL = create(<span class="string">"serif"</span>, <span class="number">0</span>);</div><div class="line">    MONOSPACE = MONOSPACE_INTERNAL = create(<span class="string">"monospace"</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    sDefaults = <span class="keyword">new</span> Typeface[] {</div><div class="line">        DEFAULT,</div><div class="line">        DEFAULT_BOLD,</div><div class="line">        create((String) <span class="keyword">null</span>, Typeface.ITALIC),</div><div class="line">        create((String) <span class="keyword">null</span>, Typeface.BOLD_ITALIC),</div><div class="line">    };</div><div class="line"></div><div class="line">    setCustomFont();</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后我在 Settings 里面简单加了一个测试用的换字体的界面，是长着这个样子的：</p>
<p>（图链接错了，然后原图不小心删掉了，懒得贴了，反正就是一个简单的 ListView）</p>
<p>这个代码就不贴了，很简单，一个 listview，底下2个 button，确定、取消。然稍微开个线程（懒的话，线程都不用开）去扫描 data 分区下我指定的那个放自定义字体的文件夹下的 ttf 文件，拿 ttf 文件的文件名来显示。然后选中把 ttf 的文件名在 SystemProperties 保存一下，如果 SystemProperties 没有就是默认的。</p>
<p>如果真的要在自己的产品里做的话，就要像我之前说的改 skia ，要把加载的默认字体换了，然后再把 java 层 Typeface 里面的默认字形给换了。我这里相当于是省略了 skia 那一步，只换 Typeface 里的字形而已。但是就是这个就有不少坑。下面来说说最大的一个坑，而且这个坑还是由于人家 android 的努力优化造成的。</p>
<p>这个坑是怎么回事呢。前面是不说要换 Typeface 的那几个 static 变量么。那首先把这几个变量的 final 属性去掉（其实这里就是坑了，人家原来这个 final 属性不是乱加的，后面就会知道）。然后看起前面我改的代码，Settings 那里自己写的界面，把 SystemProperties 改了，然后调用 Typeface 的 updateDefaultSysFont 会去重新加载设置的 ttf 文件，然后把那几个 static 变量换掉了。照理来说，还没启动的应用字体就应该换过来了（已经启动的，我还没加更新操作，先不管）。不过我发现好像不是这么回事，重新启动的应用还是原来系统的字体，我用 Settings forceStopPackage， shell 里面 kill -9 然后重启应用都没有。感觉很奇怪。但是重启后，就变过去了。刚开始我怀疑是没把 Typface 那几个 static 变量改过去，然后我里面加几个打印，发现是这样的：</p>
<p><img src="http://7u2hy4.com1.z0.glb.clouddn.com/android/Worknote-switch-sysfont/3.jpeg" alt=""></p>
<p>这还真是没改过去。这是为什么。然后我在 Settings 那个设置字体的界面也加了点打印，发现就这个 Settings 的改变了，因为我是在 Settings 里调用的 Typface 的 updateDefaultSysFont 。后面我突然想到了一点，下面就来慢慢说。</p>
<p>前面说到了 Typeface 这几个 static 变量是在 static 语句的初始化的，就是每个进程这个 Typeface 类第一次实例化的时候就触发。android 用的是 dalvik（从 4.4 开始加入 art，L 开始 art 变成默认的虚拟机了）虚拟机。我们知道启动一个 java 程序是很慢的，没感觉的去 PC 启动个 java 程序看看就知道了。不光要启动进程，还要启动 dalvik 虚拟机，而且 android 上层 java 接口还有 N 个 class，系统还有一堆系统资源。如果重头开始加载的话，冷启动一个 android 程序是非常慢的（这里为什么说冷启动呢，因为 android 一旦启动了一个应用，为其开启了一个进程，退出应用后，这个进程不会马上销毁的，这样进程加载了的运行环境都还在，下次启动直接从应用的业务逻辑开始加载就新了，这个是不是有点像电脑的快速休眠、唤醒，这种我觉得可以叫热启动。那么相应的如果事先不存在这个应用的运行环境，重头开始启动就叫冷启动，相当于电脑开机）。</p>
<p>于是 android 就开始动脑筋开始优化了。首先 android 弄了一个叫 Zygote 的东西，这个是个 natvie 程序，开机由 init.rc 启动。init.rc 启动的二进制程序是 frameworks/cmds/app_process 这个（后面启动的时候好像是 set process name 改成 zygote 的）：</p>
<pre config="brush:bash;toolbar:false;">
service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
    class main
    socket zygote stream 660 root system
    onrestart write /sys/android_power/request_state wake
    onrestart write /sys/power/state on
    onrestart restart media
    onrestart restart netd
</pre>

<p>然后这个会调用 AppRuntime 的 start 方法，去启动 dalvik 虚拟机，然后去加载 java 中 zygote 相关的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</div><div class="line">{</div><div class="line">    <span class="comment">// These are global variables in ProcessState.cpp</span></div><div class="line">    mArgC = argc;</div><div class="line">    mArgV = argv;</div><div class="line"></div><div class="line">    mArgLen = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;argc; i++) {</div><div class="line">        mArgLen += <span class="built_in">strlen</span>(argv[i]) + <span class="number">1</span>;</div><div class="line">    }</div><div class="line">    mArgLen--;</div><div class="line"></div><div class="line">    AppRuntime runtime;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* argv0 = argv[<span class="number">0</span>];</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (zygote) {</div><div class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>,</div><div class="line">                startSystemServer ? <span class="string">"start-system-server"</span> : <span class="string">""</span>);</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (className) {</div><div class="line">        <span class="comment">// Remainder of args get passed to startup class main()</span></div><div class="line">        runtime.mClassName = className;</div><div class="line">        runtime.mArgC = argc - i;</div><div class="line">        runtime.mArgV = argv + i;</div><div class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>,</div><div class="line">                application ? <span class="string">"application"</span> : <span class="string">"tool"</span>);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</div><div class="line">        app_usage();</div><div class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">10</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个 AppRuntime 继承自 AndroidRuntime ，这个在 frameworks/base/core/jni/AndroidRuntime.cpp 这里，然后这个 start 就会调用 startVM 去启动 dalvik 虚拟机加载 java 运行环境，然后调用 com.android.internal.os.ZygoteInit 这个类的 main 函数运行 java 代码了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> <span class="keyword">char</span>* options)</div><div class="line">{</div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="comment">/* start the virtual machine */</span></div><div class="line">    JNIEnv* env; </div><div class="line">    <span class="keyword">if</span> (startVm(&mJavaVM, &env) != <span class="number">0</span>) { </div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    }</div><div class="line">    onVmCreated(env);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Register android functions.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) { </div><div class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * We want to call main() with a String array with arguments in it.</span></div><div class="line"><span class="comment">     * At present we have two arguments, the class name and an option string.</span></div><div class="line"><span class="comment">     * Create an array to hold them.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    jclass stringClass;</div><div class="line">    jobjectArray strArray;</div><div class="line">    jstring classNameStr;</div><div class="line">    jstring optionsStr;</div><div class="line"></div><div class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</div><div class="line">    assert(stringClass != NULL);</div><div class="line">    strArray = env-&gt;NewObjectArray(<span class="number">2</span>, stringClass, NULL);</div><div class="line">    assert(strArray != NULL);</div><div class="line">    classNameStr = env-&gt;NewStringUTF(className);</div><div class="line">    assert(classNameStr != NULL);</div><div class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</div><div class="line">    optionsStr = env-&gt;NewStringUTF(options);</div><div class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">1</span>, optionsStr);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Start VM.  This thread becomes the main thread of the VM, and will</span></div><div class="line"><span class="comment">     * not return until the VM exits.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className);</div><div class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</div><div class="line">    <span class="keyword">if</span> (startClass == NULL) {</div><div class="line">        ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</div><div class="line">        <span class="comment">/* keep going */</span></div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</div><div class="line">            <span class="string">"([Ljava/lang/String;)V"</span>);</div><div class="line">        <span class="keyword">if</span> (startMeth == NULL) {</div><div class="line">            ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</div><div class="line">            <span class="comment">/* keep going */</span></div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</div><div class="line"></div><div class="line"><span class="preprocessor">#<span class="keyword">if</span> 0</span></div><div class="line">            <span class="keyword">if</span> (env-&gt;ExceptionCheck())</div><div class="line">                threadExitUncaughtException(env);</div><div class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="built_in">free</span>(slashClassName);</div><div class="line"></div><div class="line">    ALOGD(<span class="string">"Shutting down VM\n"</span>);</div><div class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</div><div class="line">        ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</div><div class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</div><div class="line">        ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里代码不想分析太多，挺复杂的，只是走走流程而已。然后就到 java 里面了，com.android.internal.os.ZygoteInit 的 main 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String argv[]) {</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="comment">// Start profiling the zygote initialization.</span></div><div class="line">        SamplingProfilerIntegration.start();</div><div class="line"></div><div class="line">        registerZygoteSocket();</div><div class="line">        EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</div><div class="line">            SystemClock.uptimeMillis());</div><div class="line">        <span class="comment">// 注意这个 preload</span></div><div class="line">        preload();</div><div class="line">        EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,</div><div class="line">            SystemClock.uptimeMillis());</div><div class="line"></div><div class="line">        <span class="comment">// Finish profiling the zygote initialization.</span></div><div class="line">        SamplingProfilerIntegration.writeZygoteSnapshot();</div><div class="line"></div><div class="line">        <span class="comment">// Do an initial gc to clean up after startup</span></div><div class="line">        gc();</div><div class="line"></div><div class="line">        <span class="comment">// If requested, start system server directly from Zygote</span></div><div class="line">        <span class="keyword">if</span> (argv.length != <span class="number">2</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(argv[<span class="number">0</span>] + USAGE_STRING);</div><div class="line">        }   </div><div class="line"></div><div class="line">        <span class="keyword">if</span> (argv[<span class="number">1</span>].equals(<span class="string">"start-system-server"</span>)) {</div><div class="line">            startSystemServer();</div><div class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (!argv[<span class="number">1</span>].equals(<span class="string">""</span>)) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(argv[<span class="number">0</span>] + USAGE_STRING);</div><div class="line">        }   </div><div class="line"></div><div class="line">        Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ZYGOTE_FORK_MODE) {</div><div class="line">            runForkMode();</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            runSelectLoopMode();</div><div class="line">        }   </div><div class="line"></div><div class="line">        closeServerSocket();</div><div class="line">    } <span class="keyword">catch</span> (MethodAndArgsCaller caller) {</div><div class="line">        caller.run();</div><div class="line">    } <span class="keyword">catch</span> (RuntimeException ex) {</div><div class="line">        Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</div><div class="line">        closeServerSocket();</div><div class="line">        <span class="keyword">throw</span> ex; </div><div class="line">    }   </div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>注意那个 preload：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> preload() {</div><div class="line">    preloadClasses();</div><div class="line">    preloadResources();</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里差不多该该说原理了。前面说了由于启动虚拟机很慢，而且还要 android 应用经常要使用系统提供的那一堆 java class 的接口和资源，这些东西第一加载也慢，第二其实每个应用这些东西都是一样的，如果每个应用一份，会浪费内存。</p>
<p>所以 android 就想了个办法，这个办法主要源自 linux（unix） 的 fork 机制。fork 是一个 linux 系统调用，能够在当前进程创建出一个子进程，子进程完全共享父进程的共有环境变量。好，有了这个基础就可以做一些优化了：</p>
<ol>
<li>弄一个所有应用的共有父进程，专门用来 fork 子进程的，这个就是 zygote（孵化器这个名字取得真形象）。</li>
<li>由于子进程可以共享（继承）父进程的运行环境，所以可以把一些共用的东西在 zygote 中加载好，这样子进程一 fork 出来就有完整的运行环境，不需要重新加载。</li>
<li>由于子进程可以共享（继承）父进程的运行环境，基于 fork 的 <code>copy-on-write</code> 原则，只要这些变量不改变，那么子进程都不需要复制 zygote 进程的环境变量，共同一份，内存开销大大降低。</li>
</ol>
<p>所以这个 zygote 在初始化的时候会有一个 preload 的预加载处理，其实这些资源，zygote 根本不用，是给它的子进程用的，这些子进程就是 android 的那些上层应用。这里我看看 preloadClasses 就是预先加载 sdk 中的那些 class（preloadResrouces 就不看先了，和这篇文章关系不大）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Performs Zygote process initialization. Loads and initializes</span></div><div class="line"><span class="comment">     * commonly used classes.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * Most classes only cause a few hundred bytes to be allocated, but</span></div><div class="line"><span class="comment">     * a few will allocate a dozen Kbytes (in one case, 500+K).</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preloadClasses</span>() {</div><div class="line">        <span class="keyword">final</span> VMRuntime runtime = VMRuntime.getRuntime();</div><div class="line"></div><div class="line">        InputStream is = ClassLoader.getSystemClassLoader().getResourceAsStream(</div><div class="line">                PRELOADED_CLASSES);</div><div class="line">        <span class="keyword">if</span> (is == <span class="keyword">null</span>) {</div><div class="line">            Log.e(TAG, <span class="string">"Couldn't find "</span> + PRELOADED_CLASSES + <span class="string">"."</span>);</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            Log.i(TAG, <span class="string">"Preloading classes..."</span>);</div><div class="line">            <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</div><div class="line">.... ...</div><div class="line"></div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                BufferedReader br</div><div class="line">                    = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is), <span class="number">256</span>*<span class="number">4</span>);</div><div class="line"></div><div class="line">                <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">                String line;</div><div class="line">                <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) {</div><div class="line">                    <span class="comment">// Skip comments and blank lines.</span></div><div class="line">                    line = line.trim();</div><div class="line">                    <span class="keyword">if</span> (line.startsWith(<span class="string">"#"</span>) || line.equals(<span class="string">""</span>)) {</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    }</div><div class="line"></div><div class="line">                    <span class="keyword">try</span> {</div><div class="line">                        <span class="keyword">if</span> (<span class="keyword">false</span>) {</div><div class="line">                            Log.v(TAG, <span class="string">"Preloading "</span> + line + <span class="string">"..."</span>);</div><div class="line">                        }</div><div class="line">                        <span class="comment">// 预加载就是 new 一个 class 的对象出来</span></div><div class="line">                        Class.forName(line);</div><div class="line">                        <span class="keyword">if</span> (Debug.getGlobalAllocSize() &gt; PRELOAD_GC_THRESHOLD) {</div><div class="line">                            <span class="keyword">if</span> (<span class="keyword">false</span>) {</div><div class="line">                                Log.v(TAG,</div><div class="line">                                    <span class="string">" GC at "</span> + Debug.getGlobalAllocSize());</div><div class="line">                            }</div><div class="line">                            System.gc();</div><div class="line">                            runtime.runFinalizationSync();</div><div class="line">                            Debug.resetGlobalAllocSize();</div><div class="line">                        }</div><div class="line">                        count++;</div><div class="line">                    } <span class="keyword">catch</span> (ClassNotFoundException e) {</div><div class="line">                        Log.w(TAG, <span class="string">"Class not found for preloading: "</span> + line);</div><div class="line">                    } <span class="keyword">catch</span> (Throwable t) {</div><div class="line">                        Log.e(TAG, <span class="string">"Error preloading "</span> + line + <span class="string">"."</span>, t);</div><div class="line">                        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Error) {</div><div class="line">                            <span class="keyword">throw</span> (Error) t;</div><div class="line">                        }</div><div class="line">                        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> RuntimeException) {</div><div class="line">                            <span class="keyword">throw</span> (RuntimeException) t;</div><div class="line">                        }</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(t);</div><div class="line">                    }</div><div class="line">                }</div><div class="line"></div><div class="line">                System.gc();</div><div class="line">                runtime.runFinalizationSync();</div><div class="line">                Debug.resetGlobalAllocSize();</div><div class="line">           </div><div class="line">                Log.i(TAG, <span class="string">"...preloaded "</span> + count + <span class="string">" classes in "</span></div><div class="line">                        + (SystemClock.uptimeMillis()-startTime) + <span class="string">"ms."</span>);</div><div class="line">            } <span class="keyword">catch</span> (IOException e) {</div><div class="line">                Log.e(TAG, <span class="string">"Error reading "</span> + PRELOADED_CLASSES + <span class="string">"."</span>, e);</div><div class="line">            } <span class="keyword">finally</span> {</div><div class="line">                IoUtils.closeQuietly(is);</div><div class="line">                <span class="comment">// Restore default.</span></div><div class="line">                runtime.setTargetHeapUtilization(defaultUtilization);</div><div class="line">                        </div><div class="line">                Debug.stopAllocCounting();</div><div class="line"></div><div class="line">                <span class="comment">// Bring back root. We'll need it later.</span></div><div class="line">                setEffectiveUser(ROOT_UID);</div><div class="line">                setEffectiveGroup(ROOT_GID);</div><div class="line">            }</div><div class="line">        }               </div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>它是会解析 frameworks-res.apk 中一个叫 preloaded-classes 的文件。这个文件在 frameworks/base 下面，会打包到 framework-res.apk 中去。这个文件和 ini 文件差不多，一行一个 class 路径。这个文件由 frameworks/base/tools/preload 这个个工具生成，会去检测 frameworks/base 下面的类，如果判断加载这个类超过 1250 微妙就会把这个类写入 preloaded-classes 中。当然这个文件是可以定制的。</p>
<p>preloadClasses 就是一行一行的解析这个文件，然后每次 Class.forName 就相当于 new 一个这个类的一个对象出来，就相当于加载这个类了。所以出触发这个类的一些 static 方法块。</p>
<p>我们在这个文件中发现有 Typeface。好，现在差不多就可以解释前面那个问题了。为什么我在 Settings 里，改了 Typeface 里的 static 变量会没用，即便是冷启动的应用都没有。那是因为通过 Settings 里面调用设置了 SystemProperties，就算是另外一个应用重新启动，但是由于这些应用都是通过 zygote fork 出来的，zygote 里面预先加载了 Typeface，跑了它的 static 代码块，它的那些 static 变量都已经设置好了。所以它 fork 出来的子进程，就算是新 fork 出来的，也不会再跑 Typeface 的那些 static 语句块，因为它继承了 zygote 预先加载好的 Typeface 的这些变量。所以 Typface 里面那几个 static 变量前面加的 final 不是乱加的，你要是乱改，就被坑了。</p>
<p>但是代码在咋手上，肯定还是有办法的。fork 的子进程会继承 zygote 的环境变量，那么只要把 zygote 里面的预先加载好的 Typeface 的环境变量更新一下就可以了。其实就是在 zygote 的进程里面调用下我在 Typeface 中新增的那个 updateDefaultSysFonts 就可以了。</p>
<p>好，现在要做的事，就是要更新 zygote 中的预先加载的 Typeface 的变量。这样就需要在 zygote 中加个接口。android 中 IPC 使用的 binder，但是也有非主流的，这里的 zygote 就是，zygote 用的是 socket 来通信的（同样的还有 vold）。</p>
<p>那就先看看它的协议，然后增加一条自己的就差不多。稍微来看下。前面 zygote 初始化那里，最后会跑到一个 runSelectLoopMode 的函数里：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Runs the zygote process's select loop. Accepts new connections as</span></div><div class="line"><span class="comment"> * they happen, and reads commands from connections one spawn-request's</span></div><div class="line"><span class="comment"> * worth at a time.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @throws MethodAndArgsCaller in a child process when a main() should</span></div><div class="line"><span class="comment"> * be executed.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> runSelectLoopMode() throws MethodAndArgsCaller {</div><div class="line">    ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList();</div><div class="line">    ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList();</div><div class="line">    FileDescriptor[] fdArray = <span class="keyword">new</span> FileDescriptor[<span class="number">4</span>];</div><div class="line"></div><div class="line">    fds.add(sServerSocket.getFileDescriptor());</div><div class="line">    peers.add(null);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> loopCount = GC_LOOP_COUNT; </div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">        <span class="keyword">int</span> index;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * Call gc() before we block in select().</span></div><div class="line"><span class="comment">         * It's work that has to be done anyway, and it's better</span></div><div class="line"><span class="comment">         * to avoid making every child do it.  It will also</span></div><div class="line"><span class="comment">         * madvise() any free memory as a side-effect.</span></div><div class="line"><span class="comment">         *</span></div><div class="line"><span class="comment">         * Don't call it every time, because walking the entire</span></div><div class="line"><span class="comment">         * heap is a lot of overhead to free a few hundred bytes.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">if</span> (loopCount &lt;= <span class="number">0</span>) {</div><div class="line">            gc();</div><div class="line">            loopCount = GC_LOOP_COUNT;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            loopCount--;</div><div class="line">        }</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            fdArray = fds.toArray(fdArray);</div><div class="line">            index = selectReadable(fdArray);</div><div class="line">        } <span class="keyword">catch</span> (IOException ex) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Error in select()"</span>, ex);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Error in select()"</span>);</div><div class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (index == <span class="number">0</span>) {</div><div class="line">            ZygoteConnection newPeer = acceptCommandPeer();</div><div class="line">            peers.add(newPeer);</div><div class="line">            fds.add(newPeer.getFileDesciptor());</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            boolean done;</div><div class="line">            done = peers.get(index).runOnce();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (done) {</div><div class="line">                peers.remove(index);</div><div class="line">                fds.remove(index);</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个是一个循环，这个才是典型的 service 结构么，这里 java 层的，android 又把 socket 封装了一下，这里不深究了，主要下面，当有一个连接请求过来的话，这个处理被封装成 ZygoteConnection 了，然后里面的 runOnce 函数。瞄了一下发现 zygote 这个 socket 通信的协议基本说可以没有（代码不贴了，这篇文章不是分析这个为主的）。就是 client 把几个命名，按一行一行的写入，然后 zygote 这边一行一行的读取，解析。而且这个命令主要就只有一个，就是启动新的进程，然后主要是一些参数多一点而已。</p>
<p>为此 zygote 弄了一个类 Arguments ，里面有不少变量，主要是它支持的参数多。哦，那就好办了，咋随便选一个，然后发一个特殊的参数过去当成我们的接口就 OK 了。</p>
<p>我这里选了 classpath 和 niceName，classpath 发一个特殊的字符串，我这里发 “#Lights#3Moon” 这个串，代表是我自己加的接口，路径这个都是非法的，所以不会和正常的通信起冲突，然后 niceName 就是我自己要的命令，例如现在加一个 “updatefont” 代表更新字体变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// =================================================</span></div><div class="line"><span class="comment">// add by hmm@dw.gdbbk.com</span></div><div class="line"><span class="comment">// our mgiac command.</span></div><div class="line">    </div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> String ZYGOTE_MAGIC_COMMAND = <span class="string">"#Lights#3Moon"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> String ZYGOTE_COMMAND_UPDATE_FONT = <span class="string">"updateFont"</span>;</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后就琢磨了下 parseArgs ，然后发命令的格式就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// add by hmm@dw.gdbbk.com</span></div><div class="line"><span class="comment">// for change system default fonts.</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateConfigurationForChangeSysFont</span>() {</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</div><div class="line">        <span class="comment">// update Zygote preload class cache.</span></div><div class="line">        <span class="keyword">try</span> { </div><div class="line">            ArrayList&lt;String&gt; argsForZygote = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">            <span class="comment">// we use --classpath as magic number</span></div><div class="line">            <span class="comment">// --nice-name as command</span></div><div class="line">            argsForZygote.add(<span class="string">"-classpath"</span>);</div><div class="line">            argsForZygote.add(ZYGOTE_MAGIC_COMMAND);</div><div class="line">            argsForZygote.add(<span class="string">"--nice-name="</span> + ZYGOTE_COMMAND_UPDATE_FONT);</div><div class="line">            Process.zygoteSendArgsAndGetResult(argsForZygote);</div><div class="line">        } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            e.printStackTrace();</div><div class="line">        }     </div><div class="line"></div><div class="line">        <span class="comment">// update current process.</span></div><div class="line">        <span class="comment">// we kill running process, and let restart, this is simple but effective.</span></div><div class="line">        killProcessForUpdateSysFontLocked(); </div><div class="line">    }     </div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>Process 直接就有接口，直接利用现成的就行了。然后 ZygoteConnection 的 runOnce 稍微改改，增加下我们的 magic command 的相应就行了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Reads one start command from the command socket. If successful,</span></div><div class="line"><span class="comment">     * a child is forked and a {@link ZygoteInit.MethodAndArgsCaller}</span></div><div class="line"><span class="comment">     * exception is thrown in that child while in the parent process,</span></div><div class="line"><span class="comment">     * the method returns normally. On failure, the child is not</span></div><div class="line"><span class="comment">     * spawned and messages are printed to the log and stderr. Returns</span></div><div class="line"><span class="comment">     * a boolean status value indicating whether an end-of-file on the command</span></div><div class="line"><span class="comment">     * socket has been encountered.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * @return false if command socket should continue to be read from, or</span></div><div class="line"><span class="comment">     * true if an end-of-file has been encountered.</span></div><div class="line"><span class="comment">     * @throws ZygoteInit.MethodAndArgsCaller trampoline to invoke main()</span></div><div class="line"><span class="comment">     * method in child process</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">boolean</span> runOnce() <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller {</div><div class="line"></div><div class="line">        String args[];</div><div class="line">        Arguments parsedArgs = <span class="keyword">null</span>;   </div><div class="line">        FileDescriptor[] descriptors;  </div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="comment">// add by hmm@dw.gdbbk.com</span></div><div class="line">        <span class="keyword">boolean</span> isMagicCommand = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            parsedArgs = <span class="keyword">new</span> Arguments(args);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (ZYGOTE_MAGIC_COMMAND.equals(parsedArgs.classpath)) {</div><div class="line">                isMagicCommand = <span class="keyword">true</span>;</div><div class="line">            }</div><div class="line"> </div><div class="line">            <span class="comment">// 这一堆是权限检测的，我是通过 ActivityManagerService 发过来的，权限木得问题</span></div><div class="line">            applyUidSecurityPolicy(parsedArgs, peer);</div><div class="line">            applyRlimitSecurityPolicy(parsedArgs, peer);</div><div class="line">            applyCapabilitiesSecurityPolicy(parsedArgs, peer);</div><div class="line">            applyInvokeWithSecurityPolicy(parsedArgs, peer);</div><div class="line"></div><div class="line">            applyDebuggerSystemProperty(parsedArgs);</div><div class="line">            applyInvokeWithSystemProperty(parsedArgs);</div><div class="line"></div><div class="line">            <span class="keyword">int</span>[][] rlimits = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (parsedArgs.rlimits != <span class="keyword">null</span>) {</div><div class="line">                rlimits = parsedArgs.rlimits.toArray(intArray2d);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (parsedArgs.runtimeInit && parsedArgs.invokeWith != <span class="keyword">null</span>) {</div><div class="line">                FileDescriptor[] pipeFds = Libcore.os.pipe();</div><div class="line">                childPipeFd = pipeFds[<span class="number">1</span>];</div><div class="line">                serverPipeFd = pipeFds[<span class="number">0</span>];</div><div class="line">                ZygoteInit.setCloseOnExec(serverPipeFd, <span class="keyword">true</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// for our magic command</span></div><div class="line">            <span class="comment">//pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid,</span></div><div class="line">            <span class="comment">//        parsedArgs.gids, parsedArgs.debugFlags, rlimits);</span></div><div class="line">            <span class="keyword">if</span> (isMagicCommand) {</div><div class="line">                pid = <span class="number">9999</span>;</div><div class="line">                execMagicCommand(parsedArgs);</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid,</div><div class="line">                        parsedArgs.gids, parsedArgs.debugFlags, rlimits);</div><div class="line">            }</div><div class="line">        } <span class="keyword">catch</span> (IOException ex) {</div><div class="line">            logAndPrintError(newStderr, <span class="string">"Exception creating pipe"</span>, ex);</div><div class="line">        } <span class="keyword">catch</span> (ErrnoException ex) {</div><div class="line">            logAndPrintError(newStderr, <span class="string">"Exception creating pipe"</span>, ex);</div><div class="line">        } <span class="keyword">catch</span> (IllegalArgumentException ex) {</div><div class="line">            logAndPrintError(newStderr, <span class="string">"Invalid zygote arguments"</span>, ex);</div><div class="line">        } <span class="keyword">catch</span> (ZygoteSecurityException ex) {</div><div class="line">            logAndPrintError(newStderr,</div><div class="line">                    <span class="string">"Zygote security policy prevents request: "</span>, ex);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="keyword">if</span> (pid == <span class="number">0</span>) {</div><div class="line">                <span class="comment">// in child</span></div><div class="line">                IoUtils.closeQuietly(serverPipeFd);</div><div class="line">                serverPipeFd = <span class="keyword">null</span>;</div><div class="line">                handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</div><div class="line"></div><div class="line">                <span class="comment">// should never get here, the child is expected to either</span></div><div class="line">                <span class="comment">// throw ZygoteInit.MethodAndArgsCaller or exec().</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="comment">// in parent...pid of &lt; 0 means failure</span></div><div class="line">                IoUtils.closeQuietly(childPipeFd);</div><div class="line">                childPipeFd = <span class="keyword">null</span>;</div><div class="line">                <span class="comment">//return handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</span></div><div class="line">                <span class="keyword">if</span> (isMagicCommand) {</div><div class="line">                    <span class="keyword">return</span> handleParentProcInMagicCommand(pid, descriptors, parsedArgs);</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    <span class="keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</div><div class="line">                }</div><div class="line">            }</div><div class="line">        } <span class="keyword">finally</span> {</div><div class="line">            IoUtils.closeQuietly(childPipeFd);</div><div class="line">            IoUtils.closeQuietly(serverPipeFd);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后就是我自己加的那几个函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 执行我们自定义的命令</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execMagicCommand</span>(Arguments parsedArgs) {</div><div class="line">    <span class="comment">// niceName 是我们的自己的命令</span></div><div class="line">    String cmds = parsedArgs.niceName;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == cmds) {</div><div class="line">        Log.i(TAG, <span class="string">"the magic command is null, ignore it !!"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ZYGOTE_COMMAND_UPDATE_FONT.equals(cmds)) {</div><div class="line">        <span class="comment">// "updatefont" 的话更新 zygote 进程的 Typeface 变量</span></div><div class="line">        Log.i(TAG, <span class="string">"exec zygote magic command: "</span> + cmds);</div><div class="line">        Typeface.updateDefaultFont();</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        Log.i(TAG, <span class="string">"the magic command: "</span> + cmds + <span class="string">" is unknow, ignore it !!"</span>);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// 最后要扫下尾，主要是通信结束后关闭 socket，然后返回一个假的 pid</span></div><div class="line"><span class="comment">// 这个可以照着原来的改一下</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">handleParentProcInMagicCommand</span>(<span class="keyword">int</span> pid,</div><div class="line">        FileDescriptor[] descriptors, Arguments parsedArgs) {</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (descriptors != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">for</span> (FileDescriptor fd: descriptors) {</div><div class="line">            IoUtils.closeQuietly(fd);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> usingWrapper = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="comment">// 这个 pid 本来是 fork 的子进程的</span></div><div class="line">        <span class="comment">// 前面写了个假的 9999</span></div><div class="line">        mSocketOutStream.writeInt(pid);</div><div class="line">        mSocketOutStream.writeBoolean(usingWrapper);</div><div class="line">    } <span class="keyword">catch</span> (IOException ex) {</div><div class="line">        Log.e(TAG, <span class="string">"Error reading from command socket"</span>, ex);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * If the peer wants to use the socket to wait on the</span></div><div class="line"><span class="comment">     * newly spawned process, then we're all done.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">if</span> (parsedArgs.peerWait) {</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="comment">// 关闭 socket </span></div><div class="line">            mSocket.close();</div><div class="line">        } <span class="keyword">catch</span> (IOException ex) {</div><div class="line">            Log.e(TAG, <span class="string">"Zygote: error closing sockets"</span>, ex);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这样 zygote 就改造完成了，试了下果然有效果。但是现在只是 zygote 更新后，新 fork 的子进程有效，原来 fork 出来的还是没改变。这个就是下面要说，更新之前的应用的字体。</p>
<h2 id="2-_更新应用">2. 更新应用</h2>
<p>这个咧，一开始我觉得我可以参考下 Settings 里面切换语言，因为这个和切换字体感觉挺像的。这个主要是调到了 AM 里面的 updateConfigurationLocked 这个函数。这个函数的参数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Do either or both things: (1) change the current configuration, and (2)</span></div><div class="line"><span class="comment"> * make sure the given activity is running with the (now) current</span></div><div class="line"><span class="comment"> * configuration.  Returns true if the activity has been left running, or</span></div><div class="line"><span class="comment"> * false if &lt;var&gt;starting&lt;/var&gt; is being destroyed to match the new</span></div><div class="line"><span class="comment"> * configuration.</span></div><div class="line"><span class="comment"> * @param persistent TODO</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//boolean updateConfigurationLocked(Configuration values,</span></div><div class="line"><span class="comment">//        ActivityRecord starting, boolean persistent, boolean initLocale);</span></div><div class="line"></div></pre></td></tr></table></figure>

<p>切换语言的时候发送 Settings 调用的参数是： updateConfigurationLocked(newConfig, null, false, false). Configuration 中有几个变量是和语言相关的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Current user preference for the locale, corresponding to</span></div><div class="line"><span class="comment"> * &lt;a href="{@docRoot}guide/topics/resources/providing-resources.html#LocaleQualifier"&gt;locale&lt;/a&gt;</span></div><div class="line"><span class="comment"> * resource qualifier.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> Locale locale;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Locale should persist on setting.  This is hidden because it is really</span></div><div class="line"><span class="comment"> * questionable whether this is the right way to expose the functionality.</span></div><div class="line"><span class="comment"> * @hide</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> userSetLocale;</div><div class="line"></div></pre></td></tr></table></figure>

<p>第一个是表示当前的语言（En、zh-rCN 等），后面那个是表示用户是否设置了语言。这个函数的第一参数是表示当前更改的语言（包含在 Configuration 中）。然后看了下这个函数的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">boolean</span> updateConfigurationLocked(Configuration values,</div><div class="line">        ActivityRecord starting, <span class="keyword">boolean</span> persistent, <span class="keyword">boolean</span> initLocale) {</div><div class="line">    <span class="comment">// do nothing if we are headless</span></div><div class="line">    <span class="keyword">if</span> (mHeadless) <span class="keyword">return</span> <span class="keyword">true</span>; </div><div class="line"></div><div class="line">    <span class="keyword">int</span> changes = <span class="number">0</span>;</div><div class="line">                          </div><div class="line">    <span class="keyword">boolean</span> kept = <span class="keyword">true</span>; </div><div class="line">          </div><div class="line">    <span class="keyword">if</span> (values != <span class="keyword">null</span>) {</div><div class="line">        Configuration newConfig = <span class="keyword">new</span> Configuration(mConfiguration);</div><div class="line">        changes = newConfig.updateFrom(values);</div><div class="line">        <span class="keyword">if</span> (changes != <span class="number">0</span>) {</div><div class="line">            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_CONFIGURATION) {</div><div class="line">                Slog.i(TAG, <span class="string">"Updating configuration to: "</span> + values);</div><div class="line">            }     </div><div class="line">                  </div><div class="line">            EventLog.writeEvent(EventLogTags.CONFIGURATION_CHANGED, changes);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (values.locale != <span class="keyword">null</span> && !initLocale) {</div><div class="line">                saveLocaleLocked(values.locale, </div><div class="line">                                 !values.locale.equals(mConfiguration.locale),</div><div class="line">                                 values.userSetLocale);</div><div class="line">            }     </div><div class="line"></div><div class="line">            mConfigurationSeq++;</div><div class="line">            <span class="keyword">if</span> (mConfigurationSeq &lt;= <span class="number">0</span>) {</div><div class="line">                mConfigurationSeq = <span class="number">1</span>;</div><div class="line">            }     </div><div class="line">            newConfig.seq = mConfigurationSeq;</div><div class="line">            mConfiguration = newConfig;</div><div class="line">            Slog.i(TAG, <span class="string">"Config changed: "</span> + newConfig);</div><div class="line"></div><div class="line">            <span class="keyword">final</span> Configuration configCopy = <span class="keyword">new</span> Configuration(mConfiguration);</div><div class="line">                  </div><div class="line">            <span class="comment">// TODO: If our config changes, should we auto dismiss any currently</span></div><div class="line">            <span class="comment">// showing dialogs?</span></div><div class="line">            mShowDialogs = shouldShowDialogs(newConfig);</div><div class="line"></div><div class="line">            AttributeCache ac = AttributeCache.instance();</div><div class="line">            <span class="keyword">if</span> (ac != <span class="keyword">null</span>) {</div><div class="line">                ac.updateConfiguration(configCopy);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// Make sure all resources in our process are updated</span></div><div class="line">            <span class="comment">// right now, so that anyone who is going to retrieve</span></div><div class="line">            <span class="comment">// resource values after we return will be sure to get</span></div><div class="line">            <span class="comment">// the new ones.  This is especially important during</span></div><div class="line">            <span class="comment">// boot, where the first config change needs to guarantee</span></div><div class="line">            <span class="comment">// all resources have that config before following boot</span></div><div class="line">            <span class="comment">// code is executed.</span></div><div class="line">            mSystemThread.applyConfigurationToResources(configCopy);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (persistent && Settings.System.hasInterestingConfigurationChanges(changes)) {</div><div class="line">                Message msg = mHandler.obtainMessage(UPDATE_CONFIGURATION_MSG);</div><div class="line">                msg.obj = <span class="keyword">new</span> Configuration(configCopy);</div><div class="line">                mHandler.sendMessage(msg);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mLruProcesses.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) {</div><div class="line">                ProcessRecord app = mLruProcesses.get(i);</div><div class="line">                <span class="keyword">try</span> {</div><div class="line">                    <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) {</div><div class="line">                        <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Sending to proc "</span></div><div class="line">                                + app.processName + <span class="string">" new config "</span> + mConfiguration);</div><div class="line">                        app.thread.scheduleConfigurationChanged(configCopy);</div><div class="line">                    }</div><div class="line">                } <span class="keyword">catch</span> (Exception e) {</div><div class="line">                }</div><div class="line">            }</div><div class="line">            Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_CONFIGURATION_CHANGED);</div><div class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</div><div class="line">                    | Intent.FLAG_RECEIVER_REPLACE_PENDING);</div><div class="line">            broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</div><div class="line">                    <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID, <span class="number">0</span> <span class="comment">/* TODO: Verify */</span>);</div><div class="line">            <span class="keyword">if</span> ((changes&ActivityInfo.CONFIG_LOCALE) != <span class="number">0</span>) {</div><div class="line">                broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>,</div><div class="line">                        <span class="keyword">new</span> Intent(Intent.ACTION_LOCALE_CHANGED),</div><div class="line">                        <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</div><div class="line">                        <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID, <span class="number">0</span> <span class="comment">/* TODO: Verify */</span>);</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (changes != <span class="number">0</span> && starting == <span class="keyword">null</span>) {</div><div class="line">        <span class="comment">// If the configuration changed, and the caller is not already</span></div><div class="line">        <span class="comment">// in the process of starting an activity, then find the top</span></div><div class="line">        <span class="comment">// activity to check if its configuration needs to change.</span></div><div class="line">        starting = mMainStack.topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (starting != <span class="keyword">null</span>) {</div><div class="line">        kept = mMainStack.ensureActivityConfigurationLocked(starting, changes);</div><div class="line">        <span class="comment">// And we need to make sure at this point that all other activities</span></div><div class="line">        <span class="comment">// are made visible with the correct configuration.</span></div><div class="line">        mMainStack.ensureActivitiesVisibleLocked(starting, changes);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (values != <span class="keyword">null</span> && mWindowManager != <span class="keyword">null</span>) {</div><div class="line">        mWindowManager.setNewConfiguration(mConfiguration);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> kept;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>看样子先是对比下传过来的 config 和现在正在使用的相比看看有没有变化，有的话通过 mLruProcesses 对最近使用过的进程的主线程（UI 线程）发送新的配置，让其重新加载资源。然后后面那个 starting 如果不为 null 的话，估计会根据配置变化情况是否重新启动吧，最后然 WM 也根据新配置做下调整。</p>
<p>如果是这里换字体想利用这个去更新界面的话，我尝试传递在这个函数增加一个参数，标志是我更新字体专用的。这个时候我就取当前的 config 作为更改的配置，然后故意在里面把 changes 改了一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (updateForChangeSysFont) {</div><div class="line">    <span class="comment">// we let as change launage it will update the ui show which we need when change system font.</span></div><div class="line">    newConfig.userSetLocale = <span class="keyword">true</span>;</div><div class="line">    changes |= ActivityInfo.CONFIG_LOCALE;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>



<p>后面发现，确实走了下面，但是发现界面并没有更新，后面跟了下代码，发现后面很多函数还会判断你传过去的 config 使用的 local 是不是和当前的一样的 -_-|| 。看样子没那么容易忽悠 android 啊。</p>
<p>后面我又想到了一个简单、暴力的办法，把进程直接 kill 掉，但是保留任务记录，然后让它们自己重新启动就好了。AM 里面有个方法可以直接 kill 进程，但是不清除任务记录：</p>
<pre config="brush:bash;toolbar:false;">
public boolean killPids(int[] pids, String pReason, boolean secure)
</pre>

<p>这个和 forceStopPackage 不一样，只会把进程杀掉而已，而且能一次性杀很多个。看了下实现后，发现这个接口应该是系统内存不足的时候要调整内存用的，其中里面可以看得到进程的类型，以及被杀的优先级。这个里面会选传递过去那一组 pids 中进程优先级最低的开始杀，所以不太符合我们的需求，我就访问它的实现自己改了一个出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">killProcessForUpdateSysFontLocked</span>() {</div><div class="line">    <span class="comment">// we kill add process exclude system persistent process.</span></div><div class="line">    <span class="keyword">int</span> worstType = ProcessList.FOREGROUND_APP_ADJ - <span class="number">1</span>;</div><div class="line">    String reason = <span class="string">"update sys font"</span>;</div><div class="line">    Slog.w(TAG, <span class="string">"Killing processes for reason: "</span> + reason + <span class="string">", adj="</span> + worstType);</div><div class="line">    <span class="keyword">for</span> (ProcessRecord app : mLruProcesses) {</div><div class="line">        ProcessRecord proc = mPidsSelfLocked.get(app.pid);</div><div class="line">        <span class="keyword">if</span> (proc == <span class="keyword">null</span>) {            </div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">int</span> adj = proc.setAdj;         </div><div class="line">        Slog.w(TAG, <span class="string">"try to Killing "</span> + proc + <span class="string">" (adj "</span> + adj + <span class="string">"): "</span> + reason + <span class="string">", killedBackground="</span> + proc.killedBackground);</div><div class="line">        <span class="keyword">if</span> (adj &gt;= worstType && !proc.killedBackground) {</div><div class="line">            Slog.w(TAG, <span class="string">"Killing "</span> + proc + <span class="string">" (adj "</span> + adj + <span class="string">"): "</span> + reason);</div><div class="line">            EventLog.writeEvent(EventLogTags.AM_KILL, proc.pid,</div><div class="line">                    proc.processName, adj, reason);</div><div class="line">            proc.killedBackground = <span class="keyword">true</span>;  </div><div class="line">            Process.killProcessQuiet(app.pid);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>（我的调用这个函数的地方有 synchronized 锁的，前面的代码可以看得到，所以里面就没加锁了）。这里稍微贴一下 ProcessList 的调整等级：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// This is a process holding the home application -- we want to try</span></div><div class="line"><span class="comment">// avoiding killing it, even if it would normally be in the background,</span></div><div class="line"><span class="comment">// because the user interacts with it so much.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HOME_APP_ADJ = <span class="number">6</span>;</div><div class="line"></div><div class="line"><span class="comment">// This is a process holding an application service -- killing it will not</span></div><div class="line"><span class="comment">// have much of an impact as far as the user is concerned.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERVICE_ADJ = <span class="number">5</span>;</div><div class="line"></div><div class="line"><span class="comment">// This is a process currently hosting a backup operation.  Killing it</span></div><div class="line"><span class="comment">// is not entirely fatal but is generally a bad idea.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BACKUP_APP_ADJ = <span class="number">4</span>;</div><div class="line"></div><div class="line"><span class="comment">// This is a process with a heavy-weight application.  It is in the</span></div><div class="line"><span class="comment">// background, but we want to try to avoid killing it.  Value set in</span></div><div class="line"><span class="comment">// system/rootdir/init.rc on startup.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HEAVY_WEIGHT_APP_ADJ = <span class="number">3</span>;</div><div class="line"></div><div class="line"><span class="comment">// This is a process only hosting components that are perceptible to the</span></div><div class="line"><span class="comment">// user, and we really want to avoid killing them, but they are not</span></div><div class="line"><span class="comment">// immediately visible. An example is background music playback.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERCEPTIBLE_APP_ADJ = <span class="number">2</span>;</div><div class="line"></div><div class="line"><span class="comment">// This is a process only hosting activities that are visible to the</span></div><div class="line"><span class="comment">// user, so we'd prefer they don't disappear.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VISIBLE_APP_ADJ = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">// This is the process running the current foreground app.  We'd really</span></div><div class="line"><span class="comment">// rather not kill it!</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FOREGROUND_APP_ADJ = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="comment">// This is a system persistent process, such as telephony.  Definitely</span></div><div class="line"><span class="comment">// don't want to kill it, but doing so is not completely fatal.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERSISTENT_PROC_ADJ = -<span class="number">12</span>;</div><div class="line"></div><div class="line"><span class="comment">// The system process runs at the default adjustment.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SYSTEM_ADJ = -<span class="number">16</span>;</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里没贴完的，剩余自己去看吧。按照原来的实现，数值越大的进程，就越是容易被杀掉。至于那2个负数的等级，自己看注释吧，-12 那个应该是代表通话的进程，还有 system ui 这些。-16 那个不要想了，那个 zygote 和 <code>system_server</code> 都在里面的，杀掉直接系统重启了。</p>
<p>所以我选了 <code>FOREGROUND_APP_ADJ - 1</code>。这个调用之后，几乎可以杀掉你能“看到”的所有进程，但是 system ui 杀不掉。所以 system ui 的字体没更新。这个的话，当然可以考虑使用 -12 ，但是真的是要项目上用的话，效果很不好，因为其他应用挂了，黑屏一下，还可以曲线救国一下：可以考虑在 <code>system_server</code> 搞个界面做字体选择，挡住原来那些应用，就看不到黑屏了。 但 system ui 一挂，无论如何你都会看到状态栏、虚拟按键突然没了，然后再出来，体验太不好了。</p>
<p>所以可以考虑继续使用我一开始说的那个方法，但是得继续研究下，例如在 Configuration 中加个字段，表示换字体强制更新界面，然后发给 system ui，然后 system ui 那里再处理下这个字段。或者是不是所有的应用都可以用这种方式更新，而不用杀掉它们。反正这个我目前还没研究了，但是要能用的话，至少 system ui 不能杀掉的，想偷点懒的话就结合杀进程一起用吧（system ui 更新，其他的杀）。</p>
<p>这里只是记录下大致思路，以及一些已经验证了的想法。后面真要做这个功能这里的东西还是有一定参考价值的，以后用到再说啦。</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/android/">android</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-Framework/">Android Framework</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.light3moon.com/2015/01/31/工作小笔记——Android 动态切换系统字体/" data-title="工作小笔记——Android 动态切换系统字体 | Light.Moon" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/01/31/工作小笔记——利用反射需要注意的问题/" title="工作小笔记——利用反射需要注意的问题">
  <strong>上一篇:</strong><br/>
  <span>
  工作小笔记——利用反射需要注意的问题</span>
</a>
</div>


<div class="next">
<a href="/2015/01/31/工作小笔记——Android 多用户下的要注意的问题/"  title="工作小笔记——Android 多用户下的要注意的问题">
 <strong>下一篇:</strong><br/> 
 <span>工作小笔记——Android 多用户下的要注意的问题
</span>
</a>
</div>

</nav>


	
<section class="comment">
	<div class="ds-thread" data-thread-key="工作小笔记——Android 动态切换系统字体" data-title="工作小笔记——Android 动态切换系统字体" 
      data-author-key="mingming" data-limit=10
      data-url="light3moon.com/2015/01/31/工作小笔记——Android 动态切换系统字体/">
    </div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#初步了解"><span class="toc-number">1.</span> <span class="toc-text">初步了解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本思路"><span class="toc-number">2.</span> <span class="toc-text">基本思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-替换默认字体"><span class="toc-number">3.</span> <span class="toc-text">1.替换默认字体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-_更新应用"><span class="toc-number">4.</span> <span class="toc-text">2. 更新应用</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android-Development/" title="Android Development">Android Development<sup>32</sup></a></li>
		
			<li><a href="/categories/Android-Framework/" title="Android Framework">Android Framework<sup>46</sup></a></li>
		
			<li><a href="/categories/Basics-Knowledge/" title="Basics Knowledge">Basics Knowledge<sup>11</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>23</sup></a></li>
		
			<li><a href="/categories/MiniGUI/" title="MiniGUI">MiniGUI<sup>12</sup></a></li>
		
			<li><a href="/categories/Other/" title="Other">Other<sup>8</sup></a></li>
		
			<li><a href="/categories/Server/" title="Server">Server<sup>1</sup></a></li>
		
			<li><a href="/categories/Window/" title="Window">Window<sup>10</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/android/" title="android">android<sup>78</sup></a></li>
		
			<li><a href="/tags/basics/" title="basics">basics<sup>11</sup></a></li>
		
			<li><a href="/tags/install/" title="install">install<sup>9</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>27</sup></a></li>
		
			<li><a href="/tags/minigui/" title="minigui">minigui<sup>13</sup></a></li>
		
			<li><a href="/tags/opengl/" title="opengl">opengl<sup>3</sup></a></li>
		
			<li><a href="/tags/other/" title="other">other<sup>5</sup></a></li>
		
			<li><a href="/tags/server/" title="server">server<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>5</sup></a></li>
		
			<li><a href="/tags/window/" title="window">window<sup>11</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">哥的后勤处 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-qqzone"></i> <a href="http://user.qzone.qq.com/544630305" target="_blank">QQ 空间</a></li>
      <li><i class="fa fa-github"></i> <a href="https://github.com/mingming-killer" target="_blank">GitHub</a></li>
      
        
          <li><i class="fa fa-analytics"></i> <a href="http://tongji.baidu.com/web/welcome/ico?s=fa045dbd45ffce238b146e00f91ba6a3" target="_blank">战斗力</a></li>
        
      
      <li><i class="fa fa-markdown-help"></i> <a href="http://zh.wikipedia.org/wiki/Markdown" target="_blank">Makrdown</a></li>
    </ul>
</div>


  <div class="commentlist">
  <p class="asidetitle">最近冒泡的小伙伴 ╰(●&#39;◡&#39;●)╮</p>
    <ul>
      <ul class="ds-recent-comments" 
        data-num-items="6" 
        data-show-avatars="1" 
        data-show-title="1"   
        data-show-time="1" 
        data-show-admin="1" 
        data-excerpt-length="30">
      </ul>
      <!-- duoshou js begin load, one page only load once -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"mingming"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
      <!-- duoshou js load end -->
    </ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-book"></i> <a href="http://taoyuanxiaoqi.com" target="_blank">桃园小七的博客</a></li>
    </ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
<!--
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
-->

     <!-- this is defined in footer.styl, line holder -->
	<div class="line">
	</div>
     
<!--
	<div class="social-font clearfix">
		
		
		
		
		
		<a href="https://github.com/mingming-killer" target="_blank" title="github"></a>
		
        	
		<a href="http://user.qzone.qq.com/544630305" target="_blank" title="qqzone"></a>
		         
	</div>
-->

		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/mingming-killer/Lightmoon" target="_blank" title="Lightmoon">Lightmoon</a> © 2016 
		
		<a href="http://www.light3moon.com" target="_blank" title="Mingming">Mingming</a>
		
		</p>

  <!-- baidu search verification -->
  
    <meta name="baidu-site-verification" content="w1BSX6yZ9k" />
  

  <!-- swiftype search verification -->
  

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"mingming"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fa045dbd45ffce238b146e00f91ba6a3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>
