
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

  
    <title>联芯透明窗体支持方案 | Light.Moon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Mingming">
    
    <meta name="description" content="需求

底下窗体内容会变化。
接口简单，使用方便。
内存占用少，效率高。
透明窗体弹出时，屏幕上所包含的窗体及个数不限定。
支持透明主窗体、透明非模态对话框、透明模态对话框。
能移动透明窗体和非透明窗体。
在创建了透明窗体后能继续创建非透明窗体。
能动态设置与撤销双缓冲。

问题
这里先要说明下现有">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/apple_icon.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/apple_icon.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
		<div id="header_author">
		</div>
		

         <!--
         
           <div id="imglogo">
           <a href="/"><img src="/img/logo.svg" alt="Light.Moon" title="Light.Moon"/></a>
           </div>
         
         -->

			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Light.Moon">Light.Moon</a></h1>
				<h2 class="blog-motto">〜(￣△￣〜) 三月学长的根据地 (〜￣△￣)〜</h2>
			</div>

			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/1986/12/20/文章索引">索引</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					

                      <form class="search" action=http://search.light3moon.com/cse/search target="_blank">
                      <label>搜索</label>
                      <!--
                      <input name="s" type="hidden" value="undefined">
                      -->
                      <input name="s" type="hidden" value="12628367885198549364">
                      <input type="text" name="q" size="30" placeholder="搜索"> <br>

                      
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/01/21/联芯透明窗体支持方案/" title="联芯透明窗体支持方案" itemprop="url">联芯透明窗体支持方案</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.light3moon.com" title="Mingming">Mingming</a>
    </p>
  <p class="article-time">
    <time datetime="2015-01-21T13:35:16.000Z" itemprop="datePublished">2015 1月 21</time>
    更新日期:<time datetime="2015-01-21T13:35:16.000Z" itemprop="dateModified">2015 1月 21</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#需求"><span class="toc-number">1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-number">2.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案"><span class="toc-number">3.</span> <span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#限制条件"><span class="toc-number">4.</span> <span class="toc-text">限制条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#接口"><span class="toc-number">5.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-number">6.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据结构"><span class="toc-number">6.1.</span> <span class="toc-text">数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建透明主窗体"><span class="toc-number">6.2.</span> <span class="toc-text">创建透明主窗体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#销毁透明主窗体"><span class="toc-number">6.3.</span> <span class="toc-text">销毁透明主窗体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#透明窗体更新"><span class="toc-number">6.4.</span> <span class="toc-text">透明窗体更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#非透明窗体更新"><span class="toc-number">6.5.</span> <span class="toc-text">非透明窗体更新</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用范例"><span class="toc-number">7.</span> <span class="toc-text">使用范例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2011-2-16：改动1——支持逐点_alpha（包括在缓冲dc中）"><span class="toc-number">8.</span> <span class="toc-text">2011.2.16：改动1——支持逐点 alpha（包括在缓冲dc中）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题-1"><span class="toc-number">8.1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决办法"><span class="toc-number">8.2.</span> <span class="toc-text">解决办法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#本质问题分析"><span class="toc-number">8.3.</span> <span class="toc-text">本质问题分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2011-3-24：改动2——一些小修正"><span class="toc-number">9.</span> <span class="toc-text">2011.3.24：改动2——一些小修正</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题-2"><span class="toc-number">9.1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决办法-1"><span class="toc-number">9.2.</span> <span class="toc-text">解决办法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码路径"><span class="toc-number">9.3.</span> <span class="toc-text">代码路径</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2011-4-19：改动3——支持动态设置/去除窗口透明属性"><span class="toc-number">10.</span> <span class="toc-text">2011.4.19：改动3——支持动态设置/去除窗口透明属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题-3"><span class="toc-number">10.1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决办法-2"><span class="toc-number">10.2.</span> <span class="toc-text">解决办法</span></a></li></ol></li></ol>
		</div>
		
		<h2 id="需求">需求</h2>
<ul>
<li>底下窗体内容会变化。</li>
<li>接口简单，使用方便。</li>
<li>内存占用少，效率高。</li>
<li>透明窗体弹出时，屏幕上所包含的窗体及个数不限定。</li>
<li>支持透明主窗体、透明非模态对话框、透明模态对话框。</li>
<li>能移动透明窗体和非透明窗体。</li>
<li>在创建了透明窗体后能继续创建非透明窗体。</li>
<li>能动态设置与撤销双缓冲。</li>
</ul>
<h2 id="问题">问题</h2>
<p>这里先要说明下现有 MiniGUI 框架实现透明窗体的问题。如果光光是要窗体能透明还是比较好办的。在双缓冲回调函数中设置下 memdc 的层 alpha ，然后 BitBlt 到屏幕就可以了。但是这里主要存在的问题是透明的窗体的更新的问题。就是透明窗体下面的窗体更新、或是透明窗体本身更新时怎样才能得到正确的图像。这里分2点：</p>
<ul>
<li><p>透明自身窗体更新：由于是透明窗体的，所以透明窗体的图像需要与屏幕做 alpha 混合。非透明窗体直接将自己的图像更新到屏幕就行了。但是如果透明窗体直接这么做的话，会导致与上一次的图像重叠，结果是图像越来越不透明。因此就需要将背景刷新掉。这就需要处在透明窗体下的非透明窗体更新图像。但是现有 MiniGUI 的框架是不会更新下面的窗体的，因为下面的窗体处于透明窗体之下，被挡住了，是会被剪切掉的。</p>
</li>
<li><p>非透明窗体更新：如果处于透明窗体下的非透明窗体更新的话，由于是透明窗体，所以应该能看得到底下的非透明窗体的更新。这就需要透明窗体更新。和上面一点一样， MiniGUI 的现有框架是不会更新透明窗体的。因为透明窗体位于非透明窗体的之上，MiniGUI 认为底下的窗体不会引起上面的窗体的更新。</p>
</li>
</ul>
<h2 id="解决方案">解决方案</h2>
<p>根据上面提到的问题，我们可以在应用层使用 MiniGUI 双缓冲机制来实现。双缓冲提供了一个更新回调函数，窗体有更新时就会调用这个函数。因此我们可以自己设置这个更新函数，然在里面手动更新透明窗体。总结起来分为下面几点：</p>
<ul>
<li>透明窗体和桌面上所有的非透明窗体必须使用双缓冲，透明窗体设置 <code>WS_EX_TRANSPARENT</code> 风格标志。</li>
<li>收集桌面中所有的非透明窗体，按照 zorder 保存在链表中，存放在透明窗体的 adddata2 中。</li>
<li>在透明窗体的更新函数中，遍历该链表，看其中的非透明窗体是否与透明窗体相交，是则将该非透明窗体的相应区域的图像更新到透明区域（更新透明区域的背景）。</li>
<li>在非透明窗体的更新函数，遍历桌面所有其他主窗体，找出具有 <code>WS_EX_TRANSPARENT</code> 风格的透明窗体。判断其更新区域是否与透明窗体相交，如果相交则要强制透明窗体更新。</li>
</ul>
<h2 id="限制条件">限制条件</h2>
<p>根据如上解决方案，本透明窗体的实现，具有一定的限制性，超出限制可能出现不可预料的问题。</p>
<ul>
<li>屏幕上同时只能创建1个透明主窗体。</li>
<li>不要让透明窗体透出桌面（保证其在一个窗体内）。</li>
<li>暂时不支持窗口滚动。</li>
</ul>
<h2 id="接口">接口</h2>
<p>提供如下接口：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 设置透明窗体附件数据2 */</span></div><div class="line">DWORD SetTransparentWindowAddData2 (HWND hWnd, DWORD newData);</div><div class="line"></div><div class="line"><span class="comment">/* 设置透明窗体 alpha 值 */</span></div><div class="line"><span class="keyword">void</span> SetTransparentWindowAlpha (HWND hWnd, Uint8 alpha);</div><div class="line"></div><div class="line"><span class="comment">/* 获取透明窗体附件数据2 */</span></div><div class="line">DWORD GetTransparentWindowAddData2 (HWND hWnd);</div><div class="line"></div><div class="line"><span class="comment">/* 获取透明窗体 alpha 值 */</span></div><div class="line">Uint8 GetTransparentWindowAlpha (HWND hWnd);</div><div class="line"></div><div class="line"><span class="comment">/* 创建透明主窗体 */</span></div><div class="line">HWND CreateTransparentMainWindow (PMAINWINCREATE pCreateInfo);</div><div class="line"></div><div class="line"><span class="comment">/* 创建透明非模态对话框 */</span></div><div class="line">HWND CreateTransparentMainWindowIndirectParam (</div><div class="line">        PDLGTEMPLATE pDlgTemplate, HWND hOwner,</div><div class="line">        WNDPROC WndProc, LPARAM lParam);</div><div class="line"></div><div class="line"><span class="comment">/* 创建透明模态对话框 */</span></div><div class="line"><span class="keyword">int</span> TransparentDialogBoxIndirectParam (PDLGTEMPLATE pDlgTemplate,</div><div class="line">        HWND hOwner, WNDPROC DlgProc, LPARAM lParam, Uint8 alpha);</div><div class="line"></div><div class="line"><span class="comment">/* 销毁透明主窗体 */</span></div><div class="line">BOOL DestroyTransparentMainWindow (HWND hWnd);</div><div class="line"></div><div class="line"><span class="comment">/* 销毁透明非模态对话框 */</span></div><div class="line">BOOL DestroyTransparentMainWindowIndirect (HWND hWnd);</div><div class="line"></div><div class="line"><span class="comment">/* 销毁透明模态对话框 */</span></div><div class="line">BOOL EndTransparentDialog (HWND hDlg, <span class="keyword">int</span> endCode);</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="实现">实现</h2>
<h3 id="数据结构">数据结构</h3>
<p>这里链表使用的是 linux 内核的链表实现。保存主窗体的链表数据结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* dc flags */</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> TRANS_NORMAL  0</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> TRANS_HAVE_SECONDARYDC  1</span></div><div class="line"></div><div class="line"><span class="comment">/* main window list */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _hwnd_list {</div><div class="line">    <span class="keyword">struct</span> list_head <span class="built_in">list</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* 主窗口句柄 */</span></div><div class="line">    HWND hwnd;</div><div class="line"></div><div class="line">    <span class="comment">/* 主窗体 dc flags</span></div><div class="line"><span class="comment">     * 如果原来主窗体有双缓冲风格则不需要手动设置，也不需要手动销毁 */</span></div><div class="line">    <span class="keyword">int</span> dc_flags;</div><div class="line">} hwnd_list_t;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* transparent window private data */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _trans_wnd_data {</div><div class="line">    <span class="keyword">struct</span> list_head hwnd_head;</div><div class="line"></div><div class="line">    <span class="comment">/* 透明窗体 alpha 值 */</span></div><div class="line">    Uint8 alpha;</div><div class="line"></div><div class="line">    <span class="comment">/* 透明窗体附加数据2</span></div><div class="line"><span class="comment">     * 原来的被用保存链表信息了，额外提供一个给应用程序使用 */</span></div><div class="line">    DWORD addData;</div><div class="line">} trans_wnd_data_t;</div><div class="line"></div></pre></td></tr></table></figure>

<h3 id="创建透明主窗体">创建透明主窗体</h3>
<p>CreateTansparentMainWindow、CreateTransparentMainWindowIndirectParam 和 TransparentDialogBoxIndirectParam 其实流程都是差不多。都是先调用对应的 MiniGUI 原有的 API，然后初始化私有数据（就是保存桌面主窗体的链表）。这里主要是就是要实现初始化私有数据，主要流程是：</p>
<ul>
<li>初始化链表（申请内存）。</li>
<li>使用 GetNextMainWindow 取得当前桌面的所有主窗体（注意要区分透明窗体自己）。使用 GetNextMainWindow（<code>HWND_NULL</code>） 做为遍历的开始就能保证 zorder。遍历结束的条件是 GetNextMainWindow 得到的句柄是 <code>HWND_NULL</code> 。</li>
<li>将遍历得到的主窗体句柄保存到链表中。</li>
<li>判断遍历到的主窗体是否有双缓冲风格，如果没有则手动帮其设置上。并设置链表中相应主窗体的 dc flags。</li>
<li>遍历完成，将链表保存到透明窗体的 adddata2 中。</li>
</ul>
<p>这里要注意一点：应该是由于是联芯修改 MiniGUI 源代码的问题，刚开始没办法更新非客户区，所以要在后面手动发送 <code>MSG_NCPAINT</code> 强制更新非客户区。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">BOOL init_transparent_data (HWND hWnd)</div><div class="line">{</div><div class="line">    HDC hdc_mainwnd;</div><div class="line">    HDC hdc_secondary;</div><div class="line">    HWND hwnd_main = <span class="number">0</span>;</div><div class="line">    trans_wnd_data_t* data = NULL;</div><div class="line">    hwnd_list_t* wnd_list = NULL;</div><div class="line"></div><div class="line">    <span class="comment">/* init transparent data */</span></div><div class="line">    data = (trans_wnd_data_t*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(trans_wnd_data_t));</div><div class="line">    <span class="keyword">if</span> ( NULL == data ) </div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line"></div><div class="line">    INIT_LIST_HEAD(&data-&gt;hwnd_head);</div><div class="line">    data-&gt;alpha = <span class="number">255</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* find all other visable main windows */</span></div><div class="line">    hwnd_main = GetNextMainWindow(HWND_NULL);</div><div class="line">    <span class="keyword">while</span> ( hwnd_main ) {</div><div class="line">        <span class="keyword">if</span> ( hwnd_main == hWnd ) {</div><div class="line">            hwnd_main = GetNextMainWindow(hwnd_main);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        wnd_list = (hwnd_list_t*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(hwnd_list_t));</div><div class="line">        wnd_list-&gt;hwnd = hwnd_main;</div><div class="line">        list_add(&wnd_list-&gt;<span class="built_in">list</span>, &data-&gt;hwnd_head);</div><div class="line"></div><div class="line">        <span class="comment">/* check if the main window whether has WS_EX_AUTOSECONDARYDC */</span></div><div class="line">        <span class="keyword">if</span> ( !(GetWindowExStyle(hwnd_main) & WS_EX_AUTOSECONDARYDC) ) {</div><div class="line">            hdc_mainwnd = GetDC(hwnd_main);</div><div class="line">            hdc_secondary = CreateCompatibleDC(hdc_mainwnd);</div><div class="line">            SetSecondaryDC(hwnd_main, hdc_secondary, on_update_normal);</div><div class="line">            ReleaseDC(hdc_mainwnd);</div><div class="line"></div><div class="line">            wnd_list-&gt;dc_flags = TRANS_NORMAL;</div><div class="line">            IncludeWindowExStyle(hwnd_main, WS_EX_AUTOSECONDARYDC);</div><div class="line"></div><div class="line">            <span class="comment">/* make main window draw on the secondary dc */</span></div><div class="line">            UpdateWindow(hwnd_main, TRUE);</div><div class="line">        }</div><div class="line">        <span class="keyword">else</span> {</div><div class="line">            wnd_list-&gt;dc_flags = TRANS_HAVE_SECONDARYDC;</div><div class="line">            hdc_secondary = GetSecondaryDC(hwnd_main);</div><div class="line">            SetSecondaryDC(hwnd_main, hdc_secondary, on_update_normal);</div><div class="line">        }</div><div class="line">        </div><div class="line">        hwnd_main = GetNextMainWindow(hwnd_main);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* make window to draw */</span></div><div class="line">    ShowWindow(hWnd, SW_SHOWNORMAL);</div><div class="line"></div><div class="line">    <span class="comment">/* set secondary dc update callback function */</span></div><div class="line">    hdc_secondary = GetSecondaryDC(hWnd);</div><div class="line">    SetSecondaryDC(hWnd, hdc_secondary, on_update_transparent);</div><div class="line"></div><div class="line">    <span class="comment">/* store the tranparent data */</span></div><div class="line">    SetWindowAdditionalData2(hWnd, (DWORD)data);</div><div class="line"></div><div class="line">    <span class="comment">/* update the no-client */</span></div><div class="line">    SendMessage(hWnd, MSG_NCPAINT, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> TRUE;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<h3 id="销毁透明主窗体">销毁透明主窗体</h3>
<p>DestroyTransparentMainWindow、DestroyTransparentMainWindowIndirect 和 EndTransparentDialog 的流程也差不多的。都是先销毁私有数据（就是保存桌面主窗体的链表），然后再调用 MiniGUI 对应的 API 销毁。这里主要销毁私有数据，主要流程是：</p>
<ul>
<li>遍历链表，查看主窗体的 dc flags 标志，看主窗体原来是否有双缓冲。如果没有则手动删除双缓冲数据，并还原主窗体设置。</li>
<li>逐一删除链表的节点，释放链表节点内存。</li>
<li>最后删除链表本身内存。</li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">BOOL deinit_transparent_data (HWND hWnd)</div><div class="line">{</div><div class="line">    <span class="keyword">if</span> (HWND_INVALID == hWnd)</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line"></div><div class="line">    HDC hdc_secondary;</div><div class="line">    trans_wnd_data_t* data = (trans_wnd_data_t*)GetWindowAdditionalData2(hWnd);</div><div class="line">    hwnd_list_t* wnd_list = NULL;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( NULL == data )</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line"></div><div class="line">    <span class="comment">/* free transparent data */</span></div><div class="line">    <span class="keyword">while</span> ( !list_empty(&data-&gt;hwnd_head) ) {</div><div class="line">        wnd_list = (hwnd_list_t*)data-&gt;hwnd_head.prev;</div><div class="line"></div><div class="line">        <span class="comment">/* if it's manual set secondary dc, delete it */</span></div><div class="line">        <span class="keyword">if</span> (HWND_INVALID != wnd_list-&gt;hwnd && TRANS_NORMAL == wnd_list-&gt;dc_flags) {</div><div class="line">            hdc_secondary = GetSecondaryDC(wnd_list-&gt;hwnd);</div><div class="line">            SetSecondaryDC(wnd_list-&gt;hwnd, HDC_SCREEN, ON_UPDSECDC_DONOTHING);</div><div class="line">        }</div><div class="line"></div><div class="line">        list_del(data-&gt;hwnd_head.prev);</div><div class="line">        <span class="built_in">free</span>(wnd_list);</div><div class="line">    }</div><div class="line">    <span class="built_in">free</span>(data);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> TRUE;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<h3 id="透明窗体更新">透明窗体更新</h3>
<p>由于能够支持在创建透明窗体后继续创建非透明主窗体，以及先销毁非透明主窗体。所以需要时时检测是否有新非透明窗体创建，或是有存在的非透明窗体销毁，然后更新保存非透明主窗体的链表。然后更新方式就和前面解决方案里说的是一样的了。更新一次的流程是：</p>
<ul>
<li>使用 GetNextMainWindow 遍历现有的主窗体，和链表中保存的窗体比较，以检查是否有新窗体创建或是有原有的窗体销毁。</li>
<li>如果检测出有新窗体创建或是有原有窗体销毁，则按照 zorder 重新构建链表。</li>
<li>遍历链表中的主窗体，判断这些窗体的区域是否与透明窗体的更新区域相交。如果相交则将对应区域的非透明窗体的图像 BitBlt 到透明窗体的区域（这里就解释了为什么需要桌面上所有的非透明窗体都是双缓冲，以及保存必须按照 zorder）。</li>
<li>最后根据透明窗体的 alpha 值，设置透明窗体 memdc 的 src alpha，然后 BitBlt 透明窗体的 memdc 。</li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> rebuild_trans_wnd_data (HWND hWnd)</div><div class="line">{</div><div class="line">    HWND hwnd_main;</div><div class="line">    <span class="keyword">struct</span> list_head* i;</div><div class="line">    <span class="keyword">struct</span> list_head  new_head;</div><div class="line">    hwnd_list_t* wnd_list;</div><div class="line">    trans_wnd_data_t* data = (trans_wnd_data_t*)GetWindowAdditionalData2(hWnd);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( NULL == data )</div><div class="line">        <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* rebuild the main window list according to zorder */</span></div><div class="line">    INIT_LIST_HEAD(&new_head);</div><div class="line"></div><div class="line">    hwnd_main = GetNextMainWindow(HWND_NULL);</div><div class="line">    <span class="keyword">while</span> ( hwnd_main ) {</div><div class="line">        <span class="keyword">if</span> ( hwnd_main == hWnd ) {</div><div class="line">            hwnd_main = GetNextMainWindow(hwnd_main);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* keep the main window property */</span></div><div class="line">        list_for_each(i, &data-&gt;hwnd_head) {</div><div class="line">            wnd_list = (hwnd_list_t *)i;</div><div class="line">        </div><div class="line">            <span class="comment">/* destroy the prev list and build tmp list */</span></div><div class="line">            <span class="keyword">if</span> ( hwnd_main == wnd_list-&gt;hwnd ) {</div><div class="line">                list_del(i);</div><div class="line">                list_add(i, &new_head);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        hwnd_main = GetNextMainWindow(hwnd_main);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* build the new main window list */</span></div><div class="line">    INIT_LIST_HEAD(&data-&gt;hwnd_head);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> ( !list_empty(&new_head) ) {</div><div class="line">        i = new_head.prev;</div><div class="line">        list_del(new_head.prev);</div><div class="line">        list_add(i, &data-&gt;hwnd_head);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">BOOL check_normal_mainwnd (HWND hWnd)</div><div class="line">{</div><div class="line">    BOOL is_exist = FALSE; </div><div class="line">    HDC hdc_mainwnd;</div><div class="line">    HDC hdc_secondary;</div><div class="line">    HWND hwnd_main;</div><div class="line"></div><div class="line">    <span class="keyword">struct</span> list_head* i;</div><div class="line">    hwnd_list_t* wnd_list;</div><div class="line">    trans_wnd_data_t* data = (trans_wnd_data_t*)GetWindowAdditionalData2(hWnd);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( NULL == data )</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/* check whehter there is an new main window created */</span></div><div class="line">    hwnd_main = GetNextMainWindow(HWND_NULL);</div><div class="line">    <span class="keyword">while</span> ( hwnd_main ) {</div><div class="line">        <span class="keyword">if</span> ( hwnd_main == hWnd ) {</div><div class="line">            hwnd_main = GetNextMainWindow(hwnd_main);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        is_exist = FALSE;</div><div class="line"></div><div class="line">        list_for_each(i, &data-&gt;hwnd_head) {</div><div class="line">            wnd_list = (hwnd_list_t *)i;</div><div class="line">        </div><div class="line">            <span class="keyword">if</span> ( wnd_list-&gt;hwnd == hwnd_main ) {</div><div class="line">                is_exist = TRUE;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* this main window is new created */</span></div><div class="line">        <span class="keyword">if</span> ( FALSE == is_exist ) {</div><div class="line">            wnd_list = (hwnd_list_t*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(hwnd_list_t));</div><div class="line">            wnd_list-&gt;hwnd = hwnd_main;</div><div class="line">            list_add(&wnd_list-&gt;<span class="built_in">list</span>, &data-&gt;hwnd_head);</div><div class="line">            </div><div class="line">            <span class="comment">/* check if the main window whether has WS_EX_AUTOSECONDARYDC */</span></div><div class="line">            <span class="keyword">if</span> ( !(GetWindowExStyle(hwnd_main) & WS_EX_AUTOSECONDARYDC) ) {</div><div class="line">                hdc_mainwnd = GetDC(hwnd_main);</div><div class="line">                hdc_secondary = CreateCompatibleDC(hdc_mainwnd);</div><div class="line">                SetSecondaryDC(hwnd_main, hdc_secondary, on_update_normal);</div><div class="line">                ReleaseDC(hdc_mainwnd);</div><div class="line"></div><div class="line">                wnd_list-&gt;dc_flags = TRANS_NORMAL;</div><div class="line">                IncludeWindowExStyle(hwnd_main, WS_EX_AUTOSECONDARYDC);</div><div class="line">            }</div><div class="line">            <span class="keyword">else</span> {</div><div class="line">                wnd_list-&gt;dc_flags = TRANS_HAVE_SECONDARYDC;</div><div class="line">                hdc_secondary = GetSecondaryDC(hwnd_main);</div><div class="line">                SetSecondaryDC(hwnd_main, hdc_secondary, on_update_normal);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">/* must rebuild the main window list */</span></div><div class="line">            rebuild_trans_wnd_data(hWnd);</div><div class="line"></div><div class="line">            <span class="comment">/* this is only can create one main window once */</span></div><div class="line">            <span class="keyword">return</span> TRUE;</div><div class="line">        }</div><div class="line">        </div><div class="line">        hwnd_main = GetNextMainWindow(hwnd_main);</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/* check whether there is an exist main window destroyed */</span></div><div class="line">    list_for_each(i, &data-&gt;hwnd_head) {</div><div class="line">        wnd_list = (hwnd_list_t *)i;</div><div class="line">        is_exist = FALSE;</div><div class="line"></div><div class="line">        hwnd_main = GetNextMainWindow(HWND_NULL);</div><div class="line">        <span class="keyword">while</span> ( hwnd_main ) {</div><div class="line">            <span class="keyword">if</span> ( hwnd_main == hWnd ) {</div><div class="line">                hwnd_main = GetNextMainWindow(hwnd_main);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ( wnd_list-&gt;hwnd == hwnd_main ) {</div><div class="line">                is_exist = TRUE;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            hwnd_main = GetNextMainWindow(hwnd_main);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* this main window destroyed */</span></div><div class="line">        <span class="keyword">if</span> ( FALSE == is_exist ) {</div><div class="line">            list_del(i);</div><div class="line">            <span class="built_in">free</span>(wnd_list);</div><div class="line"></div><div class="line">            <span class="comment">/* this is only can destroy one main window once */</span></div><div class="line">            <span class="keyword">return</span> TRUE;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* no new create main window, no main window destroyed */</span></div><div class="line">    <span class="keyword">return</span> FALSE;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> on_update_transparent (HWND hWnd, HDC secondary_dc,HDC real_dc,</div><div class="line">        <span class="keyword">const</span> RECT* secondary_rc, <span class="keyword">const</span> RECT* real_rc, <span class="keyword">const</span> RECT* main_update_rc)</div><div class="line">{</div><div class="line">    RECT update_rc;</div><div class="line">    RECT normal_rc;</div><div class="line">    HDC hdc_normal = <span class="number">0</span>;</div><div class="line">    HDC hdc_trans = <span class="number">0</span>;</div><div class="line">    PCLIPRGN pRgn = NULL;</div><div class="line">    HWND hwnd_normal;</div><div class="line">    <span class="comment">/* the param hWnd can be an control handle, so get the main window handle */</span></div><div class="line">    HWND hwnd_trans = GetMainWindowHandle(hWnd);</div><div class="line">    trans_wnd_data_t* data = (trans_wnd_data_t*)GetWindowAdditionalData2(hwnd_trans);</div><div class="line"></div><div class="line">    <span class="keyword">struct</span> list_head* i;</div><div class="line">    hwnd_list_t* wnd_list;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( NULL == data )</div><div class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* check whether has an new main window */</span></div><div class="line">    <span class="keyword">if</span> ( TRUE == check_normal_mainwnd(hwnd_trans) ) {</div><div class="line">        InvalidateRect(hwnd_trans, NULL, TRUE);</div><div class="line">        SendNotifyMessage(hwnd_trans, MSG_NCPAINT, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/* get the screen dc(limit in window rect) */</span></div><div class="line">    hdc_trans = GetDC(hwnd_trans);</div><div class="line"></div><div class="line">    <span class="comment">/* update desktop to the transparent */</span></div><div class="line">    update_rc = *main_update_rc;</div><div class="line">    </div><div class="line">    WindowToScreen(hwnd_trans, &update_rc.left,  &update_rc.top);</div><div class="line">    WindowToScreen(hwnd_trans, &update_rc.right, &update_rc.bottom);</div><div class="line"></div><div class="line">    SendMessage(HWND_DESKTOP, MSG_ERASEDESKTOP, <span class="number">0</span>, (LPARAM)&update_rc);</div><div class="line"></div><div class="line">    <span class="comment">/* make the update background dc has the same clip region with the transparent window dc.</span></div><div class="line"><span class="comment">     * note: it's only update no-client to set the clip region.</span></div><div class="line"><span class="comment">     * real_rc equal to main_update_rc means there is no-client, </span></div><div class="line"><span class="comment">     * except transparent window don't contain caption and border.</span></div><div class="line"><span class="comment">     * but if the transparent window don't contain caption and border there is no worry to about it. */</span></div><div class="line">    <span class="keyword">if</span> ( EqualRect((<span class="keyword">const</span> RECT*)real_rc, (<span class="keyword">const</span> RECT*)main_update_rc) ) {</div><div class="line">        pRgn = CreateClipRgn();</div><div class="line">        <span class="keyword">if</span> ( NULL == pRgn ) {</div><div class="line">            <span class="built_in">fprintf</span>(stderr, <span class="string">"on_update_transparent: CreateClipRgn failed\n"</span>);</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> ( -<span class="number">1</span> != GetClipRegion(real_dc, pRgn) ) { </div><div class="line">            SelectClipRegion(hdc_trans, (<span class="keyword">const</span> CLIPRGN*)pRgn);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* update all visable main window to the transparent*/</span></div><div class="line">    list_for_each(i, &data-&gt;hwnd_head) {</div><div class="line">        wnd_list = (hwnd_list_t *)i;</div><div class="line">        hwnd_normal = wnd_list-&gt;hwnd;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ( hwnd_normal != HWND_INVALID ) {</div><div class="line">            <span class="comment">/* this API return screen coordinates */</span></div><div class="line">            GetWindowRect(hwnd_normal, &normal_rc);</div><div class="line"></div><div class="line">            update_rc = *main_update_rc;</div><div class="line"></div><div class="line">            WindowToScreen(hwnd_trans, &update_rc.left,  &update_rc.top);</div><div class="line">            WindowToScreen(hwnd_trans, &update_rc.right, &update_rc.bottom);</div><div class="line"></div><div class="line">            <span class="comment">/* if update rect intersect normal window, then update it */</span></div><div class="line">            <span class="keyword">if</span> ( TRUE == DoesIntersect(&update_rc, &normal_rc) ) {</div><div class="line">                ScreenToWindow(hwnd_normal, &update_rc.left,  &update_rc.top);</div><div class="line">                ScreenToWindow(hwnd_normal, &update_rc.right, &update_rc.bottom);</div><div class="line"></div><div class="line">                hdc_normal = GetSecondaryDC(hwnd_normal);</div><div class="line">                BitBlt(hdc_normal, update_rc.left, update_rc.top, RECTW(update_rc), RECTH(update_rc), </div><div class="line">                        hdc_trans, main_update_rc-&gt;left, main_update_rc-&gt;top, <span class="number">0</span>);</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    ReleaseDC(hdc_trans);</div><div class="line"></div><div class="line">    <span class="comment">/* blit the transparent window */</span></div><div class="line">    SetMemDCAlpha(secondary_dc, MEMDC_FLAG_SRCALPHA, data-&gt;alpha);</div><div class="line">    BitBlt(secondary_dc, secondary_rc-&gt;left, secondary_rc-&gt;top, </div><div class="line">            RECTWP(secondary_rc), RECTHP(secondary_rc),</div><div class="line">            real_dc, real_rc-&gt;left, real_rc-&gt;top, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ( NULL != pRgn )</div><div class="line">        DestroyClipRgn(pRgn);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<h3 id="非透明窗体更新">非透明窗体更新</h3>
<p>非透明窗体的更新函数除了更新自己的图像以为，还需要通知透明窗体，让其也更新。主要流程是：</p>
<ul>
<li>使用 GetNextMainWindow 遍历现有的主窗体查找到有 WS_EX_TRANSPARENT 的透明窗体（注意区分自己）。</li>
<li>判断非透明窗体的更新区域是否与透明窗体相交。如果相交则调用 InvalidateRect 和 SendNotifyMessage 让透明窗体的客户区和非客户区重绘。</li>
<li>BitBlt 将自己的 memdc 输出到屏幕上。</li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> on_update_normal (HWND hWnd, HDC secondary_dc,HDC real_dc,</div><div class="line">        <span class="keyword">const</span> RECT* secondary_rc, <span class="keyword">const</span> RECT* real_rc, <span class="keyword">const</span> RECT* main_update_rc)</div><div class="line">{</div><div class="line">    RECT trans_rc;</div><div class="line">    RECT trans_nc_rc = *main_update_rc;</div><div class="line">    RECT update_rc = *main_update_rc;</div><div class="line">    HWND hwnd_normal = GetMainWindowHandle(hWnd);</div><div class="line">    HWND hwnd_trans = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* find out transparent main window to update it */</span></div><div class="line">    hwnd_trans = GetNextMainWindow(HWND_NULL);</div><div class="line">    <span class="keyword">while</span> ( hwnd_trans ) {</div><div class="line">        <span class="keyword">if</span> (hwnd_trans == hWnd) {</div><div class="line">            hwnd_trans = GetNextMainWindow(hwnd_trans);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ( GetWindowExStyle(hwnd_trans) & WS_EX_TRANSPARENT ) {</div><div class="line">            <span class="comment">/* this API return screen coordinates */</span></div><div class="line">            GetWindowRect(hwnd_trans, &trans_rc);</div><div class="line"></div><div class="line">            WindowToScreen(hwnd_normal, &update_rc.left,  &update_rc.top);</div><div class="line">            WindowToScreen(hwnd_normal, &update_rc.right, &update_rc.bottom);</div><div class="line"></div><div class="line">            <span class="comment">/* if update rect intersect transparent window, then update it */</span></div><div class="line">            <span class="keyword">if</span> ( TRUE == DoesIntersect(&update_rc, &trans_rc) ) {</div><div class="line">                ScreenToClient(hwnd_trans, &update_rc.left,  &update_rc.top);</div><div class="line">                ScreenToClient(hwnd_trans, &update_rc.right, &update_rc.bottom);</div><div class="line"></div><div class="line">                WindowToScreen(hwnd_normal, &trans_nc_rc.left,  &trans_nc_rc.top);</div><div class="line">                WindowToScreen(hwnd_normal, &trans_nc_rc.right, &trans_nc_rc.bottom);</div><div class="line"></div><div class="line">                ScreenToWindow(hwnd_trans, &trans_nc_rc.left,  &trans_nc_rc.top);</div><div class="line">                ScreenToWindow(hwnd_trans, &trans_nc_rc.right, &trans_nc_rc.bottom);</div><div class="line"></div><div class="line">                <span class="comment">//InvalidateRect(hwnd_trans, &update_rc, TRUE);</span></div><div class="line">                InvalidateRect(hwnd_trans, NULL, TRUE);</div><div class="line">                <span class="comment">//SendNotifyMessage(hwnd_trans, MSG_NCPAINT, 0, (LPARAM)&trans_nc_rc);</span></div><div class="line">                SendNotifyMessage(hwnd_trans, MSG_NCPAINT, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            }</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        hwnd_trans = GetNextMainWindow(hwnd_trans);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* blit the normal window */</span></div><div class="line">    BitBlt(secondary_dc, secondary_rc-&gt;left, secondary_rc-&gt;top, </div><div class="line">            RECTWP(secondary_rc), RECTHP(secondary_rc),</div><div class="line">            real_dc, real_rc-&gt;left, real_rc-&gt;top, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="使用范例">使用范例</h2>
<p>使用起来非简单，但有如下约定：</p>
<ul>
<li>必须使用对应的透明主窗体创建接口创建透明主窗体。</li>
<li>必须使用对应的透明主窗体销毁接口销毁透明主窗体。</li>
<li>只能创建一个透明主窗体。要创建下一个透明窗体时，必须要先销毁之前创建的。</li>
</ul>
<p>具体例子见 <a href="http://s.yunio.com/HRfqEc" title="附件" target="_blank" rel="external">附件</a> 的 main.c 。(哎呦，好像链接失效了，哪天有空去翻翻看代码还不在不)</p>
<hr>
<h2 id="2011-2-16：改动1——支持逐点_alpha（包括在缓冲dc中）">2011.2.16：改动1——支持逐点 alpha（包括在缓冲dc中）</h2>
<h3 id="问题-1">问题</h3>
<ul>
<li><p>在之前的实现中是没办法支持逐点 alpha 的（典型的例子使用 png 图片进行贴图）。因为在目前 MiniGUI 的 BitBlt 实现中，如果有开启了层 alpha （透明窗体的透明实现就是应用层 alpha），就会忽略掉逐点 alpha。典型问题就是如果你用 png 图片进行贴图，然后使用  BitBlt 又开启了 MEMDC_FLAGS_SRCALPHA 的话，就会看到你 png 图片本来透明的部分变黑（一般是 memdc 的默认颜色）。 </p>
</li>
<li><p>关于应用逐点 alpha 还有一个问题。如果是在 memdc 中使用的话，那么还有一个默认 dc 背景颜色的问题。当把 memdc BitBlt 到屏幕 dc 上的时候，逐点 alpha 会透出 memdc 默认的背景颜色（一般是黑色）。如果是在屏幕 dc 上，可以通过不绘制 MiniGUI 的背景来解决（截获 <code>MSG_ERASEBKGND</code> ，然后直接返回）。</p>
</li>
</ul>
<h3 id="解决办法">解决办法</h3>
<p>从以上的问题直接得到的解决办法是：</p>
<ul>
<li><p>多建立一个 memdc ，然后先 BitBlt 进行逐点 alpha 混合，然后再 BitBlt 到屏幕 dc，进行层 alpha 混合。</p>
</li>
<li><p>在 32bit 颜色格式下，可以使用完全透明的颜色，将 memdc 的背景填充一次，这样在 alpha 混合的时候就可以完全透过 memdc 的背景色了。不过这个要求是 32bit 颜色格式的。16bit 色深下十分麻烦，要在 32bit 的memdc 上进行绘制，然后再转到 16bit 的屏幕 dc 上。这个就要求所有的图像加载参考 dc 都要是 32bit 的，并且所有 gdi 相关的参考 dc 都要是 32 bit 的。这个对于联芯来说，改动肯定很大，估计他是不会接受的。</p>
</li>
</ul>
<p>从上面的讨论我们可以看到其实现在透明最大的问题的就是透明的背景问题。为了解决上面的问题可以采用这样的解决办法：</p>
<ul>
<li><p>将透明窗体下窗体的图像复制到透明窗体的缓存 dc 中做为透明的背景（这步可以在透明窗体的 <code>MSG_ERASEBKGND</code> 的消息里进行）。然后在缓冲 dc 里进行带逐点 alpha 的绘制。最后再用带层 alpha BitBlt 到屏幕 dc 上。这样缓冲 dc 里已经有正确的背景了，而且也已经正确的透过了，所以就算没了逐点 alpha 也是正确的了。并且这样还能解决 16bit 色下 memdc 透过默认背景的问题。</p>
</li>
<li><p>这样在方案实现中增加2个接口：DefaultTransparentMainWinProc 和 DefaultTransparentDialogProc 用来封装 <code>MSG_ERASEBKGND</code> 消息处理。使用透明窗体要使用这2个接口替代 MiniGUI 原来的 DefaultMainWinProc 和 DefaultDialogProc 。</p>
</li>
</ul>
<h3 id="本质问题分析">本质问题分析</h3>
<p>上面的实现方式算是比较偏的了（也包括最开始的通过双缓冲来更新透明窗体的背景的实现）。其实如果要从正常逻辑实现透明窗体的话，应该提供如下2个条件：</p>
<ul>
<li>z 序支持，从底到上，逐步重绘透明窗体的背景。</li>
<li>32 bit 颜色格式。</li>
</ul>
<p>更新下实现代码和示例。最开始写的代码有些地方不正确的。附近里的才是最新的。顺带上个效果图，show 一下，现在的 MiniGUI 也能做到这样的效果哦。 :-D</p>
<p><img src="https://mingming-killer.github.io/img/pics/minigui/leadcore-trans-window/1.png" alt=""></p>
<h2 id="2011-3-24：改动2——一些小修正">2011.3.24：改动2——一些小修正</h2>
<h3 id="问题-2">问题</h3>
<ul>
<li>很多无需收集的窗体，例如 窗口区域为0，不可见的。（联芯他们的 goku 框架里后台一大堆这样的窗口 <code>-_-||</code>）</li>
<li>被隐藏的窗口绘制不正确。</li>
<li>给普通窗体动态添加双缓冲，第一次更新双缓冲中的图片，导致闪烁。</li>
<li>透明窗体刷新速度慢</li>
</ul>
<h3 id="解决办法-1">解决办法</h3>
<ul>
<li>这个可以在透明窗体的更新函数里判断下，如果是不可见的窗体着跳过这个窗体的更新：</li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> on_update_transparent (HWND hWnd, HDC secondary_dc, HDC real_dc,</div><div class="line">        <span class="keyword">const</span> RECT* secondary_rc, <span class="keyword">const</span> RECT* real_rc, <span class="keyword">const</span> RECT* main_update_rc)</div><div class="line">{</div><div class="line">    ... ...</div><div class="line"></div><div class="line">    <span class="comment">/* update all visable main window to the transparent */</span></div><div class="line">    list_for_each(i, &data-&gt;hwnd_head) {</div><div class="line">        wnd_list = (hwnd_list_t *)i;</div><div class="line">        hwnd_normal = wnd_list-&gt;hwnd;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ( hwnd_normal != HWND_INVALID && IsWindowVisible(hwnd_normal) ) {</div><div class="line">            <span class="comment">/* this API return screen coordinates */</span></div><div class="line">            GetWindowRect(hwnd_normal, &normal_rc);</div><div class="line"></div><div class="line">            ... ...</div><div class="line">        }</div><div class="line">    }</div><div class="line">    </div><div class="line">    ... ...</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<ul>
<li><p>这个和上面一样的解决办法</p>
</li>
<li><p>这个在第一次更新时图像到双缓冲上的时候，应该不让双缓冲更新到屏幕上，也就是把双缓冲更新函数设置成 DONOTHING ：</p>
</li>
</ul>
<p>代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> BOOL init_transparent_data (HWND hWnd)</div><div class="line">{</div><div class="line">    ... ...</div><div class="line">    </div><div class="line">        <span class="comment">/* check if the main window whether has WS_EX_AUTOSECONDARYDC */</span></div><div class="line">        <span class="keyword">if</span> ( !(GetWindowExStyle(hwnd_main) & WS_EX_AUTOSECONDARYDC) ) {</div><div class="line">            hdc_mainwnd = GetDC(hwnd_main);</div><div class="line">            hdc_secondary = CreateCompatibleDC(hdc_mainwnd);</div><div class="line"></div><div class="line">            <span class="comment">/* just update the secondary dc, not update the real dc</span></div><div class="line"><span class="comment">             * this cat avoid screen blink */</span></div><div class="line">            SetSecondaryDC(hwnd_main, hdc_secondary, ON_UPDSECDC_DONOTHING);</div><div class="line"></div><div class="line">            ReleaseDC(hdc_mainwnd);</div><div class="line"></div><div class="line">            wnd_list-&gt;dc_flags = TRANS_NORMAL;</div><div class="line">            IncludeWindowExStyle(hwnd_main, WS_EX_AUTOSECONDARYDC);</div><div class="line"></div><div class="line">            <span class="comment">/* update the image in the secondary dc */</span></div><div class="line">            UpdateWindow(hwnd_main, TRUE);</div><div class="line">            SetSecondaryDC(hwnd_main, hdc_secondary, on_update_normal);</div><div class="line">        }</div><div class="line"></div><div class="line">    ... ...</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<ul>
<li>这个在联芯的实际使用情况中还是有点明显的。根据他们提出改进建议，在他们的使用情况中，有很大几率的情况会遇到在刷新链表中，某个普通窗体的更新区域（普通窗体与透明窗体相交的区域）正好是透明窗体的更新区域，这样就不需在更新后面的普通窗体的背景到透明窗体中来了。不过这样需要将保存的链表反序遍历，并且比较找到是否存在这样的普通窗体，还要记下这个链表位置（或者说记下这个窗体的句柄？？）。仔细分析下，这种思路，在某些情况下应该是能提高效率的。不过我暂时没有实现这个，据说联芯他们在自己改。</li>
</ul>
<p><img src="https://mingming-killer.github.io/img/pics/minigui/leadcore-trans-window/2.png" alt=""></p>
<h3 id="代码路径">代码路径</h3>
<p>最开始的代码已经有很多地方不对了。这里就不在上传代码在本文档里了。现在的代码已经在 svn 中（在 3rd-party/transparent 里，devsrv 就是 10.10.0.9）：</p>
<pre>
URL: svn+ssh://devsrv/home/projects/svn/minigui/branches/rel-3-0-arena
</pre>

<h2 id="2011-4-19：改动3——支持动态设置/去除窗口透明属性">2011.4.19：改动3——支持动态设置/去除窗口透明属性</h2>
<h3 id="问题-3">问题</h3>
<p>联芯需要新加一系列动态设置透明窗体属性与动态去掉透明窗体属性的接口。他们需要有个需求，是因为想绕过透明窗体实现方案中的同时只能存在一个透明窗体的限制。他们想在透明窗体存在的时候，弹出一个普通窗体，然后去掉原来透明窗体的属性，最后再给弹出来的普通窗体加上透明属性。</p>
<h3 id="解决办法-2">解决办法</h3>
<p>这个就目前的实现方法来说，并不是很难实现，灵活的运用现有的代码就能很轻松的实现了。新增加一个接口就可以了：</p>
<p><pre><br>BOOL EnableWindowTransparent(HWND hWnd, BOOL isEnable);<br></pre><br>可以通过后一个 BOOL 参数来决定是将普通窗体变成透明窗体，还是把透明窗体变成普通窗体。而这个函数内部可以简单调用内部2个实现函数就可以了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">BOOL EnableWindowTransparent(HWND hWnd, BOOL isEnable)</div><div class="line">{</div><div class="line">    <span class="keyword">if</span> (HWND_INVALID == hWnd)</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (TRUE == isEnable)</div><div class="line">        <span class="keyword">return</span> enable_win_transparent(hWnd);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> disable_win_transparent(hWnd);</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>至于内部的这个函数实现的流程如下：</p>
<ul>
<li><p>enable_win_transparent:</p>
<ol>
<li>如果当前窗体已经具有透明窗体属性，者直接返回。</li>
<li>判断当前窗体是否有双缓冲，如果没有，这动态的设置上双缓冲属性。</li>
<li>调用 <code>init_transparent_data()</code> 申请并初始化透明窗体数据。</li>
<li>更新当前窗体，使其呈现出透明窗体特性。</li>
</ol>
</li>
<li><p>disable_win_transparent:</p>
<ol>
<li>如果当前窗体</li>
<li>去除当前窗口</li>
</ol>
</li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/minigui/">minigui</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/MiniGUI/">MiniGUI</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.light3moon.com/2015/01/21/联芯透明窗体支持方案/" data-title="联芯透明窗体支持方案 | Light.Moon" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/01/25/Java 备忘/" title="Java 备忘">
  <strong>上一篇:</strong><br/>
  <span>
  Java 备忘</span>
</a>
</div>


<div class="next">
<a href="/2015/01/21/STi7167 GAL 开发笔记/"  title="STi7167 GAL 开发笔记">
 <strong>下一篇:</strong><br/> 
 <span>STi7167 GAL 开发笔记
</span>
</a>
</div>

</nav>


	
<section class="comment">
	<div class="ds-thread" data-thread-key="联芯透明窗体支持方案" data-title="联芯透明窗体支持方案" 
      data-author-key="mingming" data-limit=10
      data-url="light3moon.com/2015/01/21/联芯透明窗体支持方案/">
    </div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#需求"><span class="toc-number">1.</span> <span class="toc-text">需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-number">2.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案"><span class="toc-number">3.</span> <span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#限制条件"><span class="toc-number">4.</span> <span class="toc-text">限制条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#接口"><span class="toc-number">5.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-number">6.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据结构"><span class="toc-number">6.1.</span> <span class="toc-text">数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建透明主窗体"><span class="toc-number">6.2.</span> <span class="toc-text">创建透明主窗体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#销毁透明主窗体"><span class="toc-number">6.3.</span> <span class="toc-text">销毁透明主窗体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#透明窗体更新"><span class="toc-number">6.4.</span> <span class="toc-text">透明窗体更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#非透明窗体更新"><span class="toc-number">6.5.</span> <span class="toc-text">非透明窗体更新</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用范例"><span class="toc-number">7.</span> <span class="toc-text">使用范例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2011-2-16：改动1——支持逐点_alpha（包括在缓冲dc中）"><span class="toc-number">8.</span> <span class="toc-text">2011.2.16：改动1——支持逐点 alpha（包括在缓冲dc中）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题-1"><span class="toc-number">8.1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决办法"><span class="toc-number">8.2.</span> <span class="toc-text">解决办法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#本质问题分析"><span class="toc-number">8.3.</span> <span class="toc-text">本质问题分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2011-3-24：改动2——一些小修正"><span class="toc-number">9.</span> <span class="toc-text">2011.3.24：改动2——一些小修正</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题-2"><span class="toc-number">9.1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决办法-1"><span class="toc-number">9.2.</span> <span class="toc-text">解决办法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码路径"><span class="toc-number">9.3.</span> <span class="toc-text">代码路径</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2011-4-19：改动3——支持动态设置/去除窗口透明属性"><span class="toc-number">10.</span> <span class="toc-text">2011.4.19：改动3——支持动态设置/去除窗口透明属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题-3"><span class="toc-number">10.1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决办法-2"><span class="toc-number">10.2.</span> <span class="toc-text">解决办法</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android-Development/" title="Android Development">Android Development<sup>35</sup></a></li>
		
			<li><a href="/categories/Android-Framework/" title="Android Framework">Android Framework<sup>47</sup></a></li>
		
			<li><a href="/categories/Basics-Knowledge/" title="Basics Knowledge">Basics Knowledge<sup>11</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>25</sup></a></li>
		
			<li><a href="/categories/MiniGUI/" title="MiniGUI">MiniGUI<sup>12</sup></a></li>
		
			<li><a href="/categories/Other/" title="Other">Other<sup>8</sup></a></li>
		
			<li><a href="/categories/Server/" title="Server">Server<sup>1</sup></a></li>
		
			<li><a href="/categories/Window/" title="Window">Window<sup>10</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		
			<li><a href="/tags/android/" title="android">android<sup>82</sup></a></li>
		
			<li><a href="/tags/basics/" title="basics">basics<sup>11</sup></a></li>
		
			<li><a href="/tags/install/" title="install">install<sup>9</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>28</sup></a></li>
		
			<li><a href="/tags/minigui/" title="minigui">minigui<sup>13</sup></a></li>
		
			<li><a href="/tags/opengl/" title="opengl">opengl<sup>3</sup></a></li>
		
			<li><a href="/tags/other/" title="other">other<sup>5</sup></a></li>
		
			<li><a href="/tags/server/" title="server">server<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>5</sup></a></li>
		
			<li><a href="/tags/window/" title="window">window<sup>11</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">哥的后勤处 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-qqzone"></i> <a href="http://user.qzone.qq.com/544630305" target="_blank">QQ 空间</a></li>
      <li><i class="fa fa-github"></i> <a href="https://github.com/mingming-killer" target="_blank">GitHub</a></li>
      
        
          <li><i class="fa fa-analytics"></i> <a href="http://tongji.baidu.com/web/welcome/ico?s=fa045dbd45ffce238b146e00f91ba6a3" target="_blank">战斗力</a></li>
        
      
      <li><i class="fa fa-markdown-help"></i> <a href="http://zh.wikipedia.org/wiki/Markdown" target="_blank">Makrdown</a></li>
    </ul>
</div>


  <div class="commentlist">
  <p class="asidetitle">最近冒泡的小伙伴 ╰(●&#39;◡&#39;●)╮</p>
    <ul>
      <ul class="ds-recent-comments" 
        data-num-items="6" 
        data-show-avatars="1" 
        data-show-title="1"   
        data-show-time="1" 
        data-show-admin="1" 
        data-excerpt-length="30">
      </ul>
      <!-- duoshou js begin load, one page only load once -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"mingming"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
      <!-- duoshou js load end -->
    </ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-book"></i> <a href="http://taoyuanxiaoqi.com" target="_blank">桃园小七的博客</a></li>
      <li><i class="fa fa-book"></i> <a href="https://dongka.github.io" target="_blank">Dongka的博客</a></li>
    </ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
<!--
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
-->

     <!-- this is defined in footer.styl, line holder -->
	<div class="line">
	</div>
     
<!--
	<div class="social-font clearfix">
		
		
		
		
		
		<a href="https://github.com/mingming-killer" target="_blank" title="github"></a>
		
        	
		<a href="http://user.qzone.qq.com/544630305" target="_blank" title="qqzone"></a>
		         
	</div>
-->

		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/mingming-killer/Lightmoon" target="_blank" title="Lightmoon">Lightmoon</a> © 2019 
		
		<a href="http://www.light3moon.com" target="_blank" title="Mingming">Mingming</a>
		
		</p>

  <!-- baidu search verification -->
  
    <meta name="baidu-site-verification" content="w1BSX6yZ9k" />
  

  <!-- swiftype search verification -->
  

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"mingming"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fa045dbd45ffce238b146e00f91ba6a3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>
