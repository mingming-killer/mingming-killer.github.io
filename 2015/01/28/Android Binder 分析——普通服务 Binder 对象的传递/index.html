
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

  
    <title>Android Binder 分析——普通服务 Binder 对象的传递 | Light.Moon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Mingming">
    
    <meta name="description" content="上一篇把 SS 传递 binder 对象说了， SS 传递是要依靠 SM 的。但是普通应用的服务是没权向 SM 注册的，就是说普通应用获取普通服务的接口不能像 SS 那样，通过 SM 的接口去取。这篇就来讲讲普通应用中 binder 对象的传递。
那这篇主要就是分析这些，照例先把源代码位置啰嗦一下（">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/apple_icon.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/apple_icon.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
		<div id="header_author">
		</div>
		

         <!--
         
           <div id="imglogo">
           <a href="/"><img src="/img/logo.svg" alt="Light.Moon" title="Light.Moon"/></a>
           </div>
         
         -->

			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Light.Moon">Light.Moon</a></h1>
				<h2 class="blog-motto">三月学长的小站</h2>
			</div>

			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/1986/12/20/文章索引">索引</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					

                      <form class="search" action=http://search.light3moon.com/cse/search target="_blank">
                      <label>搜索</label>
                      <!--
                      <input name="s" type="hidden" value="undefined">
                      -->
                      <input name="s" type="hidden" value="12628367885198549364">
                      <input type="text" name="q" size="30" placeholder="搜索"> <br>

                      
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/01/28/Android Binder 分析——普通服务 Binder 对象的传递/" title="Android Binder 分析——普通服务 Binder 对象的传递" itemprop="url">Android Binder 分析——普通服务 Binder 对象的传递</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.light3moon.com" title="Mingming">Mingming</a>
    </p>
  <p class="article-time">
    <time datetime="2015-01-28T13:33:16.000Z" itemprop="datePublished">2015 1月 28</time>
    更新日期:<time datetime="2017-02-07T13:47:46.000Z" itemprop="dateModified">2017 2月 7</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Client_相关接口"><span class="toc-number">1.</span> <span class="toc-text">Client 相关接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service_相关接口"><span class="toc-number">2.</span> <span class="toc-text">Service 相关接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bindService_的实现"><span class="toc-number">3.</span> <span class="toc-text">bindService 的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务进程和服务都已经启动"><span class="toc-number">3.1.</span> <span class="toc-text">服务进程和服务都已经启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务进程已经启动，但是服务还没运行"><span class="toc-number">3.2.</span> <span class="toc-text">服务进程已经启动，但是服务还没运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务进程没有启动，服务代码也还没执行"><span class="toc-number">3.3.</span> <span class="toc-text">服务进程没有启动，服务代码也还没执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol>
		</div>
		
		<p>上一篇把 SS 传递 binder 对象说了， SS 传递是要依靠 SM 的。但是普通应用的服务是没权向 SM 注册的，就是说普通应用获取普通服务的接口不能像 SS 那样，通过 SM 的接口去取。这篇就来讲讲普通应用中 binder 对象的传递。</p>
<p>那这篇主要就是分析这些，照例先把源代码位置啰嗦一下（4.4）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># java 层 Context 相关接口</span></div><div class="line">frameworks/base/core/java/android/app/ContextImpl.java</div><div class="line">frameworks/base/core/java/android/app/LoadedApk.java</div><div class="line">frameworks/base/core/java/android/app/ActivityThread.java</div><div class="line">frameworks/base/core/java/android/content/ServiceConnection</div><div class="line"></div><div class="line"><span class="comment"># java 层 Service 相关接口</span></div><div class="line">frameworks/base/core/java/android/app/IActivityManager.java</div><div class="line">frameworks/base/core/java/android/app/ActivityManager.java</div><div class="line">frameworks/base/core/java/android/app/ActivityManagerNative.java</div><div class="line">frameworks/base/services/java/com/android/server/am/ActivityManagerService.java</div><div class="line">frameworks/base/services/java/com/android/server/am/ActiveServices.java</div><div class="line">frameworks/base/services/java/com/android/server/am/ServiceRecord.java</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="Client_相关接口">Client 相关接口</h2>
<p>还是和上一篇的一样，先从相关接口说。普通服务和 SS 不一样，好像没有 native 层相关的接口，虽然说 native 层有个 BinderService 的东西，但是没有相关绑定的接口，所以说应该没办法写 native 的普通服务。所以这里只说 java 层的。</p>
<p>要在别的进程使用普通服务提供的 IPC 接口，需要绑定服务，我们来看下绑定服务的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">bindService</span>(Intent service, ServiceConnection conn,</div><div class="line">        <span class="keyword">int</span> flags);</div><div class="line"></div></pre></td></tr></table></figure>



<p>这个是 Context 里面的接口，就是说一般在 Activity 里面可以调用这个来绑定服务。Intent 是要绑定的服务。ServiceConnection 是个接口，我们待会再说。flags 是一个标志，可以设置好几个，这里我们讨论最常见的一个： <code>BIND_AUTO_CREATE</code> 这个表示如果要绑定的服务的进程没有运行就自动启动。</p>
<p>然后我们来说说 ServiceConnection 这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServiceConnection</span> </span>{</div><div class="line">    <span class="comment">/* </span></div><div class="line"><span class="comment">     * Called when a connection to the Service has been established, with</span></div><div class="line"><span class="comment">     * the {@link android.os.IBinder} of the communication channel to the</span></div><div class="line"><span class="comment">     * Service.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * @param name The concrete component name of the service that has</span></div><div class="line"><span class="comment">     * been connected.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * @param service The IBinder of the Service's communication channel,</span></div><div class="line"><span class="comment">     * which you can now make calls on.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span>(ComponentName name, IBinder service);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Called when a connection to the Service has been lost.  This typically</span></div><div class="line"><span class="comment">     * happens when the process hosting the service has crashed or been killed.</span></div><div class="line"><span class="comment">     * This does &lt;em&gt;not&lt;/em&gt; remove the ServiceConnection itself -- this</span></div><div class="line"><span class="comment">     * binding to the service will remain active, and you will receive a call</span></div><div class="line"><span class="comment">     * to {@link #onServiceConnected} when the Service is next running.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * @param name The concrete component name of the service whose</span></div><div class="line"><span class="comment">     * connection has been lost.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span>(ComponentName name);</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>注释已经说得比较清楚了。在 onServiceConnected 中有 IBinder 对象，前面原理篇说了，这个就是 java 层的 binder 对象，有了这个就是拿到了 Bp 端对象了，就可以通过这个发起 IPC 调用了。一般来说在某个 Activity 中要 bindService，就会让这个 Activity 实现 ServiceConnection 接口，然后在 onServiceConnected 回调取到要使用的 Service 的 binder 对象，然后就完成了普通应用的 binder 对象的传递。</p>
<p>onServiceDisconnected 是告诉你服务连接中断了，在 onServiceDisconnected 中取到的 IBinder 对象无效了。这个时候可能是服务所在的进程被杀掉，或是异常退出了。这个问题后面再说，这里只讨论连接的情况，也就是 IBinder 对象的传递。</p>
<h2 id="Service_相关接口">Service 相关接口</h2>
<p>前面说了 Client 端的接口，在 Client 需要 bindService，那么 Service 这边也有相应的接口。framework 里面有一个抽象类 Service.java ，普通服务都要继承这个类，然后实现 IBinder 接口。这个 Service 是一个抽象类，它有一个比较重要的需要重载的函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> IBinder <span class="title">onBind</span>(Intent intent);</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个函数的注释太长了，意思就是说需要返回自己服务的 IBinder 对象。没错，这个返回的 IBinder 对象就是前面 Client ServiceConnection 接口 onServiceConnected 的那个参数。只不过在 Service 的 onBind 里返回的是 Bn，到了 Client 的 onServiceConnected 就变成 Bp 了（具体的可以回去看 SS 传递篇，binder 的传递过程是一样的）。</p>
<h2 id="bindService_的实现">bindService 的实现</h2>
<p>前面把接口、用法说完了。我们来看看系统的实现吧。首先我们假设有个一个普通的服务叫 SA（Service A，它在 Proc A 中），另一个普通应用 AppB（它在 Porc B 中）。现在 SA 要提供一些 IPC 接口，它首先得继承 Service ，然后实现 IBinder 接口，并且在 onBind 函数中返回自己实现的 IBinder 对象。 AppB 要调用 SA 的某个接口，那么它就得调用 Context 的 bindService，并且自己实现 ServiceConnection，在 onServiceConnected 中取得 SA 的 IBiner 对象，然后就可以通过取得的 IBinder 对象调用 SA 的 IPC 接口了。</p>
<p>Context 的 bindService 实现在 ContextImpl 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span>(Intent service, ServiceConnection conn,</div><div class="line">        <span class="keyword">int</span> flags) {</div><div class="line">    warnIfCallingFromSystemProcess();</div><div class="line">    <span class="keyword">return</span> bindServiceCommon(service, conn, flags, Process.myUserHandle());</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// 真正干活的是这个函数</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bindServiceCommon</span>(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags,</div><div class="line">        UserHandle user) {</div><div class="line">    IServiceConnection sd;</div><div class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"connection is null"</span>);</div><div class="line">    }    </div><div class="line">    <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) {</div><div class="line">        sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(),</div><div class="line">                mMainThread.getHandler(), flags);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not supported in system context"</span>);</div><div class="line">    }    </div><div class="line">    validateServiceIntent(service);</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        IBinder token = getActivityToken();</div><div class="line">        <span class="keyword">if</span> (token == <span class="keyword">null</span> && (flags&BIND_AUTO_CREATE) == <span class="number">0</span> && mPackageInfo != <span class="keyword">null</span> </div><div class="line">                && mPackageInfo.getApplicationInfo().targetSdkVersion</div><div class="line">                &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) {</div><div class="line">            flags |= BIND_WAIVE_PRIORITY;</div><div class="line">        }    </div><div class="line">        service.prepareToLeaveProcess();</div><div class="line">        <span class="keyword">int</span> res = ActivityManagerNative.getDefault().bindService(</div><div class="line">            mMainThread.getApplicationThread(), getActivityToken(),</div><div class="line">            service, service.resolveTypeIfNeeded(getContentResolver()),</div><div class="line">            sd, flags, user.getIdentifier());</div><div class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                    <span class="string">"Not allowed to bind to service "</span> + service);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> res != <span class="number">0</span>;</div><div class="line">    } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>下面的代码讲解，我会忽略很多不太重要的东西，因为 ActivityManager（AM）实在是太庞大了，如果追根究底的话，就太多了，而且容易丢掉主要的东西。首先来看看 mPackageInfo 这个东西。它是一个 LoadedApk 的变量。这个类好像是会保存一些加载了 apk 的信息，例如应用 data 目录，lib 目录等等，在这里最重要的是它保存了 service 绑定的一些信息。我们来看看下它的 getServiceDispatcher 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> IServiceConnection <span class="title">getServiceDispatcher</span>(ServiceConnection c,</div><div class="line">        Context context, Handler handler, <span class="keyword">int</span> flags) {</div><div class="line">    <span class="keyword">synchronized</span> (mServices) {</div><div class="line">        LoadedApk.ServiceDispatcher sd = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// 这个 mServices 就是连接的信息的 map 表</span></div><div class="line">        ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt; map = mServices.get(context);</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) {</div><div class="line">            sd = map.get(c);</div><div class="line">        }    </div><div class="line">        <span class="keyword">if</span> (sd == <span class="keyword">null</span>) {</div><div class="line">            <span class="comment">// 没有的话就创建一个新的</span></div><div class="line">            sd = <span class="keyword">new</span> ServiceDispatcher(c, context, handler, flags);</div><div class="line">            <span class="comment">// 然后保存起来，方便下次使用</span></div><div class="line">            <span class="keyword">if</span> (map == <span class="keyword">null</span>) {</div><div class="line">                map = <span class="keyword">new</span> ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;();</div><div class="line">                mServices.put(context, map);</div><div class="line">            }    </div><div class="line">            map.put(c, sd); </div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="comment">// 如果之前保存就直接取</span></div><div class="line">            sd.validate(context, handler);</div><div class="line">        }    </div><div class="line">        <span class="keyword">return</span> sd.getIServiceConnection();</div><div class="line">    }    </div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>接下去看下 ServiceDispatcher（它是 LoadedApk 中的内部类） 这个东西：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> class ServiceDispatcher {</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ServiceDispatcher.InnerConnection mIServiceConnection;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ServiceConnection mConnection;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Handler mActivityThread;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ServiceConnectionLeaked mLocation;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mFlags;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> RuntimeException mUnbindLocation;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> mDied;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> mForgotten;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionInfo</span> </span>{</div><div class="line">            IBinder binder;</div><div class="line">            IBinder.DeathRecipient deathMonitor;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// IserviceConnection 接口的实现</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerConnection</span> <span class="keyword">extends</span> <span class="title">IServiceConnection</span>.<span class="title">Stub</span> </span>{</div><div class="line">            <span class="keyword">final</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt; mDispatcher;</div><div class="line"></div><div class="line">            InnerConnection(LoadedApk.ServiceDispatcher sd) {</div><div class="line">                mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span>(ComponentName name, IBinder service) <span class="keyword">throws</span> RemoteException {</div><div class="line">                LoadedApk.ServiceDispatcher sd = mDispatcher.get();</div><div class="line">                <span class="keyword">if</span> (sd != <span class="keyword">null</span>) {              </div><div class="line">                    sd.connected(name, service);   </div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;ComponentName, ServiceDispatcher.ConnectionInfo&gt; mActiveConnections</div><div class="line">            = <span class="keyword">new</span> ArrayMap&lt;ComponentName, ServiceDispatcher.ConnectionInfo&gt;();</div><div class="line"></div><div class="line">        ServiceDispatcher(ServiceConnection conn,</div><div class="line">                Context context, Handler activityThread, <span class="keyword">int</span> flags) {</div><div class="line">            mIServiceConnection = <span class="keyword">new</span> InnerConnection(<span class="keyword">this</span>);</div><div class="line">            mConnection = conn;            </div><div class="line">            mContext = context;            </div><div class="line">            mActivityThread = activityThread;</div><div class="line">            mLocation = <span class="keyword">new</span> ServiceConnectionLeaked(<span class="keyword">null</span>);</div><div class="line">            mLocation.fillInStackTrace();</div><div class="line">            mFlags = flags;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span>(ComponentName name, IBinder service) {</div><div class="line">            <span class="keyword">if</span> (mActivityThread != <span class="keyword">null</span>) { </div><div class="line">                mActivityThread.post(<span class="keyword">new</span> RunConnection(name, service, <span class="number">0</span>));</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                doConnected(name, service);    </div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doConnected</span>(ComponentName name, IBinder service) {</div><div class="line">            ServiceDispatcher.ConnectionInfo old;</div><div class="line">            ServiceDispatcher.ConnectionInfo info;</div><div class="line"></div><div class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {          </div><div class="line">                <span class="keyword">if</span> (mForgotten) {              </div><div class="line">                    <span class="comment">// We unbound before receiving the connection; ignore</span></div><div class="line">                    <span class="comment">// any connection received.    </span></div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                }</div><div class="line">                old = mActiveConnections.get(name);</div><div class="line">                <span class="keyword">if</span> (old != <span class="keyword">null</span> && old.binder == service) {</div><div class="line">                    <span class="comment">// Huh, already have this one.  Oh well!</span></div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (service != <span class="keyword">null</span>) {         </div><div class="line">                    <span class="comment">// A new service is being connected... set it all up.</span></div><div class="line">                    mDied = <span class="keyword">false</span>;                 </div><div class="line">                    info = <span class="keyword">new</span> ConnectionInfo();   </div><div class="line">                    info.binder = service;         </div><div class="line">                    info.deathMonitor = <span class="keyword">new</span> DeathMonitor(name, service);</div><div class="line">                    <span class="keyword">try</span> {</div><div class="line">                        service.linkToDeath(info.deathMonitor, <span class="number">0</span>);</div><div class="line">                        mActiveConnections.put(name, info);</div><div class="line">                    } <span class="keyword">catch</span> (RemoteException e) {  </div><div class="line">                        <span class="comment">// This service was dead before we got it...  just</span></div><div class="line">                        <span class="comment">// don't do anything with it.  </span></div><div class="line">                        mActiveConnections.remove(name);</div><div class="line">                        <span class="keyword">return</span>;                        </div><div class="line">                    }</div><div class="line"></div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    <span class="comment">// The named service is being disconnected... clean up.</span></div><div class="line">                    mActiveConnections.remove(name);</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (old != <span class="keyword">null</span>) {             </div><div class="line">                    old.binder.unlinkToDeath(old.deathMonitor, <span class="number">0</span>);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// If there was an old service, it is not disconnected.</span></div><div class="line">            <span class="keyword">if</span> (old != <span class="keyword">null</span>) {</div><div class="line">                mConnection.onServiceDisconnected(name);</div><div class="line">            }</div><div class="line">            <span class="comment">// If there is a new service, it is now connected.</span></div><div class="line">            <span class="keyword">if</span> (service != <span class="keyword">null</span>) {</div><div class="line">                <span class="comment">// 终于调到这个回调了</span></div><div class="line">                mConnection.onServiceConnected(name, service);</div><div class="line">            }</div><div class="line">        }</div><div class="line">... ... </div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>



<p>其实 ServiceDispatcher 就是封装了下 ServiceConnection，因为 ServiceConnection 是没有实现 IBinder 接口，但是最后 ServiceConnection 的接口是在 AM 里面调用的，所以它必须要实现 IBinder 接口才能在 AM 调用。所以这里弄了一个 InnerConnection 的实现出来，其实就是包装了下 ServiceConnection 的回调而已。这里还多弄了一堆东西出来，层层调用，这里不管别的，只要知道 InnerConnection 实现的 IServiceConnection 接口能够在 AM 被调用，调用后就会调用 Proc B 实现的 onServiceConnected，然后 Proc B 就能得到 SA 的 IBinder 对像了。</p>
<p>好这里现在就要看看是哪里调用了 IServiceConnection 的接口（其实在 AM 里面）。然后我们回到 ContextImpl 的 bindServiceCommon，取到 IServiceConnection 接口后（这里是 Bn 端），然后就调用 AM 的 bindService 的 IPC 接口了，并且把 IServiceConnection 传了过去。这里 IServiceConnection 也是一个 IBinder 对象来的，它的传递参见 SS 那篇。其实 IBinder 对象的传递，只要有最原始的 Bn 端就能够传递，SS 是把自己的 Bn 传给了 SM，其它进程再从 SM 那取。因为其它进程没 SS 原始 Bn 端。但是在 binder 设计上 SM 是特殊的（handle 固定是 0），在任何进程可以取得到，所以可以通过 SM 取指定的 SS 的 IBinder 对象。这里有 IServiceConnection 的原始 Bn 对象所以是可以传递给 AM 的。</p>
<p>接下来我们就要去看 AM 的 bindService 接口了（其实很多一部分工作是在 AM 里面完成的，普通应用程序通过 SM 取 AM -_-||）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span>(IApplicationThread caller, IBinder token,</div><div class="line">        Intent service, String resolvedType,</div><div class="line">        IServiceConnection connection, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId) {</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"bindService"</span>);</div><div class="line">    <span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">    <span class="keyword">if</span> (service != <span class="keyword">null</span> && service.hasFileDescriptors() == <span class="keyword">true</span>) {</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) {</div><div class="line">        <span class="keyword">return</span> mServices.bindServiceLocked(caller, token, service, resolvedType,</div><div class="line">                connection, flags, userId);    </div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>AM 中 Service 这一块的相关工作是在 ActiveServices.java 中实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">int</span> bindServiceLocked(IApplicationThread caller, IBinder token,</div><div class="line">            Intent service, String resolvedType,</div><div class="line">            IServiceConnection connection, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId) {</div><div class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG, <span class="string">"bindService: "</span> + service</div><div class="line">                + <span class="string">" type="</span> + resolvedType + <span class="string">" conn="</span> + connection.asBinder()</div><div class="line">                + <span class="string">" flags=0x"</span> + Integer.toHexString(flags));</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="comment">// 这里取到 ServiceRecord</span></div><div class="line">        ServiceLookupResult res =</div><div class="line">            retrieveServiceLocked(service, resolvedType,</div><div class="line">                    Binder.getCallingPid(), Binder.getCallingUid(), userId, <span class="keyword">true</span>, callerFg);</div><div class="line">        <span class="keyword">if</span> (res == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (res.record == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        }</div><div class="line">        ServiceRecord s = res.record;</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个函数比较长，我们只看关键的地方。首先通过 retrieveServiceLocked 获取 ServiceRecord（这个 ServiceRecord 是个比较重要的东西，在 AM 中记录了 Service 的相关数据）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ServiceLookupResult <span class="title">retrieveServiceLocked</span>(Intent service,</div><div class="line">        String resolvedType, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">int</span> userId,</div><div class="line">        <span class="keyword">boolean</span> createIfNeeded, <span class="keyword">boolean</span> callingFromFg) {</div><div class="line">    ServiceRecord r = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG, <span class="string">"retrieveServiceLocked: "</span> + service</div><div class="line">            + <span class="string">" type="</span> + resolvedType + <span class="string">" callingUid="</span> + callingUid);</div><div class="line"></div><div class="line">    userId = mAm.handleIncomingUser(callingPid, callingUid, userId,</div><div class="line">            <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="string">"service"</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    ServiceMap smap = getServiceMap(userId);</div><div class="line">    <span class="keyword">final</span> ComponentName comp = service.getComponent();</div><div class="line">    <span class="comment">// 先通过 ComponentName 在 ServiceMap 中取 ServiceMap</span></div><div class="line">    <span class="keyword">if</span> (comp != <span class="keyword">null</span>) {</div><div class="line">        r = smap.mServicesByName.get(comp);</div><div class="line">    }</div><div class="line">    <span class="comment">// ComponentName 没取到的话，再通过 Intent filer 取    </span></div><div class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span>) {</div><div class="line">        Intent.FilterComparison filter = <span class="keyword">new</span> Intent.FilterComparison(service);</div><div class="line">        r = smap.mServicesByIntent.get(filter);</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">try</span> {       </div><div class="line">            ResolveInfo rInfo =</div><div class="line">                AppGlobals.getPackageManager().resolveService(</div><div class="line">                            service, resolvedType,</div><div class="line">                            ActivityManagerService.STOCK_PM_FLAGS, userId);</div><div class="line">            ServiceInfo sInfo =</div><div class="line">                rInfo != <span class="keyword">null</span> ? rInfo.serviceInfo : <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (sInfo == <span class="keyword">null</span>) {</div><div class="line">                Slog.w(TAG, <span class="string">"Unable to start service "</span> + service + <span class="string">" U="</span> + userId +</div><div class="line">                      <span class="string">": not found"</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            }</div><div class="line">            ComponentName name = <span class="keyword">new</span> ComponentName(</div><div class="line">                    sInfo.applicationInfo.packageName, sInfo.name);</div><div class="line">            <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) {</div><div class="line">                <span class="keyword">if</span> (mAm.isSingleton(sInfo.processName, sInfo.applicationInfo,</div><div class="line">                        sInfo.name, sInfo.flags)) {</div><div class="line">                    userId = <span class="number">0</span>;</div><div class="line">                    smap = getServiceMap(<span class="number">0</span>);</div><div class="line">                }</div><div class="line">                sInfo = <span class="keyword">new</span> ServiceInfo(sInfo);</div><div class="line">                sInfo.applicationInfo = mAm.getAppInfoForUser(sInfo.applicationInfo, userId);</div><div class="line">            }</div><div class="line">            <span class="comment">// 最后再取一次</span></div><div class="line">            r = smap.mServicesByName.get(name);</div><div class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span> && createIfNeeded) {</div><div class="line">                Intent.FilterComparison filter</div><div class="line">                        = <span class="keyword">new</span> Intent.FilterComparison(service.cloneFilter());</div><div class="line">                ServiceRestarter res = <span class="keyword">new</span> ServiceRestarter();</div><div class="line">                BatteryStatsImpl.Uid.Pkg.Serv ss = <span class="keyword">null</span>;</div><div class="line">                BatteryStatsImpl stats = mAm.mBatteryStatsService.getActiveStatistics();</div><div class="line">                <span class="keyword">synchronized</span> (stats) {</div><div class="line">                    ss = stats.getServiceStatsLocked(</div><div class="line">                            sInfo.applicationInfo.uid, sInfo.packageName,</div><div class="line">                            sInfo.name);</div><div class="line">                }</div><div class="line">                <span class="comment">// 再取不到就 new 一个了</span></div><div class="line">                r = <span class="keyword">new</span> ServiceRecord(mAm, ss, name, filter, sInfo, callingFromFg, res);</div><div class="line">                res.setService(r);</div><div class="line">                <span class="comment">// 然后添加到 ServiceMap 中去</span></div><div class="line">                smap.mServicesByName.put(name, r);</div><div class="line">                smap.mServicesByIntent.put(filter, r);</div><div class="line"></div><div class="line">                <span class="comment">// Make sure this component isn't in the pending list.</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=mPendingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) {</div><div class="line">                    ServiceRecord pr = mPendingServices.get(i);</div><div class="line">                    <span class="keyword">if</span> (pr.serviceInfo.applicationInfo.uid == sInfo.applicationInfo.uid</div><div class="line">                            && pr.name.equals(name)) {</div><div class="line">                        mPendingServices.remove(i);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">        } <span class="keyword">catch</span> (RemoteException ex) {</div><div class="line">            <span class="comment">// pm is in same process, this will never happen.</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="comment">// 后面 ServiceLookupResult 其实可以不怎么管</span></div><div class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">if</span> (mAm.checkComponentPermission(r.permission,</div><div class="line">                callingPid, callingUid, r.appInfo.uid, r.exported)</div><div class="line">                != PackageManager.PERMISSION_GRANTED) {</div><div class="line">            <span class="keyword">if</span> (!r.exported) {</div><div class="line">                Slog.w(TAG, <span class="string">"Permission Denial: Accessing service "</span> + r.name</div><div class="line">                        + <span class="string">" from pid="</span> + callingPid</div><div class="line">                        + <span class="string">", uid="</span> + callingUid</div><div class="line">                        + <span class="string">" that is not exported from uid "</span> + r.appInfo.uid);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(<span class="keyword">null</span>, <span class="string">"not exported from uid "</span></div><div class="line">                        + r.appInfo.uid);</div><div class="line">            }</div><div class="line">            Slog.w(TAG, <span class="string">"Permission Denial: Accessing service "</span> + r.name</div><div class="line">                    + <span class="string">" from pid="</span> + callingPid</div><div class="line">                    + <span class="string">", uid="</span> + callingUid</div><div class="line">                    + <span class="string">" requires "</span> + r.permission);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(<span class="keyword">null</span>, r.permission);</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (!mAm.mIntentFirewall.checkService(r.name, service, callingUid, callingPid,</div><div class="line">                resolvedType, r.appInfo)) {</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(r, <span class="keyword">null</span>);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>AM 中有一个 ServiceMap 保存了 ComponentName、Intent filter 相关的 ServiceRecord （反正通过 Intent 能找得到的）。然后我们来看下 ServiceRecord 的结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ServiceRecord.java ======================================</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * A running application service.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">final</span> class ServiceRecord extends Binder {</div><div class="line">    <span class="comment">// Maximum number of delivery attempts before giving up.</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_DELIVERY_COUNT = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Maximum number of times it can fail during execution before giving up.</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_DONE_EXECUTING_COUNT = <span class="number">6</span>;</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ArrayMap&lt;Intent.FilterComparison, IntentBindRecord&gt; bindings</div><div class="line">            = <span class="keyword">new</span> ArrayMap&lt;Intent.FilterComparison, IntentBindRecord&gt;();</div><div class="line">                            <span class="comment">// All active bindings to the service.</span></div><div class="line">    <span class="keyword">final</span> ArrayMap&lt;IBinder, ArrayList&lt;ConnectionRecord&gt;&gt; connections</div><div class="line">            = <span class="keyword">new</span> ArrayMap&lt;IBinder, ArrayList&lt;ConnectionRecord&gt;&gt;();</div><div class="line">                            <span class="comment">// IBinder -&gt; ConnectionRecord of all bound clients</span></div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// ConnectionRecord.java =====================================</span></div><div class="line"></div><div class="line"><span class="javadoc">/**</span></div><div class="line"><span class="javadoc"> * Description of a single binding to a service.</span></div><div class="line"><span class="javadoc"> */</span></div><div class="line"><span class="keyword">final</span> class ConnectionRecord {</div><div class="line">    <span class="keyword">final</span> AppBindRecord binding;    <span class="comment">// The application/service binding.</span></div><div class="line">    <span class="keyword">final</span> ActivityRecord activity;  <span class="comment">// If non-null, the owning activity.</span></div><div class="line">    <span class="keyword">final</span> IServiceConnection conn;  <span class="comment">// The client connection.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> flags;                <span class="comment">// Binding options.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> clientLabel;          <span class="comment">// String resource labeling this client.</span></div><div class="line">    <span class="keyword">final</span> PendingIntent clientIntent; <span class="comment">// How to launch the client.</span></div><div class="line">    String stringName;              <span class="comment">// Caching of toString.</span></div><div class="line">    <span class="keyword">boolean</span> serviceDead;            <span class="comment">// Well is it?</span></div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line"><span class="comment">// IntentBindRecord.java ===================================== </span></div><div class="line"></div><div class="line"><span class="javadoc">/**</span></div><div class="line"><span class="javadoc"> * A particular Intent that has been bound to a Service.</span></div><div class="line"><span class="javadoc"> */</span></div><div class="line"><span class="keyword">final</span> class IntentBindRecord {</div><div class="line">    <span class="javadoc">/** The running service. */</span></div><div class="line">    <span class="keyword">final</span> ServiceRecord service;</div><div class="line">    <span class="javadoc">/** The intent that is bound.*/</span></div><div class="line">    <span class="keyword">final</span> Intent.FilterComparison intent; <span class="comment">//</span></div><div class="line">    <span class="javadoc">/** All apps that have bound to this Intent. */</span></div><div class="line">    <span class="keyword">final</span> ArrayMap&lt;ProcessRecord, AppBindRecord&gt; apps</div><div class="line">            = <span class="keyword">new</span> ArrayMap&lt;ProcessRecord, AppBindRecord&gt;();</div><div class="line">    <span class="javadoc">/** Binder published from service. */</span></div><div class="line">    IBinder binder;</div><div class="line">    <span class="javadoc">/** Set when we have initiated a request for this binder. */</span></div><div class="line">    <span class="keyword">boolean</span> requested;</div><div class="line">    <span class="javadoc">/** Set when we have received the requested binder. */</span></div><div class="line">    <span class="keyword">boolean</span> received;</div><div class="line">    <span class="javadoc">/** Set when we still need to tell the service all clients are unbound. */</span></div><div class="line">    <span class="keyword">boolean</span> hasBound;</div><div class="line">    <span class="javadoc">/** Set when the service's onUnbind() has asked to be told about new clients. */</span></div><div class="line">    <span class="keyword">boolean</span> doRebind;</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>ServiceRecord 中有一个 ConnectionRecord 的数组，ConnectionRecord 中有 IServiceConnection 这个 IBinder 接口。这个就是上面封装 Client 中实现的 ServiceConnection 接口。然后 ServiceRcord 里面还有一个 IntentBindRecord 这个记录服务被绑定的信息。不过 new ServiceRecord 那里并没设置 connections，我们接着往下看:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ActiveServices--bindServiceLocked  ====================</span></div><div class="line"></div><div class="line">        <span class="comment">// s 为之前取到的 ServiceRecord</span></div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="keyword">if</span> (unscheduleServiceRestartLocked(s, callerApp.info.uid, <span class="keyword">false</span>)) {</div><div class="line">                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG, <span class="string">"BIND SERVICE WHILE RESTART PENDING: "</span></div><div class="line">                        + s);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((flags&Context.BIND_AUTO_CREATE) != <span class="number">0</span>) {</div><div class="line">                s.lastActivity = SystemClock.uptimeMillis();</div><div class="line">                <span class="keyword">if</span> (!s.hasAutoCreateConnections()) {</div><div class="line">                    <span class="comment">// This is the first binding, let the tracker know.</span></div><div class="line">                    ProcessStats.ServiceState stracker = s.getTracker();</div><div class="line">                    <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) {</div><div class="line">                        stracker.setBound(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(),</div><div class="line">                                s.lastActivity);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// 在 ServiceRecord 里取 AppBindRecord，最关键的是这个函数</span></div><div class="line">            <span class="comment">// 会触发ServiceRecord创建IntentBindRecord（如果还没创建的话）</span></div><div class="line">            <span class="comment">// IntentBindRecord 前面说了，保存了绑定的信息的</span></div><div class="line">            AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp);</div><div class="line">            <span class="comment">// 这里 new ConnectionRecord 了，注意参数 connection 是</span></div><div class="line">            <span class="comment">// client bindService 传过来的 IServiceConnection</span></div><div class="line">            ConnectionRecord c = <span class="keyword">new</span> ConnectionRecord(b, activity,</div><div class="line">                    connection, flags, clientLabel, clientIntent);</div><div class="line"></div><div class="line">            <span class="comment">// 之前没 ServiceRecord 的 connections 没设置，这里设置了哦</span></div><div class="line">            IBinder binder = connection.asBinder();</div><div class="line">            ArrayList&lt;ConnectionRecord&gt; clist = s.connections.get(binder);</div><div class="line">            <span class="keyword">if</span> (clist == <span class="keyword">null</span>) {</div><div class="line">                clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</div><div class="line">                s.connections.put(binder, clist);</div><div class="line">            }</div><div class="line">            clist.add(c);</div><div class="line">            b.connections.add(c);</div><div class="line">            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">if</span> (activity.connections == <span class="keyword">null</span>) {</div><div class="line">                    activity.connections = <span class="keyword">new</span> HashSet&lt;ConnectionRecord&gt;();</div><div class="line">                }</div><div class="line">                activity.connections.add(c);</div><div class="line">            }</div><div class="line">            b.client.connections.add(c);</div><div class="line">            <span class="keyword">if</span> ((c.flags&Context.BIND_ABOVE_CLIENT) != <span class="number">0</span>) {</div><div class="line">                b.client.hasAboveClient = <span class="keyword">true</span>;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (s.app != <span class="keyword">null</span>) {</div><div class="line">                updateServiceClientActivitiesLocked(s.app, c);</div><div class="line">            }</div><div class="line">            clist = mServiceConnections.get(binder);</div><div class="line">            <span class="keyword">if</span> (clist == <span class="keyword">null</span>) {</div><div class="line">                clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</div><div class="line">                mServiceConnections.put(binder, clist);</div><div class="line">            }</div><div class="line">            clist.add(c);</div><div class="line"></div><div class="line">            ... ...</div><div class="line"></div><div class="line">        } <span class="keyword">finally</span> {</div><div class="line">            Binder.restoreCallingIdentity(origId);</div><div class="line">        }</div><div class="line"></div></pre></td></tr></table></figure>

<p>将 Client 的 IServiceConneciton 保存到 AM 中了。然后后面的处理要分为3种情况来说：</p>
<ol>
<li>要绑定的服务所在的进程已经在运行，并且服务代码也已经执行了，这个时候只要请求绑定服务就行了。</li>
<li>要绑定的服务所在的进程已经在运行，但是服务代码没有执行，这个时候需要执行服务代码，然后再绑定服务。</li>
<li>要绑定的服务的进程还没运行，要先启动服务所在的进程，然后执行服务代码，最后再绑定服务。</li>
</ol>
<h3 id="服务进程和服务都已经启动">服务进程和服务都已经启动</h3>
<p>第一种情况比较简单，进程和服务都在运行，直接绑定就可以了。</p>
<p><img src="https://mingming-killer.github.io/img/pics/android/Binder-service/1.png" alt=""></p>
<p>我们继续看 bindServiceLocked 的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ((flags&Context.BIND_AUTO_CREATE) != <span class="number">0</span>) {</div><div class="line">    s.lastActivity = SystemClock.uptimeMillis();</div><div class="line">    <span class="keyword">if</span> (bringUpServiceLocked(s, service.getFlags(), callerFg, <span class="keyword">false</span>) != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p><code>BIND_AUTO_CREATE</code> 前面说了，如果要绑定的服务没启动的话，会自动帮你启动服务。主要是 bringUpServiceLocked 这个函数处理，看名字还挺形象的，把服务拉起来 -_-||。这里既然是第一种情况，我们也当设置了这个标志，进去看看:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String <span class="title">bringUpServiceLocked</span>(ServiceRecord r,</div><div class="line">            <span class="keyword">int</span> intentFlags, <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> whileRestarting) {</div><div class="line">        <span class="comment">//Slog.i(TAG, "Bring up service:");</span></div><div class="line">        <span class="comment">//r.dump("  ");</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span> && r.app.thread != <span class="keyword">null</span>) {</div><div class="line">            sendServiceArgsLocked(r, execInFg, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        }      </div><div class="line"></div><div class="line">... ...</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>如果是服务所在进程已经在运行（r.app != null），服务代码也已经被执行了（r.app.thread != null），这里啥也没做，马上就返回 null 了。我们回到 bindServiceLocked 继续往下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 更新下最近运行的程序和 OOM</span></div><div class="line"><span class="keyword">if</span> (s.app != <span class="keyword">null</span>) {           </div><div class="line">    <span class="comment">// This could have made the service more important.</span></div><div class="line">    mAm.updateLruProcessLocked(s.app, s.app.hasClientActivities, b.client);</div><div class="line">    mAm.updateOomAdjLocked(s.app); </div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG, <span class="string">"Bind "</span> + s + <span class="string">" with "</span> + b</div><div class="line">        + <span class="string">": received="</span> + b.intent.received</div><div class="line">        + <span class="string">" apps="</span> + b.intent.apps.size()</div><div class="line">        + <span class="string">" doRebind="</span> + b.intent.doRebind);</div><div class="line"></div><div class="line"><span class="comment">// 这个判断代表服务已经跑起来了</span></div><div class="line"><span class="keyword">if</span> (s.app != <span class="keyword">null</span> && b.intent.received) {</div><div class="line">    <span class="comment">// Service is already running, so we can immediately</span></div><div class="line">    <span class="comment">// publish the connection.     </span></div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="comment">// 调用 Client 的 IServiceConnection 的接口了</span></div><div class="line">        c.conn.connected(s.name, b.intent.binder);</div><div class="line">    } <span class="keyword">catch</span> (Exception e) {        </div><div class="line">        Slog.w(TAG, <span class="string">"Failure sending service "</span> + s.shortName</div><div class="line">                + <span class="string">" to connection "</span> + c.conn.asBinder()</div><div class="line">                + <span class="string">" (in "</span> + c.binding.client.processName + <span class="string">")"</span>, e);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// 我们先不管重新绑定的情况</span></div><div class="line">    <span class="comment">// If this is the first app connected back to this binding,</span></div><div class="line">    <span class="comment">// and the service had previously asked to be told when</span></div><div class="line">    <span class="comment">// rebound, then do so.</span></div><div class="line">    <span class="keyword">if</span> (b.intent.apps.size() == <span class="number">1</span> && b.intent.doRebind) {</div><div class="line">        requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">true</span>);</div><div class="line">    }</div><div class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (!b.intent.requested) {</div><div class="line">    <span class="comment">// 正常应该走这里的</span></div><div class="line">    requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">false</span>);</div><div class="line">}</div><div class="line"></div><div class="line">getServiceMap(s.userId).ensureNotStartingBackground(s);</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里这个 s.app != null &amp;&amp; b.intent.received 判断应该是比较特殊的， app != null 好说。那个 IntentBindRecord 的 received == true 的话，后面会看到，请求绑定的话，会被设置为 true 的，就是说这个已经绑定过了，所以可以直接调用 IServiceConnection 接口了。调用这个接口相关的，后面再说。我们主要看正常路线，就是下面那个 !b.intent.requested。这个会调用 requestServiceBindingLocked：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">requestServiceBindingLocked</span>(ServiceRecord r, </div><div class="line">        IntentBindRecord i, <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> rebind) {</div><div class="line">    <span class="comment">// 看这个判断，前面那个实际上只有 b.intent.received 有用而已</span></div><div class="line">    <span class="keyword">if</span> (r.app == <span class="keyword">null</span> || r.app.thread == <span class="keyword">null</span>) {</div><div class="line">        <span class="comment">// If service is not currently running, can't yet bind.</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line">    <span class="comment">// 注意这个 requested 的判断，如果已经 requested 过了就不处理了       </span></div><div class="line">    <span class="keyword">if</span> ((!i.requested || rebind) && i.apps.size() &gt; <span class="number">0</span>) {</div><div class="line">        <span class="keyword">try</span> {   </div><div class="line">            <span class="comment">// 远程调用到服务的线程执行绑定操作</span></div><div class="line">            bumpServiceExecutingLocked(r, execInFg, <span class="string">"bind"</span>);</div><div class="line">            r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">            r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,</div><div class="line">                    r.app.repProcState);</div><div class="line">            <span class="comment">// 成功后，会把 IntentBindRecord的 requested 设置为 true</span></div><div class="line">            <span class="keyword">if</span> (!rebind) {</div><div class="line">                i.requested = <span class="keyword">true</span>;</div><div class="line">            }</div><div class="line">            i.hasBound = <span class="keyword">true</span>;</div><div class="line">            i.doRebind = <span class="keyword">false</span>;</div><div class="line">        } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG, <span class="string">"Crashed while binding "</span> + r);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>最开始 r.app == null || r.app.thread == null 这个判断说明这条路线需要绑定的服务，进程、执行线程都要在运行才行。然后 r.app.thread 这个其实是一个 IActivityThread 的 IBinder 接口。ActivityThread（AT） 是 android 应用进程的主线程，java 的 main 函数在这个线程里面跑的。AT 管理了进程的主线程，负责执行各种 Activity、Service 和 Broadcast。简单的来说就这里这个 IPC 远程调用，就跑到服务运行的进程中去了。注意传递的一个参数，把 ServiceRecord 传过去了，ServiceRecord 在 java 层继承自 Binder，能够在 IPC 之间传递的。我们来具体看下吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ActivityThread.java ==========================</span></div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleBindService</span>(IBinder token, Intent intent,</div><div class="line">                <span class="keyword">boolean</span> rebind, <span class="keyword">int</span> processState) {</div><div class="line">            updateProcessState(processState, <span class="keyword">false</span>);</div><div class="line">            BindServiceData s = <span class="keyword">new</span> BindServiceData();</div><div class="line">            s.token = token;</div><div class="line">            s.intent = intent;</div><div class="line">            s.rebind = rebind;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (DEBUG_SERVICE)</div><div class="line">                Slog.v(TAG, <span class="string">"scheduleBindService token="</span> + token + <span class="string">" intent="</span> + intent + <span class="string">" uid="</span></div><div class="line">                        + Binder.getCallingUid() + <span class="string">" pid="</span> + Binder.getCallingPid());</div><div class="line">            sendMessage(H.BIND_SERVICE, s);</div><div class="line">        }</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里是发送消息到 Handle 里面去了，然后就返回了。我们看到 AT 的这个 Handle（mH）其实还是在 AT 这个线程里面（代码我不贴了，直接在 AT 中 new 出来的，Looper 还是 AT 的线程来的）。为什么还要费劲转到 Handle 里处理呢。这里说一下，主要是为了能够马上返回，因为这个调用是在 AM 的 bindService 里面的，这个函数后面的调用是有 AM 的锁的。然后后面会看到 handleBindService 里面又要调到 AM 里面去的，然后那个里面也有 AM 的锁，如果这里不返回的话，后面会调用 AM 里面就会死锁的（至于为什么 AM 里面有那么多锁，后面多线程篇会讲到的）。这里返回后后面就为什么处理了，我们去看 AT Handle 里面的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindService</span>(BindServiceData data) {</div><div class="line">    Service s = mServices.get(data.token);</div><div class="line">    <span class="keyword">if</span> (DEBUG_SERVICE)</div><div class="line">        Slog.v(TAG, <span class="string">"handleBindService s="</span> + s + <span class="string">" rebind="</span> + data.rebind);</div><div class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">try</span> {   </div><div class="line">            data.intent.setExtrasClassLoader(s.getClassLoader());</div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                <span class="keyword">if</span> (!data.rebind) {</div><div class="line">                    <span class="comment">// 这里调用 Service 实现的 onBind 获取 Service </span></div><div class="line">                    <span class="comment">// 的 IBinder 对象了。</span></div><div class="line">                    IBinder binder = s.onBind(data.intent);</div><div class="line">                    ActivityManagerNative.getDefault().publishService(</div><div class="line">                            data.token, data.intent, binder);</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    s.onRebind(data.intent);</div><div class="line">                    ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                            data.token, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                }</div><div class="line">                ensureJitEnabled();</div><div class="line">            } <span class="keyword">catch</span> (RemoteException ex) {</div><div class="line">            }</div><div class="line">        } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                        <span class="string">"Unable to bind to service "</span> + s</div><div class="line">                        + <span class="string">" with "</span> + data.intent + <span class="string">": "</span> + e.toString(), e);</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>开始那个 mServices 是一个 map，用来保存 Service 对象的，key 是 scheduleBindService 传递的 ServiceRecord 的 IBinder 对象。后面启动服务的时候，会看到，在本线程内每启动一个 Service 会把这个 Service 对象保存到 mServices 里去的。这么看其实可以一个线程里面跑多个服务，在应用层来说应该是一个进程里面可以跑多个服务的（这个是主线程）。</p>
<p>取到 Service 对象后，在 Service 本进程里可以调用 Service 的 onBind 函数取得 Service 的 IBinder 对象。然后把这个 IBinder 对象又传递给 AM 那调用 publishService 了。转了半天又回去了（不过想想其实也是对的，后面要调用 Client 的 IServiceConnection 的回调，这个应该由 AM 处理比较好）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ActivityManagerService.java ==========================</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishService</span>(IBinder token, Intent intent, IBinder service) {</div><div class="line">        <span class="comment">// Refuse possible leaked file descriptors</span></div><div class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span> && intent.hasFileDescriptors() == <span class="keyword">true</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) {</div><div class="line">            <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</div><div class="line">            }</div><div class="line">            mServices.publishServiceLocked((ServiceRecord)token, intent, service);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>果然又是要到 ActiveServices.java 里面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ServiceRecord 被 AM 传递给 ActivityThread，又传回来了 -_-||</span></div><div class="line"><span class="comment">// 第二 service（IBinder） 是 ActivityThread 取的 Service 的，</span></div><div class="line"><span class="comment">// Client 就是要这个 IBinder 对象</span></div><div class="line"><span class="keyword">void</span> publishServiceLocked(ServiceRecord r, Intent intent, IBinder service) {</div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG, <span class="string">"PUBLISHING "</span> + r</div><div class="line">                + <span class="string">" "</span> + intent + <span class="string">": "</span> + service);</div><div class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) {</div><div class="line">            Intent.FilterComparison filter</div><div class="line">                    = <span class="keyword">new</span> Intent.FilterComparison(intent);</div><div class="line">            IntentBindRecord b = r.bindings.get(filter);</div><div class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span> && !b.received) {</div><div class="line">                b.binder = service;</div><div class="line">                <span class="comment">// 这里 requested 和 received 都设置 true 了</span></div><div class="line">                b.requested = <span class="keyword">true</span>;</div><div class="line">                b.received = <span class="keyword">true</span>;</div><div class="line">                <span class="comment">// 前面 bindService 保存的 ConnectionRecord 这里要派上用场了</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> conni=r.connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) {</div><div class="line">                    ArrayList&lt;ConnectionRecord&gt; clist = r.connections.valueAt(conni);</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clist.size(); i++) {</div><div class="line">                        ConnectionRecord c = clist.get(i);</div><div class="line">                        <span class="keyword">if</span> (!filter.equals(c.binding.intent.intent)) {</div><div class="line">                            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</div><div class="line">                                    TAG, <span class="string">"Not publishing to: "</span> + c);</div><div class="line">                            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</div><div class="line">                                    TAG, <span class="string">"Bound intent: "</span> + c.binding.intent.intent);</div><div class="line">                            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</div><div class="line">                                    TAG, <span class="string">"Published intent: "</span> + intent);</div><div class="line">                            <span class="keyword">continue</span>;</div><div class="line">                        }</div><div class="line">                        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG, <span class="string">"Publishing to: "</span> + c);</div><div class="line">                        <span class="keyword">try</span> {</div><div class="line">                            <span class="comment">// 终于调 IServiceConnection 回调了</span></div><div class="line">                            c.conn.connected(r.name, service);</div><div class="line">                        } <span class="keyword">catch</span> (Exception e) {</div><div class="line">                            Slog.w(TAG, <span class="string">"Failure sending service "</span> + r.name +</div><div class="line">                                  <span class="string">" to connection "</span> + c.conn.asBinder() +</div><div class="line">                                  <span class="string">" (in "</span> + c.binding.client.processName + <span class="string">")"</span>, e);</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// 其他的都先忽略吧</span></div><div class="line">            serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), <span class="keyword">false</span>);</div><div class="line">        }</div><div class="line">    } <span class="keyword">finally</span> {</div><div class="line">        Binder.restoreCallingIdentity(origId);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里就算是最后一步了。 ActivityThread 把 Service 的 IBinder 对象传递过来了，然后 AM 把 bindService 中保存的 ConnectionRecord 遍历了一次，依次调用 IServiceConneciton 接口，这样 Client 那里就能得到 Service 的 IBinder 对象了（IBinder 对象的具体传递细节可以看上一篇）。注意下前面把 IntentBindRecord 的 requested 和 received 设置为 true 了，这样能防止重复调用 IServiceConneciton 接口（设置了特殊标志位的除外）。</p>
<h3 id="服务进程已经启动，但是服务还没运行">服务进程已经启动，但是服务还没运行</h3>
<p>接下来我们来看第二种情况，这种情况服务所在进程依然已经启动，但是服务可能还没运行。我们需要启动服务后，再绑定。</p>
<p><img src="https://mingming-killer.github.io/img/pics/android/Binder-service/2.png" alt=""><br>（handleBindService 后面的我省略了，第一种情况画过了）</p>
<p>这条分支的话，我们在 bringUpServiceLocked 开头不会返回：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String <span class="title">bringUpServiceLocked</span>(ServiceRecord r,</div><div class="line">            <span class="keyword">int</span> intentFlags, <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> whileRestarting) {</div><div class="line">        <span class="comment">//Slog.i(TAG, "Bring up service:");</span></div><div class="line">        <span class="comment">//r.dump("  ");</span></div><div class="line"></div><div class="line">        <span class="comment">// 这里不会返回</span></div><div class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span> && r.app.thread != <span class="keyword">null</span>) {</div><div class="line">            sendServiceArgsLocked(r, execInFg, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!whileRestarting && r.restartDelay &gt; <span class="number">0</span>) {</div><div class="line">            <span class="comment">// If waiting for a restart, then do nothing.</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG, <span class="string">"Bringing up "</span> + r + <span class="string">" "</span> + r.intent);</div><div class="line"></div><div class="line">        <span class="comment">// We are now bringing the service up, so no longer in the</span></div><div class="line">        <span class="comment">// restarting state.</span></div><div class="line">        <span class="keyword">if</span> (mRestartingServices.remove(r)) {</div><div class="line">            clearRestartingIfNeededLocked(r);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Make sure this service is no longer considered delayed, we are starting it now.</span></div><div class="line">        <span class="keyword">if</span> (r.delayed) {</div><div class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STATS) Slog.v(TAG, <span class="string">"REM FR DELAY LIST (bring up): "</span> + r);</div><div class="line">            getServiceMap(r.userId).mDelayedStartList.remove(r);</div><div class="line">            r.delayed = <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Make sure that the user who owns this service is started.  If not,</span></div><div class="line">        <span class="comment">// we don't want to allow it to run.</span></div><div class="line">        <span class="keyword">if</span> (mAm.mStartedUsers.get(r.userId) == <span class="keyword">null</span>) {</div><div class="line">            String msg = <span class="string">"Unable to launch app "</span></div><div class="line">                    + r.appInfo.packageName + <span class="string">"/"</span></div><div class="line">                    + r.appInfo.uid + <span class="string">" for service "</span></div><div class="line">                    + r.intent.getIntent() + <span class="string">": user "</span> + r.userId + <span class="string">" is stopped"</span>;</div><div class="line">            Slog.w(TAG, msg);</div><div class="line">            bringDownServiceLocked(r);</div><div class="line">            <span class="keyword">return</span> msg;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Service is now being launched, its package can't be stopped.</span></div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            AppGlobals.getPackageManager().setPackageStoppedState(</div><div class="line">                    r.packageName, <span class="keyword">false</span>, r.userId);</div><div class="line">        } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">        } <span class="keyword">catch</span> (IllegalArgumentException e) {</div><div class="line">            Slog.w(TAG, <span class="string">"Failed trying to unstop package "</span></div><div class="line">                    + r.packageName + <span class="string">": "</span> + e);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isolated = (r.serviceInfo.flags&ServiceInfo.FLAG_ISOLATED_PROCESS) != <span class="number">0</span>;</div><div class="line">        <span class="keyword">final</span> String procName = r.processName;</div><div class="line">        ProcessRecord app;</div><div class="line"></div><div class="line">        <span class="comment">// 前面就打打酱油，主要看下面的，这里正常使用不是 isolated 的</span></div><div class="line">        <span class="keyword">if</span> (!isolated) {</div><div class="line">            <span class="comment">// 通过 Service 的 procName 取 ProcessRecord</span></div><div class="line">            app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"bringUpServiceLocked: appInfo.uid="</span> + r.appInfo.uid</div><div class="line">                        + <span class="string">" app="</span> + app);</div><div class="line">            <span class="comment">// 这里如果第二种分支，这里就会走这条分支，去启动服务。</span></div><div class="line">            <span class="comment">// 然后返回，后面和第一种分支一样绑定服务了。</span></div><div class="line">            <span class="keyword">if</span> (app != <span class="keyword">null</span> && app.thread != <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">try</span> {</div><div class="line">                    app.addPackage(r.appInfo.packageName, mAm.mProcessStats);</div><div class="line">                    realStartServiceLocked(r, app, execInFg);</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">                    Slog.w(TAG, <span class="string">"Exception when starting service "</span> + r.shortName, e);</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">// If a dead object exception was thrown -- fall through to</span></div><div class="line">                <span class="comment">// restart the application.</span></div><div class="line">            }</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="comment">// If this service runs in an isolated process, then each time</span></div><div class="line">            <span class="comment">// we call startProcessLocked() we will get a new isolated</span></div><div class="line">            <span class="comment">// process, starting another process if we are currently waiting</span></div><div class="line">            <span class="comment">// for a previous process to come up.  To deal with this, we store</span></div><div class="line">            <span class="comment">// in the service any current isolated process it is running in or</span></div><div class="line">            <span class="comment">// waiting to have come up.</span></div><div class="line">            app = r.isolatedProc;</div><div class="line">        }</div><div class="line"></div><div class="line">... ...</div><div class="line">       </div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>app != null &amp;&amp; app.thread != null 这个判断说明服务所在的进程已经启动了（主线程也在跑了），就调用 realStartServiceLocked 去启动服务。如果不出错的话，启动完成后，bringUpServiceLocked 就会返回 null，然后继续第一种情况的分支，后面绑定服务。我们来看看 realStartServiceLocked：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ServiceRerord 和 ProcessRecord 传递过来了</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span>(ServiceRecord r,</div><div class="line">        ProcessRecord app, <span class="keyword">boolean</span> execInFg) <span class="keyword">throws</span> RemoteException {</div><div class="line">    <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (DEBUG_MU)</div><div class="line">        Slog.v(TAG_MU, <span class="string">"realStartServiceLocked, ServiceRecord.uid = "</span> + r.appInfo.uid</div><div class="line">                + <span class="string">", ProcessRecord.uid = "</span> + app.uid);</div><div class="line">    <span class="comment">// 这里把 ProcessRecord 保存到 ServiceRecrod 里面去了</span></div><div class="line">    <span class="comment">// 以前再跑 bindService 就会走第一种情况的分支了 </span></div><div class="line">    r.app = app;</div><div class="line">    r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</div><div class="line"> </div><div class="line">    app.services.add(r);</div><div class="line">    bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</div><div class="line">    mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">    mAm.updateOomAdjLocked();</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        String nameTerm;</div><div class="line">        <span class="keyword">int</span> lastPeriod = r.shortName.lastIndexOf(<span class="string">'.'</span>);</div><div class="line">        nameTerm = lastPeriod &gt;= <span class="number">0</span> ? r.shortName.substring(lastPeriod) : r.shortName;</div><div class="line">        EventLogTags.writeAmCreateService(</div><div class="line">                r.userId, System.identityHashCode(r), nameTerm, r.app.uid, r.app.pid);</div><div class="line">        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) {</div><div class="line">            r.stats.startLaunchedLocked();</div><div class="line">        }    </div><div class="line">        mAm.ensurePackageDexOpt(r.serviceInfo.packageName);</div><div class="line">        app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</div><div class="line">        <span class="comment">// 和第一种情况差不多，远程跑到服务的进程中调用相关函数处理</span></div><div class="line">        app.thread.scheduleCreateService(r, r.serviceInfo,</div><div class="line">                mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</div><div class="line">                app.repProcState);</div><div class="line">        r.postNotification();</div><div class="line">        created = <span class="keyword">true</span>;</div><div class="line">    } <span class="keyword">finally</span> {</div><div class="line">        <span class="keyword">if</span> (!created) {</div><div class="line">            app.services.remove(r);</div><div class="line">            r.app = <span class="keyword">null</span>;</div><div class="line">            scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</div><div class="line">        }    </div><div class="line">    }    </div><div class="line"></div><div class="line">    <span class="comment">// 这里怎么调用请求绑定的函数，后面返回之后同样还会调用的，</span></div><div class="line">    <span class="comment">// 不过有设置变量，倒不会重复调用，不过感觉有点怪</span></div><div class="line">    requestServiceBindingsLocked(r, execInFg);</div><div class="line"></div><div class="line">    <span class="comment">// 后面的忽略了 ... ...</span></div><div class="line">    <span class="comment">// If the service is in the started state, and there are no</span></div><div class="line">    <span class="comment">// pending arguments, then fake up one so its onStartCommand() will</span></div><div class="line">    <span class="comment">// be called.</span></div><div class="line">    <span class="keyword">if</span> (r.startRequested && r.callStart && r.pendingStarts.size() == <span class="number">0</span>) {</div><div class="line">        r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</div><div class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>));</div><div class="line">    }</div><div class="line"></div><div class="line">    sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.delayed) {</div><div class="line">        <span class="keyword">if</span> (DEBUG_DELAYED_STATS) Slog.v(TAG, <span class="string">"REM FR DELAY LIST (new proc): "</span> + r);</div><div class="line">        getServiceMap(r.userId).mDelayedStartList.remove(r);</div><div class="line">        r.delayed = <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.delayedStop) {</div><div class="line">        <span class="comment">// Oh and hey we've already been asked to stop!</span></div><div class="line">        r.delayedStop = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (r.startRequested) {</div><div class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STATS) Slog.v(TAG, <span class="string">"Applying delayed stop (from start): "</span> + r);</div><div class="line">            stopServiceLocked(r);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>只要 realStartServiceLocked 之后，ServiceRecord 的 app 就不是 null 了，以后绑定，就可以走第一种情况的分支（这个快）。然后主要是远程调用到 AT 的 scheduleCreateService 去让 Service 的进程的主线程执行 Service 的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span>(IBinder token,</div><div class="line">        ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState) {</div><div class="line">    updateProcessState(processState, <span class="keyword">false</span>);</div><div class="line">    CreateServiceData s = <span class="keyword">new</span> CreateServiceData();</div><div class="line">    <span class="comment">// token 是 ServiceRecord 的 IBinder 对象</span></div><div class="line">    s.token = token;</div><div class="line">    <span class="comment">// info 里面有 Service 类名</span></div><div class="line">    s.info = info;</div><div class="line">    s.compatInfo = compatInfo;     </div><div class="line"></div><div class="line">    sendMessage(H.CREATE_SERVICE, s);</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里和前面一样也是发到 Handle 里面的，然后能够直接返回，我们先看看返回后，还有什么处理。其实返回后然后会调用 requestServiceBindsLocked（里面调用 requestServiceBindingsLocked） 去请求绑定服务，这个第一种情况的分支分析过了。不过 bringUpServiceLocked 返回 null 后，还有调用这个的，这里有设置标志，不会重复调用的，至于什么会有2个地方有请求绑定服务的函数，后面到第三种情况就知道了。</p>
<p>现在回到 AT 这边：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span>(CreateServiceData data) {</div><div class="line">    <span class="comment">// If we are getting ready to gc after going to the background, well</span></div><div class="line">    <span class="comment">// we are back active so skip it.</span></div><div class="line">    unscheduleGcIdler();</div><div class="line"></div><div class="line">    LoadedApk packageInfo = getPackageInfoNoCheck(</div><div class="line">            data.info.applicationInfo, data.compatInfo);</div><div class="line">    Service service = <span class="keyword">null</span>;        </div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="comment">// 这里用反射 new 出 Service 的对象出来了                 </span></div><div class="line">        java.lang.ClassLoader cl = packageInfo.getClassLoader();</div><div class="line">        service = (Service) cl.loadClass(data.info.name).newInstance();</div><div class="line">    } <span class="keyword">catch</span> (Exception e) {        </div><div class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(    </div><div class="line">                <span class="string">"Unable to instantiate service "</span> + data.info.name</div><div class="line">                + <span class="string">": "</span> + e.toString(), e);     </div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Creating service "</span> + data.info.name);</div><div class="line"></div><div class="line">        <span class="comment">// Context 也 new 了一个出来</span></div><div class="line">        ContextImpl context = <span class="keyword">new</span> ContextImpl();</div><div class="line">        context.init(packageInfo, <span class="keyword">null</span>, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">        Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line">        context.setOuterContext(service);</div><div class="line">        <span class="comment">// 这个 attach 设置下Service的运行上下文环境（刚刚new出来那个） </span></div><div class="line">        service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</div><div class="line">                ActivityManagerNative.getDefault());</div><div class="line">        <span class="comment">// 调用了 Service 的生命周期函数 onCreate 了</span></div><div class="line">        service.onCreate();            </div><div class="line">        <span class="comment">// 把这个 new 出来的 Service 对象保存到 mServices 里了。</span></div><div class="line">        <span class="comment">// key 是 ServiceRecord 的 IBinder 对象。</span></div><div class="line">        <span class="comment">// 前面 handleBindService 有用到这个东西。</span></div><div class="line">        mServices.put(data.token, service);</div><div class="line">        <span class="comment">// 后面的忽略 ... ...</span></div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            ActivityManagerNative.getDefault().serviceDoneExecuting(</div><div class="line">                    data.token, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);          </div><div class="line">        } <span class="keyword">catch</span> (RemoteException e) {  </div><div class="line">            <span class="comment">// nothing to do.              </span></div><div class="line">        }</div><div class="line">    } <span class="keyword">catch</span> (Exception e) {</div><div class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="string">"Unable to create service "</span> + data.info.name</div><div class="line">                + <span class="string">": "</span> + e.toString(), e);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个 scheduleCreateService 名字太形象的，还真是 new 了一个 Service 对象出来 -_-||。这样 Service 的代码就在主线程中加载起来了（执行了）。前面 AM 那边又会调用 requestServiceBindingsLocked 会让 AT 这边继续向 Handle 发一个 handleBindService 的消息，Handle 的 MessageQueue 会排队的，不用担心，能保证先 CreateService 再 BindService。</p>
<h3 id="服务进程没有启动，服务代码也还没执行">服务进程没有启动，服务代码也还没执行</h3>
<p>前面2种情况说完了。第三种是最悲剧的，服务没运行，连所在的进程都还没跑起来。这种情况下需要启动服务所在进程、然后执行服务代码，最后才能绑定服务。这种情况是最慢的，所以 bindService 有些时候回调快、有些时候回调慢，就是这个原因（看我这篇文章里有关 Zygote 启动进程的就知道慢了： <a href="http://light3moon.com/2015/01/31/工作小笔记——Android 动态切换系统字体" title="工作小笔记——Android 动态切换系统字体" target="_blank" rel="external">工作小笔记——Android 动态切换系统字体</a>）。</p>
<p><img src="https://mingming-killer.github.io/img/pics/android/Binder-service/3.png" alt=""><br>（realStartServiceLocked 后面的我省略了，第二种情况画过了）</p>
<p>我们回到 bringUpServiceLocked 那个分支那：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String <span class="title">bringUpServiceLocked</span>(ServiceRecord r,</div><div class="line">            <span class="keyword">int</span> intentFlags, <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> whileRestarting) {</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="comment">// 这里接着前面那里就可以接着往下走了</span></div><div class="line">        <span class="comment">// Not running -- get it started, and enqueue this service record</span></div><div class="line">        <span class="comment">// to be executed when the app comes up.</span></div><div class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) {</div><div class="line">            <span class="comment">// 调用 AM 的接口去启动服务的进程</span></div><div class="line">            <span class="keyword">if</span> ((app=mAm.startProcessLocked(procName, r.appInfo, <span class="keyword">true</span>, intentFlags,</div><div class="line">                    <span class="string">"service"</span>, r.name, <span class="keyword">false</span>, isolated, <span class="keyword">false</span>)) == <span class="keyword">null</span>) {</div><div class="line">                String msg = <span class="string">"Unable to launch app "</span></div><div class="line">                        + r.appInfo.packageName + <span class="string">"/"</span></div><div class="line">                        + r.appInfo.uid + <span class="string">" for service "</span></div><div class="line">                        + r.intent.getIntent() + <span class="string">": process is bad"</span>;</div><div class="line">                Slog.w(TAG, msg);</div><div class="line">                bringDownServiceLocked(r);</div><div class="line">                <span class="keyword">return</span> msg;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (isolated) {</div><div class="line">                r.isolatedProc = app;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// 把 ServiceRecord 添加到 mPendingServices</span></div><div class="line">        <span class="comment">// 这个玩意后面会有用的</span></div><div class="line">        <span class="keyword">if</span> (!mPendingServices.contains(r)) {</div><div class="line">            mPendingServices.add(r);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// 后面的忽略了 ... ...</span></div><div class="line">        <span class="keyword">if</span> (r.delayedStop) {</div><div class="line">            <span class="comment">// Oh and hey we've already been asked to stop!</span></div><div class="line">            r.delayedStop = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (r.startRequested) {</div><div class="line">                <span class="keyword">if</span> (DEBUG_DELAYED_STATS) Slog.v(TAG, <span class="string">"Applying delayed stop (in bring up): "</span> + r);</div><div class="line">                stopServiceLocked(r);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>这是第三种情况的分支，前面获取 ProcessRecord 是 null，就会往下走了。然后就要调用 AM 的 startProcessLocked 去启动服务所在的进程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> ProcessRecord startProcessLocked(String processName,</div><div class="line">        ApplicationInfo info, <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags,</div><div class="line">        String hostingType, ComponentName hostingName, <span class="keyword">boolean</span> allowWhileBooting,</div><div class="line">        <span class="keyword">boolean</span> isolated, <span class="keyword">boolean</span> keepIfLarge) {</div><div class="line">    ProcessRecord app;</div><div class="line">    <span class="comment">// 先已经存在的进程记录集中取一下，看是不是进程已经存在了</span></div><div class="line">    <span class="comment">// 已经存在的话用已经存在的进程记录</span></div><div class="line">    <span class="keyword">if</span> (!isolated) {</div><div class="line">        app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="comment">// If this is an isolated process, it can't re-use an existing process.</span></div><div class="line">        app = <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">    <span class="comment">// We don't have to do anything more if:</span></div><div class="line">    <span class="comment">// (1) There is an existing application record; and</span></div><div class="line">    <span class="comment">// (2) The caller doesn't think it is dead, OR there is no thread</span></div><div class="line">    <span class="comment">//     object attached to it so we know it couldn't have crashed; and</span></div><div class="line">    <span class="comment">// (3) There is a pid assigned to it, so it is either starting or</span></div><div class="line">    <span class="comment">//     already running.</span></div><div class="line">    <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"startProcess: name="</span> + processName</div><div class="line">            + <span class="string">" app="</span> + app + <span class="string">" knownToBeDead="</span> + knownToBeDead</div><div class="line">            + <span class="string">" thread="</span> + (app != <span class="keyword">null</span> ? app.thread : <span class="keyword">null</span>)</div><div class="line">            + <span class="string">" pid="</span> + (app != <span class="keyword">null</span> ? app.pid : -<span class="number">1</span>));</div><div class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> && app.pid &gt; <span class="number">0</span>) {</div><div class="line">        <span class="keyword">if</span> (!knownToBeDead || app.thread == <span class="keyword">null</span>) {</div><div class="line">            <span class="comment">// We already have the app running, or are waiting for it to</span></div><div class="line">            <span class="comment">// come up (we have a pid but not yet its thread), so keep it.</span></div><div class="line">            <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"App already running: "</span> + app);</div><div class="line">            <span class="comment">// If this is a new package in the process, add the package to the list</span></div><div class="line">            app.addPackage(info.packageName, mProcessStats);</div><div class="line">            <span class="keyword">return</span> app;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// An application record is attached to a previous process,</span></div><div class="line">        <span class="comment">// clean it up now.</span></div><div class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES || DEBUG_CLEANUP) Slog.v(TAG, <span class="string">"App died: "</span> + app);</div><div class="line">        handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    String hostingNameStr = hostingName != <span class="keyword">null</span></div><div class="line">            ? hostingName.flattenToShortString() : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!isolated) {</div><div class="line">        <span class="keyword">if</span> ((intentFlags&Intent.FLAG_FROM_BACKGROUND) != <span class="number">0</span>) {</div><div class="line">            <span class="comment">// If we are in the background, then check to see if this process</span></div><div class="line">            <span class="comment">// is bad.  If so, we will just silently fail.</span></div><div class="line">            <span class="keyword">if</span> (mBadProcesses.get(info.processName, info.uid) != <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"Bad process: "</span> + info.uid</div><div class="line">                        + <span class="string">"/"</span> + info.processName);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            }</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="comment">// When the user is explicitly starting a process, then clear its</span></div><div class="line">            <span class="comment">// crash count so that we won't make it bad until they see at</span></div><div class="line">            <span class="comment">// least one crash dialog again, and make the process good again</span></div><div class="line">            <span class="comment">// if it had been bad.</span></div><div class="line">            <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"Clearing bad process: "</span> + info.uid</div><div class="line">                    + <span class="string">"/"</span> + info.processName);</div><div class="line">            mProcessCrashTimes.remove(info.processName, info.uid);</div><div class="line">            <span class="keyword">if</span> (mBadProcesses.get(info.processName, info.uid) != <span class="keyword">null</span>) {</div><div class="line">                EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,</div><div class="line">                        UserHandle.getUserId(info.uid), info.uid,</div><div class="line">                        info.processName);</div><div class="line">                mBadProcesses.remove(info.processName, info.uid);</div><div class="line">                <span class="keyword">if</span> (app != <span class="keyword">null</span>) {</div><div class="line">                    app.bad = <span class="keyword">false</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// 不存在的话，new 一个 ProcessRecord 出来的，然后保存一下</span></div><div class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) {</div><div class="line">        app = newProcessRecordLocked(info, processName, isolated);</div><div class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) {</div><div class="line">            Slog.w(TAG, <span class="string">"Failed making new process record for "</span></div><div class="line">                    + processName + <span class="string">"/"</span> + info.uid + <span class="string">" isolated="</span> + isolated);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line">        mProcessNames.put(processName, app.uid, app);</div><div class="line">        <span class="keyword">if</span> (isolated) {</div><div class="line">            mIsolatedProcesses.put(app.uid, app);</div><div class="line">        }</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="comment">// If this is a new package in the process, add the package to the list</span></div><div class="line">        app.addPackage(info.packageName, mProcessStats);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// If the system is not ready yet, then hold off on starting this</span></div><div class="line">    <span class="comment">// process until it is.</span></div><div class="line">    <span class="keyword">if</span> (!mProcessesReady</div><div class="line">            && !isAllowedWhileBooting(info)</div><div class="line">            && !allowWhileBooting) {</div><div class="line">        <span class="keyword">if</span> (!mProcessesOnHold.contains(app)) {</div><div class="line">            mProcessesOnHold.add(app);</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"System not ready, putting on hold: "</span> + app);</div><div class="line">        <span class="keyword">return</span> app;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// 又是马甲调用</span></div><div class="line">    startProcessLocked(app, hostingType, hostingNameStr);</div><div class="line">    <span class="keyword">return</span> (app.pid != <span class="number">0</span>) ? app : <span class="keyword">null</span>;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>前面做了一些时候存在的处理，关键的还是最后一个，又调用到另一个同名不同参数的 startProcessLocked 里去了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span>(ProcessRecord app,</div><div class="line">            String hostingType, String hostingNameStr) {</div><div class="line">        <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> && app.pid != MY_PID) {</div><div class="line">            <span class="keyword">synchronized</span> (mPidsSelfLocked) {</div><div class="line">                mPidsSelfLocked.remove(app.pid);</div><div class="line">                mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</div><div class="line">            }</div><div class="line">            app.setPid(<span class="number">0</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES && mProcessesOnHold.contains(app)) Slog.v(TAG,</div><div class="line">                <span class="string">"startProcessLocked removing on hold: "</span> + app);</div><div class="line">        mProcessesOnHold.remove(app);</div><div class="line">        </div><div class="line">        <span class="comment">// 更新下 cpu 统计        </span></div><div class="line">        updateCpuStats();</div><div class="line">                </div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="keyword">int</span> uid = app.uid;</div><div class="line">            </div><div class="line">            <span class="comment">// 获取下这个应用的安装位置（对应 class 文件的位置）</span></div><div class="line">            <span class="comment">// 以及用户组等信息</span></div><div class="line">            <span class="keyword">int</span>[] gids = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</div><div class="line">            <span class="keyword">if</span> (!app.isolated) {</div><div class="line">                <span class="keyword">int</span>[] permGids = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">try</span> {</div><div class="line">                    <span class="keyword">final</span> PackageManager pm = mContext.getPackageManager();</div><div class="line">                    permGids = pm.getPackageGids(app.info.packageName);</div><div class="line">               </div><div class="line">                    <span class="keyword">if</span> (Environment.isExternalStorageEmulated()) {</div><div class="line">                        <span class="keyword">if</span> (pm.checkPermission(</div><div class="line">                                android.Manifest.permission.ACCESS_ALL_EXTERNAL_STORAGE,</div><div class="line">                                app.info.packageName) == PERMISSION_GRANTED) {</div><div class="line">                            mountExternal = Zygote.MOUNT_EXTERNAL_MULTIUSER_ALL;</div><div class="line">                        } <span class="keyword">else</span> {</div><div class="line">                            mountExternal = Zygote.MOUNT_EXTERNAL_MULTIUSER;</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                } <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) {</div><div class="line">                    Slog.w(TAG, <span class="string">"Unable to retrieve gids"</span>, e);</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="comment">/*</span></div><div class="line"><span class="comment">                 * Add shared application GID so applications can share some</span></div><div class="line"><span class="comment">                 * resources like shared libraries</span></div><div class="line"><span class="comment">                 */</span></div><div class="line">                <span class="keyword">if</span> (permGids == <span class="keyword">null</span>) {</div><div class="line">                    gids = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                    gids = <span class="keyword">new</span> <span class="keyword">int</span>[permGids.length + <span class="number">1</span>];</div><div class="line">                    System.arraycopy(permGids, <span class="number">0</span>, gids, <span class="number">1</span>, permGids.length);</div><div class="line">                }</div><div class="line">                gids[<span class="number">0</span>] = UserHandle.getSharedAppGid(UserHandle.getAppId(uid));</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (mFactoryTest != SystemServer.FACTORY_TEST_OFF) {</div><div class="line">                <span class="keyword">if</span> (mFactoryTest == SystemServer.FACTORY_TEST_LOW_LEVEL</div><div class="line">                        && mTopComponent != <span class="keyword">null</span></div><div class="line">                        && app.processName.equals(mTopComponent.getPackageName())) {</div><div class="line">                    uid = <span class="number">0</span>;</div><div class="line">                }</div><div class="line">                <span class="keyword">if</span> (mFactoryTest == SystemServer.FACTORY_TEST_HIGH_LEVEL</div><div class="line">                        && (app.info.flags&ApplicationInfo.FLAG_FACTORY_TEST) != <span class="number">0</span>) {</div><div class="line">                    uid = <span class="number">0</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="comment">// 设置下 zygote 调试信息标志</span></div><div class="line">            <span class="keyword">int</span> debugFlags = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> ((app.info.flags & ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>) {</div><div class="line">                debugFlags |= Zygote.DEBUG_ENABLE_DEBUGGER;</div><div class="line">                <span class="comment">// Also turn on CheckJNI for debuggable apps. It's quite</span></div><div class="line">                <span class="comment">// awkward to turn on otherwise.</span></div><div class="line">                debugFlags |= Zygote.DEBUG_ENABLE_CHECKJNI;</div><div class="line">            }</div><div class="line">            <span class="comment">// Run the app in safe mode if its manifest requests so or the</span></div><div class="line">            <span class="comment">// system is booted in safe mode.</span></div><div class="line">            <span class="keyword">if</span> ((app.info.flags & ApplicationInfo.FLAG_VM_SAFE_MODE) != <span class="number">0</span> ||</div><div class="line">                Zygote.systemInSafeMode == <span class="keyword">true</span>) {</div><div class="line">                debugFlags |= Zygote.DEBUG_ENABLE_SAFEMODE;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (<span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"debug.checkjni"</span>))) {</div><div class="line">                debugFlags |= Zygote.DEBUG_ENABLE_CHECKJNI;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (<span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"debug.jni.logging"</span>))) {</div><div class="line">                debugFlags |= Zygote.DEBUG_ENABLE_JNI_LOGGING;</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (<span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"debug.assert"</span>))) {</div><div class="line">                debugFlags |= Zygote.DEBUG_ENABLE_ASSERT;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// 调用 Procss 去启动进程</span></div><div class="line">            <span class="comment">// Start the process.  It will either succeed and return a result containing</span></div><div class="line">            <span class="comment">// the PID of the new process, or else throw a RuntimeException.</span></div><div class="line">            Process.ProcessStartResult startResult = Process.start(<span class="string">"android.app.ActivityThread"</span>,</div><div class="line">                    app.processName, uid, uid, gids, debugFlags, mountExternal,</div><div class="line">                    app.info.targetSdkVersion, app.info.seinfo, <span class="keyword">null</span>);</div><div class="line"></div><div class="line"><span class="comment">// 后面不贴了，和这里关系不大的</span></div><div class="line">... ...</div><div class="line"></div><div class="line">            }</div><div class="line">        } <span class="keyword">catch</span> (RuntimeException e) {</div><div class="line">            <span class="comment">// XXX do better error recovery.</span></div><div class="line">            app.setPid(<span class="number">0</span>);</div><div class="line">            Slog.e(TAG, <span class="string">"Failure starting process "</span> + app.processName, e);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>启动进程前面要准备比较多参数。最后是调用 Process.java 中的 start 接口去启动进程的。进程通过 Zygote fork 出来的，细节可以看我前面说的我的那篇工作小笔记。这里发过去的要加载的 java 类是 ActivityThread，前面说了这个是 android 应用程序进程的主线程，里面有 java 的 main 函数。然后通过 Zygote fork 后，Service 的进程就跑起来了，然后会跑到 AT 的 main 函数里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) {</div><div class="line">    SamplingProfilerIntegration.start();</div><div class="line"></div><div class="line">    <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></div><div class="line">    <span class="comment">// disable it here, but selectively enable it later (via</span></div><div class="line">    <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></div><div class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);  </div><div class="line"></div><div class="line">    Environment.initForCurrentUser();</div><div class="line"></div><div class="line">    <span class="comment">// Set the reporter for event logging in libcore</span></div><div class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</div><div class="line"></div><div class="line">    Security.addProvider(<span class="keyword">new</span> AndroidKeyStoreProvider());</div><div class="line"></div><div class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</div><div class="line"></div><div class="line">    Looper.prepareMainLooper();    </div><div class="line"></div><div class="line">    <span class="comment">// 关键看这里， attch 这个函数</span></div><div class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread(); </div><div class="line">    thread.attach(<span class="keyword">false</span>); </div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) { </div><div class="line">        sMainThreadHandler = thread.getHandler();</div><div class="line">    }</div><div class="line"></div><div class="line">    AsyncTask.init();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) {</div><div class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></div><div class="line">                LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</div><div class="line">    }</div><div class="line"></div><div class="line">    Looper.loop();</div><div class="line"></div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个 main 函数，new 了一个 AT 对象出来，然后跑了 AT 的 attch 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span>(<span class="keyword">boolean</span> system) {</div><div class="line">    sCurrentActivityThread = <span class="keyword">this</span>; </div><div class="line">    mSystemThread = system;</div><div class="line">    <span class="comment">// 系统进程走的下面那个        </span></div><div class="line">    <span class="keyword">if</span> (!system) {</div><div class="line">        ViewRootImpl.addFirstDrawHandler(<span class="keyword">new</span> Runnable() {</div><div class="line">            <span class="annotation">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {            </div><div class="line">                ensureJitEnabled();            </div><div class="line">            }</div><div class="line">        });</div><div class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"&lt;pre-initialized&gt;"</span>,</div><div class="line">                                                UserHandle.myUserId());        </div><div class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</div><div class="line">        IActivityManager mgr = ActivityManagerNative.getDefault();</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="comment">// 主要是这个，调用了 AM 的 attchApplication</span></div><div class="line">            mgr.attachApplication(mAppThread);</div><div class="line">        } <span class="keyword">catch</span> (RemoteException ex) { </div><div class="line">            <span class="comment">// Ignore</span></div><div class="line">        }</div><div class="line">    } <span class="keyword">else</span> {       </div><div class="line">        <span class="comment">// 系统进程可能在别的地方 attchApplication 了吧</span></div><div class="line">        <span class="comment">// 看注释不想给系统进程设置崩溃弹出的那个对话框       </span></div><div class="line">        <span class="comment">// Don't set application object here -- if the system crashes,</span></div><div class="line">        <span class="comment">// we can't display an alert, we just want to die die die.</span></div><div class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"system_process"</span>,</div><div class="line">                                                UserHandle.myUserId());        </div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            mInstrumentation = <span class="keyword">new</span> Instrumentation();</div><div class="line">            ContextImpl context = <span class="keyword">new</span> ContextImpl();</div><div class="line">            context.init(getSystemContext().mPackageInfo, <span class="keyword">null</span>, <span class="keyword">this</span>);</div><div class="line">            Application app = Instrumentation.newApplication(Application.class, context);</div><div class="line">            mAllApplications.add(app);     </div><div class="line">            mInitialApplication = app;     </div><div class="line">            app.onCreate();                </div><div class="line">        } <span class="keyword">catch</span> (Exception e) {        </div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(    </div><div class="line">                    <span class="string">"Unable to instantiate Application():"</span> + e.toString(), e);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// 后面继续忽略 ... ...</span></div><div class="line">    <span class="comment">// add dropbox logging to libcore</span></div><div class="line">    DropBox.setReporter(<span class="keyword">new</span> DropBoxReporter());</div><div class="line"></div><div class="line">    ViewRootImpl.addConfigCallback(<span class="keyword">new</span> ComponentCallbacks2() {</div><div class="line">        <span class="annotation">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span>(Configuration newConfig) {</div><div class="line">            <span class="keyword">synchronized</span> (mResourcesManager) {</div><div class="line">                <span class="comment">// We need to apply this change to the resources</span></div><div class="line">                <span class="comment">// immediately, because upon returning the view</span></div><div class="line">                <span class="comment">// hierarchy will be informed about it.</span></div><div class="line">                <span class="keyword">if</span> (mResourcesManager.applyConfigurationToResourcesLocked(newConfig, <span class="keyword">null</span>)) {</div><div class="line">                    <span class="comment">// This actually changed the resources!  Tell</span></div><div class="line">                    <span class="comment">// everyone about it.</span></div><div class="line">                    <span class="keyword">if</span> (mPendingConfiguration == <span class="keyword">null</span> ||</div><div class="line">                            mPendingConfiguration.isOtherSeqNewer(newConfig)) {</div><div class="line">                        mPendingConfiguration = newConfig;</div><div class="line"></div><div class="line">                        sendMessage(H.CONFIGURATION_CHANGED, newConfig);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="annotation">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span>() {</div><div class="line">        }</div><div class="line">        <span class="annotation">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span>(<span class="keyword">int</span> level) {</div><div class="line">        }</div><div class="line">    });</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里主要是看调用 AM 的 attachApplication，然后又转到 AM 里面了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span>(IApplicationThread thread) {</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</div><div class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity(); </div><div class="line">        attachApplicationLocked(thread, callingPid);</div><div class="line">        Binder.restoreCallingIdentity(origId);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>是个马甲，但是注意锁。这里我们要回到前面 AM 调用 Process 去 start 服务进程那里，因为那里也是有锁的。所以 AT 这里的 atttach 应该是会被锁住的（binder 的多线程问题见我的另一篇线程篇）。我们先回去到 AM 调用完 Process.start 那里。回去看前面的代码，调用 Process.start 就会从 AM 返回到 bringUpServiceLocked，然后后面把 ServiceRecord 添加到 mPendingServices，然后返回 null 到 bindServiceLocked 继续往下执行，但是到 requestServiceBindingLocked 那里回由于 ServiceRecord 的 app 为 null 而失败，因为进程虽然跑起来了，但是服务还没执行。然后这个 Client 的 AM 的 bindService 应该就调用结束了。然后 AM 的锁就应该没了，现在可以继续回到 Service 的 AT 调用 AM 的 attachApplication 那里继续了。</p>
<p>这里是调用了另一个 attachApplicationLocked:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span>(IApplicationThread thread,</div><div class="line">            <span class="keyword">int</span> pid) {</div><div class="line"></div><div class="line">        <span class="comment">// Find the application record that is being attached...  either via</span></div><div class="line">        <span class="comment">// the pid if we are running in multiple processes, or just pull the</span></div><div class="line">        <span class="comment">// next app record if we are emulating process with anonymous threads.</span></div><div class="line">        ProcessRecord app;</div><div class="line">        <span class="keyword">if</span> (pid != MY_PID && pid &gt;= <span class="number">0</span>) {</div><div class="line">            <span class="keyword">synchronized</span> (mPidsSelfLocked) {</div><div class="line">                app = mPidsSelfLocked.get(pid);</div><div class="line">            }</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            app = <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line"></div><div class="line"><span class="comment">// 这函数太长了，前面都是和这篇关系不大的，忽略先</span></div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="comment">// 主要看这个，果然又调用到 ActiveServices 里面去了</span></div><div class="line">        <span class="comment">// Find any services that should be running in this process...</span></div><div class="line">        <span class="keyword">if</span> (!badApp) {</div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                didSomething |= mServices.attachApplicationLocked(app, processName);</div><div class="line">            } <span class="keyword">catch</span> (Exception e) {</div><div class="line">                badApp = <span class="keyword">true</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!didSomething) {</div><div class="line">            updateOomAdjLocked();</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>我们继续去 ActiveServices 里面去看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">boolean</span> attachApplicationLocked(ProcessRecord proc, String processName) <span class="keyword">throws</span> Exception {</div><div class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">// 前面那个 mPendingServices 作用就是这里啦</span></div><div class="line">    <span class="comment">// Collect any services that are waiting for this process to come up.</span></div><div class="line">    <span class="keyword">if</span> (mPendingServices.size() &gt; <span class="number">0</span>) {</div><div class="line">        ServiceRecord sr = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> {   </div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mPendingServices.size(); i++) {</div><div class="line">                sr = mPendingServices.get(i);</div><div class="line">                <span class="keyword">if</span> (proc != sr.isolatedProc && (proc.uid != sr.appInfo.uid</div><div class="line">                        || !processName.equals(sr.processName))) {</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                }</div><div class="line">        </div><div class="line">                <span class="comment">// 调用 realStartServiceLocked 去启动服务了</span></div><div class="line">                mPendingServices.remove(i);</div><div class="line">                i--;</div><div class="line">                proc.addPackage(sr.appInfo.packageName, mAm.mProcessStats);</div><div class="line">                realStartServiceLocked(sr, proc, sr.createdFromFg);</div><div class="line">                didSomething = <span class="keyword">true</span>;</div><div class="line">            }</div><div class="line">        } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            Slog.w(TAG, <span class="string">"Exception in new application when starting service "</span></div><div class="line">                    + sr.shortName, e);</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        }   </div><div class="line">    }       </div><div class="line">    <span class="comment">// Also, if there are any services that are waiting to restart and</span></div><div class="line">    <span class="comment">// would run in this process, now is a good time to start them.  It would</span></div><div class="line">    <span class="comment">// be weird to bring up the process but arbitrarily not let the services</span></div><div class="line">    <span class="comment">// run at this point just because their restart time hasn't come up.</span></div><div class="line">    <span class="keyword">if</span> (mRestartingServices.size() &gt; <span class="number">0</span>) {</div><div class="line">        ServiceRecord sr = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mRestartingServices.size(); i++) {</div><div class="line">            sr = mRestartingServices.get(i);</div><div class="line">            <span class="keyword">if</span> (proc != sr.isolatedProc && (proc.uid != sr.appInfo.uid</div><div class="line">                    || !processName.equals(sr.processName))) {</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            }</div><div class="line">            mAm.mHandler.removeCallbacks(sr.restarter);</div><div class="line">            mAm.mHandler.post(sr.restarter);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> didSomething;</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>还记得前面 bringUpServiceLocked 调用完 AM startProcessLocked 把 ServiceRecord 添加到 mPendingServices 中，我说这个东西后面会有用的。就是在这里用的。前面也看到了，bindService 继续完后走，但是由于服务还没执行，所以无法进行绑定操作。所以就拿了个东西把要绑定的服务信息保存起来，当服务所在的进程跑起来去 attach 上下文的时候去检测这个东西，如果有的话就去启动需要绑定的服务。怪不得叫 Pending XX ，其实就是延迟处理的意思。怪不得前面分析 realStartServiceLocked 为什么最后那里还有 requestServiceBindingsLocked 的操作，明明 bindServiceLocked 后面已经有了，原来是这里用的啊。</p>
<p>realStartServiceLocked 前面分析过了，回去看看吧，这里不重复说了。到这里 bindService 三种情况都说完了。可以看得出来第三种情况是最麻烦的，得拿个东西保存一下要绑定的信息，然后去启动服务所在的进程，等进程跑主线程的 main 函数再去执行服务代码，然后才能绑定。</p>
<h2 id="总结">总结</h2>
<p>普通服务的 binder 对象的传递就分析完了。其实普通服务 binder 对象的获取原理上和 SS 是差不多的，SS 是向 SM 注册，然后 SM 保存了 SS binder 的 handle 值，然后通过向 SM 取 SS 的 binder 对象。而普通服务则是在启动的时候在 AM 保存了 ServiceRecord，然后普通应用通过 AM 的 bindService 去让 AM 向普通服务要 binder 对象，然后传给普通应用。感觉对于普通应用（服务）来说，AM 就牵了根线，有点像 SM 的感觉了。还有一点区别，SS 是一开机就启动的，正常情况下一直运行的，所以不存在说服务还没运行一说，所以 SM 一直返回之前保存的 handle 值就行了。但是普通服务没这待遇，开机不一定能启动不说，还可能由于系统资源不足而被杀死，所以 AM 在 bindService 的时候还得兼顾进程、服务还没启动的情况。</p>
<p>这就是铁饭碗和临时工的区别啊 -_-|| 。</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/android/">android</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-Framework/">Android Framework</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.light3moon.com/2015/01/28/Android Binder 分析——普通服务 Binder 对象的传递/" data-title="Android Binder 分析——普通服务 Binder 对象的传递 | Light.Moon" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/01/28/Android Binder 分析——系统服务 Binder 对象的传递/" title="Android Binder 分析——系统服务 Binder 对象的传递">
  <strong>上一篇:</strong><br/>
  <span>
  Android Binder 分析——系统服务 Binder 对象的传递</span>
</a>
</div>


<div class="next">
<a href="/2015/01/28/Android Binder 分析——多线程支持/"  title="Android Binder 分析——多线程支持">
 <strong>下一篇:</strong><br/> 
 <span>Android Binder 分析——多线程支持
</span>
</a>
</div>

</nav>


	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Client_相关接口"><span class="toc-number">1.</span> <span class="toc-text">Client 相关接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service_相关接口"><span class="toc-number">2.</span> <span class="toc-text">Service 相关接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bindService_的实现"><span class="toc-number">3.</span> <span class="toc-text">bindService 的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务进程和服务都已经启动"><span class="toc-number">3.1.</span> <span class="toc-text">服务进程和服务都已经启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务进程已经启动，但是服务还没运行"><span class="toc-number">3.2.</span> <span class="toc-text">服务进程已经启动，但是服务还没运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务进程没有启动，服务代码也还没执行"><span class="toc-number">3.3.</span> <span class="toc-text">服务进程没有启动，服务代码也还没执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android-Development/" title="Android Development">Android Development<sup>32</sup></a></li>
		
			<li><a href="/categories/Android-Framework/" title="Android Framework">Android Framework<sup>48</sup></a></li>
		
			<li><a href="/categories/Basics-Knowledge/" title="Basics Knowledge">Basics Knowledge<sup>11</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>24</sup></a></li>
		
			<li><a href="/categories/MiniGUI/" title="MiniGUI">MiniGUI<sup>12</sup></a></li>
		
			<li><a href="/categories/Other/" title="Other">Other<sup>9</sup></a></li>
		
			<li><a href="/categories/Performance/" title="Performance">Performance<sup>4</sup></a></li>
		
			<li><a href="/categories/Window/" title="Window">Window<sup>10</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		
			<li><a href="/tags/android/" title="android">android<sup>84</sup></a></li>
		
			<li><a href="/tags/basics/" title="basics">basics<sup>11</sup></a></li>
		
			<li><a href="/tags/install/" title="install">install<sup>9</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>27</sup></a></li>
		
			<li><a href="/tags/minigui/" title="minigui">minigui<sup>13</sup></a></li>
		
			<li><a href="/tags/opengl/" title="opengl">opengl<sup>3</sup></a></li>
		
			<li><a href="/tags/other/" title="other">other<sup>5</sup></a></li>
		
			<li><a href="/tags/server/" title="server">server<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>5</sup></a></li>
		
			<li><a href="/tags/window/" title="window">window<sup>11</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">我的链接</p>
    <ul>
      <li><i class="fa fa-github"></i> <a href="https://github.com/mingming-killer" target="_blank">GitHub</a></li>
      
        
          <li><i class="fa fa-analytics"></i> <a href="http://tongji.baidu.com/web/welcome/ico?s=fa045dbd45ffce238b146e00f91ba6a3" target="_blank">网站数据统计</a></li>
        
      
      <li><i class="fa fa-markdown-help"></i> <a href="http://zh.wikipedia.org/wiki/Markdown" target="_blank">Makrdown</a></li>
    </ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <li><i class="fa fa-book"></i> <a href="http://taoyuanxiaoqi.com" target="_blank">桃园小七的博客</a></li>
      <li><i class="fa fa-book"></i> <a href="https://dongka.github.io" target="_blank">Dongka的博客</a></li>
    </ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
<!--
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
-->

     <!-- this is defined in footer.styl, line holder -->
	<div class="line">
	</div>
     
<!--
	<div class="social-font clearfix">
		
		
		
		
		
		<a href="https://github.com/mingming-killer" target="_blank" title="github"></a>
		
        	         
	</div>
-->

		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/mingming-killer/Lightmoon" target="_blank" title="Lightmoon">Lightmoon</a> © 2021 
		
		<a href="http://www.light3moon.com" target="_blank" title="Mingming">Mingming</a>
		
		</p>

  <!-- baidu search verification -->
  
    <meta name="baidu-site-verification" content="w1BSX6yZ9k" />
  

  <!-- swiftype search verification -->
  

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fa045dbd45ffce238b146e00f91ba6a3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>
