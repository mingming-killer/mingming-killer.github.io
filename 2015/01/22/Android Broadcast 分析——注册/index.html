
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">

  
    <title>Android Broadcast 分析——注册 | Light.Moon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Mingming">
    
    <meta name="description" content="背景
我们的平板增加了一个关机闹钟的功能。就是设备在关机的情况也能唤醒然后响闹钟。实现方法是：在 kernel 中增加一个 RTC 时钟（关机情况下，板载的 RTC 时钟还在运行的，所以你关机一段时间发现电池会变少），然后提前一段时间开机（我们设定的是1分钟，得给点时间给开机，我们的平板开机要40多">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/apple_icon.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/apple_icon.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
		<div id="header_author">
		</div>
		

         <!--
         
           <div id="imglogo">
           <a href="/"><img src="/img/logo.svg" alt="Light.Moon" title="Light.Moon"/></a>
           </div>
         
         -->

			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Light.Moon">Light.Moon</a></h1>
				<h2 class="blog-motto">〜(￣△￣〜) 三月学长的根据地 (〜￣△￣)〜</h2>
			</div>

			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">首页</a></li>
					
						<li><a href="/1986/12/20/文章索引">索引</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					

                      <form class="search" action=http://search.light3moon.com/cse/search target="_blank">
                      <label>搜索</label>
                      <!--
                      <input name="s" type="hidden" value="undefined">
                      -->
                      <input name="s" type="hidden" value="12628367885198549364">
                      <input type="text" name="q" size="30" placeholder="搜索"> <br>

                      
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/01/22/Android Broadcast 分析——注册/" title="Android Broadcast 分析——注册" itemprop="url">Android Broadcast 分析——注册</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://www.light3moon.com" title="Mingming">Mingming</a>
    </p>
  <p class="article-time">
    <time datetime="2015-01-22T02:07:16.000Z" itemprop="datePublished">2015 1月 22</time>
    更新日期:<time datetime="2016-03-31T02:34:16.000Z" itemprop="dateModified">2016 3月 31</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态注册"><span class="toc-number">2.</span> <span class="toc-text">动态注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#接口端"><span class="toc-number">2.1.</span> <span class="toc-text">接口端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端"><span class="toc-number">2.2.</span> <span class="toc-text">服务端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#静态注册"><span class="toc-number">3.</span> <span class="toc-text">静态注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol>
		</div>
		
		<h2 id="背景">背景</h2>
<p>我们的平板增加了一个关机闹钟的功能。就是设备在关机的情况也能唤醒然后响闹钟。实现方法是：在 kernel 中增加一个 RTC 时钟（关机情况下，板载的 RTC 时钟还在运行的，所以你关机一段时间发现电池会变少），然后提前一段时间开机（我们设定的是1分钟，得给点时间给开机，我们的平板开机要40多秒咧），然后闹钟模块接收开机广播（<code>ACTION_BOOT_COMPLETED</code>），然后把 android 应用层的闹钟设置下去，然后就能实现关机闹钟功能了。</p>
<p>但是最近遇到一个问题：说关机闹钟，到了时间设备能唤醒，但是闹钟不响。于是分析一下 android 广播的处理流程（这里以开机广播为例）。然后顺带记录下分析过程，以后忘记看几眼能捡起来。</p>
<p>android 广播的注册方式分为2种：一种是动态注册，一种是静态注册。哦，对了，在说之前，照例把相关源码位置啰嗦一下（4.2.2）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Content 广播相关的代码</span></div><div class="line">frameworks/base/core/java/android/app/ContextImpl.java</div><div class="line">frameworks/base/core/java/android/app/LoadedApk.java</div><div class="line"></div><div class="line">frameworks/base/core/java/android/content/Intent.java</div><div class="line">frameworks/base/core/java/android/content/IntentFilter.java</div><div class="line">frameworks/base/core/java/android/content/BroadcastReceiver.java</div><div class="line">frameworks/base/core/java/android/content/IIntentReceiver.aidl</div><div class="line"></div><div class="line"><span class="comment"># 广播解析相关代码</span></div><div class="line">frameworks/base/services/java/com/android/server/IntentResolver.java</div><div class="line"></div><div class="line"><span class="comment"># AM 广播相关代码</span></div><div class="line">frameworks/base/services/java/com/android/server/am/ActivityManagerService.java</div><div class="line">frameworks/base/services/java/com/android/server/am/RecevierList.java</div><div class="line">frameworks/base/services/java/com/android/server/am/BroadcastFilter.java</div><div class="line">frameworks/base/services/java/com/android/server/am/BroadcastRecord.java</div><div class="line"></div><div class="line"><span class="comment"># PM 广播相关代码</span></div><div class="line">frameworks/base/services/java/com/android/server/pm/PackageManagerService.java</div><div class="line"></div></pre></td></tr></table></figure>

<h2 id="动态注册">动态注册</h2>
<h3 id="接口端">接口端</h3>
<p>我们先来说说动态注册。动态注册是在程序当中调用 Context（ContextImpl）的接口来注册的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span>(BroadcastReceiver receiver, IntentFilter filter)</div><div class="line"></div></pre></td></tr></table></figure>

<p>其中一般自己要继承 BoradcastReceiver，然后实现里面的 onReceive 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Context 是运行该 receiver 所在在的 context</span></div><div class="line"><span class="comment">// Intent 是所接收到的广播发出的 intent </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onReceive</span>(Context context, Intent intent);</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后那个 IntentFilter 里面可以设置要接收的广播，可以设置好多种类型，具体的自己去翻 api 文档。一般简单的可以直接设一个 ACTION。然后因为这个是需要在程序运行中拿 Context 去注册的，所以这种注册就有一个特点：<strong>接收广播的进程已经运行起来了</strong>。</p>
<p>接下来我们就去看看这个注册过程是怎么样的。首先调用的是 Context（Activity、Service 里均可以调用）的 registerReceiver ，这个其实是挂 ContextImpl 里面的同名函数的马甲：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span>(BroadcastReceiver receiver, IntentFilter filter) {</div><div class="line">    <span class="keyword">return</span> registerReceiver(receiver, filter, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span>(BroadcastReceiver receiver, IntentFilter filter,</div><div class="line">        String broadcastPermission, Handler scheduler) {</div><div class="line">    <span class="keyword">return</span> registerReceiverInternal(receiver, getUserId(),</div><div class="line">            filter, broadcastPermission, scheduler, getOuterContext());</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>可以看出最后是调用 registerReceiverInternal 这个函数的。然后我们用的那个没指定权限（我们先不管啥权限之类的），还有 Handler。传过去的是 null：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Intent <span class="title">registerReceiverInternal</span>(BroadcastReceiver receiver, <span class="keyword">int</span> userId,</div><div class="line">        IntentFilter filter, String broadcastPermission,</div><div class="line">        Handler scheduler, Context context) {</div><div class="line">    IIntentReceiver rd = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (receiver != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span> && context != <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) {</div><div class="line">                <span class="comment">// 默认使用的是当前注册进程的主线程来处理接收到的广播</span></div><div class="line">                scheduler = mMainThread.getHandler();</div><div class="line">            }    </div><div class="line">            <span class="comment">// 如果 mPackageInfo(LoadedApk) 不为空，去调用其中的方法取 IIntentReceiver</span></div><div class="line">            rd = mPackageInfo.getReceiverDispatcher(</div><div class="line">                receiver, context, scheduler,</div><div class="line">                mMainThread.getInstrumentation(), <span class="keyword">true</span>);</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) {</div><div class="line">                scheduler = mMainThread.getHandler();</div><div class="line">            }</div><div class="line">            <span class="comment">// 否则直接 new 一个新的出来</span></div><div class="line">            rd = <span class="keyword">new</span> LoadedApk.ReceiverDispatcher(</div><div class="line">                    receiver, context, scheduler, <span class="keyword">null</span>, <span class="keyword">true</span>).getIIntentReceiver();</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="comment">// 最后还是要去 AM 里面去注册</span></div><div class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().registerReceiver(</div><div class="line">                mMainThread.getApplicationThread(), mBasePackageName,</div><div class="line">                rd, filter, broadcastPermission, userId);</div><div class="line">    } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后我们得先说 IIntentReceiver 这个东西。这个是保存广播最基本的数据了。这个是以 II 开头的，就知道这个实现了 Binder 接口支持 IPC 访问的。这个是用 aidl 写的，接口只有一个： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 这个看注释就知道是接收到广播后触发处理的函数</span></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * System private API for dispatching intent broadcasts.  This is given to the </span></div><div class="line"><span class="comment"> * activity manager as part of registering for an intent broadcasts, and is</span></div><div class="line"><span class="comment"> * called when it receives intents.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * {@hide}</span></div><div class="line"><span class="comment"> */</span></div><div class="line">oneway interface IIntentReceiver {</div><div class="line">    <span class="keyword">void</span> performReceive(in Intent intent, <span class="keyword">int</span> resultCode, String data,</div><div class="line">            in Bundle extras, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser);</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后 LoadApk 中的一个内部类的内部类(LoadedApk.ReceiverDispatcher.InnerReceiver)实现了这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> class ReceiverDispatcher {</div><div class="line">        </div><div class="line">        <span class="comment">// 这里是 Bn 端啦，注册的进程运行处理函数（Bp 端的实现 aidl 自动生成鸟）</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">static</span> class InnerReceiver extends IIntentReceiver.Stub {</div><div class="line">            <span class="keyword">final</span> WeakReference&lt;LoadedApk.ReceiverDispatcher&gt; mDispatcher;</div><div class="line">            <span class="keyword">final</span> LoadedApk.ReceiverDispatcher mStrongRef;</div><div class="line">            </div><div class="line">            InnerReceiver(LoadedApk.ReceiverDispatcher rd, <span class="keyword">boolean</span> strong) {</div><div class="line">                mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ReceiverDispatcher&gt;(rd);</div><div class="line">                mStrongRef = strong ? rd : <span class="keyword">null</span>;</div><div class="line">            }</div><div class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performReceive</span>(Intent intent, <span class="keyword">int</span> resultCode, String data,</div><div class="line">                    Bundle extras, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser) {</div><div class="line">                <span class="comment">// 这里我们先不分析处理过程，留到后面再说</span></div><div class="line">                ... ...</div><div class="line">            }</div><div class="line">        }</div><div class="line">        </div><div class="line">... ...</div><div class="line">        </div><div class="line">        <span class="keyword">final</span> IIntentReceiver.Stub mIIntentReceiver;</div><div class="line">        <span class="keyword">final</span> BroadcastReceiver mReceiver;</div><div class="line">        <span class="keyword">final</span> Context mContext;</div><div class="line">        <span class="keyword">final</span> Handler mActivityThread;</div><div class="line">        <span class="keyword">final</span> Instrumentation mInstrumentation;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> mRegistered;</div><div class="line">        <span class="keyword">final</span> IntentReceiverLeaked mLocation;</div><div class="line">        RuntimeException mUnregisterLocation;</div><div class="line">        <span class="keyword">boolean</span> mForgotten;</div><div class="line">        </div><div class="line">... ...</div><div class="line">        </div><div class="line">        ReceiverDispatcher(BroadcastReceiver receiver, Context context,</div><div class="line">                Handler activityThread, Instrumentation instrumentation,</div><div class="line">                <span class="keyword">boolean</span> registered) {</div><div class="line">            <span class="keyword">if</span> (activityThread == <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Handler must not be null"</span>);</div><div class="line">            }</div><div class="line">            </div><div class="line">            <span class="comment">// new 这个 ReceiverDispatcher 的时候就会 new 一个 InnerReceiver</span></div><div class="line">            mIIntentReceiver = <span class="keyword">new</span> InnerReceiver(<span class="keyword">this</span>, !registered);</div><div class="line">            <span class="comment">// 保存广播接收器对象</span></div><div class="line">            mReceiver = receiver;</div><div class="line">            mContext = context;</div><div class="line">            <span class="comment">// 保存指定的处理广播的线程（Handler）</span></div><div class="line">            mActivityThread = activityThread;</div><div class="line">            mInstrumentation = instrumentation;</div><div class="line">            mRegistered = registered;</div><div class="line">            mLocation = <span class="keyword">new</span> IntentReceiverLeaked(<span class="keyword">null</span>);</div><div class="line">            mLocation.fillInStackTrace();</div><div class="line">        }</div><div class="line">        </div><div class="line">        <span class="keyword">void</span> validate(Context context, Handler activityThread) {</div><div class="line">            <span class="keyword">if</span> (mContext != context) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    <span class="string">"Receiver "</span> + mReceiver +</div><div class="line">                    <span class="string">" registered with differing Context (was "</span> +</div><div class="line">                    mContext + <span class="string">" now "</span> + context + <span class="string">")"</span>);</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (mActivityThread != activityThread) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    <span class="string">"Receiver "</span> + mReceiver +</div><div class="line">                    <span class="string">" registered with differing handler (was "</span> +</div><div class="line">                    mActivityThread + <span class="string">" now "</span> + activityThread + <span class="string">")"</span>);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        IIntentReceiver getIIntentReceiver() {</div><div class="line">            <span class="keyword">return</span> mIIntentReceiver;</div><div class="line">        }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个 LoadedApk 看名字，基本上就是和本应用程序包相关的东西（manifest 里面申明的那一堆东西基本上都在这里，当然扫描、解析是 PMS 干的）。然后它提供一个 IIntentReceiver 的 Bn 实现。它会保存调用者传递过来的 Handler，这个也就是说我们可以指定广播处理的线程（哪天有空把 Handler、Looper 也写下分析），如果我们没有指定的话，默认用注册进程的主线程（<strong>所以如果要在广播接收中做一些耗时的操作，请开一个后台线程作为接收的处理线程</strong>）。然后我们回到 ContextImpl 的注册函数那，有一个处理，如果 mPackageInfo 不为空，就去调用 LoadedApk 里的函数去取：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> IIntentReceiver <span class="title">getReceiverDispatcher</span>(BroadcastReceiver r,</div><div class="line">        Context context, Handler handler,</div><div class="line">        Instrumentation instrumentation, <span class="keyword">boolean</span> registered) {</div><div class="line">    <span class="keyword">synchronized</span> (mReceivers) {</div><div class="line">        LoadedApk.ReceiverDispatcher rd = <span class="keyword">null</span>;</div><div class="line">        HashMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt; map = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// 动态注册传过来的是 true</span></div><div class="line">        <span class="keyword">if</span> (registered) { </div><div class="line">            <span class="comment">// 其实就是内部把之前注册过的保存了起来，如果后面重复注册一样的，可以不用重复处理</span></div><div class="line">            map = mReceivers.get(context);</div><div class="line">            <span class="keyword">if</span> (map != <span class="keyword">null</span>) {</div><div class="line">                rd = map.get(r);</div><div class="line">            }   </div><div class="line">        }           </div><div class="line">        <span class="keyword">if</span> (rd == <span class="keyword">null</span>) {</div><div class="line">            <span class="comment">// 如果之前没有注册过的话，还是要创建一个新的</span></div><div class="line">            rd = <span class="keyword">new</span> ReceiverDispatcher(r, context, handler,</div><div class="line">                    instrumentation, registered);</div><div class="line">            <span class="keyword">if</span> (registered) {</div><div class="line">                <span class="keyword">if</span> (map == <span class="keyword">null</span>) {</div><div class="line">                    map = <span class="keyword">new</span> HashMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;();</div><div class="line">                    mReceivers.put(context, map);</div><div class="line">                }</div><div class="line">                map.put(r, rd);</div><div class="line">            }</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="comment">// 这个验证代码去看前面，就是检测下是不是当前运行的环境和线程而已</span></div><div class="line">            rd.validate(context, handler);</div><div class="line">        }</div><div class="line">        rd.mForgotten = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">return</span> rd.getIIntentReceiver();</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>然后后面就去 AMS 里面去注册了。其实 AMS 可以说是广播的中转站，应用程序通过 AMS 发送广播，然后 AMS 找到对应的接收器进行广播分发（咋感觉和消息分发差不多）。</p>
<h3 id="服务端">服务端</h3>
<p>来看下 AMS 中 registerReceiver ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// caller: 客户端传过来标示客户进程的</span></div><div class="line"><span class="comment">// receiver: 客户端准备好的接收广播的对象，这里传过来已经是 Bp 端了</span></div><div class="line"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span>(IApplicationThread caller, String callerPackage,</div><div class="line">        IIntentReceiver receiver, IntentFilter filter, String permission, <span class="keyword">int</span> userId) {</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"registerReceiver"</span>);</div><div class="line">    <span class="keyword">int</span> callingUid;</div><div class="line">    <span class="keyword">int</span> callingPid;</div><div class="line">    <span class="comment">// IPC 服务端多线程，接口实现照例加锁</span></div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) {</div><div class="line">        <span class="comment">// 这里是去取注册调用者的进程信息，pid、uid 之类的</span></div><div class="line">        ProcessRecord callerApp = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) {</div><div class="line">            callerApp = getRecordForAppLocked(caller);</div><div class="line">            <span class="keyword">if</span> (callerApp == <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                        <span class="string">"Unable to find app for caller "</span> + caller</div><div class="line">                        + <span class="string">" (pid="</span> + Binder.getCallingPid()</div><div class="line">                        + <span class="string">") when registering receiver "</span> + receiver);</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (callerApp.info.uid != Process.SYSTEM_UID &&</div><div class="line">                    !callerApp.pkgList.contains(callerPackage)) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Given caller package "</span> + callerPackage</div><div class="line">                        + <span class="string">" is not running in process "</span> + callerApp);</div><div class="line">            }</div><div class="line">            callingUid = callerApp.info.uid;</div><div class="line">            callingPid = callerApp.pid;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            callerPackage = <span class="keyword">null</span>;</div><div class="line">            callingUid = Binder.getCallingUid();</div><div class="line">            callingPid = Binder.getCallingPid();</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// 把用户 Id 也取到了，android 中多用户的广播是分开的，能够避免一些公共广播发出来，</span></div><div class="line">        <span class="comment">// 把其他用户安装的应用也启动起来</span></div><div class="line">        userId = <span class="keyword">this</span>.handleIncomingUser(callingPid, callingUid, userId,</div><div class="line">                <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="string">"registerReceiver"</span>, callerPackage);</div><div class="line"></div><div class="line">        List allSticky = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 这个和 sticky 功能相关我们不管先</span></div><div class="line">        <span class="comment">// Look for any matching sticky broadcasts...</span></div><div class="line">        Iterator actions = filter.actionsIterator();</div><div class="line">        <span class="keyword">if</span> (actions != <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">while</span> (actions.hasNext()) {</div><div class="line">                String action = (String)actions.next();</div><div class="line">                allSticky = getStickiesLocked(action, filter, allSticky,</div><div class="line">                        UserHandle.USER_ALL);</div><div class="line">                allSticky = getStickiesLocked(action, filter, allSticky,</div><div class="line">                        UserHandle.getUserId(callingUid));</div><div class="line">            }</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            allSticky = getStickiesLocked(<span class="keyword">null</span>, filter, allSticky,</div><div class="line">                    UserHandle.USER_ALL);</div><div class="line">            allSticky = getStickiesLocked(<span class="keyword">null</span>, filter, allSticky,</div><div class="line">                    UserHandle.getUserId(callingUid));</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// The first sticky in the list is returned directly back to</span></div><div class="line">        <span class="comment">// the client.</span></div><div class="line">        Intent sticky = allSticky != <span class="keyword">null</span> ? (Intent)allSticky.get(<span class="number">0</span>) : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(TAG, <span class="string">"Register receiver "</span> + filter</div><div class="line">                + <span class="string">": "</span> + sticky);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (receiver == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">return</span> sticky;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// 这个根据传过来的 IIntentReceiver(receiver) 构造一个 ReceiverList</span></div><div class="line">        <span class="comment">// 这个其实一个数组，一个 receiver 可能可以对应多个 Intent（广播）</span></div><div class="line">        ReceiverList rl</div><div class="line">            = (ReceiverList)mRegisteredReceivers.get(receiver.asBinder());</div><div class="line">        <span class="keyword">if</span> (rl == <span class="keyword">null</span>) {</div><div class="line">            rl = <span class="keyword">new</span> ReceiverList(<span class="keyword">this</span>, callerApp, callingPid, callingUid,</div><div class="line">                    userId, receiver);</div><div class="line">            <span class="keyword">if</span> (rl.app != <span class="keyword">null</span>) {</div><div class="line">                rl.app.receivers.add(rl);</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="keyword">try</span> {</div><div class="line">                    <span class="comment">// 这里注册了这个 recevier 的死亡通知函数（后面会知道这个注册的用处的）</span></div><div class="line">                    receiver.asBinder().linkToDeath(rl, <span class="number">0</span>);</div><div class="line">                } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">                    <span class="keyword">return</span> sticky;</div><div class="line">                }</div><div class="line">                rl.linkedToDeath = <span class="keyword">true</span>;</div><div class="line">            }</div><div class="line">            mRegisteredReceivers.put(receiver.asBinder(), rl);</div><div class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (rl.uid != callingUid) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                    <span class="string">"Receiver requested to register for uid "</span> + callingUid</div><div class="line">                    + <span class="string">" was previously registered for uid "</span> + rl.uid);</div><div class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (rl.pid != callingPid) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                    <span class="string">"Receiver requested to register for pid "</span> + callingPid</div><div class="line">                    + <span class="string">" was previously registered for pid "</span> + rl.pid);</div><div class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (rl.userId != userId) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                    <span class="string">"Receiver requested to register for user "</span> + userId</div><div class="line">                    + <span class="string">" was previously registered for user "</span> + rl.userId);</div><div class="line">        }</div><div class="line">        <span class="comment">// 然后再根据上面的 ReceiverList 构造出一个 BroadcastFilter</span></div><div class="line">        BroadcastFilter bf = <span class="keyword">new</span> BroadcastFilter(filter, rl, callerPackage,</div><div class="line">                permission, callingUid, userId);</div><div class="line">        rl.add(bf);</div><div class="line">        <span class="keyword">if</span> (!bf.debugCheck()) {</div><div class="line">            Slog.w(TAG, <span class="string">"==&gt; For Dynamic broadast"</span>);</div><div class="line">        }</div><div class="line">        <span class="comment">// 这里是关键步骤了，把上面那个 BroadcastFilter add 到 IntentResolver 这个对象中。</span></div><div class="line">        <span class="comment">// 这个东西后面分发广播的时候会用到（其实分发的时候查询这个里面的数据）。</span></div><div class="line">        mReceiverResolver.addFilter(bf);</div><div class="line"></div><div class="line">        <span class="comment">// sticky 相关的继续无视</span></div><div class="line">        <span class="comment">// Enqueue broadcasts for all existing stickies that match</span></div><div class="line">        <span class="comment">// this filter.</span></div><div class="line">        <span class="keyword">if</span> (allSticky != <span class="keyword">null</span>) {</div><div class="line">            ArrayList receivers = <span class="keyword">new</span> ArrayList();</div><div class="line">            receivers.add(bf);</div><div class="line"></div><div class="line">            <span class="keyword">int</span> N = allSticky.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) {</div><div class="line">                Intent intent = (Intent)allSticky.get(i);</div><div class="line">                BroadcastQueue queue = broadcastQueueForIntent(intent);</div><div class="line">                BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, <span class="keyword">null</span>,</div><div class="line">                        <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="keyword">null</span>, receivers, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</div><div class="line">                        <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, -<span class="number">1</span>);</div><div class="line">                queue.enqueueParallelBroadcastLocked(r);</div><div class="line">                queue.scheduleBroadcastsLocked();</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">return</span> sticky;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>我们先说说参数，IIntentReceiver 是支持 Binder 的，传过来的是 Bp，IntentFilter 实现了 Parcelable 接口，也能 IPC 传过来。然后我们再开始说代码，一开始先获取注册调用者的进程记录（ProcessRecord，这个东西在 Binder 篇有说过，这里不多说）。然后广播有个 sticky 的功能，我们先不管这些花哨功能先。后面出现了一个 ReceiverList 的对象，我们来看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * A receiver object that has registered for one or more broadcasts.</span></div><div class="line"><span class="comment"> * The ArrayList holds BroadcastFilter objects.</span></div><div class="line"><span class="comment"> */</span></div><div class="line">class ReceiverList extends ArrayList&lt;BroadcastFilter&gt;</div><div class="line">        implements IBinder.DeathRecipient {</div><div class="line">    <span class="keyword">final</span> ActivityManagerService owner;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> IIntentReceiver receiver;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ProcessRecord app;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> pid;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> uid;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> userId;</div><div class="line">    BroadcastRecord curBroadcast = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">boolean</span> linkedToDeath = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    String stringName;</div><div class="line">        </div><div class="line">    ReceiverList(ActivityManagerService _owner, ProcessRecord _app,</div><div class="line">            <span class="keyword">int</span> _pid, <span class="keyword">int</span> _uid, <span class="keyword">int</span> _userId, IIntentReceiver _receiver) {</div><div class="line">        owner = _owner;</div><div class="line">        receiver = _receiver;</div><div class="line">        app = _app;</div><div class="line">        pid = _pid;</div><div class="line">        uid = _uid;</div><div class="line">        userId = _userId;</div><div class="line">    } </div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个是自己改造的一个 ArrayList，里面存放的是 BroadcastFilter，然后注意它保存了 IIntentReceiver（从 AMS 注册接口调用者那里得到）。然后上面的代码后面马上就构造出了一个 BroadcastFilter，添加到这个 ReceiverList 中去了。这个 BroadcastFilter 我们也来稍微看下它的结构吧：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">class BroadcastFilter extends IntentFilter {</div><div class="line">    <span class="comment">// Back-pointer to the list this filter is in.</span></div><div class="line">    <span class="keyword">final</span> ReceiverList receiverList;</div><div class="line">    <span class="keyword">final</span> String packageName;</div><div class="line">    <span class="keyword">final</span> String requiredPermission;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> owningUid;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> owningUserId;</div><div class="line"></div><div class="line">    BroadcastFilter(IntentFilter _filter, ReceiverList _receiverList,</div><div class="line">            String _packageName, String _requiredPermission, <span class="keyword">int</span> _owningUid, <span class="keyword">int</span> _userId) {</div><div class="line">        <span class="keyword">super</span>(_filter);</div><div class="line">        receiverList = _receiverList;</div><div class="line">        packageName = _packageName;</div><div class="line">        requiredPermission = _requiredPermission;</div><div class="line">        owningUid = _owningUid;</div><div class="line">        owningUserId = _userId;</div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>继续自 IntentFilter（这个我就不多说了，注册广播的应该对这个很熟悉了）。上面代码 AMS 中还保存了已经注册过的 RecieverList(mRegisteredReceivers)，会先去以前的列表里面去找，看之前是不是注册过，这个可以防止多个重复的 broadcast recevier。然后到最后了， mReceiverResolver.addFilter(bf); 这里就很关键了。我们先来看看这个 mReceiverResolver 是什么东西：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// ================= ActivityManagerService.java ========================</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Resolver for broadcast intents to registered receivers.</span></div><div class="line"><span class="comment">     * Holds BroadcastFilter (subclass of IntentFilter).</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">final</span> IntentResolver&lt;BroadcastFilter, BroadcastFilter&gt; mReceiverResolver</div><div class="line">            = <span class="keyword">new</span> IntentResolver&lt;BroadcastFilter, BroadcastFilter&gt;() {</div><div class="line">        ... ...    </div><div class="line">    };</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// ================= IntentResolver.java ========================</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * {@hide}</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">IntentResolver</span>&lt;<span class="title">F</span> <span class="keyword">extends</span> <span class="title">IntentFilter</span>, <span class="title">R</span> <span class="keyword">extends</span> <span class="title">Object</span>&gt; </span>{</div><div class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> String TAG = <span class="string">"IntentResolver"</span>;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> DEBUG = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> localLOGV = DEBUG || <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> VALIDATE = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="comment">// 存数据的都在这里，基本不是 HashMap 就是 HashSet</span></div><div class="line">    <span class="comment">// 注释也写得很清楚是拿来存什么的</span></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * All filters that have been registered.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;F&gt; mFilters = <span class="keyword">new</span> HashSet&lt;F&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * All of the MIME types that have been registered, such as "image/jpeg",</span></div><div class="line"><span class="comment">     * "image/*", or "{@literal *}/*".</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, F[]&gt; mTypeToFilter = <span class="keyword">new</span> HashMap&lt;String, F[]&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * The base names of all of all fully qualified MIME types that have been</span></div><div class="line"><span class="comment">     * registered, such as "image" or "*".  Wild card MIME types such as</span></div><div class="line"><span class="comment">     * "image/*" will not be here.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, F[]&gt; mBaseTypeToFilter = <span class="keyword">new</span> HashMap&lt;String, F[]&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * The base names of all of the MIME types with a sub-type wildcard that</span></div><div class="line"><span class="comment">     * have been registered.  For example, a filter with "image/*" will be</span></div><div class="line"><span class="comment">     * included here as "image" but one with "image/jpeg" will not be</span></div><div class="line"><span class="comment">     * included here.  This also includes the "*" for the "{@literal *}/*"</span></div><div class="line"><span class="comment">     * MIME type.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, F[]&gt; mWildTypeToFilter = <span class="keyword">new</span> HashMap&lt;String, F[]&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * All of the URI schemes (such as http) that have been registered.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, F[]&gt; mSchemeToFilter = <span class="keyword">new</span> HashMap&lt;String, F[]&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * All of the actions that have been registered, but only those that did</span></div><div class="line"><span class="comment">     * not specify data.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, F[]&gt; mActionToFilter = <span class="keyword">new</span> HashMap&lt;String, F[]&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * All of the actions that have been registered and specified a MIME type.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, F[]&gt; mTypedActionToFilter = <span class="keyword">new</span> HashMap&lt;String, F[]&gt;();</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>mReceiverResolver 继承自 IntentResolver 这个模板类。前面的 <strong>F</strong> 是传入类型，保存在列表（HashMap、HashSet）里面的，后面那个 <strong>R</strong> 是传出类型，后面 AMS 处理广播的时候要向 IntentResolver 查询的，那个时候返回的就是 R。然后2个模板都是 BroadcastFilter。我们先继续看它的 addFilter 里面是怎么处理的（在父类里面）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">IntentResolver</span>&lt;<span class="title">F</span> <span class="keyword">extends</span> <span class="title">IntentFilter</span>, <span class="title">R</span> <span class="keyword">extends</span> <span class="title">Object</span>&gt; </span>{</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilter</span>(F f) {</div><div class="line">        <span class="keyword">if</span> (localLOGV) {</div><div class="line">            Slog.v(TAG, <span class="string">"Adding filter: "</span> + f);</div><div class="line">            f.dump(<span class="keyword">new</span> LogPrinter(Log.VERBOSE, TAG, Log.LOG_ID_SYSTEM), <span class="string">"      "</span>);</div><div class="line">            Slog.v(TAG, <span class="string">"    Building Lookup Maps:"</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// 先保存到 mFilters 里面，这个相当于是所有总类型的</span></div><div class="line">        mFilters.add(f);</div><div class="line">        <span class="comment">// 然后下面的是保 Scheme 的，IntentFilter 不是可以设置 Scheme 么</span></div><div class="line">        <span class="keyword">int</span> numS = register_intent_filter(f, f.schemesIterator(),</div><div class="line">                mSchemeToFilter, <span class="string">"      Scheme: "</span>);</div><div class="line">        <span class="comment">// 保存 Mime type 类型的，IntentFilter 也可以设置 Mime type</span></div><div class="line">        <span class="keyword">int</span> numT = register_mime_types(f, <span class="string">"      Type: "</span>);</div><div class="line">        <span class="keyword">if</span> (numS == <span class="number">0</span> && numT == <span class="number">0</span>) {</div><div class="line">            <span class="comment">// 如果 IntentFiler 既没有设置 Scheme 也没有设置 Mime type 就保存 Action</span></div><div class="line">            <span class="comment">// IntentFiler 感觉还是 Action 用得多吧</span></div><div class="line">            register_intent_filter(f, f.actionsIterator(),</div><div class="line">                    mActionToFilter, <span class="string">"      Action: "</span>);</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (numT != <span class="number">0</span>) {</div><div class="line">            <span class="comment">// 这个和上面的区别在于指定了 Action 的同时还指定了 Mime type</span></div><div class="line">            register_intent_filter(f, f.actionsIterator(),</div><div class="line">                    mTypedActionToFilter, <span class="string">"      TypedAction: "</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// 下面的不用管，是兼容以前版本的格式的，VAILIDATE 设置为 false 的</span></div><div class="line">        <span class="keyword">if</span> (VALIDATE) {</div><div class="line">            mOldResolver.addFilter(f);</div><div class="line">            verifyDataStructures(f);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个 addFilter 大意就是把传过来的 F（这里是 BroadcastFilter）保存到对应的列表里面。不过我们还是继续去看看 register_intent_filter 里面的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">register_intent_filter</span>(F filter, Iterator&lt;String&gt; i,</div><div class="line">        HashMap&lt;String, F[]&gt; dest, String prefix) {</div><div class="line">    <span class="keyword">if</span> (i == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">int</span> num = <span class="number">0</span>;</div><div class="line">    <span class="comment">// 我们这里以 Action 为例，循环取出看看注册的 IntentFiler 里面包含多少个 Action</span></div><div class="line">    <span class="keyword">while</span> (i.hasNext()) {</div><div class="line">        String name = i.next();        </div><div class="line">        num++;</div><div class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, prefix + name);</div><div class="line">        <span class="comment">// 这个 addFilter 是私有的，并且参数个数和上面的不一样</span></div><div class="line">        addFilter(dest, name, filter); </div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> num;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addFilter</span>(HashMap&lt;String, F[]&gt; map, String name, F filter) {</div><div class="line">    <span class="comment">// 这个函数比较简单，就是把上面取到的 Action 和 传入的 filter 存到上面给定的 HashMap（HashSet） 中</span></div><div class="line">    F[] array = map.get(name);</div><div class="line">    <span class="keyword">if</span> (array == <span class="keyword">null</span>) {</div><div class="line">        array = newArray(<span class="number">2</span>);</div><div class="line">        map.put(name,  array);</div><div class="line">        array[<span class="number">0</span>] = filter;</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = array.length;</div><div class="line">        <span class="keyword">int</span> i = N;</div><div class="line">        <span class="keyword">while</span> (i &gt; <span class="number">0</span> && array[i-<span class="number">1</span>] == <span class="keyword">null</span>) {</div><div class="line">            i--;</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (i &lt; N) {</div><div class="line">            array[i] = filter;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            F[] newa = newArray((N*<span class="number">3</span>)/<span class="number">2</span>);</div><div class="line">            System.arraycopy(array, <span class="number">0</span>, newa, <span class="number">0</span>, N);</div><div class="line">            newa[N] = filter;</div><div class="line">            map.put(name, newa);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>



<p>处理比较简单，就是存下数据，不过注意这里 new 数据的时候函数 newArray， AMS 中的 mReceiverResolver 实现了这个函数（其实还实现了好个，这里先看这个）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">protected</span> BroadcastFilter[] <span class="title">newArray</span>(<span class="keyword">int</span> size) {</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BroadcastFilter[size];</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>也挺简单的，就是返回具体模板的对象的数组而已。到这里动态注册的服务端的流程就完了。简单来说就是把传过来的接收处理对象（IItnentRecevier）和要接收的广播（IntentFilter）保存到了 AMS 的一个叫 mReceiverResolver 里面去了。但是由于对象层层封装，容易一下子看多了忘记这个倒数是啥东西了。于是我整了一张，看一下应该就会好了：</p>
<p><img src="http://7u2hy4.com1.z0.glb.clouddn.com/android/Broadcast-register/AMS-registerReceiver.png" alt="" title="AMS registerReceiver 数据流程"></p>
<h2 id="静态注册">静态注册</h2>
<p>上面说完了动态注册，我们来说下静态注册。和动态相对的，静态注册最大的特点就是： <strong>进程不需要运行，并且 AMS 在处理广播的时候还会帮你把接收器所在的进程启动起来</strong>。静态注册在 AndroidMainfest.xml 中声明一个 recevier 就可以了，例如像下面这样：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">receiver</span> <span class="attribute">android:name</span>=<span class="value">".service.AlarmInitReceiver"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">intent-filter</span> <span class="attribute">android:priority</span>=<span class="value">"90"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.BOOT_COMPLETED"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.TIME_SET"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.TIMEZONE_CHANGED"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.LOCALE_CHANGED"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">receiver</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure>

<p>那静态广播是怎么注册到系统里面的去咧。其实看到在 mainfest 声明就应该猜到是 PMS 扫描，然后将扫描结果存了起来。实际就是这样的，我们来看看具体流程。首先在 PMS 的构造函数有这么一个调用（PMS 会在 SystemService 初始化的时候启动起来，具体的去看 Binder 多线程篇）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="title">PackageManagerService</span>(Context context, Installer installer,</div><div class="line">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore) {</div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="comment">// SS 业务函数多线程支持照例加锁（话说这里还加了2把）</span></div><div class="line">        <span class="keyword">synchronized</span> (mInstallLock) {</div><div class="line">        <span class="comment">// writer</span></div><div class="line">        <span class="keyword">synchronized</span> (mPackages) {</div><div class="line">            mHandlerThread.start();</div><div class="line">            mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</div><div class="line"></div><div class="line">            <span class="comment">// 设置一些路径</span></div><div class="line">            File dataDir = Environment.getDataDirectory();</div><div class="line">            mAppDataDir = <span class="keyword">new</span> File(dataDir, <span class="string">"data"</span>);</div><div class="line">            mAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app"</span>);</div><div class="line">            mAppLibInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-lib"</span>);</div><div class="line">            mAsecInternalPath = <span class="keyword">new</span> File(dataDir, <span class="string">"app-asec"</span>).getPath();</div><div class="line">            mUserAppDataDir = <span class="keyword">new</span> File(dataDir, <span class="string">"user"</span>);</div><div class="line">            mDrmAppPrivateInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-private"</span>);</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">            <span class="comment">// framework 的路径是 /system/framework</span></div><div class="line">            mFrameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</div><div class="line">            mDalvikCacheDir = <span class="keyword">new</span> File(dataDir, <span class="string">"dalvik-cache"</span>);</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">            <span class="comment">// Find base frameworks (resource packages without code).</span></div><div class="line">            mFrameworkInstallObserver = <span class="keyword">new</span> AppDirObserver(</div><div class="line">                mFrameworkDir.getPath(), OBSERVER_EVENTS, <span class="keyword">true</span>);</div><div class="line">            mFrameworkInstallObserver.startWatching();</div><div class="line">            scanDirLI(mFrameworkDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">                    | PackageParser.PARSE_IS_SYSTEM_DIR,</div><div class="line">                    scanMode | SCAN_NO_DEX, <span class="number">0</span>);</div><div class="line"></div><div class="line">            <span class="comment">// 系统应用的路径是 /system/app</span></div><div class="line">            <span class="comment">// Collect all system packages.</span></div><div class="line">            mSystemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</div><div class="line">            mSystemInstallObserver = <span class="keyword">new</span> AppDirObserver(</div><div class="line">                mSystemAppDir.getPath(), OBSERVER_EVENTS, <span class="keyword">true</span>);</div><div class="line">            mSystemInstallObserver.startWatching();</div><div class="line">            <span class="comment">// 扫描系统应用</span></div><div class="line">            scanDirLI(mSystemAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">                    | PackageParser.PARSE_IS_SYSTEM_DIR, scanMode, <span class="number">0</span>);</div><div class="line"></div><div class="line">            <span class="comment">// /vendor/app 下面应该是留给 OEM 厂商定制的 app</span></div><div class="line">            <span class="comment">// 不过一些 OEM 厂商不买 google 账，自己乱放（例如步步高）</span></div><div class="line">            <span class="comment">// Collect all vendor packages.</span></div><div class="line">            mVendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</div><div class="line">            mVendorInstallObserver = <span class="keyword">new</span> AppDirObserver(</div><div class="line">                mVendorAppDir.getPath(), OBSERVER_EVENTS, <span class="keyword">true</span>);</div><div class="line">            mVendorInstallObserver.startWatching();</div><div class="line">            <span class="comment">// 扫描 OEM 定制应用</span></div><div class="line">            scanDirLI(mVendorAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">                    | PackageParser.PARSE_IS_SYSTEM_DIR, scanMode, <span class="number">0</span>);</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">            <span class="comment">// 这个 onlyCore 是运行在加密的设备上（"vold.decrypt" 被设置为 true）才是 true，</span></div><div class="line">            <span class="comment">// 一般的是 false</span></div><div class="line">            <span class="keyword">if</span> (!mOnlyCore) {</div><div class="line">                EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</div><div class="line">                        SystemClock.uptimeMillis());</div><div class="line">                mAppInstallObserver = <span class="keyword">new</span> AppDirObserver(</div><div class="line">                    mAppInstallDir.getPath(), OBSERVER_EVENTS, <span class="keyword">false</span>);</div><div class="line">                mAppInstallObserver.startWatching();</div><div class="line">                <span class="comment">// 这个路径前面设置过了是 /data/data，这里扫描普通应用</span></div><div class="line">                scanDirLI(mAppInstallDir, <span class="number">0</span>, scanMode, <span class="number">0</span>);</div><div class="line"></div><div class="line">                <span class="comment">// 这里是扫描受 DRM 保护的应用</span></div><div class="line">                mDrmAppInstallObserver = <span class="keyword">new</span> AppDirObserver(</div><div class="line">                    mDrmAppPrivateInstallDir.getPath(), OBSERVER_EVENTS, <span class="keyword">false</span>);</div><div class="line">                mDrmAppInstallObserver.startWatching();</div><div class="line">                scanDirLI(mDrmAppPrivateInstallDir, PackageParser.PARSE_FORWARD_LOCK,</div><div class="line">                        scanMode, <span class="number">0</span>);</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                mAppInstallObserver = <span class="keyword">null</span>;</div><div class="line">                mDrmAppInstallObserver = <span class="keyword">null</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        } <span class="comment">// synchronized (mPackages)</span></div><div class="line">        } <span class="comment">// synchronized (mInstallLock)</span></div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>SS（PMS） 是开机启动的，也就是说在开机的时候 PMS 会去扫描一系列目录下的应用去收集一些应用的信息（稍微扯远点，注意看上面有一些文件 Observer（这个是 android 自己弄了一个监视文件变动的 Observer）设置，会在监视相应目录下的文件变动，一有变动，PMS 会扫描变动，这也就是为什么调试的时候直接 push apk 到 /system/app 或者 /data/app 下面也是能够正常安装的原因）。扫描函数是 scanDirLI：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 这个是扫描目录的</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span>(File dir, <span class="keyword">int</span> flags, <span class="keyword">int</span> scanMode, <span class="keyword">long</span> currentTime) {</div><div class="line">    String[] files = dir.list();</div><div class="line">    <span class="keyword">if</span> (files == <span class="keyword">null</span>) {</div><div class="line">        Log.d(TAG, <span class="string">"No files in app dir "</span> + dir);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    }   </div><div class="line">        </div><div class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) {</div><div class="line">        Log.d(TAG, <span class="string">"Scanning app dir "</span> + dir);</div><div class="line">    }   </div><div class="line">        </div><div class="line">    <span class="comment">// 这个写法，不支持递归目录咧（也不需要支持）</span></div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;files.length; i++) {</div><div class="line">        File file = <span class="keyword">new</span> File(dir, files[i]);</div><div class="line">        <span class="comment">// 稍微判断下是不是 apk 文件（这里我们就不去看这个判断了）</span></div><div class="line">        <span class="keyword">if</span> (!isPackageFilename(files[i])) {</div><div class="line">            <span class="comment">// Ignore entries which are not apk's</span></div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        }</div><div class="line">        <span class="comment">// 罗列下指定目录下的 apk 文件，然后交给扫描文件的函数处理</span></div><div class="line">        PackageParser.Package pkg = scanPackageLI(file,</div><div class="line">                flags|PackageParser.PARSE_MUST_BE_APK, scanMode, currentTime, <span class="keyword">null</span>);</div><div class="line">        <span class="comment">// Don't mess around with apps in system partition.</span></div><div class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span> && (flags & PackageParser.PARSE_IS_SYSTEM) == <span class="number">0</span> &&</div><div class="line">                mLastScanError == PackageManager.INSTALL_FAILED_INVALID_APK) {</div><div class="line">            <span class="comment">// Delete the apk</span></div><div class="line">            Slog.w(TAG, <span class="string">"Cleaning up failed install of "</span> + file);</div><div class="line">            file.delete();</div><div class="line">        }</div><div class="line">    }   </div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里把扫描单个 apk 文件的任务交给 scanPackageLI 这个函数了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     *  Scan a package and return the newly parsed package.</span></div><div class="line"><span class="comment">     *  Returns null in case of errors and the error code is stored in mLastScanError</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> PackageParser.Package <span class="title">scanPackageLI</span>(File scanFile,</div><div class="line">            <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanMode, <span class="keyword">long</span> currentTime, UserHandle user) {</div><div class="line">        mLastScanError = PackageManager.INSTALL_SUCCEEDED;</div><div class="line">        String scanPath = scanFile.getPath();</div><div class="line">        parseFlags |= mDefParseFlags;</div><div class="line">        PackageParser pp = <span class="keyword">new</span> PackageParser(scanPath);</div><div class="line">        pp.setSeparateProcesses(mSeparateProcesses);</div><div class="line">        pp.setOnlyCoreApps(mOnlyCore);</div><div class="line">        <span class="comment">// PMS 中有一个专门解析 apk 文件的东西（PackageParser），里面包括了很多文件的解析</span></div><div class="line">        <span class="comment">// 这里我们不去过多分析这个，以后有空再单独开一篇分析咯，这里就当它解析好了就行了</span></div><div class="line">        <span class="keyword">final</span> PackageParser.Package pkg = pp.parsePackage(scanFile,</div><div class="line">                scanPath, mMetrics, parseFlags);</div><div class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) {</div><div class="line">            mLastScanError = pp.getParseError();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; </div><div class="line">        }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        String codePath = <span class="keyword">null</span>; </div><div class="line">        String resPath = <span class="keyword">null</span>; </div><div class="line">        <span class="keyword">if</span> ((parseFlags & PackageParser.PARSE_FORWARD_LOCK) != <span class="number">0</span>) {</div><div class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span> && ps.resourcePathString != <span class="keyword">null</span>) {</div><div class="line">                resPath = ps.resourcePathString;</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="comment">// Should not happen at all. Just log an error.</span></div><div class="line">                Slog.e(TAG, <span class="string">"Resource path not set for pkg : "</span> + pkg.packageName);</div><div class="line">            }     </div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            resPath = pkg.mScanPath;</div><div class="line">        }     </div><div class="line">        codePath = pkg.mScanPath;</div><div class="line">        <span class="comment">// Set application objects path explicitly.</span></div><div class="line">        setApplicationInfoPaths(pkg, codePath, resPath);</div><div class="line">        <span class="comment">// 这里又调用另外一个同名不同参数的函数去处理了</span></div><div class="line">        <span class="comment">// Note that we invoke the following method only if we are about to unpack an application</span></div><div class="line">        PackageParser.Package scannedPkg = scanPackageLI(pkg, parseFlags, scanMode</div><div class="line">                | SCAN_UPDATE_SIGNATURE, currentTime, user);</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="keyword">return</span> scannedPkg;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>又调用到同名，不同参数的函数中去了，而且这个函数巨长无比，有将近 1000 行，我们只看关键部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">private</span> PackageParser.Package <span class="title">scanPackageLI</span>(PackageParser.Package pkg,</div><div class="line">            <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanMode, <span class="keyword">long</span> currentTime, UserHandle user) {</div><div class="line">        File scanFile = <span class="keyword">new</span> File(pkg.mScanPath);</div><div class="line">        <span class="keyword">if</span> (scanFile == <span class="keyword">null</span> || pkg.applicationInfo.sourceDir == <span class="keyword">null</span> ||</div><div class="line">                pkg.applicationInfo.publicSourceDir == <span class="keyword">null</span>) {</div><div class="line">            <span class="comment">// Bail out. The resource and code paths haven't been set.</span></div><div class="line">            Slog.w(TAG, <span class="string">" Code and resource paths haven't been set correctly"</span>);</div><div class="line">            mLastScanError = PackageManager.INSTALL_FAILED_INVALID_APK;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        }   </div><div class="line">        mScanningPath = scanFile;</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">        <span class="comment">// writer</span></div><div class="line">        <span class="keyword">synchronized</span> (mPackages) {</div><div class="line">            <span class="comment">// We don't expect installation to fail beyond this point,</span></div><div class="line">            <span class="keyword">if</span> ((scanMode&SCAN_MONITOR) != <span class="number">0</span>) {</div><div class="line">                mAppDirs.put(pkg.mPath, pkg);</div><div class="line">            }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">            <span class="comment">// 取 PackageParser 解析 manifest 中有声明了的 receiver </span></div><div class="line">            N = pkg.receivers.size();</div><div class="line">            r = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) {</div><div class="line">                PackageParser.Activity a = pkg.receivers.get(i);</div><div class="line">                a.info.processName = fixProcessName(pkg.applicationInfo.processName,</div><div class="line">                        a.info.processName, pkg.applicationInfo.uid);</div><div class="line">                <span class="comment">// 这个 addActivity 是关键步骤了</span></div><div class="line">                mReceivers.addActivity(a, <span class="string">"receiver"</span>);</div><div class="line">                <span class="keyword">if</span> ((parseFlags&PackageParser.PARSE_CHATTY) != <span class="number">0</span>) {</div><div class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) {</div><div class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</div><div class="line">                    } <span class="keyword">else</span> {</div><div class="line">                        r.append(<span class="string">' '</span>);</div><div class="line">                    }         </div><div class="line">                    r.append(a.info.name);</div><div class="line">                }                 </div><div class="line">            }                 </div><div class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</div><div class="line">            }</div><div class="line"></div><div class="line">... ...</div><div class="line">            </div><div class="line">        }         </div><div class="line">                </div><div class="line">        <span class="keyword">return</span> pkg;</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>我们先来看这个 mReceivers 是什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">// All available receivers, for your resolving pleasure.</span></div><div class="line">    <span class="keyword">final</span> ActivityIntentResolver mReceivers =</div><div class="line">            <span class="keyword">new</span> ActivityIntentResolver();</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityIntentResolver</span></span></div><div class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">IntentResolver</span>&lt;<span class="title">PackageParser</span>.<span class="title">ActivityIntentInfo</span>, <span class="title">ResolveInfo</span>&gt; </span>{</div><div class="line">        ... ...</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>经过前面动态注册的分析，对于个 IntentResolver 模板类应该不陌生了吧。PMS 中也有一个，用来来保存静态的注册信息的（AMS 那个是保存动态的）。PMS 里面的 F 是 PackageParser.ActivityIntentInfo， R 是 ResolverInfo。我们来看下这个 F 的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntentInfo</span> <span class="keyword">extends</span> <span class="title">IntentFilter</span> </span>{</div><div class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> hasDefault;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> labelRes;</div><div class="line">    <span class="keyword">public</span> CharSequence nonLocalizedLabel;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> icon;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> logo;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityIntentInfo</span> <span class="keyword">extends</span> <span class="title">IntentInfo</span> </span>{</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Activity activity;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="title">ActivityIntentInfo</span>(Activity _activity) {</div><div class="line">        activity = _activity;</div><div class="line">    }    </div><div class="line"></div><div class="line">    <span class="keyword">public</span> String <span class="title">toString</span>() {</div><div class="line">        <span class="keyword">return</span> <span class="string">"ActivityIntentInfo{"</span></div><div class="line">            + Integer.toHexString(System.identityHashCode(<span class="keyword">this</span>))</div><div class="line">            + <span class="string">" "</span> + activity.info.name + <span class="string">"}"</span>; </div><div class="line">    }    </div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>还是得继承自 IntentFilter，只不过又多了一层，然后多了几个变量而已。然后 scanPackageLI 这个函数是传入 PackageParser.Activity 这个对象过去的，我们看看这个东西：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Component</span>&lt;<span class="title">II</span> <span class="keyword">extends</span> <span class="title">IntentInfo</span>&gt; </span>{</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> Package owner;    </div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;II&gt; intents;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String className; </div><div class="line">        <span class="keyword">public</span> Bundle metaData;        </div><div class="line"></div><div class="line">        ComponentName componentName;   </div><div class="line">        String componentShortName;  </div><div class="line">... ...</div><div class="line">        </div><div class="line">    }</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Activity</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">ActivityIntentInfo</span>&gt; </span>{</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> ActivityInfo info;</div><div class="line">            </div><div class="line">        <span class="keyword">public</span> <span class="title">Activity</span>(<span class="keyword">final</span> ParseComponentArgs args, <span class="keyword">final</span> ActivityInfo _info) {</div><div class="line">            <span class="keyword">super</span>(args, _info);</div><div class="line">            info = _info; </div><div class="line">            info.applicationInfo = args.owner.applicationInfo;</div><div class="line">        }       </div><div class="line">            </div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPackageName</span>(String packageName) {</div><div class="line">            <span class="keyword">super</span>.setPackageName(packageName);</div><div class="line">            info.packageName = packageName;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keyword">public</span> String <span class="title">toString</span>() {</div><div class="line">            <span class="keyword">return</span> <span class="string">"Activity{"</span></div><div class="line">                + Integer.toHexString(System.identityHashCode(<span class="keyword">this</span>))</div><div class="line">                + <span class="string">" "</span> + getComponentShortName() + <span class="string">"}"</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div></pre></td></tr></table></figure>

<p>绕了几下，反正是 ActivityIntentInfo 的子类。至于 ActivityIntentInfo 怎么从 PackageParser 解析出来的，前面说了我们这里不做分析。然后我们直接去看 ActivityIntentResolver 的 addActivity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// type 前面传入的是 "receiver"</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addActivity</span>(PackageParser.Activity a, String type) {   </div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> systemApp = isSystemApp(a.info.applicationInfo);</div><div class="line">    mActivities.put(a.getComponentName(), a);</div><div class="line">    <span class="keyword">if</span> (DEBUG_SHOW_INFO)</div><div class="line">        Log.v(</div><div class="line">        TAG, <span class="string">"  "</span> + type + <span class="string">" "</span> +</div><div class="line">        (a.info.nonLocalizedLabel != <span class="keyword">null</span> ? a.info.nonLocalizedLabel : a.info.name) + <span class="string">":"</span>);</div><div class="line">    <span class="keyword">if</span> (DEBUG_SHOW_INFO)</div><div class="line">        Log.v(TAG, <span class="string">"    Class="</span> + a.info.name);</div><div class="line">    <span class="comment">// 前面 Activity 的父类的父类 Component 中有一个 ArrayList 保存了系列 ActivityIntentInfo</span></div><div class="line">    <span class="comment">// 然后就是 mainfest 里面声明了多少个 &lt;intent-filer&gt; 的标签，这里就有几个 ActivityIntentInfo</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NI = a.intents.size();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;NI; j++) {</div><div class="line">        PackageParser.ActivityIntentInfo intent = a.intents.get(j);</div><div class="line">        <span class="comment">// 这里有个优先级权限判断，如果不是系统应用，或者 type 类型是 activity（这里是 recevier）</span></div><div class="line">        <span class="comment">// 优先级设置大于 0 的话，强制变成0</span></div><div class="line">        <span class="comment">// 换句话说，只有系统应用能把 receiver 的优先级设置成大于 0</span></div><div class="line">        <span class="keyword">if</span> (!systemApp && intent.getPriority() &gt; <span class="number">0</span> && <span class="string">"activity"</span>.equals(type)) {</div><div class="line">            intent.setPriority(<span class="number">0</span>); </div><div class="line">            Log.w(TAG, <span class="string">"Package "</span> + a.info.applicationInfo.packageName + <span class="string">" has activity "</span></div><div class="line">                    + a.className + <span class="string">" with priority &gt; 0, forcing to 0"</span>);</div><div class="line">        }  </div><div class="line">        <span class="keyword">if</span> (DEBUG_SHOW_INFO) {</div><div class="line">            Log.v(TAG, <span class="string">"    IntentFilter:"</span>);</div><div class="line">            intent.dump(<span class="keyword">new</span> LogPrinter(Log.VERBOSE, TAG), <span class="string">"      "</span>);</div><div class="line">        }   </div><div class="line">        <span class="keyword">if</span> (!intent.debugCheck()) {</div><div class="line">            Log.w(TAG, <span class="string">"==&gt; For Activity "</span> + a.info.name);</div><div class="line">        }</div><div class="line">        <span class="comment">// 调用父类 IntentResolver 的 addFilter 添加 IntentFilter </span></div><div class="line">        addFilter(intent);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这里有个解决前面背景中关机闹钟不响问题的关键——广播 receiver 接收优先级的设置。在 mainfest 的 intent-filter 标签中可以声明一个优先级（看我前面的那个例子），这个是一个 int 类型，一般默认是 0。数值越大，优先级越高，这个优先级在哪里会用到，到后面一篇，广播处理那里就能看到了。这个数值是由 PackageParser 解析 mainfest 中的声明得到的，从这里的判断可以看出，普通应用的广播 receiver 无法声明高于 0。但是这点好像只对静态注册的广播有限制，动态的可以使用 IntentFilter.setPriority 设置，虽然 API 文档里告诉你不要让这个值高于 <code>SYSTEM_HIGH_PRIORITY(1000)</code> ，但是 AMS 里面没有任何限制判断，所以你要耍下流氓可以把这个值设得很高。不过动态注册的 recevier 在并行广播处理（后面那篇处理的会解释什么叫并行广播、什么叫串行广播）中和静态的 receiver 的优先级有本质的区别（后面能知道本质区别在哪），所以动态的流氓点好像关系也不大。</p>
<p>扯了下优先级的问题。最后还是调用父类 IntentResolver 的 addFilter 保存到列表中，然后 PMS 的 ActivityIntentResolver 的 newArray 是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line"><span class="keyword">protected</span> ActivityIntentInfo[] <span class="title">newArray</span>(<span class="keyword">int</span> size) {</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActivityIntentInfo[size];</div><div class="line">}</div><div class="line"></div></pre></td></tr></table></figure>

<p>这个 addFilter 就不重复说一遍了。</p>
<h2 id="总结">总结</h2>
<p>通过上面的分析，可以看到，虽然广播接收器注册分动态和静态。但是最后的流程都是一样的，<strong>只不过一个接收器的数据保存在 AMS 中（动态的）</strong>，<strong>一个接收器的数据保存在 PMS 中（静态的）</strong>。所以后面处理广播的时候查询动态的接收器直接用 AMS 自己的数据查，而查询静态的需要调用 PMS 的接口去查（不过它们2个都在一个进程里面，也算一家人啦）。</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/android/">android</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android-Framework/">Android Framework</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://www.light3moon.com/2015/01/22/Android Broadcast 分析——注册/" data-title="Android Broadcast 分析——注册 | Light.Moon" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/11/02/Android 应用内存泄漏分析/" title="Android 应用内存泄漏问题分析">
  <strong>上一篇:</strong><br/>
  <span>
  Android 应用内存泄漏问题分析</span>
</a>
</div>


<div class="next">
<a href="/2015/01/22/Android Broadcast 分析——发送、处理/"  title="Android Broadcast 分析——发送、处理">
 <strong>下一篇:</strong><br/> 
 <span>Android Broadcast 分析——发送、处理
</span>
</a>
</div>

</nav>


	
<section class="comment">
	<div class="ds-thread" data-thread-key="Android Broadcast 分析——注册" data-title="Android Broadcast 分析——注册" 
      data-author-key="mingming" data-limit=10
      data-url="light3moon.com/2015/01/22/Android Broadcast 分析——注册/">
    </div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态注册"><span class="toc-number">2.</span> <span class="toc-text">动态注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#接口端"><span class="toc-number">2.1.</span> <span class="toc-text">接口端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端"><span class="toc-number">2.2.</span> <span class="toc-text">服务端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#静态注册"><span class="toc-number">3.</span> <span class="toc-text">静态注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Android-Development/" title="Android Development">Android Development<sup>35</sup></a></li>
		
			<li><a href="/categories/Android-Framework/" title="Android Framework">Android Framework<sup>47</sup></a></li>
		
			<li><a href="/categories/Basics-Knowledge/" title="Basics Knowledge">Basics Knowledge<sup>11</sup></a></li>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>24</sup></a></li>
		
			<li><a href="/categories/MiniGUI/" title="MiniGUI">MiniGUI<sup>12</sup></a></li>
		
			<li><a href="/categories/Other/" title="Other">Other<sup>8</sup></a></li>
		
			<li><a href="/categories/Server/" title="Server">Server<sup>1</sup></a></li>
		
			<li><a href="/categories/Window/" title="Window">Window<sup>10</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		
			<li><a href="/tags/android/" title="android">android<sup>82</sup></a></li>
		
			<li><a href="/tags/basics/" title="basics">basics<sup>11</sup></a></li>
		
			<li><a href="/tags/install/" title="install">install<sup>9</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>27</sup></a></li>
		
			<li><a href="/tags/minigui/" title="minigui">minigui<sup>13</sup></a></li>
		
			<li><a href="/tags/opengl/" title="opengl">opengl<sup>3</sup></a></li>
		
			<li><a href="/tags/other/" title="other">other<sup>5</sup></a></li>
		
			<li><a href="/tags/server/" title="server">server<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>5</sup></a></li>
		
			<li><a href="/tags/window/" title="window">window<sup>11</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">哥的后勤处 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-qqzone"></i> <a href="http://user.qzone.qq.com/544630305" target="_blank">QQ 空间</a></li>
      <li><i class="fa fa-github"></i> <a href="https://github.com/mingming-killer" target="_blank">GitHub</a></li>
      
        
          <li><i class="fa fa-analytics"></i> <a href="http://tongji.baidu.com/web/welcome/ico?s=fa045dbd45ffce238b146e00f91ba6a3" target="_blank">战斗力</a></li>
        
      
      <li><i class="fa fa-markdown-help"></i> <a href="http://zh.wikipedia.org/wiki/Markdown" target="_blank">Makrdown</a></li>
    </ul>
</div>


  <div class="commentlist">
  <p class="asidetitle">最近冒泡的小伙伴 ╰(●&#39;◡&#39;●)╮</p>
    <ul>
      <ul class="ds-recent-comments" 
        data-num-items="6" 
        data-show-avatars="1" 
        data-show-title="1"   
        data-show-time="1" 
        data-show-admin="1" 
        data-excerpt-length="30">
      </ul>
      <!-- duoshou js begin load, one page only load once -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"mingming"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
      <!-- duoshou js load end -->
    </ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接 o(^▽^)o</p>
    <ul>
      <li><i class="fa fa-book"></i> <a href="http://taoyuanxiaoqi.com" target="_blank">桃园小七的博客</a></li>
    </ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
<!--
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
-->

     <!-- this is defined in footer.styl, line holder -->
	<div class="line">
	</div>
     
<!--
	<div class="social-font clearfix">
		
		
		
		
		
		<a href="https://github.com/mingming-killer" target="_blank" title="github"></a>
		
        	
		<a href="http://user.qzone.qq.com/544630305" target="_blank" title="qqzone"></a>
		         
	</div>
-->

		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/mingming-killer/Lightmoon" target="_blank" title="Lightmoon">Lightmoon</a> © 2016 
		
		<a href="http://www.light3moon.com" target="_blank" title="Mingming">Mingming</a>
		
		</p>

  <!-- baidu search verification -->
  
    <meta name="baidu-site-verification" content="w1BSX6yZ9k" />
  

  <!-- swiftype search verification -->
  

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"mingming"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fa045dbd45ffce238b146e00f91ba6a3";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


  </body>
</html>
